<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VCC Pay - å…¨çƒè™šæ‹Ÿå¡æ”¯ä»˜å¹³å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .nav-link.active { background-color: #eff6ff; color: #4f46e5; border-right: 3px solid #4f46e5; }
        .visa-bg { background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); }
        .master-bg { background: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%); }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        .slide-up { animation: slideUp 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* ç™»å½•é¡µä¸“ç”¨èƒŒæ™¯ */
        .auth-bg {
            background-image: radial-gradient(circle at 50% 0%, #4f46e5 0%, #0f172a 60%);
        }
    </style>
</head>
<body class="text-slate-800 h-screen overflow-hidden">

    <div id="auth-layout" class="w-full h-full flex bg-slate-900 relative z-50">
        <div class="hidden lg:flex lg:w-1/2 items-center justify-center relative overflow-hidden auth-bg">
            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
            <div class="relative z-10 text-center px-10 slide-up">
                <div class="w-20 h-20 bg-white/10 backdrop-blur-lg rounded-2xl flex items-center justify-center text-white font-bold text-4xl mb-8 mx-auto shadow-2xl border border-white/20">V</div>
                <h1 class="text-4xl font-bold text-white mb-4">VCC Pay Global</h1>
                <p class="text-indigo-200 text-lg max-w-md mx-auto">èµ‹èƒ½å…¨çƒæ”¯ä»˜ï¼Œä¸€é”®å¼€é€š Visa/Mastercard è™šæ‹Ÿå¡ï¼ŒåŠ©åŠ›è·¨å¢ƒä¸šåŠ¡æ— ç¼å¢é•¿ã€‚</p>
                
                <div class="mt-12 grid grid-cols-3 gap-4 max-w-sm mx-auto">
                    <div class="p-4 bg-white/5 rounded-xl border border-white/10"><p class="text-2xl font-bold text-white">50+</p><p class="text-xs text-indigo-300">æ”¯æŒå¸ç§</p></div>
                    <div class="p-4 bg-white/5 rounded-xl border border-white/10"><p class="text-2xl font-bold text-white">0s</p><p class="text-xs text-indigo-300">æé€Ÿå‘å¡</p></div>
                    <div class="p-4 bg-white/5 rounded-xl border border-white/10"><p class="text-2xl font-bold text-white">99%</p><p class="text-xs text-indigo-300">æ”¯ä»˜æˆåŠŸç‡</p></div>
                </div>
            </div>
        </div>

        <div class="w-full lg:w-1/2 bg-white flex items-center justify-center p-8">
            <div class="w-full max-w-md slide-up" id="auth-forms">
                
                <div id="login-form" class="space-y-6">
                    <div>
                        <h2 class="text-3xl font-bold text-slate-900">æ¬¢è¿å›æ¥</h2>
                        <p class="text-slate-500 mt-2">è¯·è¾“å…¥æ‚¨çš„è´¦å·ä»¥ç®¡ç†å¡ç‰‡èµ„äº§</p>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">ç”µå­é‚®ç®±</label>
                            <input type="email" id="login-email" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition" placeholder="user@demo.com" value="user@demo.com">
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <label class="block text-sm font-medium text-slate-700">å¯†ç </label>
                                <a href="#" class="text-xs text-indigo-600 hover:underline">å¿˜è®°å¯†ç ?</a>
                            </div>
                            <input type="password" id="login-pass" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" value="123456">
                        </div>
                    </div>
                    <button onclick="handleLogin()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 transition flex justify-center items-center gap-2">
                        <span id="login-btn-text">ç«‹å³ç™»å½•</span>
                        <svg id="login-loading" class="w-5 h-5 animate-spin hidden" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                    <p class="text-center text-sm text-slate-500">
                        è¿˜æ²¡æœ‰è´¦å·? <button onclick="switchAuthMode('register')" class="text-indigo-600 font-bold hover:underline">ç«‹å³å…è´¹æ³¨å†Œ</button>
                    </p>
                </div>

               <div id="register-form" class="space-y-5 hidden">
    <div>
        <h2 class="text-3xl font-bold text-slate-900">åˆ›å»ºè´¦æˆ·</h2>
        <p class="text-slate-500 mt-2">ä»…éœ€ 30 ç§’å³å¯å¼€å¯å…¨çƒæ”¯ä»˜ä¹‹æ—…</p>
    </div>

    <div class="bg-slate-100 p-1 rounded-xl flex">
        <button onclick="setRegisterType('personal')" id="type-btn-personal" class="flex-1 py-2 text-sm font-bold rounded-lg bg-white text-indigo-600 shadow-sm transition">ä¸ªäººè´¦æˆ·</button>
        <button onclick="setRegisterType('enterprise')" id="type-btn-enterprise" class="flex-1 py-2 text-sm font-bold rounded-lg text-slate-500 hover:text-slate-700 transition">ä¼ä¸šè´¦æˆ·</button>
    </div>

    <div class="space-y-4">
        <div id="enterprise-fields" class="hidden space-y-4 p-4 bg-slate-50 rounded-xl border border-slate-100">
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">ä¼ä¸šåç§°</label>
                <input type="text" id="reg-company-name" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white" placeholder="è¯·è¾“å…¥è¥ä¸šæ‰§ç…§ç™»è®°åç§°">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">ä¼ä¸šè§„æ¨¡</label>
                <select id="reg-company-size" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white appearance-none">
                    <option value="" disabled selected>è¯·é€‰æ‹©äººå‘˜è§„æ¨¡</option>
                    <option value="1-10">1-10 äºº (åˆåˆ›å›¢é˜Ÿ)</option>
                    <option value="11-50">11-50 äºº</option>
                    <option value="51-200">51-200 äºº</option>
                    <option value="200+">200 äººä»¥ä¸Š</option>
                </select>
            </div>
        </div>

        <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">ä¸»è¦ä½¿ç”¨åœºæ™¯ (å¿…é€‰)</label>
            <div class="relative">
                <select id="reg-usage" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none appearance-none bg-white">
                    <option value="" disabled selected>è¯·é€‰æ‹© VCC å¡ä¸»è¦ç”¨é€”</option>
                    <option value="ads">å¹¿å‘ŠæŠ•æ”¾ (Facebook/Google/TikTok)</option>
                    <option value="ai">AI è®¢é˜… (ChatGPT/Midjourney/Claude)</option>
                    <option value="ecommerce">ç”µå•†æµ·æ·˜/åº—ç¾¤ (Amazon/eBay/Shopify)</option>
                    <option value="cloud">äº‘æœåŠ¡/æœåŠ¡å™¨ (AWS/Google Cloud/Azure)</option>
                    <option value="travel">èˆªæ—…é¢„è®¢ (Booking/Agoda/Expedia)</option>
                    <option value="other">å…¶ä»–ç”¨é€”</option>
                </select>
                <svg class="w-4 h-4 text-slate-400 absolute right-4 top-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7" stroke-width="2"/></svg>
            </div>
        </div>

        <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">ç”µå­é‚®ç®±</label>
            <div class="flex gap-2">
                <input type="email" id="reg-email" class="flex-1 px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="æ‚¨çš„å¸¸ç”¨é‚®ç®±">
                <button class="px-4 py-2 bg-slate-100 text-slate-600 text-xs font-bold rounded-lg hover:bg-slate-200 whitespace-nowrap">å‘é€éªŒè¯ç </button>
            </div>
        </div>
        
        <div class="flex gap-4">
            <div class="w-1/3">
                <label class="block text-sm font-medium text-slate-700 mb-1">éªŒè¯ç </label>
                <input type="text" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="6ä½æ•°å­—">
            </div>
            <div class="flex-1">
                <label class="block text-sm font-medium text-slate-700 mb-1">è®¾ç½®å¯†ç </label>
                <input type="password" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="è‡³å°‘8ä½å­—ç¬¦">
            </div>
        </div>
    </div>

    <button onclick="handleRegister()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 transition mt-2">å®Œæˆæ³¨å†Œ</button>
    
    <p class="text-center text-sm text-slate-500">
        å·²æœ‰è´¦å·? <button onclick="switchAuthMode('login')" class="text-indigo-600 font-bold hover:underline">ç›´æ¥ç™»å½•</button>
    </p>
</div>

            </div>
        </div>
    </div>

    <div id="app-layout" class="w-full h-full flex hidden">
        <aside class="w-64 bg-white border-r border-slate-200 flex flex-col z-20 shadow-lg">
            <div class="p-6 flex items-center gap-3">
                <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold text-xl">V</div>
                <span class="text-xl font-bold text-slate-900 tracking-tight">VCC Pay</span>
            </div>

            <div class="px-4 mb-6">
                <div class="bg-slate-900 rounded-xl p-4 text-white">
                    <p class="text-xs text-slate-400 mb-1">æ€»èµ„äº§æŠ˜åˆ (USD)</p>
                    <h3 class="text-2xl font-bold mb-3">$<span id="nav-total-balance">12,450.80</span></h3>
                    <button onclick="showView('wallet')" class="w-full py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-xs font-semibold transition">ç«‹å³å……å€¼</button>
                </div>
            </div>

            <nav class="flex-1 px-2 space-y-1 overflow-y-auto">
                <a href="#" onclick="showView('dashboard')" class="nav-link active flex items-center gap-3 px-4 py-3 rounded-lg text-slate-600 hover:bg-slate-50 transition group">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" stroke-width="2"/></svg>
                    <span class="font-medium">ä»ªè¡¨ç›˜</span>
                </a>
                <a href="#" onclick="showView('cards')" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-slate-600 hover:bg-slate-50 transition group">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" stroke-width="2"/></svg>
                    <span class="font-medium">å¡ç‰‡ä¸­å¿ƒ</span>
                </a>
                <a href="#" onclick="showView('apply')" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-slate-600 hover:bg-slate-50 transition group">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4" stroke-width="2"/></svg>
                    <span class="font-medium">ç”³è¯·æ–°å¡</span>
                    <span class="ml-auto bg-rose-100 text-rose-600 text-[10px] px-2 py-0.5 rounded-full font-bold">Hot</span>
                </a>
                <a href="#" onclick="showView('wallet')" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-slate-600 hover:bg-slate-50 transition group">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" stroke-width="2"/></svg>
                    <span class="font-medium">èµ„é‡‘é’±åŒ…</span>
                </a>
                <a href="#" onclick="showView('transactions')" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-slate-600 hover:bg-slate-50 transition group">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" stroke-width="2"/></svg>
                    <span class="font-medium">äº¤æ˜“è®°å½•</span>
                </a>
            </nav>

            <div class="p-4 border-t border-slate-200">
                <button onclick="handleLogout()" class="flex items-center justify-between w-full px-3 py-2 hover:bg-red-50 hover:text-red-600 rounded-lg transition group">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 flex items-center justify-center text-white font-bold text-xs" id="user-avatar">U</div>
                        <div class="text-left">
                            <p class="text-sm font-bold text-slate-700 group-hover:text-red-600" id="user-name-display">User Demo</p>
                            <p class="text-[10px] text-green-600 flex items-center gap-1 group-hover:text-red-400">â— åœ¨çº¿</p>
                        </div>
                    </div>
                    <svg class="w-5 h-5 text-slate-400 group-hover:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" stroke-width="2"/></svg>
                </button>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto bg-[#f8fafc] relative">
            <header class="h-16 bg-white/80 backdrop-blur-md border-b border-slate-200 sticky top-0 z-10 px-8 flex items-center justify-between">
                <h2 id="page-title" class="text-xl font-bold text-slate-800">ä»ªè¡¨ç›˜</h2>
                <div class="flex items-center gap-4">
                    <button class="relative p-2 text-slate-500 hover:bg-slate-100 rounded-full transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" stroke-width="2"/></svg>
                        <span class="absolute top-1.5 right-1.5 w-2 h-2 bg-red-500 rounded-full border border-white"></span>
                    </button>
                </div>
            </header>

            <div id="content-area" class="p-8 max-w-7xl mx-auto pb-24"></div>
        </main>
    </div>

    <div id="modal-container"></div>

<script>
// ======================== æ ¸å¿ƒæ•°æ® ========================
const currentUser = {
    id: 'u_001',
    email: 'user@demo.com',
    balance: 2450.50, 
    cardBalance: 10000.30,
    kycLevel: 'L2'
};

const products = [
    { id: 1, name: 'Facebook å¹¿å‘Šè‡³å°Šå¡', bin: '485932', type: 'Visa', icon: 'ğŸ“¢', features: ['FaceBook/Google æ‹’ä»˜ç‡ä½', 'æ— é™å¼€å¡'], fee: 2.0, minRecharge: 10 },
    { id: 2, name: 'ChatGPT/AI è®¢é˜…å¡', bin: '531245', type: 'Mastercard', icon: 'ğŸ¤–', features: ['æ”¯æŒ OpenAI/Midjourney', 'ç¾å…ƒæœ¬å¸ç»“ç®—'], fee: 3.5, minRecharge: 20 },
    { id: 3, name: 'Amazon æµ·æ·˜è´­ç‰©å¡', bin: '428811', type: 'Visa', icon: 'ğŸ›’', features: ['æ”¯æŒ 3DS éªŒè¯', 'äºšé©¬é€Š/eBay ä¸“ç”¨'], fee: 1.0, minRecharge: 5 }
];

const myCards = [
    { id: 'c_1', name: 'FB Ads Main', number: '485932******4421', cvv: '***', exp: '12/26', balance: 450.20, status: 'active', type: 'Visa', product: 'Facebook å¹¿å‘Šè‡³å°Šå¡' },
    { id: 2, name: 'Midjourney Sub', number: '531245******8891', cvv: '***', exp: '08/25', balance: 20.00, status: 'active', type: 'Mastercard', product: 'ChatGPT/AI è®¢é˜…å¡' },
    { id: 3, name: 'Test Card', number: '428811******1122', cvv: '***', exp: '01/27', balance: 0.00, status: 'frozen', type: 'Visa', product: 'Amazon æµ·æ·˜è´­ç‰©å¡' }
];

const transactions = [
    { id: 'TX_001', merchant: 'FACEBOOK *ADS', amount: -45.00, date: '2025-11-20 14:30', status: 'success', card: '4421' },
    { id: 'TX_002', merchant: 'Wallet Deposit', amount: +1000.00, date: '2025-11-20 10:00', status: 'success', card: '-' },
    { id: 'TX_003', merchant: 'OPENAI *API', amount: -120.00, date: '2025-11-19 09:15', status: 'failed', card: '8891' },
    { id: 'TX_004', merchant: 'Card Recharge', amount: -200.00, date: '2025-11-18 16:20', status: 'success', card: 'Wallet -> Card' }
];

// ======================== è®¤è¯é€»è¾‘ (æ–°åŠŸèƒ½) ========================

// åˆ‡æ¢ç™»å½•/æ³¨å†Œè¡¨å•
function switchAuthMode(mode) {
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    
    if (mode === 'register') {
        loginForm.classList.add('hidden');
        registerForm.classList.remove('hidden');
    } else {
        registerForm.classList.add('hidden');
        loginForm.classList.remove('hidden');
    }
}

// å¤„ç†ç™»å½•
function handleLogin() {
    const email = document.getElementById('login-email').value;
    const btnText = document.getElementById('login-btn-text');
    const loading = document.getElementById('login-loading');
    
    if(!email) return alert('è¯·è¾“å…¥é‚®ç®±');

    // UI Loading
    btnText.innerText = 'ç™»å½•ä¸­...';
    loading.classList.remove('hidden');

    setTimeout(() => {
        // ç™»å½•æˆåŠŸï¼Œåˆ‡æ¢å¸ƒå±€
        document.getElementById('auth-layout').classList.add('hidden');
        document.getElementById('app-layout').classList.remove('hidden');
        
        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
        document.getElementById('user-name-display').innerText = email.split('@')[0];
        document.getElementById('user-avatar').innerText = email.charAt(0).toUpperCase();
        
        showView('dashboard');
        
        // é‡ç½®æŒ‰é’®
        btnText.innerText = 'ç«‹å³ç™»å½•';
        loading.classList.add('hidden');
    }, 1000);
}

// å¤„ç†æ³¨å†Œ
// ======================== è®¤è¯é€»è¾‘ (ä¿®æ”¹å) ========================

let currentRegType = 'personal'; // é»˜è®¤ä¸ºä¸ªäºº

// åˆ‡æ¢æ³¨å†Œç±»å‹ (æ–°åŠŸèƒ½)
function setRegisterType(type) {
    currentRegType = type;
    const personalBtn = document.getElementById('type-btn-personal');
    const enterpriseBtn = document.getElementById('type-btn-enterprise');
    const enterpriseFields = document.getElementById('enterprise-fields');

    if (type === 'personal') {
        // æ ·å¼åˆ‡æ¢
        personalBtn.className = "flex-1 py-2 text-sm font-bold rounded-lg bg-white text-indigo-600 shadow-sm transition";
        enterpriseBtn.className = "flex-1 py-2 text-sm font-bold rounded-lg text-slate-500 hover:text-slate-700 transition";
        // éšè—ä¼ä¸šå­—æ®µ
        enterpriseFields.classList.add('hidden');
    } else {
        // æ ·å¼åˆ‡æ¢
        enterpriseBtn.className = "flex-1 py-2 text-sm font-bold rounded-lg bg-white text-indigo-600 shadow-sm transition";
        personalBtn.className = "flex-1 py-2 text-sm font-bold rounded-lg text-slate-500 hover:text-slate-700 transition";
        // æ˜¾ç¤ºä¼ä¸šå­—æ®µ
        enterpriseFields.classList.remove('hidden');
        enterpriseFields.classList.add('fade-in'); // æ·»åŠ æ·¡å…¥åŠ¨ç”»
    }
}

// å¤„ç†æ³¨å†Œ (ä¿®æ”¹åï¼ŒåŒ…å«éªŒè¯)
function handleRegister() {
    const email = document.getElementById('reg-email').value;
    const usage = document.getElementById('reg-usage').value;
    
    // åŸºç¡€éªŒè¯
    if (!usage) return alert('è¯·é€‰æ‹©æ‚¨çš„ä¸»è¦ä½¿ç”¨åœºæ™¯');
    if (!email) return alert('è¯·è¾“å…¥ç”µå­é‚®ç®±');
    
    // ä¼ä¸šéªŒè¯
    if (currentRegType === 'enterprise') {
        const companyName = document.getElementById('reg-company-name').value;
        const companySize = document.getElementById('reg-company-size').value;
        if (!companyName) return alert('è¯·è¾“å…¥ä¼ä¸šåç§°');
        if (!companySize) return alert('è¯·é€‰æ‹©ä¼ä¸šè§„æ¨¡');
        
        alert(`æäº¤æˆåŠŸï¼\nç±»å‹: ä¼ä¸šè´¦æˆ·\nä¼ä¸š: ${companyName} (${companySize})\nåœºæ™¯: ${usage}\n\næˆ‘ä»¬å°†å‘ ${email} å‘é€æ¿€æ´»é“¾æ¥ã€‚`);
    } else {
        alert(`æäº¤æˆåŠŸï¼\nç±»å‹: ä¸ªäººè´¦æˆ·\nåœºæ™¯: ${usage}\n\næˆ‘ä»¬å°†å‘ ${email} å‘é€æ¿€æ´»é“¾æ¥ã€‚`);
    }

    switchAuthMode('login');
}

// å¤„ç†ç™»å‡º
function handleLogout() {
    if(confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        document.getElementById('app-layout').classList.add('hidden');
        document.getElementById('auth-layout').classList.remove('hidden');
        // é‡ç½®åˆ°ç™»å½•è¡¨å•
        switchAuthMode('login');
    }
}

// ======================== ä¸šåŠ¡è§†å›¾å®šä¹‰ ========================
const views = {
    dashboard: () => `
        <div class="fade-in space-y-8">
            <div class="grid grid-cols-3 gap-6">
                <div class="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-2xl p-6 text-white shadow-xl shadow-indigo-200 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2"></div>
                    <p class="text-indigo-200 text-sm font-medium mb-1">æ€»èµ„äº§ä¼°å€¼</p>
                    <h2 class="text-4xl font-bold mb-4">$${(currentUser.balance + currentUser.cardBalance).toLocaleString()}</h2>
                    <div class="flex gap-4 text-sm border-t border-white/20 pt-4">
                        <div><span class="text-indigo-200">é’±åŒ…ä½™é¢:</span> <span class="font-semibold">$${currentUser.balance.toLocaleString()}</span></div>
                        <div class="w-px bg-white/20"></div>
                        <div><span class="text-indigo-200">å¡å†…ä½™é¢:</span> <span class="font-semibold">$${currentUser.cardBalance.toLocaleString()}</span></div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm flex flex-col justify-between">
                    <div><p class="text-slate-500 text-sm font-medium mb-1">æŒæœ‰å¡ç‰‡</p><h2 class="text-3xl font-bold text-slate-800">${myCards.length} <span class="text-sm font-normal text-slate-400">å¼ </span></h2></div>
                    <div class="flex gap-2 mt-4">
                        <button onclick="showView('apply')" class="flex-1 py-2 bg-slate-900 text-white rounded-lg text-sm font-semibold hover:bg-slate-800 transition">ç”³è¯·æ–°å¡</button>
                        <button onclick="showView('cards')" class="flex-1 py-2 border border-slate-300 rounded-lg text-sm font-semibold hover:bg-slate-50 transition">ç®¡ç†å¡ç‰‡</button>
                    </div>
                </div>
                <div class="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm flex flex-col justify-between">
                    <div><p class="text-slate-500 text-sm font-medium mb-1">æœ¬æœˆæ”¯å‡º</p><h2 class="text-3xl font-bold text-slate-800">$3,420.50</h2><p class="text-xs text-green-600 mt-1 font-medium">â†“ 12% è¾ƒä¸Šæœˆ</p></div>
                </div>
            </div>
            <h3 class="text-lg font-bold text-slate-800">è¿‘æœŸæ´»è·ƒå¡ç‰‡</h3>
            <div class="grid grid-cols-3 gap-6">
                ${myCards.slice(0,3).map(card => `
                    <div class="glass-card rounded-xl border border-slate-200 p-5 hover:shadow-md transition cursor-pointer group" onclick="showCardDetails('${card.id}')">
                        <div class="flex justify-between items-start mb-4">
                            <div class="w-10 h-6 ${card.type === 'Visa' ? 'bg-blue-600' : 'bg-orange-500'} rounded flex items-center justify-center text-[10px] text-white font-bold italic tracking-wider">${card.type.toUpperCase()}</div>
                            <span class="text-xs font-bold px-2 py-1 rounded ${card.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${card.status === 'active' ? 'æ´»è·ƒ' : 'å†»ç»“'}</span>
                        </div>
                        <p class="text-slate-500 text-xs mb-1">${card.name}</p>
                        <p class="text-slate-800 font-mono font-bold text-lg tracking-wider mb-4">**** ${card.number.slice(-4)}</p>
                        <div class="flex justify-between items-end">
                            <div><p class="text-[10px] text-slate-400">ä½™é¢</p><p class="font-bold text-slate-700">$${card.balance.toFixed(2)}</p></div>
                            <button class="opacity-0 group-hover:opacity-100 transition px-3 py-1 bg-indigo-50 text-indigo-600 text-xs font-bold rounded">ç®¡ç†</button>
                        </div>
                    </div>`).join('')}
            </div>
        </div>`,

    apply: () => `
        <div class="fade-in space-y-6">
            <div class="text-center mb-8"><h2 class="text-2xl font-bold text-slate-800">é€‰æ‹©å¡ç‰‡äº§å“</h2><p class="text-slate-500 mt-2">æ ¹æ®æ‚¨çš„ä¸šåŠ¡åœºæ™¯é€‰æ‹©æœ€é€‚åˆçš„è™šæ‹Ÿå¡</p></div>
            <div class="grid grid-cols-3 gap-6">
                ${products.map(p => `
                    <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden hover:shadow-xl transition duration-300 group relative">
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 to-purple-500"></div>
                        <div class="p-6">
                            <div class="w-14 h-14 bg-slate-50 rounded-xl flex items-center justify-center text-3xl mb-4 shadow-sm group-hover:scale-110 transition">${p.icon}</div>
                            <h3 class="text-lg font-bold text-slate-800 mb-1">${p.name}</h3>
                            <div class="flex items-center gap-2 mb-4"><span class="text-xs font-bold px-2 py-0.5 bg-slate-100 text-slate-600 rounded">${p.type}</span><span class="text-xs font-mono text-slate-400">BIN: ${p.bin}</span></div>
                            <ul class="space-y-2 mb-6">${p.features.map(f => `<li class="text-sm text-slate-600 flex items-center gap-2"><svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-width="2"/></svg>${f}</li>`).join('')}</ul>
                            <div class="bg-slate-50 rounded-lg p-3 mb-6 border border-slate-100"><div class="flex justify-between text-xs mb-1"><span class="text-slate-500">å¼€å¡è´¹</span><span class="font-bold text-slate-800">$${p.fee}</span></div><div class="flex justify-between text-xs"><span class="text-slate-500">æœ€ä½å……å€¼</span><span class="font-bold text-slate-800">$${p.minRecharge}</span></div></div>
                            <button onclick="openCreateCardModal(${p.id})" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 transition transform group-hover:-translate-y-1">ç«‹å³å¼€é€š</button>
                        </div>
                    </div>`).join('')}
            </div>
        </div>`,

    cards: () => `
        <div class="fade-in space-y-6">
            <div class="flex justify-between items-center">
                <div class="flex gap-4"><button class="px-4 py-2 bg-white border border-slate-200 rounded-lg text-sm font-semibold shadow-sm text-indigo-600">å…¨éƒ¨å¡ç‰‡ (${myCards.length})</button></div>
                <div class="relative"><input type="text" placeholder="æœç´¢å¡å·..." class="pl-9 pr-4 py-2 border border-slate-200 rounded-lg text-sm w-64 focus:ring-2 focus:ring-indigo-500"><svg class="w-4 h-4 text-slate-400 absolute left-3 top-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-width="2"/></svg></div>
            </div>
            <div class="space-y-4">
                ${myCards.map(card => `
                    <div class="bg-white rounded-xl border border-slate-200 p-4 flex items-center justify-between hover:shadow-md transition group">
                        <div class="flex items-center gap-5">
                            <div class="w-16 h-10 ${card.type === 'Visa' ? 'visa-bg' : 'master-bg'} rounded-md flex items-center justify-center text-white font-bold italic text-xs shadow-sm">${card.type}</div>
                            <div>
                                <div class="flex items-center gap-2"><h4 class="font-bold text-slate-800">${card.name}</h4><span class="text-[10px] px-1.5 py-0.5 bg-slate-100 text-slate-500 rounded border border-slate-200">${card.product}</span></div>
                                <p class="text-sm text-slate-500 font-mono mt-0.5">${card.number} <span class="mx-2 text-slate-300">|</span> Exp: ${card.exp}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-10">
                            <div class="text-right"><p class="text-xs text-slate-400 uppercase font-bold">ä½™é¢</p><p class="text-lg font-bold text-slate-800">$${card.balance.toFixed(2)}</p></div>
                            <div class="text-right"><p class="text-xs text-slate-400 uppercase font-bold">çŠ¶æ€</p><span class="text-sm font-bold ${card.status === 'active' ? 'text-green-600' : 'text-red-500'} flex items-center justify-end gap-1"><span class="w-2 h-2 rounded-full ${card.status === 'active' ? 'bg-green-500' : 'bg-red-500'}"></span>${card.status === 'active' ? 'æ­£å¸¸' : 'å†»ç»“'}</span></div>
                            <div class="flex gap-2">
                                <button onclick="openRechargeCardModal('${card.id}')" class="px-4 py-2 bg-indigo-50 text-indigo-600 rounded-lg text-sm font-bold hover:bg-indigo-100 transition">å……å€¼</button>
                                <button onclick="showCardDetails('${card.id}')" class="px-4 py-2 border border-slate-200 text-slate-600 rounded-lg text-sm font-bold hover:bg-slate-50 transition">è¯¦æƒ…</button>
                            </div>
                        </div>
                    </div>`).join('')}
            </div>
        </div>`,

    wallet: () => `
        <div class="fade-in space-y-6">
            <div class="grid grid-cols-2 gap-6">
                <div class="bg-slate-900 rounded-2xl p-8 text-white relative overflow-hidden">
                    <div class="absolute -right-10 -top-10 w-40 h-40 bg-indigo-500 rounded-full blur-3xl opacity-20"></div>
                    <p class="text-slate-400 text-sm font-medium mb-2">é’±åŒ…å¯ç”¨ä½™é¢</p>
                    <h2 class="text-5xl font-bold mb-8">$${currentUser.balance.toLocaleString()}</h2>
                    <div class="flex gap-4">
                        <button onclick="openDepositModal()" class="px-6 py-3 bg-indigo-600 hover:bg-indigo-500 rounded-xl font-bold transition flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4" stroke-width="2"/></svg>å……å€¼ (Deposit)</button>
                        <button onclick="openTransferModal()" class="px-6 py-3 bg-white/10 hover:bg-white/20 rounded-xl font-bold transition">å†…éƒ¨åˆ’è½¬ (Card â†’ Wallet)</button>
                    </div>
                </div>
                <div class="bg-white rounded-2xl border border-slate-200 p-6">
                    <h3 class="font-bold text-slate-800 mb-4">å¿«é€Ÿé€šé“</h3>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition">
                            <div class="flex items-center gap-3"><div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-green-600 text-xl font-bold">T</div><div><p class="font-bold text-slate-700">USDT-TRC20</p><p class="text-xs text-slate-500">é¢„è®¡ 3 åˆ†é’Ÿåˆ°è´¦</p></div></div><svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-width="2"/></svg>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition">
                            <div class="flex items-center gap-3"><div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 text-xl font-bold">E</div><div><p class="font-bold text-slate-700">USDT-ERC20</p><p class="text-xs text-slate-500">å¤§é¢å……å€¼æ¨è</p></div></div><svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-width="2"/></svg>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-2xl border border-slate-200 p-6"><h3 class="font-bold text-slate-800 mb-4">èµ„é‡‘æ˜ç»†</h3><p class="text-sm text-slate-500 italic">æš‚æ— æ›´å¤šæ˜ç»†...</p></div>
        </div>`,

    transactions: () => `
        <div class="fade-in space-y-6">
            <h2 class="text-xl font-bold text-slate-800">äº¤æ˜“è®°å½•</h2>
            <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 border-b border-slate-100"><tr><th class="px-6 py-3">å•†æˆ·/è¯´æ˜</th><th class="px-6 py-3">å¡ç‰‡</th><th class="px-6 py-3 text-right">é‡‘é¢</th></tr></thead>
                    <tbody class="divide-y divide-slate-100">
                        ${transactions.map(t => `
                            <tr class="hover:bg-slate-50">
                                <td class="px-6 py-4"><p class="font-bold text-slate-700">${t.merchant}</p><p class="text-xs text-slate-400">${t.date}</p></td>
                                <td class="px-6 py-4">${t.card !== '-' ? `<span class="px-2 py-1 bg-slate-100 rounded text-xs font-mono text-slate-600">${t.card}</span>` : '-'}</td>
                                <td class="px-6 py-4 text-right"><span class="font-bold ${t.amount > 0 ? 'text-green-600' : 'text-slate-800'}">${t.amount > 0 ? '+' : ''}$${Math.abs(t.amount).toFixed(2)}</span><p class="text-[10px] ${t.status === 'success' ? 'text-green-500' : 'text-red-500'}">${t.status.toUpperCase()}</p></td>
                            </tr>`).join('')}
                    </tbody>
                </table>
            </div>
        </div>`
};

// ======================== å…¨å±€äº¤äº’é€»è¾‘ ========================

function showView(viewName) {
    const container = document.getElementById('content-area');
    const title = document.getElementById('page-title');
    document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
    event?.currentTarget?.classList.add('active');
    if (views[viewName]) {
        container.innerHTML = views[viewName]();
        const titles = { dashboard: 'ä»ªè¡¨ç›˜', cards: 'å¡ç‰‡ä¸­å¿ƒ', apply: 'ç”³è¯·æ–°å¡', wallet: 'èµ„é‡‘é’±åŒ…', transactions: 'äº¤æ˜“è®°å½•' };
        title.innerText = titles[viewName];
    }
}

function closeModal() {
    document.getElementById('modal-container').innerHTML = '';
}

// --- å¼€å¡ ---
function openCreateCardModal(productId) {
    const product = products.find(p => p.id === productId);
    const modalHTML = `
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center fade-in" id="modal-overlay">
            <div class="bg-white rounded-2xl w-full max-w-md overflow-hidden shadow-2xl transform transition-all">
                <div class="bg-slate-50 px-6 py-4 border-b border-slate-200 flex justify-between items-center"><h3 class="font-bold text-slate-800">å¼€é€šè™šæ‹Ÿå¡</h3><button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 text-2xl">Ã—</button></div>
                <div class="p-6 space-y-4">
                    <div class="flex items-center gap-3 mb-4"><div class="text-3xl">${product.icon}</div><div><p class="font-bold text-slate-800">${product.name}</p><p class="text-xs text-slate-500">${product.type} â€¢ BIN ${product.bin}</p></div></div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">å……å€¼é‡‘é¢ (æœ€ä½ $${product.minRecharge})</label><div class="relative"><span class="absolute left-3 top-2 text-slate-500">$</span><input type="number" id="open-amount" class="w-full border border-slate-300 rounded-lg pl-6 pr-3 py-2 text-sm font-bold text-slate-800" value="${product.minRecharge}"></div></div>
                    <div class="bg-indigo-50 rounded-lg p-3 text-xs space-y-1"><div class="flex justify-between"><span class="text-slate-500">å¼€å¡è´¹</span><span class="font-bold text-slate-700">$${product.fee}</span></div><div class="flex justify-between"><span class="text-slate-500">é¢„è®¡æ‰£æ¬¾</span><span class="font-bold text-indigo-600" id="total-deduct">$${(product.minRecharge + product.fee).toFixed(2)}</span></div></div>
                    <button onclick="processOpenCard()" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition shadow-md">ç¡®è®¤æ”¯ä»˜å¹¶å¼€å¡</button>
                </div>
            </div>
        </div>`;
    document.getElementById('modal-container').innerHTML = modalHTML;
}

function processOpenCard() {
    event.target.innerText = 'å¼€å¡ä¸­...';
    setTimeout(() => {
        closeModal();
        alert('ğŸ‰ å¼€å¡æˆåŠŸï¼æ‚¨çš„æ–°å¡å·²ç”Ÿæˆã€‚');
        showView('cards');
    }, 1000);
}

// --- å……å€¼ (Wallet -> Card) ---
function openRechargeCardModal(cardId) {
    const card = myCards.find(c => c.id == cardId);
    if (!card) return;
    const modalHTML = `
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center fade-in" id="modal-overlay">
            <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden">
                <div class="bg-indigo-600 px-6 py-4 flex justify-between items-center"><h3 class="font-bold text-white">å¡ç‰‡èµ„é‡‘åˆ’è½¬</h3><button onclick="closeModal()" class="text-white/80 hover:text-white text-xl">Ã—</button></div>
                <div class="p-6 space-y-6">
                    <div class="flex items-center gap-3 bg-slate-50 p-3 rounded-lg border border-slate-200">
                        <div class="w-10 h-6 ${card.type === 'Visa' ? 'bg-blue-600' : 'bg-orange-500'} rounded flex items-center justify-center text-[10px] text-white font-bold italic">${card.type.toUpperCase()}</div>
                        <div><p class="text-xs text-slate-500 font-bold">${card.name}</p><p class="text-xs text-slate-400 font-mono">**** ${card.number.slice(-4)}</p></div>
                        <div class="ml-auto text-right"><p class="text-[10px] text-slate-400">å½“å‰ä½™é¢</p><p class="text-sm font-bold text-slate-700">$${card.balance.toFixed(2)}</p></div>
                    </div>
                    <div>
                        <div class="flex justify-between text-xs mb-2"><span class="font-bold text-slate-700">åˆ’è½¬é‡‘é¢ (USD)</span><span class="text-indigo-600 cursor-pointer hover:underline" onclick="document.getElementById('recharge-input').value = currentUser.balance">é’±åŒ…å¯ç”¨: $${currentUser.balance.toLocaleString()}</span></div>
                        <div class="relative"><span class="absolute left-3 top-2.5 text-slate-500 font-bold">$</span><input type="number" id="recharge-input" class="w-full border-2 border-indigo-100 rounded-xl pl-8 pr-4 py-2 text-lg font-bold text-slate-800 focus:border-indigo-500 focus:ring-0 outline-none transition" placeholder="0.00"></div>
                    </div>
                    <button onclick="confirmRecharge('${card.id}')" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 transition">ç¡®è®¤åˆ’è½¬</button>
                </div>
            </div>
        </div>`;
    document.getElementById('modal-container').innerHTML = modalHTML;
}

function confirmRecharge(cardId) {
    const amount = parseFloat(document.getElementById('recharge-input').value);
    if (!amount || amount <= 0) return alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å……å€¼é‡‘é¢');
    if (amount > currentUser.balance) return alert('é’±åŒ…ä½™é¢ä¸è¶³');
    
    currentUser.balance -= amount;
    const card = myCards.find(c => c.id == cardId);
    card.balance += amount;
    currentUser.cardBalance += amount;
    
    transactions.unshift({ id: 'TX_' + Date.now(), merchant: 'èµ„é‡‘åˆ’è½¬ (Wallet to Card)', amount: -amount, date: new Date().toLocaleString(), status: 'success', card: card.number.slice(-4) });
    
    closeModal();
    document.getElementById('nav-total-balance').innerText = (currentUser.balance + currentUser.cardBalance).toLocaleString();
    showView('cards');
    setTimeout(() => alert(`âœ… å……å€¼æˆåŠŸï¼å·²åˆ’è½¬ $${amount} è‡³å¡ç‰‡ ${card.name}`), 100);
}

// --- æç° (Card -> Wallet) ---
function openTransferModal() {
    const activeCards = myCards.filter(c => c.balance > 0);
    const cardOptions = activeCards.length > 0 ? activeCards.map(c => `<option value="${c.id}">${c.name} (ä½™é¢: $${c.balance.toFixed(2)})</option>`).join('') : '<option value="" disabled selected>æ— å¯ç”¨ä½™é¢å¡ç‰‡</option>';
    const modalHTML = `
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center fade-in" id="modal-overlay">
            <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden">
                <div class="bg-slate-900 px-6 py-4 flex justify-between items-center"><h3 class="font-bold text-white">èµ„é‡‘å›åˆ’ (Withdraw)</h3><button onclick="closeModal()" class="text-white/80 hover:text-white text-xl">Ã—</button></div>
                <div class="p-6 space-y-5">
                    <div class="flex items-center justify-between px-4 py-3 bg-slate-50 rounded-xl border border-slate-200">
                        <div class="text-center"><p class="text-[10px] text-slate-400 uppercase font-bold mb-1">FROM</p><div class="w-8 h-8 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" stroke-width="2"/></svg></div><p class="text-xs font-bold text-slate-700 mt-1">è™šæ‹Ÿå¡ç‰‡</p></div>
                        <div class="flex-1 flex justify-center"><svg class="w-6 h-6 text-slate-300 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17 8l4 4m0 0l-4 4m4-4H3" stroke-width="2"/></svg></div>
                        <div class="text-center"><p class="text-[10px] text-slate-400 uppercase font-bold mb-1">TO</p><div class="w-8 h-8 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" stroke-width="2"/></svg></div><p class="text-xs font-bold text-slate-700 mt-1">èµ„é‡‘é’±åŒ…</p></div>
                    </div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">é€‰æ‹©è½¬å‡ºå¡ç‰‡</label><select id="transfer-card-select" onchange="updateMaxTransfer()" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm bg-white">${cardOptions}</select></div>
                    <div><div class="flex justify-between text-xs mb-1"><span class="font-bold text-slate-500">åˆ’è½¬é‡‘é¢</span><span class="text-indigo-600 cursor-pointer hover:underline" id="max-transfer-hint" onclick="fillMaxTransfer()"></span></div><div class="relative"><span class="absolute left-3 top-2.5 text-slate-500 font-bold">$</span><input type="number" id="transfer-amount" class="w-full border-2 border-slate-200 rounded-xl pl-8 pr-4 py-2 text-lg font-bold text-slate-800 focus:border-slate-500 focus:ring-0 outline-none transition" placeholder="0.00"></div></div>
                    <button onclick="confirmTransfer()" class="w-full py-3 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-bold shadow-lg transition">ç¡®è®¤å›åˆ’èµ„é‡‘</button>
                </div>
            </div>
        </div>`;
    document.getElementById('modal-container').innerHTML = modalHTML;
    if(activeCards.length > 0) updateMaxTransfer();
}

function updateMaxTransfer() {
    const cardId = document.getElementById('transfer-card-select').value;
    const card = myCards.find(c => c.id == cardId);
    if (card) document.getElementById('max-transfer-hint').innerText = `æœ€å¤§å¯è½¬: $${card.balance.toFixed(2)}`;
}

function fillMaxTransfer() {
    const cardId = document.getElementById('transfer-card-select').value;
    const card = myCards.find(c => c.id == cardId);
    if (card) document.getElementById('transfer-amount').value = card.balance;
}

function confirmTransfer() {
    const cardId = document.getElementById('transfer-card-select').value;
    const amount = parseFloat(document.getElementById('transfer-amount').value);
    const card = myCards.find(c => c.id == cardId);
    
    if (!card) return alert('è¯·é€‰æ‹©å¡ç‰‡');
    if (!amount || amount <= 0) return alert('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢');
    if (amount > card.balance) return alert('å¡ç‰‡ä½™é¢ä¸è¶³');

    card.balance -= amount;
    currentUser.balance += amount;
    currentUser.cardBalance -= amount;

    transactions.unshift({ id: 'TX_' + Date.now(), merchant: 'èµ„é‡‘å›åˆ’ (Card -> Wallet)', amount: +amount, date: new Date().toLocaleString(), status: 'success', card: card.number.slice(-4) });

    closeModal();
    document.getElementById('nav-total-balance').innerText = (currentUser.balance + currentUser.cardBalance).toLocaleString();
    showView('wallet');
    setTimeout(() => alert(`âœ… åˆ’è½¬æˆåŠŸï¼\n$${amount} å·²å›åˆ°æ‚¨çš„èµ„é‡‘é’±åŒ…ã€‚`), 100);
}

function showCardDetails(cardId) {
    const card = myCards.find(c => c.id == cardId);
    const modalHTML = `
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center fade-in" id="modal-overlay">
            <div class="bg-white rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden flex">
                <div class="w-1/2 bg-slate-900 p-8 flex items-center justify-center relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-indigo-500 rounded-full blur-3xl opacity-20 -translate-y-1/2 translate-x-1/2"></div>
                    <div class="w-full aspect-[1.58/1] rounded-xl ${card.type === 'Visa' ? 'visa-bg' : 'master-bg'} p-6 text-white shadow-2xl relative flex flex-col justify-between">
                        <div class="flex justify-between items-start"><span class="font-bold italic tracking-wider opacity-80">${card.type.toUpperCase()}</span><span class="text-xs bg-white/20 px-2 py-1 rounded">${card.product}</span></div>
                        <div class="font-mono text-xl tracking-widest drop-shadow-md">${card.number}</div>
                        <div class="flex justify-between items-end"><div><p class="text-[10px] opacity-60 uppercase">Card Holder</p><p class="text-sm font-medium">USER DEMO</p></div><div><p class="text-[10px] opacity-60 uppercase">Expires</p><p class="text-sm font-mono">${card.exp}</p></div></div>
                    </div>
                </div>
                <div class="w-1/2 p-8">
                    <div class="flex justify-between items-start mb-6"><div><h3 class="text-xl font-bold text-slate-800">${card.name}</h3><p class="text-xs text-slate-500">ID: ${card.id}</p></div><button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 text-2xl">Ã—</button></div>
                    <div class="space-y-4 mb-8">
                        <div class="flex justify-between py-2 border-b border-slate-100"><span class="text-sm text-slate-500">å¡ç‰‡çŠ¶æ€</span><span class="text-sm font-bold text-green-600">â— æ­£å¸¸æ´»è·ƒ</span></div>
                        <div class="flex justify-between py-2 border-b border-slate-100"><span class="text-sm text-slate-500">å½“å‰ä½™é¢</span><span class="text-xl font-bold text-slate-800">$${card.balance.toFixed(2)}</span></div>
                        <div class="flex justify-between py-2 border-b border-slate-100 items-center"><span class="text-sm text-slate-500">å®‰å…¨ç  (CVV)</span><div class="flex items-center gap-2"><span class="font-mono font-bold bg-slate-100 px-2 rounded">***</span><button class="text-xs text-indigo-600 font-bold hover:underline">ç‚¹å‡»æŸ¥çœ‹</button></div></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="closeModal(); openRechargeCardModal('${card.id}')" class="py-2 bg-indigo-600 text-white rounded-lg font-bold text-sm hover:bg-indigo-700">ç«‹å³å……å€¼</button>
                        <button class="py-2 border border-slate-200 text-slate-700 rounded-lg font-bold text-sm hover:bg-slate-50">å†»ç»“å¡ç‰‡</button>
                    </div>
                </div>
            </div>
        </div>`;
    document.getElementById('modal-container').innerHTML = modalHTML;
}

function openDepositModal() {
    document.getElementById('modal-container').innerHTML = `<div class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center fade-in"><div class="bg-white rounded-2xl w-full max-w-md shadow-2xl p-6 text-center"><h3 class="font-bold text-xl text-slate-800 mb-2">å……å€¼ USDT (TRC20)</h3><p class="text-sm text-slate-500 mb-6">ä»…æ”¯æŒ TRC20 é“¾</p><div class="bg-white border-2 border-slate-100 p-2 inline-block rounded-xl mb-6"><img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=TRX_ADDRESS_DEMO_123" alt="QR"></div><div class="bg-slate-50 border border-slate-200 rounded-lg p-3 mb-6 flex items-center justify-between"><p class="font-mono text-xs text-slate-600 truncate w-64">TVJ2xxxxxxxxxxxxxxxxxxxxxx8812</p><button class="text-indigo-600 text-xs font-bold hover:underline">å¤åˆ¶</button></div><button onclick="closeModal()" class="w-full py-3 border border-slate-300 text-slate-700 rounded-xl font-bold hover:bg-slate-50">å…³é—­</button></div></div>`;
}

// åˆå§‹åŒ–: é»˜è®¤æ˜¾ç¤ºç™»å½•é¡µ (ä¸è‡ªåŠ¨è¿›å…¥ Dashboard)
// window.addEventListener('load', () => { showView('dashboard'); }); // æ—§é€»è¾‘
</script>
<script>
{
    // --- 1. å®šä¹‰å˜é‡ (é˜²å†²çª) ---
    let newRegisteredEmail = ""; 
    let newRegisteredType = ""; 
    let currentRegType = 'personal';
    let kycState = { type: 'personal', region: '' };

    const kycRegions = [
        { code: 'CN', name: 'ä¸­å›½å¤§é™† (China)', flag: 'ğŸ‡¨ğŸ‡³' }, { code: 'HK', name: 'ä¸­å›½é¦™æ¸¯ (Hong Kong)', flag: 'ğŸ‡­ğŸ‡°' },
        { code: 'SG', name: 'æ–°åŠ å¡ (Singapore)', flag: 'ğŸ‡¸ğŸ‡¬' }, { code: 'VN', name: 'è¶Šå— (Vietnam)', flag: 'ğŸ‡»ğŸ‡³' },
        { code: 'ID', name: 'å°åº¦å°¼è¥¿äºš (Indonesia)', flag: 'ğŸ‡®ğŸ‡©' }, { code: 'TH', name: 'æ³°å›½ (Thailand)', flag: 'ğŸ‡¹ğŸ‡­' }
    ];

    // --- 2. èµ„æ–™é…ç½®æ¸…å• ---
    const kycRequirements = {
        personal: {
            common: [{ id: 'idImg', label: 'æŠ¤ç…§/èº«ä»½è¯æ­£é¢', type: 'file' }],
            CN: [{ section: 'å®åä¿¡æ¯' }, { id: 'realName', label: 'çœŸå®å§“å', type: 'text' }, { id: 'idNo', label: 'èº«ä»½è¯å·', type: 'text' }, { id: 'idFront', label: 'èº«ä»½è¯äººåƒé¢', type: 'file' }, { id: 'idBack', label: 'èº«ä»½è¯å›½å¾½é¢', type: 'file' }, { section: 'ç»“ç®—è´¦æˆ·' }, { id: 'bankCard', label: 'æœ¬äººé“¶è¡Œå¡å·', type: 'text' }],
            HK: [{ section: 'Identity' }, { id: 'realName', label: 'Legal Name', type: 'text' }, { id: 'hkid', label: 'HKID Number', type: 'text' }, { id: 'hkidImg', label: 'HKID Photo', type: 'file' }, { section: 'Proof' }, { id: 'poa', label: 'Address Proof', type: 'file' }],
            SG: [{ section: 'Identity' }, { id: 'realName', label: 'Full Name', type: 'text' }, { id: 'nric', label: 'NRIC / FIN', type: 'text' }, { id: 'nricImg', label: 'IC Front & Back', type: 'file' }, { id: 'poa', label: 'Proof of Address', type: 'file' }],
            VN: [{ section: 'XÃ¡c minh' }, { id: 'name', label: 'Há» vÃ  tÃªn', type: 'text' }, { id: 'cccd', label: 'CCCD / CMND', type: 'file' }, { id: 'selfie', label: 'Selfie with ID', type: 'file' }],
            TH: [{ section: 'Identity' }, { id: 'name', label: 'Full Name', type: 'text' }, { id: 'passport', label: 'Thai ID', type: 'file' }, { id: 'selfie', label: 'Selfie holding ID', type: 'file' }],
            ID: [{ section: 'Identitas' }, { id: 'name', label: 'Nama Lengkap', type: 'text' }, { id: 'ktp', label: 'KTP', type: 'file' }, { id: 'selfie', label: 'Selfie dengan KTP', type: 'file' }]
        },
        enterprise: {
            CN: [{ section: 'ä¼ä¸šä¿¡æ¯' }, { id: 'companyName', label: 'ä¼ä¸šåç§°', type: 'text' }, { id: 'regAddress', label: 'æ³¨å†Œåœ°å€', type: 'text' }, { id: 'licenseImg', label: 'è¥ä¸šæ‰§ç…§', type: 'file' }, { section: 'æ³•äººä¿¡æ¯' }, { id: 'legalName', label: 'æ³•äººå§“å', type: 'text' }, { id: 'legalIdImg', label: 'æ³•äººè¯ä»¶', type: 'file' }, { section: 'åˆè§„ææ–™' }, { id: 'financials', label: 'ç»è¥è¯æ˜ææ–™', type: 'file', multiple: true }],
            HK: [{ section: 'Company' }, { id: 'companyName', label: 'Company Name', type: 'text' }, { id: 'ciImg', label: 'CI (æ³¨å†Œè¯ä¹¦)', type: 'file' }, { id: 'brImg', label: 'BR (å•†ä¸šç™»è®°)', type: 'file' }, { id: 'director', label: 'Director ID', type: 'file' }],
            SG: [{ section: 'ACRA' }, { id: 'companyName', label: 'Company Name', type: 'text' }, { id: 'bizProfile', label: 'ACRA Biz Profile', type: 'file' }, { id: 'constitution', label: 'Constitution', type: 'file' }],
            VN: [{ section: 'Doanh nghiá»‡p' }, { id: 'erc', label: 'ERC License', type: 'file' }, { id: 'tax', label: 'Tax Registration', type: 'file' }],
            ID: [{ section: 'Legal' }, { id: 'nib', label: 'NIB Document', type: 'file' }, { id: 'npwp', label: 'NPWP Card', type: 'file' }],
            TH: [{ section: 'Corporate' }, { id: 'dbd', label: 'DBD Affidavit', type: 'file' }, { id: 'vat', label: 'VAT (P.P.20)', type: 'file' }]
        }
    };

    // --- 3. æ ¸å¿ƒè§†å›¾é€»è¾‘ (å«å®¡æ ¸ä¸­çŠ¶æ€) ---
    views.kyc = () => {
        // === åœºæ™¯ A: æ­£åœ¨å®¡æ ¸ä¸­ (Pending) ===
        if (currentUser.kycLevel === 'L1_Pending') {
            return `
            <div class="max-w-2xl mx-auto fade-in pt-10 text-center">
                <div class="bg-white rounded-2xl border border-slate-200 shadow-xl p-10 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-yellow-400 to-orange-500"></div>
                    
                    <div class="w-24 h-24 bg-orange-50 rounded-full flex items-center justify-center mx-auto mb-6 animate-pulse">
                        <svg class="w-12 h-12 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2"/></svg>
                    </div>
                    
                    <h2 class="text-2xl font-bold text-slate-900 mb-2">èµ„æ–™å®¡æ ¸ä¸­</h2>
                    <p class="text-slate-500 mb-8">æ‚¨çš„${currentUser.kycAccountType === 'enterprise' ? 'ä¼ä¸š' : 'ä¸ªäºº'}è®¤è¯ç”³è¯·å·²æäº¤ï¼Œåˆè§„å›¢é˜Ÿæ­£åœ¨åŠ æ€¥å¤„ç†ã€‚</p>
                    
                    <div class="flex items-center justify-center gap-2 mb-10">
                        <div class="flex flex-col items-center gap-2"><div class="w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center text-xs font-bold">âœ“</div><span class="text-xs font-bold text-slate-700">æäº¤èµ„æ–™</span></div>
                        <div class="w-16 h-0.5 bg-green-500 mb-6"></div>
                        <div class="flex flex-col items-center gap-2"><div class="w-8 h-8 rounded-full bg-orange-500 text-white flex items-center justify-center text-xs font-bold animate-bounce">â—</div><span class="text-xs font-bold text-orange-600">å®¡æ ¸ä¸­</span></div>
                        <div class="w-16 h-0.5 bg-slate-200 mb-6"></div>
                        <div class="flex flex-col items-center gap-2"><div class="w-8 h-8 rounded-full bg-slate-100 text-slate-300 flex items-center justify-center text-xs font-bold">3</div><span class="text-xs font-bold text-slate-400">å®Œæˆ</span></div>
                    </div>

                    <div class="bg-slate-50 rounded-xl p-4 text-left text-sm text-slate-600 space-y-2 mb-6">
                        <p>â€¢ é¢„è®¡å®¡æ ¸æ—¶é—´ï¼š<span class="font-bold text-slate-800">1-24 å°æ—¶</span></p>
                        <p>â€¢ å®¡æ ¸ç»“æœå°†å‘é€è‡³ï¼š<span class="font-bold text-slate-800">${currentUser.email}</span></p>
                    </div>
                    
                    <button onclick="showView('dashboard')" class="text-indigo-600 font-bold hover:underline text-sm">è¿”å›ä»ªè¡¨ç›˜ (æµè§ˆæ¨¡å¼)</button>
                </div>
            </div>`;
        }

        // === åœºæ™¯ B: æœªè®¤è¯ï¼Œå¡«å†™è¡¨å• ===
        const lockedType = currentUser.kycAccountType;
        if (lockedType) kycState.type = lockedType; // é”å®šç±»å‹

        let typeSwitcherHTML = '';
        if (lockedType === 'personal') {
            typeSwitcherHTML = `<div class="bg-indigo-50 border border-indigo-100 p-3 rounded-xl text-center mb-4"><p class="text-indigo-700 font-bold text-sm">ğŸ‘¤ å½“å‰ä¸ºä¸ªäººè´¦æˆ·è®¤è¯é€šé“</p></div>`;
        } else if (lockedType === 'enterprise') {
             typeSwitcherHTML = `<div class="bg-indigo-50 border border-indigo-100 p-3 rounded-xl text-center mb-4"><p class="text-indigo-700 font-bold text-sm">ğŸ¢ å½“å‰ä¸ºä¼ä¸šè´¦æˆ·è®¤è¯é€šé“</p></div>`;
        } else {
            typeSwitcherHTML = `<div class="bg-slate-100 p-1 rounded-xl flex text-sm"><button onclick="setKycType('personal')" id="kyc-type-personal" class="flex-1 py-2 bg-white shadow-sm text-indigo-600 font-bold rounded-lg transition border border-slate-100">ä¸ªäººè®¤è¯</button><button onclick="setKycType('enterprise')" id="kyc-type-enterprise" class="flex-1 py-2 text-slate-500 hover:text-slate-700 font-medium transition">ä¼ä¸šè®¤è¯</button></div>`;
        }

        return `
        <div class="max-w-4xl mx-auto fade-in pb-20">
            <div class="mb-8 text-center">
                <div class="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">ğŸ›¡ï¸</div>
                <h2 class="text-2xl font-bold text-slate-900">èº«ä»½åˆè§„è®¤è¯</h2>
                <p class="text-slate-500 mt-2 max-w-lg mx-auto">è¯·å®Œå–„æ‚¨çš„${lockedType === 'enterprise' ? 'ä¼ä¸š' : 'ä¸ªäºº'}èµ„æ–™ä»¥è§£é”å®Œæ•´åŠŸèƒ½</p>
            </div>
            <div class="flex flex-col md:flex-row gap-8">
                <div class="w-full md:w-1/3 space-y-6">
                    ${typeSwitcherHTML}
                    <div class="bg-white rounded-xl border border-slate-200 p-4 shadow-sm">
                        <h3 class="text-xs font-bold text-slate-400 uppercase mb-3">é€‰æ‹©æ‰€å±åœ°åŒº (Region)</h3>
                        <div class="grid grid-cols-2 gap-2">${kycRegions.map(r => `<div onclick="setKycRegion('${r.code}')" data-code="${r.code}" class="region-card cursor-pointer border border-slate-100 rounded-lg p-2 hover:bg-slate-50 transition flex flex-col items-center justify-center text-center gap-1 h-20"><span class="text-2xl">${r.flag}</span><span class="text-[10px] font-bold text-slate-700 leading-tight">${r.name.split(' ')[0]}</span></div>`).join('')}</div>
                    </div>
                </div>
                <div class="flex-1">
                    <div class="bg-white rounded-2xl border border-slate-200 shadow-xl p-6 md:p-8 relative overflow-hidden">
                        <div id="kyc-dynamic-form" class="relative z-10">
                            <div class="text-center py-10 text-slate-400 flex flex-col items-center"><svg class="w-10 h-10 mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2"/></svg><span>è¯·å…ˆåœ¨å·¦ä¾§é€‰æ‹©æ‚¨çš„åœ°åŒº</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
    };

    // --- 4. é€»è¾‘å‡½æ•° ---

    // æäº¤ KYCï¼šå˜ä¸ºå®¡æ ¸çŠ¶æ€
    window.handleKycSubmit = function() {
        if (!kycState.region) return alert('è¯·é€‰æ‹©åœ°åŒº');
        const btn = event.currentTarget;
        btn.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
        setTimeout(() => {
            // æ ¸å¿ƒï¼šæ”¹å˜çŠ¶æ€ä¸º Pending
            currentUser.kycLevel = 'L1_Pending'; 
            // åˆ·æ–°è§†å›¾ï¼Œè¿™ä¼šè§¦å‘ views.kyc ä¸­çš„ "å®¡æ ¸ä¸­" ç•Œé¢
            showView('kyc'); 
            alert('âœ… æäº¤æˆåŠŸï¼è¿›å…¥äººå·¥å®¡æ ¸æµç¨‹ã€‚');
        }, 1500);
    }

    window.handleRegister = function() {
        const email = document.getElementById('reg-email').value;
        const usage = document.getElementById('reg-usage').value;
        if (!usage) return alert('è¯·é€‰æ‹©ä½¿ç”¨åœºæ™¯');
        if (!email) return alert('è¯·è¾“å…¥é‚®ç®±');
        
        if (currentRegType === 'enterprise') {
            if (!document.getElementById('reg-company-name').value) return alert('è¯·è¾“å…¥ä¼ä¸šåç§°');
            newRegisteredType = 'enterprise'; 
            alert(`ä¼ä¸šè´¦å·æ³¨å†Œå·²æäº¤ï¼è¯·ç™»å½• ${email} è¿›è¡Œä¼ä¸šè®¤è¯ã€‚`);
        } else {
            newRegisteredType = 'personal'; 
            alert(`ä¸ªäººè´¦å·æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½• ${email} è¿›è¡Œèº«ä»½è®¤è¯ã€‚`);
        }
        newRegisteredEmail = email;
        document.getElementById('login-email').value = email;
        document.getElementById('login-pass').value = ""; 
        switchAuthMode('login');
    }

    window.handleLogin = function() {
        const email = document.getElementById('login-email').value;
        if(!email) return alert('è¯·è¾“å…¥é‚®ç®±');
        const btnText = document.getElementById('login-btn-text');
        const loading = document.getElementById('login-loading');
        
        btnText.innerText = 'ç™»å½•ä¸­...';
        loading.classList.remove('hidden');

        setTimeout(() => {
            document.getElementById('auth-layout').classList.add('hidden');
            document.getElementById('app-layout').classList.remove('hidden');
            document.getElementById('user-name-display').innerText = email.split('@')[0];
            document.getElementById('user-avatar').innerText = email.charAt(0).toUpperCase();

            if (email === newRegisteredEmail) {
                currentUser.kycLevel = 'L1'; 
                currentUser.kycAccountType = newRegisteredType; 
                currentUser.balance = 0.00;
                document.getElementById('nav-total-balance').innerText = "0.00";
                showView('kyc'); 
            } else {
                currentUser.kycLevel = 'L2'; 
                delete currentUser.kycAccountType; 
                currentUser.balance = 12450.80; 
                showView('dashboard');
            }
            btnText.innerText = 'ç«‹å³ç™»å½•';
            loading.classList.add('hidden');
        }, 1000);
    }

    window.renderKycForm = function() {
        const container = document.getElementById('kyc-dynamic-form');
        if(!container) return;
        const { type, region } = kycState;
        if (!region) {
            container.innerHTML = `<div class="text-center py-10 text-slate-400 flex flex-col items-center"><svg class="w-10 h-10 mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2"/></svg><span>è¯·å…ˆåœ¨å·¦ä¾§é€‰æ‹©æ‚¨çš„åœ°åŒº</span></div>`;
            return;
        }
        const config = kycRequirements[type];
        const fields = (config[region] && config[region].length > 0) ? config[region] : config.common;

        let html = '<div class="space-y-5 fade-in">';
        fields.forEach(field => {
            if (field.section) {
                html += `<h4 class="text-sm font-bold text-slate-900 mt-6 border-l-4 border-indigo-500 pl-3 uppercase tracking-wide">${field.section}</h4>`;
            } else {
                html += `<div><label class="block text-xs font-bold text-slate-600 mb-1.5">${field.label}</label>`;
                if (field.type === 'text') html += `<input type="text" class="w-full px-4 py-2.5 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition" placeholder="${field.placeholder || ''}">`;
                else if (field.type === 'file') html += `<div class="border-2 border-dashed border-slate-300 rounded-lg p-4 hover:bg-slate-50 transition cursor-pointer group relative bg-white"><input type="file" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" ${field.multiple ? 'multiple' : ''}><div class="flex items-center justify-center gap-3"><div class="w-10 h-10 bg-indigo-50 rounded-full flex items-center justify-center text-indigo-500 group-hover:scale-110 transition"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" stroke-width="2"/></svg></div><div class="text-left"><p class="text-sm font-medium text-slate-700 group-hover:text-indigo-600">ç‚¹å‡»ä¸Šä¼  ${field.multiple ? 'æ–‡ä»¶ (æ”¯æŒå¤šé€‰)' : 'å›¾ç‰‡'}</p><p class="text-xs text-slate-400">${field.hint || 'æ”¯æŒ JPG, PNG, PDF (Max 5MB)'}</p></div></div></div>`;
                html += `</div>`;
            }
        });
        html += `<div class="pt-4"><button onclick="handleKycSubmit()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 transition flex items-center justify-center gap-2">æäº¤å®¡æ ¸ <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M14 5l7 7m0 0l-7 7m7-7H3" stroke-width="2"/></svg></button></div></div>`;
        container.innerHTML = html;
    }

    window.showView = function(viewName) {
        const container = document.getElementById('content-area');
        const title = document.getElementById('page-title');
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        if (viewName !== 'kyc') {
            const link = document.querySelector(`a[onclick="showView('${viewName}')"]`);
            if(link) link.classList.add('active');
        }
        if (views[viewName]) {
            container.innerHTML = views[viewName]();
            const titles = { dashboard: 'ä»ªè¡¨ç›˜', cards: 'å¡ç‰‡ä¸­å¿ƒ', apply: 'ç”³è¯·æ–°å¡', wallet: 'èµ„é‡‘é’±åŒ…', transactions: 'äº¤æ˜“è®°å½•', kyc: 'è´¦æˆ·è®¤è¯' };
            title.innerText = titles[viewName] || 'VCC Pay';
            if(viewName === 'kyc') { 
                kycState.region = ''; 
                if (currentUser.kycLevel !== 'L1_Pending') renderKycForm(); 
            }
        }
    }
    // UI Helpers (åŒå‰)
    window.setRegisterType = function(type) {
        currentRegType = type;
        const personalBtn = document.getElementById('type-btn-personal');
        const enterpriseBtn = document.getElementById('type-btn-enterprise');
        const enterpriseFields = document.getElementById('enterprise-fields');
        if (type === 'personal') {
            personalBtn.className = "flex-1 py-2 text-sm font-bold rounded-lg bg-white text-indigo-600 shadow-sm transition";
            enterpriseBtn.className = "flex-1 py-2 text-sm font-bold rounded-lg text-slate-500 hover:text-slate-700 transition";
            enterpriseFields.classList.add('hidden');
        } else {
            enterpriseBtn.className = "flex-1 py-2 text-sm font-bold rounded-lg bg-white text-indigo-600 shadow-sm transition";
            personalBtn.className = "flex-1 py-2 text-sm font-bold rounded-lg text-slate-500 hover:text-slate-700 transition";
            enterpriseFields.classList.remove('hidden');
            enterpriseFields.classList.add('fade-in');
        }
    }
    window.setKycRegion = function(code) {
        kycState.region = code;
        document.querySelectorAll('.region-card').forEach(el => {
            if(el.dataset.code === code) el.classList.add('ring-2', 'ring-indigo-600', 'bg-indigo-50');
            else el.classList.remove('ring-2', 'ring-indigo-600', 'bg-indigo-50');
        });
        renderKycForm();
    }
    window.setKycType = function(type) {
        kycState.type = type;
        const pBtn = document.getElementById('kyc-type-personal');
        const eBtn = document.getElementById('kyc-type-enterprise');
        if(pBtn && eBtn) {
            pBtn.className = type === 'personal' ? 'flex-1 py-2 bg-white shadow-sm text-indigo-600 font-bold rounded-lg transition border border-slate-100' : 'flex-1 py-2 text-slate-500 hover:text-slate-700 font-medium transition';
            eBtn.className = type === 'enterprise' ? 'flex-1 py-2 bg-white shadow-sm text-indigo-600 font-bold rounded-lg transition border border-slate-100' : 'flex-1 py-2 text-slate-500 hover:text-slate-700 font-medium transition';
        }
        renderKycForm();
    }

    const newRegisterFormHTML = `
    <div id="register-form" class="space-y-5 hidden">
        <div><h2 class="text-3xl font-bold text-slate-900">åˆ›å»ºè´¦æˆ·</h2><p class="text-slate-500 mt-2">ä»…éœ€ 30 ç§’å³å¯å¼€å¯å…¨çƒæ”¯ä»˜ä¹‹æ—…</p></div>
        <div class="bg-slate-100 p-1 rounded-xl flex"><button onclick="setRegisterType('personal')" id="type-btn-personal" class="flex-1 py-2 text-sm font-bold rounded-lg bg-white text-indigo-600 shadow-sm transition">ä¸ªäººè´¦æˆ·</button><button onclick="setRegisterType('enterprise')" id="type-btn-enterprise" class="flex-1 py-2 text-sm font-bold rounded-lg text-slate-500 hover:text-slate-700 transition">ä¼ä¸šè´¦æˆ·</button></div>
        <div class="space-y-4">
            <div id="enterprise-fields" class="hidden space-y-4 p-4 bg-slate-50 rounded-xl border border-slate-100">
                <div><label class="block text-sm font-medium text-slate-700 mb-1">ä¼ä¸šåç§°</label><input type="text" id="reg-company-name" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white" placeholder="è¯·è¾“å…¥è¥ä¸šæ‰§ç…§ç™»è®°åç§°"></div>
                <div><label class="block text-sm font-medium text-slate-700 mb-1">ä¼ä¸šè§„æ¨¡</label><select id="reg-company-size" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white appearance-none"><option value="" disabled selected>è¯·é€‰æ‹©äººå‘˜è§„æ¨¡</option><option value="1-10">1-10 äºº (åˆåˆ›å›¢é˜Ÿ)</option><option value="11-50">11-50 äºº</option><option value="51-200">51-200 äºº</option><option value="200+">200 äººä»¥ä¸Š</option></select></div>
            </div>
            <div><label class="block text-sm font-medium text-slate-700 mb-1">ä¸»è¦ä½¿ç”¨åœºæ™¯ (å¿…é€‰)</label><div class="relative"><select id="reg-usage" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none appearance-none bg-white"><option value="" disabled selected>è¯·é€‰æ‹© VCC å¡ä¸»è¦ç”¨é€”</option><option value="ads">å¹¿å‘ŠæŠ•æ”¾ (Facebook/Google/TikTok)</option><option value="ai">AI è®¢é˜… (ChatGPT/Midjourney/Claude)</option><option value="ecommerce">ç”µå•†æµ·æ·˜/åº—ç¾¤ (Amazon/eBay/Shopify)</option><option value="cloud">äº‘æœåŠ¡/æœåŠ¡å™¨ (AWS/Google Cloud/Azure)</option><option value="travel">èˆªæ—…é¢„è®¢ (Booking/Agoda/Expedia)</option><option value="other">å…¶ä»–ç”¨é€”</option></select><svg class="w-4 h-4 text-slate-400 absolute right-4 top-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7" stroke-width="2"/></svg></div></div>
            <div><label class="block text-sm font-medium text-slate-700 mb-1">ç”µå­é‚®ç®±</label><div class="flex gap-2"><input type="email" id="reg-email" class="flex-1 px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="æ‚¨çš„å¸¸ç”¨é‚®ç®±"><button class="px-4 py-2 bg-slate-100 text-slate-600 text-xs font-bold rounded-lg hover:bg-slate-200 whitespace-nowrap">å‘é€éªŒè¯ç </button></div></div>
            <div class="flex gap-4"><div class="w-1/3"><label class="block text-sm font-medium text-slate-700 mb-1">éªŒè¯ç </label><input type="text" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="6ä½æ•°å­—"></div><div class="flex-1"><label class="block text-sm font-medium text-slate-700 mb-1">è®¾ç½®å¯†ç </label><input type="password" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="è‡³å°‘8ä½å­—ç¬¦"></div></div>
        </div>
        <button onclick="handleRegister()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 transition mt-2">å®Œæˆæ³¨å†Œ</button>
        <p class="text-center text-sm text-slate-500">å·²æœ‰è´¦å·? <button onclick="switchAuthMode('login')" class="text-indigo-600 font-bold hover:underline">ç›´æ¥ç™»å½•</button></p>
    </div>`;
    const oldRegForm = document.getElementById('register-form');
    if(oldRegForm) oldRegForm.outerHTML = newRegisterFormHTML;
}
</script>
<script>
{
    // 1. å®šä¹‰æ–°çš„ä¸°å¯Œæ•°æ®æº
    
    // èµ„é‡‘é’±åŒ…æ˜ç»†æ•°æ® (å……å€¼/åˆ’è½¬/æç°)
    const walletHistoryData = [
        { id: 'W_001', type: 'deposit', title: 'USDT å……å€¼ (TRC20)', amount: 5000.00, balance: 12450.80, date: '2025-11-21 10:42:05', status: 'success', tag: 'å……å€¼' },
        { id: 'W_002', type: 'transfer_out', title: 'åˆ’è½¬è‡³å¡ç‰‡ (FB Ads Main)', amount: -1000.00, balance: 7450.80, date: '2025-11-21 09:15:00', status: 'success', tag: 'åˆ’è½¬' },
        { id: 'W_003', type: 'transfer_out', title: 'åˆ’è½¬è‡³å¡ç‰‡ (Midjourney Sub)', amount: -50.00, balance: 8450.80, date: '2025-11-20 16:20:33', status: 'success', tag: 'åˆ’è½¬' },
        { id: 'W_004', type: 'deposit', title: 'USDT å……å€¼ (ERC20)', amount: 2000.00, balance: 8500.80, date: '2025-11-19 14:10:00', status: 'success', tag: 'å……å€¼' },
        { id: 'W_005', type: 'refund', title: 'å¡ç‰‡èµ„é‡‘å›åˆ’ (Test Card)', amount: 120.50, balance: 6500.80, date: '2025-11-18 11:30:00', status: 'success', tag: 'å›åˆ’' },
        { id: 'W_006', type: 'fee', title: 'è´¦æˆ·ç®¡ç†è´¹ (æœˆä»˜)', amount: -10.00, balance: 6380.30, date: '2025-11-01 00:00:00', status: 'success', tag: 'æœåŠ¡è´¹' },
        { id: 'W_007', type: 'deposit', title: 'ç³»ç»Ÿé€€æ¬¾ (å¼€å¡å¤±è´¥)', amount: 10.00, balance: 6390.30, date: '2025-10-28 15:22:10', status: 'success', tag: 'é€€æ¬¾' }
    ];

    // å…¨å±€äº¤æ˜“è®°å½•æ•°æ® (æ¶ˆè´¹/æ‰£æ¬¾)
    const extendedTransactions = [
        { id: 'TX_101', merchant: 'FACEBOOK *ADS', amount: -245.50, date: '2025-11-21 15:30', status: 'success', card: '4421', type: 'æ¶ˆè´¹' },
        { id: 'TX_102', merchant: 'GOOGLE *ADS', amount: -120.00, date: '2025-11-21 14:15', status: 'success', card: '4421', type: 'æ¶ˆè´¹' },
        { id: 'TX_103', merchant: 'AWS EMEA', amount: -850.00, date: '2025-11-21 09:00', status: 'pending', card: '8891', type: 'é¢„æˆæƒ' },
        { id: 'TX_104', merchant: 'OPENAI *CHATGPT', amount: -20.00, date: '2025-11-20 20:12', status: 'success', card: '8891', type: 'è®¢é˜…' },
        { id: 'TX_105', merchant: 'Midjourney Inc', amount: -30.00, date: '2025-11-20 18:45', status: 'failed', card: '8891', type: 'ä½™é¢ä¸è¶³' },
        { id: 'TX_106', merchant: 'APPLE.COM/BILL', amount: -14.99, date: '2025-11-19 10:20', status: 'success', card: '1122', type: 'æ¶ˆè´¹' },
        { id: 'TX_107', merchant: 'NETFLIX.COM', amount: -19.00, date: '2025-11-18 22:00', status: 'success', card: '1122', type: 'è®¢é˜…' },
        { id: 'TX_108', merchant: 'Namecheap', amount: -9.88, date: '2025-11-18 14:30', status: 'success', card: '4421', type: 'æ¶ˆè´¹' },
        { id: 'TX_109', merchant: 'DigitalOcean', amount: -55.00, date: '2025-11-17 03:00', status: 'success', card: '8891', type: 'æ¶ˆè´¹' },
        { id: 'TX_110', merchant: 'FACEBOOK *ADS', amount: -500.00, date: '2025-11-16 11:20', status: 'success', card: '4421', type: 'æ¶ˆè´¹' },
        { id: 'TX_111', merchant: 'Card Withdrawal', amount: 120.50, date: '2025-11-18 11:30', status: 'success', card: 'Wallet', type: 'æç°' },
        { id: 'TX_112', merchant: 'AliExpress London', amount: -45.20, date: '2025-11-15 09:10', status: 'declined', card: '1122', type: 'é£æ§æ‹’ç»' }
    ];

    // 2. é‡å†™ Wallet è§†å›¾ (æ¸²æŸ“è¯¦ç»†è¡¨æ ¼)
    views.wallet = () => `
        <div class="fade-in space-y-6">
            <div class="grid grid-cols-2 gap-6">
                <div class="bg-slate-900 rounded-2xl p-8 text-white relative overflow-hidden">
                    <div class="absolute -right-10 -top-10 w-40 h-40 bg-indigo-500 rounded-full blur-3xl opacity-20"></div>
                    <p class="text-slate-400 text-sm font-medium mb-2">é’±åŒ…å¯ç”¨ä½™é¢</p>
                    <h2 class="text-5xl font-bold mb-8">$${currentUser.balance.toLocaleString(undefined, {minimumFractionDigits: 2})}</h2>
                    <div class="flex gap-4">
                        <button onclick="openDepositModal()" class="px-6 py-3 bg-indigo-600 hover:bg-indigo-500 rounded-xl font-bold transition flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4" stroke-width="2"/></svg>å……å€¼ (Deposit)</button>
                        <button onclick="openTransferModal()" class="px-6 py-3 bg-white/10 hover:bg-white/20 rounded-xl font-bold transition">å†…éƒ¨åˆ’è½¬ (Card â†’ Wallet)</button>
                    </div>
                </div>
                <div class="bg-white rounded-2xl border border-slate-200 p-6 flex flex-col justify-center">
                    <h3 class="font-bold text-slate-800 mb-4">å¿«é€Ÿå……å€¼é€šé“</h3>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition" onclick="openDepositModal()">
                            <div class="flex items-center gap-3"><div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-green-600 text-xl font-bold">T</div><div><p class="font-bold text-slate-700">USDT-TRC20</p><p class="text-xs text-slate-500">æé€Ÿè‡ªåŠ¨åˆ°è´¦ (æ¨è)</p></div></div><svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-width="2"/></svg>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition">
                            <div class="flex items-center gap-3"><div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 text-xl font-bold">E</div><div><p class="font-bold text-slate-700">USDT-ERC20</p><p class="text-xs text-slate-500">é€‚åˆå¤§é¢å……å€¼</p></div></div><svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-width="2"/></svg>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="font-bold text-slate-800">èµ„é‡‘æµæ°´æ˜ç»†</h3>
                    <button class="text-indigo-600 text-xs font-bold hover:underline">å¯¼å‡ºè´¦å•</button>
                </div>
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 border-b border-slate-100 text-slate-500">
                        <tr><th class="px-6 py-3 font-medium">æ—¶é—´</th><th class="px-6 py-3 font-medium">ç±»å‹/è¯´æ˜</th><th class="px-6 py-3 font-medium text-right">å˜åŠ¨é‡‘é¢</th><th class="px-6 py-3 font-medium text-right">å˜åŠ¨åä½™é¢</th><th class="px-6 py-3 font-medium text-right">çŠ¶æ€</th></tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        ${walletHistoryData.map(item => `
                            <tr class="hover:bg-slate-50 transition">
                                <td class="px-6 py-4 text-slate-500 font-mono text-xs">${item.date}</td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center gap-2">
                                        <span class="px-2 py-0.5 rounded text-[10px] font-bold ${item.amount > 0 ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-600'}">${item.tag}</span>
                                        <span class="font-bold text-slate-700">${item.title}</span>
                                    </div>
                                    <p class="text-xs text-slate-400 mt-0.5 pl-10">ID: ${item.id}</p>
                                </td>
                                <td class="px-6 py-4 text-right font-bold ${item.amount > 0 ? 'text-green-600' : 'text-slate-900'}">${item.amount > 0 ? '+' : ''}${item.amount.toFixed(2)}</td>
                                <td class="px-6 py-4 text-right text-slate-500 font-mono">$${item.balance.toFixed(2)}</td>
                                <td class="px-6 py-4 text-right"><span class="text-xs font-bold text-green-600 flex items-center justify-end gap-1"><span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>Success</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>`;

    // 3. é‡å†™ Transactions è§†å›¾ (ä½¿ç”¨æ‰©å……æ•°æ®)
    views.transactions = () => `
        <div class="fade-in space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-slate-800">å…¨å±€äº¤æ˜“è®°å½•</h2>
                <div class="flex gap-2">
                    <select class="border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-600 outline-none hover:border-indigo-500 transition"><option>æ‰€æœ‰çŠ¶æ€</option><option>æˆåŠŸ</option><option>å¤±è´¥/æ‹’ä»˜</option></select>
                    <select class="border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-600 outline-none hover:border-indigo-500 transition"><option>æœ¬æœˆ</option><option>ä¸Šæœˆ</option></select>
                </div>
            </div>
            <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 border-b border-slate-100">
                        <tr><th class="px-6 py-3 text-slate-500">å•†æˆ·/æ—¶é—´</th><th class="px-6 py-3 text-slate-500">å¡ç‰‡/ç±»å‹</th><th class="px-6 py-3 text-slate-500 text-right">é‡‘é¢</th><th class="px-6 py-3 text-slate-500 text-right">çŠ¶æ€</th></tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        ${extendedTransactions.map(t => {
                            let statusClass = 'text-slate-500';
                            let statusBg = 'bg-slate-100';
                            if(t.status === 'success') { statusClass = 'text-green-600'; statusBg = 'bg-green-100'; }
                            if(t.status === 'failed' || t.status === 'declined') { statusClass = 'text-red-600'; statusBg = 'bg-red-100'; }
                            if(t.status === 'pending') { statusClass = 'text-orange-600'; statusBg = 'bg-orange-100'; }
                            
                            return `
                            <tr class="hover:bg-slate-50 transition">
                                <td class="px-6 py-4">
                                    <p class="font-bold text-slate-800">${t.merchant}</p>
                                    <p class="text-xs text-slate-400 font-mono mt-0.5">${t.date}</p>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center gap-2">
                                        <span class="font-mono text-slate-600 bg-slate-100 px-2 py-0.5 rounded text-xs">..${t.card}</span>
                                        <span class="text-xs text-slate-400 border border-slate-200 px-1.5 py-0.5 rounded">${t.type}</span>
                                    </div>
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <span class="font-bold ${t.amount > 0 ? 'text-green-600' : 'text-slate-800'} text-base">${t.amount > 0 ? '+' : ''}$${Math.abs(t.amount).toFixed(2)}</span>
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <span class="px-2 py-1 rounded text-xs font-bold uppercase ${statusClass} ${statusBg}">${t.status}</span>
                                </td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>
                <div class="p-4 border-t border-slate-100 text-center">
                    <button class="text-sm text-indigo-600 font-bold hover:underline">åŠ è½½æ›´å¤šè®°å½• â†“</button>
                </div>
            </div>
        </div>`;
}
</script>
<script>
{
    // å®šä¹‰è´¹ç‡ (1%)
    const DEPOSIT_FEE_RATE = 0.01; 

    // å®šä¹‰å„é“¾è·¯çš„æ”¶æ¬¾åœ°å€ (æ¨¡æ‹Ÿæ•°æ®)
    const chainAddresses = {
        'TRC20': 'TVJ2wMqCwXj5...TRC20...Address...8812',
        'ERC20': '0x71C7...ERC20...Address...9A23',
        'BSC': '0x71C7...BSC...Address...9A23',
        'Polygon': '0x71C7...MATIC...Address...9A23'
    };

    // è¦†ç›–åŸæœ‰çš„å……å€¼å¼¹çª—å‡½æ•°
    window.openDepositModal = function() {
        const defaultChain = 'TRC20';
        const address = chainAddresses[defaultChain];
        
        const modalHTML = `
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center fade-in" id="modal-overlay">
            <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <h3 class="font-bold text-lg text-slate-800">é’±åŒ…å……å€¼ (Deposit)</h3>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 text-2xl leading-none">&times;</button>
                </div>

                <div class="p-6 overflow-y-auto custom-scrollbar">
                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1.5">é€‰æ‹©å……å€¼ç½‘ç»œ (Network)</label>
                            <select id="deposit-chain" onchange="updateDepositChain()" class="w-full px-4 py-3 border border-slate-200 rounded-xl text-sm font-bold text-slate-700 bg-white focus:ring-2 focus:ring-indigo-500 outline-none appearance-none bg-[url('https://api.iconify.design/heroicons/chevron-down.svg')] bg-no-repeat bg-[center_right_1rem]">
                                <option value="TRC20" selected>USDT - TRC20 (æ¨è)</option>
                                <option value="ERC20">USDT - ERC20</option>
                                <option value="BSC">USDT - BEP20 (BSC)</option>
                                <option value="Polygon">USDT - Polygon</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1.5">å……å€¼é‡‘é¢ (Amount)</label>
                            <div class="relative">
                                <input type="number" id="deposit-amount" oninput="calculateDeposit()" class="w-full px-4 py-3 border border-slate-200 rounded-xl text-lg font-bold text-slate-800 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="100">
                                <span class="absolute right-4 top-3.5 text-sm font-bold text-slate-400">USDT</span>
                            </div>
                        </div>

                        <div class="bg-indigo-50 rounded-xl p-4 space-y-2 border border-indigo-100">
                            <div class="flex justify-between text-xs text-slate-500">
                                <span>å¹³å°æ‰‹ç»­è´¹ (Rate: ${(DEPOSIT_FEE_RATE * 100).toFixed(0)}%)</span>
                                <span class="font-bold text-slate-700" id="calc-fee">$0.00</span>
                            </div>
                            <div class="w-full h-px bg-indigo-200/50"></div>
                            <div class="flex justify-between items-center">
                                <span class="text-xs font-bold text-slate-600">é¢„è®¡å®é™…åˆ°è´¦</span>
                                <span class="text-lg font-bold text-indigo-600" id="calc-arrival">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mb-6">
                        <div class="bg-white border-2 border-slate-100 p-2 inline-block rounded-2xl mb-4 shadow-sm relative group">
                            <img id="deposit-qr" src="https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=${address}" alt="QR" class="rounded-lg">
                            <div class="absolute inset-0 bg-white/90 opacity-0 group-hover:opacity-100 transition flex items-center justify-center backdrop-blur-sm rounded-lg cursor-pointer" onclick="copyAddress()">
                                <span class="text-xs font-bold text-indigo-600">ç‚¹å‡»å¤åˆ¶åœ°å€</span>
                            </div>
                        </div>
                        <p class="text-xs text-slate-400 mb-2">å……å€¼åœ°å€ (ç‚¹å‡»å¤åˆ¶)</p>
                        <div class="bg-slate-100 border border-slate-200 rounded-lg p-3 flex items-center justify-between cursor-pointer hover:bg-slate-200 transition group" onclick="copyAddress()">
                            <p id="deposit-address-text" class="font-mono text-xs text-slate-600 truncate w-64 text-center mx-auto select-all">${address}</p>
                            <svg class="w-4 h-4 text-slate-400 group-hover:text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" stroke-width="2"/></svg>
                        </div>
                    </div>

                    <div class="bg-orange-50 rounded-xl p-4 border border-orange-100">
                        <h4 class="text-xs font-bold text-orange-700 mb-2 flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" stroke-width="2"/></svg>
                            å……å€¼æ³¨æ„äº‹é¡¹
                        </h4>
                        <ul class="text-[10px] text-orange-800/80 space-y-1 list-disc pl-3 leading-relaxed">
                            <li>è¯·åŠ¡å¿…ç¡®è®¤é€‰æ‹©çš„<b>å……å€¼ç½‘ç»œ</b>ä¸æå¸ç½‘ç»œä¸€è‡´ï¼Œå¦åˆ™èµ„äº§æ— æ³•æ‰¾å›ã€‚</li>
                            <li>æœ€ä½å……å€¼é‡‘é¢ä¸º <b>10 USDT</b>ï¼Œä½äºæ­¤é‡‘é¢å°†æ— æ³•å…¥è´¦ã€‚</li>
                            <li>å……å€¼é€šå¸¸éœ€è¦ <b>1-3 ä¸ªç½‘ç»œç¡®è®¤</b>ï¼Œé¢„è®¡ 3-5 åˆ†é’Ÿå†…åˆ°è´¦ã€‚</li>
                            <li>å¹³å°æ”¶å– <b>${(DEPOSIT_FEE_RATE * 100).toFixed(0)}% æ‰‹ç»­è´¹</b>ï¼Œè¯·åœ¨è®¡ç®—æˆæœ¬æ—¶é¢„ç•™ã€‚</li>
                            <li>ä»…æ”¯æŒ USDT å……å€¼ï¼Œè¯·å‹¿å‘æ­¤åœ°å€è½¬å…¥ BTC/ETH ç­‰å…¶ä»–èµ„äº§ã€‚</li>
                        </ul>
                    </div>
                </div>
                
                <div class="p-4 border-t border-slate-100 bg-slate-50/50">
                    <button onclick="closeModal()" class="w-full py-3 bg-white border border-slate-300 text-slate-700 rounded-xl font-bold hover:bg-slate-100 transition shadow-sm">æˆ‘å·²å®Œæˆæ”¯ä»˜</button>
                </div>
            </div>
        </div>`;
        
        document.getElementById('modal-container').innerHTML = modalHTML;
        
        // åˆå§‹åŒ–è®¡ç®—ä¸€æ¬¡(å¦‚æœé»˜è®¤æœ‰å€¼)
        calculateDeposit(); 
    }

    // è®¡ç®—è´¹ç‡é€»è¾‘
    window.calculateDeposit = function() {
        const input = document.getElementById('deposit-amount');
        const feeDisplay = document.getElementById('calc-fee');
        const arrivalDisplay = document.getElementById('calc-arrival');
        
        const amount = parseFloat(input.value);

        if (!amount || amount <= 0) {
            feeDisplay.innerText = '$0.00';
            arrivalDisplay.innerText = '$0.00';
            return;
        }

        const fee = amount * DEPOSIT_FEE_RATE;
        const arrival = amount - fee;

        feeDisplay.innerText = '-$' + fee.toFixed(2);
        arrivalDisplay.innerText = '$' + arrival.toFixed(2);
    }

    // åˆ‡æ¢ç½‘ç»œé€»è¾‘
    window.updateDepositChain = function() {
        const chain = document.getElementById('deposit-chain').value;
        const addressEl = document.getElementById('deposit-address-text');
        const qrEl = document.getElementById('deposit-qr');
        
        const newAddress = chainAddresses[chain] || 'Address_Error';
        
        // æ›´æ–°åœ°å€æ–‡æœ¬
        addressEl.innerText = newAddress;
        // æ›´æ–°äºŒç»´ç 
        qrEl.src = `https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=${newAddress}`;
    }

    // å¤åˆ¶åœ°å€é€»è¾‘
    window.copyAddress = function() {
        const text = document.getElementById('deposit-address-text').innerText;
        navigator.clipboard.writeText(text).then(() => {
            alert('åœ°å€å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        }).catch(err => {
            alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
        });
    }
}
</script>
<script>
{
    // 1. é‡æ–°å®šä¹‰æ•°æ®æº (ç¡®ä¿è¯¦æƒ…é¡µèƒ½è¯»å–åˆ°)
    const walletHistoryData = [
        { id: 'W_001', type: 'deposit', title: 'USDT å……å€¼ (TRC20)', amount: 5000.00, balance: 12450.80, date: '2025-11-21 10:42:05', status: 'success', tag: 'å……å€¼' },
        { id: 'W_002', type: 'transfer_out', title: 'åˆ’è½¬è‡³å¡ç‰‡ (FB Ads Main)', amount: -1000.00, balance: 7450.80, date: '2025-11-21 09:15:00', status: 'success', tag: 'åˆ’è½¬' },
        { id: 'W_003', type: 'transfer_out', title: 'åˆ’è½¬è‡³å¡ç‰‡ (Midjourney Sub)', amount: -50.00, balance: 8450.80, date: '2025-11-20 16:20:33', status: 'success', tag: 'åˆ’è½¬' },
        { id: 'W_004', type: 'deposit', title: 'USDT å……å€¼ (ERC20)', amount: 2000.00, balance: 8500.80, date: '2025-11-19 14:10:00', status: 'success', tag: 'å……å€¼' },
        { id: 'W_005', type: 'refund', title: 'å¡ç‰‡èµ„é‡‘å›åˆ’ (Test Card)', amount: 120.50, balance: 6500.80, date: '2025-11-18 11:30:00', status: 'success', tag: 'å›åˆ’' },
        { id: 'W_006', type: 'fee', title: 'è´¦æˆ·ç®¡ç†è´¹ (æœˆä»˜)', amount: -10.00, balance: 6380.30, date: '2025-11-01 00:00:00', status: 'success', tag: 'æœåŠ¡è´¹' }
    ];

    const extendedTransactions = [
        { id: 'TX_101', merchant: 'FACEBOOK *ADS', amount: -245.50, date: '2025-11-21 15:30', status: 'success', card: '4421', type: 'æ¶ˆè´¹' },
        { id: 'TX_102', merchant: 'GOOGLE *ADS', amount: -120.00, date: '2025-11-21 14:15', status: 'success', card: '4421', type: 'æ¶ˆè´¹' },
        { id: 'TX_103', merchant: 'AWS EMEA', amount: -850.00, date: '2025-11-21 09:00', status: 'pending', card: '8891', type: 'é¢„æˆæƒ' },
        { id: 'TX_104', merchant: 'OPENAI *CHATGPT', amount: -20.00, date: '2025-11-20 20:12', status: 'success', card: '8891', type: 'è®¢é˜…' },
        { id: 'TX_105', merchant: 'Midjourney Inc', amount: -30.00, date: '2025-11-20 18:45', status: 'failed', card: '8891', type: 'ä½™é¢ä¸è¶³' },
        { id: 'TX_106', merchant: 'APPLE.COM/BILL', amount: -14.99, date: '2025-11-19 10:20', status: 'success', card: '1122', type: 'æ¶ˆè´¹' },
        { id: 'TX_107', merchant: 'NETFLIX.COM', amount: -19.00, date: '2025-11-18 22:00', status: 'success', card: '1122', type: 'è®¢é˜…' },
        { id: 'TX_108', merchant: 'Namecheap', amount: -9.88, date: '2025-11-18 14:30', status: 'success', card: '4421', type: 'æ¶ˆè´¹' },
        { id: 'TX_109', merchant: 'FACEBOOK *ADS', amount: -500.00, date: '2025-11-16 11:20', status: 'success', card: '4421', type: 'æ¶ˆè´¹' },
        { id: 'TX_111', merchant: 'Card Withdrawal', amount: 120.50, date: '2025-11-18 11:30', status: 'success', card: 'Wallet', type: 'æç°' }
    ];

    // 2. æ›´æ–° Wallet è§†å›¾ (æ·»åŠ  onclick äº‹ä»¶)
    views.wallet = () => `
        <div class="fade-in space-y-6">
            <div class="grid grid-cols-2 gap-6">
                <div class="bg-slate-900 rounded-2xl p-8 text-white relative overflow-hidden">
                    <div class="absolute -right-10 -top-10 w-40 h-40 bg-indigo-500 rounded-full blur-3xl opacity-20"></div>
                    <p class="text-slate-400 text-sm font-medium mb-2">é’±åŒ…å¯ç”¨ä½™é¢</p>
                    <h2 class="text-5xl font-bold mb-8">$${currentUser.balance.toLocaleString(undefined, {minimumFractionDigits: 2})}</h2>
                    <div class="flex gap-4">
                        <button onclick="openDepositModal()" class="px-6 py-3 bg-indigo-600 hover:bg-indigo-500 rounded-xl font-bold transition flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4" stroke-width="2"/></svg>å……å€¼</button>
                        <button onclick="openTransferModal()" class="px-6 py-3 bg-white/10 hover:bg-white/20 rounded-xl font-bold transition">åˆ’è½¬</button>
                    </div>
                </div>
                <div class="bg-white rounded-2xl border border-slate-200 p-6 flex flex-col justify-center">
                    <h3 class="font-bold text-slate-800 mb-4">å¿«é€Ÿå……å€¼é€šé“</h3>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition" onclick="openDepositModal()">
                            <div class="flex items-center gap-3"><div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-green-600 text-xl font-bold">T</div><div><p class="font-bold text-slate-700">USDT-TRC20</p><p class="text-xs text-slate-500">æé€Ÿè‡ªåŠ¨åˆ°è´¦</p></div></div><svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-width="2"/></svg>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition">
                            <div class="flex items-center gap-3"><div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 text-xl font-bold">E</div><div><p class="font-bold text-slate-700">USDT-ERC20</p><p class="text-xs text-slate-500">å¤§é¢å……å€¼</p></div></div><svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-width="2"/></svg>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="font-bold text-slate-800">èµ„é‡‘æµæ°´æ˜ç»†</h3>
                    <span class="text-xs text-slate-400">ç‚¹å‡»åˆ—è¡¨æŸ¥çœ‹è¯¦æƒ…</span>
                </div>
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 border-b border-slate-100 text-slate-500">
                        <tr><th class="px-6 py-3">æ—¶é—´</th><th class="px-6 py-3">ç±»å‹/è¯´æ˜</th><th class="px-6 py-3 text-right">å˜åŠ¨é‡‘é¢</th><th class="px-6 py-3 text-right">çŠ¶æ€</th></tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        ${walletHistoryData.map(item => `
                            <tr onclick="showWalletDetail('${item.id}')" class="hover:bg-slate-50 transition cursor-pointer group">
                                <td class="px-6 py-4 text-slate-500 font-mono text-xs">${item.date}</td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center gap-2"><span class="px-2 py-0.5 rounded text-[10px] font-bold ${item.amount > 0 ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-600'}">${item.tag}</span><span class="font-bold text-slate-700 group-hover:text-indigo-600 transition">${item.title}</span></div>
                                    <p class="text-xs text-slate-400 mt-0.5 pl-10">ID: ${item.id} <span class="text-indigo-400 opacity-0 group-hover:opacity-100 transition ml-2 text-[10px]">æŸ¥çœ‹è¯¦æƒ… ></span></p>
                                </td>
                                <td class="px-6 py-4 text-right font-bold ${item.amount > 0 ? 'text-green-600' : 'text-slate-900'}">${item.amount > 0 ? '+' : ''}${item.amount.toFixed(2)}</td>
                                <td class="px-6 py-4 text-right"><span class="text-xs font-bold text-green-600">Success</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>`;

    // 3. æ›´æ–° Transactions è§†å›¾ (æ·»åŠ  onclick äº‹ä»¶)
    views.transactions = () => `
        <div class="fade-in space-y-6">
            <div class="flex justify-between items-center"><h2 class="text-xl font-bold text-slate-800">å…¨å±€äº¤æ˜“è®°å½•</h2><span class="text-xs text-slate-400">ç‚¹å‡»äº¤æ˜“æŸ¥çœ‹è´¹ç‡è¯¦æƒ…</span></div>
            <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 border-b border-slate-100"><tr><th class="px-6 py-3">å•†æˆ·/æ—¶é—´</th><th class="px-6 py-3">å¡ç‰‡</th><th class="px-6 py-3 text-right">äº¤æ˜“é¢</th><th class="px-6 py-3 text-right">çŠ¶æ€</th></tr></thead>
                    <tbody class="divide-y divide-slate-100">
                        ${extendedTransactions.map(t => `
                            <tr onclick="showTransactionDetail('${t.id}')" class="hover:bg-slate-50 transition cursor-pointer group">
                                <td class="px-6 py-4"><p class="font-bold text-slate-800 group-hover:text-indigo-600 transition">${t.merchant}</p><p class="text-xs text-slate-400 font-mono mt-0.5">${t.date}</p></td>
                                <td class="px-6 py-4"><div class="flex items-center gap-2"><span class="font-mono text-slate-600 bg-slate-100 px-2 py-0.5 rounded text-xs">..${t.card}</span><span class="text-xs text-slate-400 border border-slate-200 px-1.5 py-0.5 rounded">${t.type}</span></div></td>
                                <td class="px-6 py-4 text-right"><span class="font-bold ${t.amount > 0 ? 'text-green-600' : 'text-slate-800'} text-base">${t.amount > 0 ? '+' : ''}$${Math.abs(t.amount).toFixed(2)}</span></td>
                                <td class="px-6 py-4 text-right"><span class="px-2 py-1 rounded text-xs font-bold uppercase ${t.status === 'success' ? 'text-green-600 bg-green-100' : (t.status === 'pending' ? 'text-orange-600 bg-orange-100' : 'text-red-600 bg-red-100')}">${t.status}</span></td>
                            </tr>`).join('')}
                    </tbody>
                </table>
            </div>
        </div>`;

    // 4. å®šä¹‰å¼¹çª—é€»è¾‘å‡½æ•°
    
    // èµ„é‡‘è¯¦æƒ…å¼¹çª— (Wallet Detail)
    window.showWalletDetail = function(id) {
        const item = walletHistoryData.find(i => i.id === id);
        if (!item) return;

        // æ¨¡æ‹Ÿè®¡ç®—é€»è¾‘ (å€’æ¨)
        // å……å€¼ (Deposit): å†…æ‰£æ³•ã€‚è®°å½•çš„ amount æ˜¯å®é™…åˆ°è´¦ã€‚
        // å‡è®¾åˆ°è´¦ 5000ï¼Œè´¹ç‡ 1%ï¼Œåˆ™åŸå……å€¼é¢ = 5000 / 0.99 = 5050.50ï¼Œæ‰‹ç»­è´¹ 50.50
        // ä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿ï¼Œè¿™é‡Œç®€åŒ–å±•ç¤ºï¼š
        
        let detailHTML = '';
        if (item.type === 'deposit') {
            const rate = 0.01; // 1%
            const netAmount = item.amount;
            const originalAmount = netAmount / (1 - rate);
            const fee = originalAmount - netAmount;
            
            detailHTML = `
                <div class="flex justify-between py-2"><span class="text-slate-500">å……å€¼æœ¬é‡‘</span><span class="font-bold text-slate-800">$${originalAmount.toFixed(2)}</span></div>
                <div class="flex justify-between py-2"><span class="text-slate-500">å¹³å°æ‰‹ç»­è´¹ (1%)</span><span class="font-bold text-red-500">-$${fee.toFixed(2)}</span></div>
                <div class="w-full h-px bg-slate-100 my-2"></div>
                <div class="flex justify-between py-2"><span class="text-slate-800 font-bold">å®é™…åˆ°è´¦</span><span class="font-bold text-green-600 text-lg">+$${netAmount.toFixed(2)}</span></div>
            `;
        } else {
            // åˆ’è½¬ç­‰å…¶ä»–ç±»å‹æš‚æ— è´¹ç‡
            detailHTML = `
                <div class="flex justify-between py-2"><span class="text-slate-500">å˜åŠ¨é‡‘é¢</span><span class="font-bold ${item.amount>0?'text-green-600':'text-slate-800'}">${item.amount>0?'+':''}$${item.amount.toFixed(2)}</span></div>
                <div class="flex justify-between py-2"><span class="text-slate-500">æ‰‹ç»­è´¹</span><span class="font-bold text-slate-400">--</span></div>
            `;
        }

        const modal = `
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center fade-in">
            <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden">
                <div class="bg-slate-50 px-6 py-4 border-b border-slate-100 flex justify-between items-center"><h3 class="font-bold text-slate-800">èµ„é‡‘æ˜ç»†è¯¦æƒ…</h3><button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button></div>
                <div class="p-6 space-y-4">
                    <div class="text-center mb-6">
                        <div class="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-3 text-xl font-bold">Wallet</div>
                        <h2 class="text-xl font-bold text-slate-800">${item.title}</h2>
                        <p class="text-xs text-slate-500 font-mono mt-1">${item.date}</p>
                    </div>
                    <div class="bg-slate-50 rounded-xl p-4 text-sm space-y-1 border border-slate-100">
                        ${detailHTML}
                    </div>
                    <div class="text-xs text-center text-slate-400 font-mono pt-2">Transaction ID: ${item.id}</div>
                </div>
            </div>
        </div>`;
        document.getElementById('modal-container').innerHTML = modal;
    }

    // äº¤æ˜“è¯¦æƒ…å¼¹çª— (Transaction Detail)
    window.showTransactionDetail = function(id) {
        const t = extendedTransactions.find(i => i.id === id);
        if (!t) return;

        const rawAmount = Math.abs(t.amount);
        let feeRate = 0;
        let fee = 0;
        
        // ä»…å¯¹æ¶ˆè´¹ç±»å‹è®¡ç®—è´¹ç‡ (æç°/é€€æ¬¾é™¤å¤–)
        if (t.type === 'æ¶ˆè´¹' || t.type === 'è®¢é˜…') {
            feeRate = 0.01; // 1% è´¹ç‡
            fee = rawAmount * feeRate;
        }
        
        const totalDeduct = rawAmount + fee;

        const modal = `
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center fade-in">
            <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden">
                <div class="bg-white px-6 py-5 border-b border-slate-100 flex justify-between items-center"><h3 class="font-bold text-slate-800">äº¤æ˜“è¯¦æƒ…å•</h3><button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button></div>
                
                <div class="p-6 bg-slate-50/50">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="w-12 h-12 bg-white border border-slate-200 rounded-xl flex items-center justify-center text-2xl shadow-sm">ğŸ§¾</div>
                        <div>
                            <h3 class="font-bold text-slate-800 text-lg leading-tight">${t.merchant}</h3>
                            <span class="text-xs font-bold px-2 py-0.5 bg-indigo-100 text-indigo-700 rounded-md">${t.type}</span>
                        </div>
                    </div>

                    <div class="bg-white border border-slate-200 rounded-xl p-5 shadow-sm mb-6 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full ${t.amount > 0 ? 'bg-green-500' : 'bg-red-500'}"></div>
                        
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between items-center">
                                <span class="text-slate-500">äº¤æ˜“é‡‘é¢</span>
                                <span class="font-bold text-slate-800 font-mono text-base">$${rawAmount.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-slate-500 flex items-center gap-1">äº¤æ˜“æ‰‹ç»­è´¹ <span class="text-[10px] bg-slate-100 px-1 rounded text-slate-500">1%</span></span>
                                <span class="font-bold text-slate-600 font-mono">$${fee.toFixed(2)}</span>
                            </div>
                            <div class="w-full h-px bg-slate-100 border-t border-dashed border-slate-300 my-1"></div>
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-slate-800">å®é™…æ‰£é™¤æ€»é¢</span>
                                <span class="font-bold text-red-600 font-mono text-xl">-$${totalDeduct.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-3 text-xs text-slate-500">
                        <div class="flex justify-between"><span>äº¤æ˜“æ—¶é—´</span><span class="font-mono">${t.date}</span></div>
                        <div class="flex justify-between"><span>æ”¯ä»˜å¡ç‰‡</span><span class="font-mono">VCC - ${t.card}</span></div>
                        <div class="flex justify-between"><span>äº¤æ˜“çŠ¶æ€</span><span class="font-bold ${t.status==='success'?'text-green-600':(t.status==='pending'?'text-orange-500':'text-red-500')} uppercase">${t.status}</span></div>
                        <div class="flex justify-between"><span>æµæ°´å·</span><span class="font-mono text-slate-400">${t.id}</span></div>
                    </div>
                </div>
                
                <div class="p-4 bg-white border-t border-slate-100 text-center">
                    <button onclick="closeModal()" class="text-indigo-600 font-bold text-sm hover:underline">å…³é—­è¯¦æƒ…</button>
                </div>
            </div>
        </div>`;
        document.getElementById('modal-container').innerHTML = modal;
    }
}
</script>
<script>
{
    // --- 1. èœå•æ é¡ºåºè°ƒæ•´ (DOM é‡æ’) ---
    try {
        const navContainer = document.querySelector('nav');
        if (navContainer) {
            // å®šä¹‰ç›®æ ‡é¡ºåº (æ ¹æ® onclick å±æ€§ä¸­çš„è§†å›¾å)
            const orderMap = ['dashboard', 'wallet', 'apply', 'cards', 'transactions'];
            
            // è·å–æ‰€æœ‰å¯¼èˆªé¡¹
            const navItems = Array.from(navContainer.children);
            
            // æ’åºå‡½æ•°
            navItems.sort((a, b) => {
                // æå– onclick="showView('xxx')" ä¸­çš„ xxx
                const getViewName = (el) => {
                    const match = el.getAttribute('onclick')?.match(/showView\('(\w+)'\)/);
                    return match ? match[1] : '';
                };
                const indexA = orderMap.indexOf(getViewName(a));
                const indexB = orderMap.indexOf(getViewName(b));
                // å¦‚æœæ‰¾ä¸åˆ°(æ¯”å¦‚ç™»å‡ºæŒ‰é’®)ï¼Œæ”¾åˆ°æœ€å
                return (indexA === -1 ? 99 : indexA) - (indexB === -1 ? 99 : indexB);
            });

            // é‡æ–°æ’å…¥ DOM (è‡ªåŠ¨ç§»åŠ¨ä½ç½®)
            navItems.forEach(item => navContainer.appendChild(item));
        }
    } catch (e) { console.error('Menu reorder failed', e); }


    // --- 2. æ–°å¢äº¤äº’é€»è¾‘å‡½æ•° ---

    // åˆ‡æ¢ CVV æ˜¾ç¤º/éšè—
    window.toggleCVV = function(btn, realCVV) {
        const container = btn.previousElementSibling; // è·å–å‰é¢çš„ *** å®¹å™¨
        if (btn.innerText === 'ç‚¹å‡»æŸ¥çœ‹') {
            container.innerText = realCVV;
            container.classList.remove('bg-slate-100', 'text-slate-500');
            container.classList.add('bg-indigo-50', 'text-indigo-600');
            btn.innerText = 'éšè—';
        } else {
            container.innerText = '***';
            container.classList.add('bg-slate-100', 'text-slate-500');
            container.classList.remove('bg-indigo-50', 'text-indigo-600');
            btn.innerText = 'ç‚¹å‡»æŸ¥çœ‹';
        }
    }

    // å†»ç»“/è§£å†»å¡ç‰‡é€»è¾‘
    window.toggleCardFreeze = function(cardId) {
        const card = myCards.find(c => c.id == cardId);
        if (!card) return;

        if (card.status === 'active') {
            if(!confirm(`ç¡®å®šè¦å†»ç»“å¡ç‰‡ ${card.number.slice(-4)} å—ï¼Ÿ\nå†»ç»“åå°†æ— æ³•è¿›è¡Œäº¤æ˜“ã€‚`)) return;
            card.status = 'frozen';
            alert('â„ï¸ å¡ç‰‡å·²å†»ç»“');
        } else {
            card.status = 'active';
            alert('âœ… å¡ç‰‡å·²è§£å†»ï¼Œæ¢å¤æ­£å¸¸ä½¿ç”¨');
        }
        
        // åˆ·æ–°å½“å‰è¯¦æƒ…é¡µçŠ¶æ€
        showCardDetails(cardId);
        // åˆ·æ–°å¡ç‰‡åˆ—è¡¨é¡µ(å¦‚æœåº•è‰²æœ‰çŠ¶æ€åŒºåˆ†çš„è¯)
        if(document.querySelector('a[onclick="showView(\'cards\')"]').classList.contains('active')) {
            showView('cards'); 
        }
    }


    // --- 3. è¦†ç›–å¡ç‰‡è¯¦æƒ…å¼¹çª— (é›†æˆæ–°äº¤äº’) ---
    window.showCardDetails = function(cardId) {
        const card = myCards.find(c => c.id == cardId);
        if (!card) return;
        
        // åˆ¤æ–­çŠ¶æ€æ ·å¼
        const isFrozen = card.status === 'frozen';
        const statusColor = isFrozen ? 'text-red-600 bg-red-50 border-red-100' : 'text-green-600 bg-green-50 border-green-100';
        const statusText = isFrozen ? 'â— å·²å†»ç»“ (Frozen)' : 'â— æ­£å¸¸æ´»è·ƒ (Active)';
        const freezeBtnText = isFrozen ? 'è§£å†»å¡ç‰‡' : 'å†»ç»“å¡ç‰‡';
        const freezeBtnClass = isFrozen 
            ? 'bg-green-600 text-white hover:bg-green-700 border-transparent' 
            : 'bg-white text-red-600 border-red-200 hover:bg-red-50';

        const modalHTML = `
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center fade-in" id="modal-overlay">
            <div class="bg-white rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden flex flex-col md:flex-row">
                <div class="w-full md:w-1/2 bg-slate-900 p-8 flex items-center justify-center relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-indigo-500 rounded-full blur-3xl opacity-20 -translate-y-1/2 translate-x-1/2"></div>
                    <div class="w-full aspect-[1.58/1] rounded-xl ${card.type === 'Visa' ? 'visa-bg' : 'master-bg'} p-6 text-white shadow-2xl relative flex flex-col justify-between transform hover:scale-105 transition duration-500">
                        <div class="flex justify-between items-start">
                            <span class="font-bold italic tracking-wider opacity-80">${card.type.toUpperCase()}</span>
                            <span class="text-[10px] bg-white/20 px-2 py-1 rounded backdrop-blur-md">${card.product}</span>
                        </div>
                        <div class="font-mono text-xl tracking-widest drop-shadow-md text-center my-4">${card.number}</div>
                        <div class="flex justify-between items-end">
                            <div><p class="text-[10px] opacity-60 uppercase">Card Holder</p><p class="text-sm font-medium tracking-wide">USER DEMO</p></div>
                            <div><p class="text-[10px] opacity-60 uppercase">Expires</p><p class="text-sm font-mono">${card.exp}</p></div>
                        </div>
                        ${isFrozen ? '<div class="absolute inset-0 bg-black/40 backdrop-blur-[2px] rounded-xl flex items-center justify-center"><span class="border-2 border-white px-4 py-1 text-white font-bold text-xl -rotate-12 opacity-80">FROZEN</span></div>' : ''}
                    </div>
                </div>

                <div class="w-full md:w-1/2 p-8 flex flex-col">
                    <div class="flex justify-between items-start mb-6">
                        <div><h3 class="text-xl font-bold text-slate-800">${card.name}</h3><p class="text-xs text-slate-400 font-mono mt-1">ID: ${card.id}</p></div>
                        <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 text-2xl leading-none">&times;</button>
                    </div>

                    <div class="space-y-5 mb-8 flex-1">
                        <div class="flex justify-between items-center py-2 border-b border-slate-50">
                            <span class="text-sm text-slate-500">å¡ç‰‡çŠ¶æ€</span>
                            <span class="text-xs font-bold px-2 py-1 rounded border ${statusColor}">${statusText}</span>
                        </div>
                        
                        <div class="flex justify-between items-center py-2 border-b border-slate-50">
                            <span class="text-sm text-slate-500">å½“å‰ä½™é¢</span>
                            <span class="text-2xl font-bold text-slate-800">$${card.balance.toFixed(2)}</span>
                        </div>

                        <div class="flex justify-between items-center py-2 border-b border-slate-50">
                            <span class="text-sm text-slate-500">å®‰å…¨ç  (CVV)</span>
                            <div class="flex items-center gap-3">
                                <span class="font-mono font-bold bg-slate-100 text-slate-500 px-3 py-1 rounded tracking-widest min-w-[3rem] text-center transition-colors">***</span>
                                <button onclick="toggleCVV(this, '${card.cvv}')" class="text-xs text-indigo-600 font-bold hover:text-indigo-700 hover:bg-indigo-50 px-2 py-1 rounded transition">ç‚¹å‡»æŸ¥çœ‹</button>
                            </div>
                        </div>
                        
                        <div class="py-1">
                            <p class="text-xs text-slate-400 mb-1">è´¦å•åœ°å€ (Billing Address)</p>
                            <p class="text-xs text-slate-600 bg-slate-50 p-2 rounded border border-slate-100">4522 SW 3rd St, Miami, FL 33125, US</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mt-auto">
                        <button onclick="closeModal(); openRechargeCardModal('${card.id}')" class="py-3 bg-indigo-600 text-white rounded-xl font-bold text-sm hover:bg-indigo-700 shadow-lg shadow-indigo-100 transition disabled:opacity-50 disabled:cursor-not-allowed" ${isFrozen ? 'disabled' : ''}>ç«‹å³å……å€¼</button>
                        <button onclick="toggleCardFreeze('${card.id}')" class="py-3 border rounded-xl font-bold text-sm transition shadow-sm ${freezeBtnClass}">${freezeBtnText}</button>
                    </div>
                </div>
            </div>
        </div>`;
        document.getElementById('modal-container').innerHTML = modalHTML;
    }
}
</script>
<script>
{
    // 1. åˆå§‹åŒ–æ•°æ®ï¼šç»™ç°æœ‰å¡ç‰‡è¡¥å……é»˜è®¤é™é¢ (é˜²æ­¢æŠ¥é”™)
    myCards.forEach(c => {
        if (typeof c.limit === 'undefined') c.limit = 5000.00; // é»˜è®¤é™é¢ 5000
    });

    // å®šä¹‰é™é¢è§„åˆ™
    const LIMIT_CONFIG = { min: 10, max: 50000 };

    // 2. æ–°å¢ï¼šå¼€å¡æˆåŠŸä¸“ç”¨æ¨¡æ€çª— (æ›¿ä»£ alert)
    window.showOpenCardSuccess = function(card) {
        const modalHTML = `
        <div class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[80] flex items-center justify-center fade-in">
            <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden transform transition-all scale-100 relative">
                <div class="h-2 w-full bg-gradient-to-r from-green-400 to-emerald-600"></div>
                
                <div class="p-8 text-center">
                    <div class="w-20 h-20 bg-green-50 rounded-full flex items-center justify-center mx-auto mb-6 animate-bounce">
                        <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center shadow-lg shadow-green-200">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </div>
                    </div>
                    
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">å¼€å¡æˆåŠŸï¼</h2>
                    <p class="text-slate-500 text-sm mb-8">æ‚¨çš„è™šæ‹Ÿå¡å·²ç”Ÿæˆå¹¶æ¿€æ´»ï¼Œå³åˆ»å¯ç”¨ã€‚</p>

                    <div class="bg-slate-50 border border-slate-100 rounded-xl p-4 mb-8 flex items-center gap-4 text-left relative overflow-hidden">
                        <div class="absolute right-0 top-0 h-full w-1 bg-${card.type === 'Visa' ? 'blue' : 'orange'}-500"></div>
                        <div class="w-12 h-8 ${card.type === 'Visa' ? 'visa-bg' : 'master-bg'} rounded flex items-center justify-center text-[10px] text-white font-bold italic shadow-sm">${card.type}</div>
                        <div>
                            <p class="font-bold text-slate-700 text-sm">${card.name}</p>
                            <p class="text-xs text-slate-400 font-mono mt-0.5">**** ${card.number.slice(-4)}</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="closeModal(); showCardDetails('${card.id}')" class="py-3 border border-slate-200 text-slate-600 font-bold rounded-xl hover:bg-slate-50 transition">æŸ¥çœ‹è¯¦æƒ…</button>
                        <button onclick="closeModal(); showView('cards')" class="py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 shadow-lg shadow-indigo-100 transition">æˆ‘çŸ¥é“äº†</button>
                    </div>
                </div>
            </div>
        </div>`;
        document.getElementById('modal-container').innerHTML = modalHTML;
    }

    // 3. è¦†ç›–ï¼šå¼€å¡å¤„ç†é€»è¾‘ (æ¥å…¥æ–°å¼¹çª—)
    window.processOpenCard = function() {
        const btn = event.target;
        const amountInput = document.getElementById('open-amount');
        const amount = parseFloat(amountInput.value);
        
        if (!amount || amount < 0) return alert('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢');
        if (amount > currentUser.balance) return alert('é’±åŒ…ä½™é¢ä¸è¶³ï¼Œè¯·å…ˆå……å€¼');

        btn.innerText = 'å¤„ç†ä¸­...';
        btn.disabled = true;
        
        setTimeout(() => {
            closeModal(); // å…³é—­ç”³è¯·å¼¹çª—
            // ç§»é™¤æ–°æ‰‹å¼•å¯¼(å¦‚æœæœ‰)
            if(window.removeGuide) window.removeGuide();

            // åˆ›å»ºæ–°å¡æ•°æ®
            const newCard = { 
                id: 'c_' + Date.now(), 
                name: 'New Virtual Card', 
                number: '4288' + Math.floor(Math.random() * 100000000000), 
                cvv: Math.floor(100 + Math.random() * 900), 
                exp: '12/28', 
                balance: amount, 
                status: 'active', 
                type: 'Visa', 
                product: 'Amazon æµ·æ·˜è´­ç‰©å¡',
                limit: 5000 // åˆå§‹é™é¢
            };
            
            myCards.unshift(newCard);
            currentUser.balance -= (amount + 2); // æ‰£é™¤é‡‘é¢+å¼€å¡è´¹
            currentUser.cardBalance += amount;
            
            // æ›´æ–°ä½™é¢æ˜¾ç¤º
            document.getElementById('nav-total-balance').innerText = (currentUser.balance + currentUser.cardBalance).toLocaleString(undefined, {minimumFractionDigits: 2});

            // === å…³é”®å˜åŒ–ï¼šè°ƒç”¨æ–°çš„æˆåŠŸå¼¹çª— ===
            showOpenCardSuccess(newCard);

            // è§¦å‘æ–°æ‰‹å¼•å¯¼ä¸‹ä¸€æ­¥ (å¦‚æœæœ‰)
            if (typeof currentGuideStep !== 'undefined' && currentGuideStep === 2) {
                setTimeout(runGuideStep3, 500); 
            } else {
                showView('cards'); // åˆ·æ–°åˆ—è¡¨
            }
        }, 1000);
    }

    // 4. æ–°å¢ï¼šè®¾ç½®é™é¢å¼¹çª—
    window.openSetLimitModal = function(cardId) {
        const card = myCards.find(c => c.id == cardId);
        if (!card) return;

        const modalHTML = `
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[90] flex items-center justify-center fade-in">
            <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="font-bold text-slate-800">è®¾ç½®å•ç¬”äº¤æ˜“é™é¢</h3>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
                </div>
                <div class="p-6 space-y-6">
                    <div class="bg-blue-50 rounded-xl p-4 flex items-start gap-3 border border-blue-100">
                        <svg class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2"/></svg>
                        <p class="text-xs text-blue-800 leading-relaxed">æ­¤è®¾ç½®ä»…é™åˆ¶<b>å•ç¬”äº¤æ˜“</b>çš„æœ€å¤§é‡‘é¢ã€‚è®¾ç½®å®æ—¶ç”Ÿæ•ˆï¼Œå¯ç”¨äºé£é™©æ§åˆ¶ã€‚</p>
                    </div>
                    
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-xs font-bold text-slate-500">äº¤æ˜“é™é¢ (USD)</label>
                            <span class="text-[10px] font-bold text-slate-400">èŒƒå›´: $${LIMIT_CONFIG.min} - $${LIMIT_CONFIG.max.toLocaleString()}</span>
                        </div>
                        <div class="relative">
                            <span class="absolute left-4 top-3 text-slate-400 font-bold">$</span>
                            <input type="number" id="limit-input" class="w-full pl-8 pr-4 py-3 border border-slate-200 rounded-xl font-bold text-slate-800 focus:ring-2 focus:ring-indigo-500 outline-none transition" value="${card.limit}" placeholder="5000">
                        </div>
                        <p id="limit-error" class="text-xs text-red-500 mt-2 font-bold hidden animate-pulse">âš ï¸ é™é¢è¶…å‡ºå…è®¸èŒƒå›´ï¼Œæ— æ³•è®¾ç½®</p>
                    </div>

                    <button onclick="handleSaveLimit('${card.id}')" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 transition">ä¿å­˜è®¾ç½®</button>
                </div>
            </div>
        </div>`;
        
        // å¦‚æœå½“å‰æœ‰å…¶ä»–å¼¹çª—(æ¯”å¦‚è¯¦æƒ…é¡µ)ï¼Œå…ˆè®°å½•ä¸‹æ¥ä»¥ä¾¿è¿”å›ï¼Œæˆ–è€…ç®€å•å¤„ç†ç›´æ¥è¦†ç›–
        // è¿™é‡Œä¸ºäº†ç®€å•ï¼Œç›´æ¥è¦†ç›–å†…å®¹ï¼Œè‹¥è¦è¿”å›ä½“éªŒæ›´å¥½éœ€åšæ ˆç®¡ç†ã€‚è¿™é‡Œå‡è®¾ç”¨æˆ·è®¾ç½®å®Œå°±å›åˆ°åˆ—è¡¨æˆ–è¯¦æƒ…ã€‚
        document.getElementById('modal-container').innerHTML = modalHTML;
    }

    // 5. æ–°å¢ï¼šä¿å­˜é™é¢é€»è¾‘
    window.handleSaveLimit = function(cardId) {
        const input = document.getElementById('limit-input');
        const errorMsg = document.getElementById('limit-error');
        const val = parseFloat(input.value);
        const card = myCards.find(c => c.id == cardId);

        // æ ¡éªŒé€»è¾‘
        if (!val || val < LIMIT_CONFIG.min || val > LIMIT_CONFIG.max) {
            input.classList.add('border-red-500', 'bg-red-50');
            input.classList.remove('border-slate-200');
            errorMsg.classList.remove('hidden');
            return; // é˜»æ­¢ä¿å­˜
        }

        // ä¿å­˜
        card.limit = val;
        
        // æˆåŠŸæç¤º (ä½¿ç”¨ä¹‹å‰çš„ showAlertModalï¼Œå¦‚æœå­˜åœ¨çš„è¯ï¼Œä¸å­˜åœ¨ç”¨alert)
        if(window.showAlertModal) {
            showAlertModal('è®¾ç½®æˆåŠŸ', `å¡ç‰‡ ${card.number.slice(-4)} å•ç¬”é™é¢å·²æ›´æ–°ä¸º $${val.toLocaleString()}`, 'success');
        } else {
            alert(`âœ… è®¾ç½®æˆåŠŸï¼\nå•ç¬”é™é¢å·²æ›´æ–°ä¸º $${val.toLocaleString()}`);
            closeModal();
        }
        
        // å¦‚æœæ˜¯åœ¨è¯¦æƒ…é¡µè§¦å‘çš„ï¼Œç†è®ºä¸Šåº”è¯¥åˆ·æ–°è¯¦æƒ…é¡µã€‚
        // ä½†ç”±äº openSetLimitModal è¦†ç›–äº† modal-containerï¼Œæˆ‘ä»¬åªéœ€å…³é—­å³å¯ã€‚
        // ç”¨æˆ·å¯ä»¥é‡æ–°ç‚¹è¯¦æƒ…æŸ¥çœ‹ã€‚
    }

    // 6. è¦†ç›–ï¼šå¡ç‰‡è¯¦æƒ…é¡µ (å¢åŠ â€œé™é¢è®¾ç½®â€å…¥å£)
    // æˆ‘ä»¬éœ€è¦é‡æ–°å®šä¹‰ showCardDetailsï¼ŒæŠŠé™é¢è¡ŒåŠ è¿›å»
    window.showCardDetails = function(cardId) {
        const card = myCards.find(c => c.id == cardId);
        if (!card) return;
        
        const isFrozen = card.status === 'frozen';
        const statusColor = isFrozen ? 'text-red-600 bg-red-50 border-red-100' : 'text-green-600 bg-green-50 border-green-100';
        const statusText = isFrozen ? 'â— å·²å†»ç»“ (Frozen)' : 'â— æ­£å¸¸æ´»è·ƒ (Active)';
        
        // ç¡®ä¿æœ‰ limit å±æ€§
        if(!card.limit) card.limit = 5000;

        const modalHTML = `
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center fade-in" id="modal-overlay">
            <div class="bg-white rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden flex flex-col md:flex-row">
                <div class="w-full md:w-1/2 bg-slate-900 p-8 flex items-center justify-center relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-indigo-500 rounded-full blur-3xl opacity-20 -translate-y-1/2 translate-x-1/2"></div>
                    <div class="w-full aspect-[1.58/1] rounded-xl ${card.type === 'Visa' ? 'visa-bg' : 'master-bg'} p-6 text-white shadow-2xl relative flex flex-col justify-between transform hover:scale-105 transition duration-500">
                        <div class="flex justify-between items-start">
                            <span class="font-bold italic tracking-wider opacity-80">${card.type.toUpperCase()}</span>
                            <span class="text-[10px] bg-white/20 px-2 py-1 rounded backdrop-blur-md">${card.product}</span>
                        </div>
                        <div class="font-mono text-xl tracking-widest drop-shadow-md text-center my-4">${card.number}</div>
                        <div class="flex justify-between items-end">
                            <div><p class="text-[10px] opacity-60 uppercase">Card Holder</p><p class="text-sm font-medium tracking-wide">USER DEMO</p></div>
                            <div><p class="text-[10px] opacity-60 uppercase">Expires</p><p class="text-sm font-mono">${card.exp}</p></div>
                        </div>
                        ${isFrozen ? '<div class="absolute inset-0 bg-black/40 backdrop-blur-[2px] rounded-xl flex items-center justify-center"><span class="border-2 border-white px-4 py-1 text-white font-bold text-xl -rotate-12 opacity-80">FROZEN</span></div>' : ''}
                    </div>
                </div>

                <div class="w-full md:w-1/2 p-8 flex flex-col">
                    <div class="flex justify-between items-start mb-6">
                        <div><h3 class="text-xl font-bold text-slate-800">${card.name}</h3><p class="text-xs text-slate-400 font-mono mt-1">ID: ${card.id}</p></div>
                        <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 text-2xl leading-none">&times;</button>
                    </div>

                    <div class="space-y-4 mb-8 flex-1">
                        <div class="flex justify-between items-center py-2 border-b border-slate-50">
                            <span class="text-sm text-slate-500">å¡ç‰‡çŠ¶æ€</span>
                            <span class="text-xs font-bold px-2 py-1 rounded border ${statusColor}">${statusText}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-slate-50">
                            <span class="text-sm text-slate-500">å½“å‰ä½™é¢</span>
                            <span class="text-2xl font-bold text-slate-800">$${card.balance.toFixed(2)}</span>
                        </div>
                        
                        <div class="flex justify-between items-center py-2 border-b border-slate-50">
                            <div class="flex flex-col">
                                <span class="text-sm text-slate-500">å•ç¬”é™é¢</span>
                                <span class="text-[10px] text-slate-400">Transaction Limit</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-slate-800">$${card.limit.toLocaleString()}</span>
                                <button onclick="openSetLimitModal('${card.id}')" class="w-6 h-6 rounded-full bg-slate-100 hover:bg-indigo-100 text-slate-400 hover:text-indigo-600 flex items-center justify-center transition" title="ä¿®æ”¹é™é¢">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" stroke-width="2"/></svg>
                                </button>
                            </div>
                        </div>

                        <div class="flex justify-between items-center py-2 border-b border-slate-50">
                            <span class="text-sm text-slate-500">å®‰å…¨ç  (CVV)</span>
                            <div class="flex items-center gap-3">
                                <span class="font-mono font-bold bg-slate-100 text-slate-500 px-3 py-1 rounded tracking-widest min-w-[3rem] text-center transition-colors">***</span>
                                <button onclick="toggleCVV(this, '${card.cvv}')" class="text-xs text-indigo-600 font-bold hover:text-indigo-700 hover:bg-indigo-50 px-2 py-1 rounded transition">ç‚¹å‡»æŸ¥çœ‹</button>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mt-auto">
                        <button onclick="closeModal(); openRechargeCardModal('${card.id}')" class="py-3 bg-indigo-600 text-white rounded-xl font-bold text-sm hover:bg-indigo-700 shadow-lg shadow-indigo-100 transition disabled:opacity-50 disabled:cursor-not-allowed" ${isFrozen ? 'disabled' : ''}>ç«‹å³å……å€¼</button>
                        <button onclick="toggleCardFreeze('${card.id}')" class="py-3 border rounded-xl font-bold text-sm transition shadow-sm ${isFrozen ? 'bg-green-600 text-white hover:bg-green-700 border-transparent' : 'bg-white text-red-600 border-red-200 hover:bg-red-50'}">${isFrozen ? 'è§£å†»å¡ç‰‡' : 'å†»ç»“å¡ç‰‡'}</button>
                    </div>
                </div>
            </div>
        </div>`;
        document.getElementById('modal-container').innerHTML = modalHTML;
    }
}
</script>
<script>
{
    // 1. å®šä¹‰æ–°çš„å¡æ®µ (BIN) æ•°æ®æº (æ¨¡æ‹Ÿæˆªå›¾ä¸­çš„æ•°æ®)
    const binList = [
        { bin: '52737560', net: 'Mastercard', type: 'Credit', platforms: ['wechat', 'alipay', 'paypal', 'amazon', 'google'], rate: 99, fee: 2.0 },
        { bin: '52737597', net: 'Mastercard', type: 'Debit', platforms: ['wechat', 'alipay', 'google', 'amazon'], rate: 99, fee: 2.0 },
        { bin: '54492360', net: 'Mastercard', type: 'Credit', platforms: ['wechat', 'alipay', 'paypal', 'amazon'], rate: 99, fee: 3.5 },
        { bin: '54493747', net: 'Mastercard', type: 'Prepaid', platforms: ['alipay', 'paypal', 'google', 'amazon'], rate: 99, fee: 1.0 },
        { bin: '558325', net: 'Mastercard', type: 'Credit', platforms: ['paypal', 'google', 'amazon', 'wechat'], rate: 96, fee: 5.0 },
        { bin: '53211359', net: 'Mastercard', type: 'Debit', platforms: ['wechat', 'alipay', 'google', 'amazon'], rate: 96, fee: 0.0 }
    ];

    let selectedBinIndex = 0; // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
    let isLimitExpanded = false; // é™é¢åŒºåŸŸé»˜è®¤æ”¶èµ·

    // 2. é‡å†™ Apply è§†å›¾ (å®Œå…¨æ›¿æ¢åŸæœ‰ç½‘æ ¼è§†å›¾)
    views.apply = () => {
        const selectedBin = binList[selectedBinIndex];
        
        // ç”Ÿæˆå¹³å°å›¾æ ‡è¾…åŠ©å‡½æ•°
        const renderIcons = (platforms) => {
            const iconMap = {
                'wechat': '<span class="text-green-500 bg-green-50 p-1 rounded-full text-xs">å¾®ä¿¡</span>',
                'alipay': '<span class="text-blue-500 bg-blue-50 p-1 rounded-full text-xs">æ”¯</span>',
                'paypal': '<span class="text-indigo-600 bg-indigo-50 p-1 rounded-full text-xs">Pay</span>',
                'google': '<span class="text-red-500 bg-red-50 p-1 rounded-full text-xs">G</span>',
                'amazon': '<span class="text-orange-500 bg-orange-50 p-1 rounded-full text-xs">Amz</span>'
            };
            return platforms.map(p => iconMap[p] || '').join(' ');
        };

        return `
        <div class="max-w-5xl mx-auto fade-in pb-20">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8">
                <h2 class="text-xl font-bold text-slate-800 mb-6">ç”³è¯·æ–°å¡ (New Card)</h2>
                
                <div class="mb-8">
                    <label class="block text-xs font-bold text-slate-500 mb-3">ä½¿ç”¨åœºæ™¯ (Scenarios)</label>
                    <div class="flex gap-3">
                        <button class="px-5 py-2 bg-indigo-50 text-indigo-600 border border-indigo-200 rounded-lg text-sm font-bold shadow-sm">ç”µå•†/ç‹¬ç«‹ç«™</button>
                        <button class="px-5 py-2 bg-white text-slate-600 border border-slate-200 rounded-lg text-sm hover:bg-slate-50 transition">å¹¿å‘ŠæŠ•æ”¾</button>
                        <button class="px-5 py-2 bg-white text-slate-600 border border-slate-200 rounded-lg text-sm hover:bg-slate-50 transition">è®¢é˜…æœåŠ¡</button>
                        <button class="px-5 py-2 bg-white text-slate-600 border border-slate-200 rounded-lg text-sm hover:bg-slate-50 transition">å•†åŠ¡æ—…è¡Œ</button>
                    </div>
                </div>

                <div class="mb-8 max-w-xs">
                    <label class="block text-xs font-bold text-slate-500 mb-3">å¸ç§ (Currency)</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <img src="https://flagcdn.com/w20/us.png" class="w-5 h-3.5 rounded-sm shadow-sm">
                        </div>
                        <select class="w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-bold text-slate-700 outline-none appearance-none cursor-not-allowed" disabled>
                            <option>USD - ç¾å…ƒ</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                            <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7" stroke-width="2"/></svg>
                        </div>
                    </div>
                </div>

                <div class="mb-8">
                    <div class="flex justify-between items-end mb-3">
                        <label class="block text-xs font-bold text-slate-500">å¡ BIN æ¨è</label>
                        <span class="text-[10px] text-slate-400">ç‚¹å‡»è¡Œå¯åˆ‡æ¢é€‰æ‹©</span>
                    </div>
                    <div class="border border-slate-200 rounded-xl overflow-hidden">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 border-b border-slate-200 text-slate-500 font-medium">
                                <tr>
                                    <th class="px-5 py-3 w-16">é€‰æ‹©</th>
                                    <th class="px-5 py-3">å¡ BIN</th>
                                    <th class="px-5 py-3">æ”¯æŒå¹³å°</th>
                                    <th class="px-5 py-3 text-right">äº¤æ˜“æˆåŠŸç‡</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                ${binList.map((item, index) => `
                                    <tr onclick="selectBinItem(${index})" class="cursor-pointer transition hover:bg-slate-50 ${selectedBinIndex === index ? 'bg-indigo-50/50' : ''}">
                                        <td class="px-5 py-4">
                                            <div class="w-4 h-4 rounded-full border ${selectedBinIndex === index ? 'border-indigo-600 bg-indigo-600' : 'border-slate-300 bg-white'} flex items-center justify-center">
                                                ${selectedBinIndex === index ? '<div class="w-1.5 h-1.5 rounded-full bg-white"></div>' : ''}
                                            </div>
                                        </td>
                                        <td class="px-5 py-4">
                                            <div class="flex items-center gap-2">
                                                <span class="font-mono font-bold text-slate-800 text-lg">${item.bin}</span>
                                                <div class="w-8 h-5 bg-slate-800 rounded flex items-center justify-center"><div class="w-3 h-3 rounded-full bg-red-500 opacity-80 -mr-1"></div><div class="w-3 h-3 rounded-full bg-yellow-500 opacity-80"></div></div>
                                            </div>
                                        </td>
                                        <td class="px-5 py-4">
                                            <div class="flex gap-2 items-center">
                                                ${renderIcons(item.platforms)}
                                            </div>
                                        </td>
                                        <td class="px-5 py-4 text-right">
                                            <span class="font-bold text-green-600">${item.rate}%</span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs font-bold text-slate-500">å¼€å¡æ•°é‡ (å¼ )</label>
                            <span class="text-[10px] text-slate-400">å‰©ä½™å¯å¼€: 295</span>
                        </div>
                        <select id="apply-qty" class="w-full px-4 py-3 border border-slate-200 rounded-xl text-sm font-bold text-slate-800 focus:ring-2 focus:ring-indigo-500 outline-none appearance-none bg-white">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="5">5</option>
                            <option value="10">10</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-2">å¡ç‰‡æ˜µç§° (é€‰å¡«)</label>
                        <input type="text" id="apply-nickname" class="w-full px-4 py-3 border border-slate-200 rounded-xl text-sm font-bold text-slate-800 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="ä¾‹å¦‚ï¼šFB å¹¿å‘ŠæŠ•æ”¾ Aç»„">
                    </div>
                </div>

                <div class="mb-8 border border-slate-200 rounded-xl overflow-hidden">
                    <div onclick="toggleLimitSection()" class="w-full px-6 py-4 bg-white flex items-center justify-between cursor-pointer hover:bg-slate-50 transition">
                        <div class="flex items-center gap-2">
                            <label class="text-sm font-bold text-slate-800 cursor-pointer">è®¾ç½®äº¤æ˜“é™é¢ (é€‰å¡«)</label>
                            ${!isLimitExpanded ? '<span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded">é»˜è®¤ä¸é™</span>' : ''}
                        </div>
                        <div class="flex items-center gap-3">
                            ${isLimitExpanded ? '<span class="text-xs text-indigo-600 hover:underline z-10" onclick="event.stopPropagation(); clearLimits()">ğŸ—‘ æ¸…ç©ºé™é¢</span>' : ''}
                            <svg class="w-5 h-5 text-slate-400 transform transition ${isLimitExpanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7" stroke-width="2"/></svg>
                        </div>
                    </div>
                    
                    <div class="${isLimitExpanded ? 'block' : 'hidden'} px-6 pb-6 pt-2 bg-slate-50 border-t border-slate-200 fade-in">
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-slate-500 mb-1">å•ç¬”æœ€å¤§äº¤æ˜“é¢åº¦</label>
                                <div class="relative"><input type="number" class="limit-input w-full pl-4 pr-12 py-2 border border-slate-200 rounded-lg text-sm outline-none focus:border-indigo-500" placeholder="20000"><span class="absolute right-3 top-2 text-xs font-bold text-slate-400">USD</span></div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-500 mb-1">æ—¥äº¤æ˜“é™é¢</label>
                                <div class="relative"><input type="number" class="limit-input w-full pl-4 pr-12 py-2 border border-slate-200 rounded-lg text-sm outline-none focus:border-indigo-500" placeholder="20000"><span class="absolute right-3 top-2 text-xs font-bold text-slate-400">USD</span></div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-500 mb-1">æœˆäº¤æ˜“é™é¢</label>
                                <div class="relative"><input type="number" class="limit-input w-full pl-4 pr-12 py-2 border border-slate-200 rounded-lg text-sm outline-none focus:border-indigo-500" placeholder="50000"><span class="absolute right-3 top-2 text-xs font-bold text-slate-400">USD</span></div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-500 mb-1">äº¤æ˜“é™é¢ç±»å‹</label>
                                <select class="w-full px-4 py-2 border border-slate-200 rounded-lg text-sm outline-none bg-white"><option>ä¸é™</option><option>ä»…é™æ¶ˆè´¹</option></select>
                            </div>
                         </div>
                         <p class="text-[10px] text-slate-400 mt-3">* è®¾ç½®é™é¢å¯æœ‰æ•ˆé˜²æ­¢ç›—åˆ·å’Œæ„å¤–æ‰£è´¹ï¼Œå»ºè®®æ ¹æ®å®é™…ä¸šåŠ¡å¡«å†™ã€‚</p>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row items-center justify-between gap-6 border-t border-slate-100 pt-6">
                    <div class="text-sm space-y-1">
                        <div class="flex items-center gap-8 text-slate-600">
                            <span>æ¯å¼ å¡å¼€å¡è´¹: <span class="font-bold text-slate-800">$${selectedBin.fee.toFixed(2)}</span></span>
                            <span>æœˆç®¡ç†è´¹: <span class="font-bold text-slate-800">$0.00 / æœˆ</span></span>
                        </div>
                    </div>
                    <div class="flex gap-4 w-full md:w-auto">
                        <button onclick="showView('dashboard')" class="px-6 py-3 border border-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-50 transition">è¿”å›</button>
                        <button onclick="handleApplyNext()" class="px-8 py-3 bg-amber-400 hover:bg-amber-500 text-slate-900 rounded-xl font-bold shadow-lg shadow-orange-100 transition flex-1 md:flex-none">ä¸‹ä¸€æ­¥</button>
                    </div>
                </div>

            </div>
        </div>`;
    }

    // 3. è¾…åŠ©é€»è¾‘å‡½æ•°
    
    // é€‰æ‹© BIN è¡Œ
    window.selectBinItem = function(index) {
        selectedBinIndex = index;
        showView('apply'); // åˆ·æ–°è§†å›¾ä»¥æ›´æ–°é€‰ä¸­æ€
    }

    // åˆ‡æ¢é™é¢åŒºåŸŸæ˜¾ç¤º
    window.toggleLimitSection = function() {
        isLimitExpanded = !isLimitExpanded;
        showView('apply'); // åˆ·æ–°è§†å›¾
    }

    // æ¸…ç©ºé™é¢è¾“å…¥
    window.clearLimits = function() {
        // è¿™é‡Œç”±äºæ¯æ¬¡åˆ·æ–°è§†å›¾ input éƒ½ä¼šé‡ç½®ï¼ˆå› ä¸ºæ²¡æœ‰åšåŒå‘ç»‘å®šåˆ°å˜é‡ï¼‰ï¼Œ
        // æ‰€ä»¥ç®€å•é‡æ–°æ¸²æŸ“å³å¯æ¸…ç©ºï¼Œæˆ–è€…æ‰‹åŠ¨æ¸…ç©º DOMã€‚
        // ç®€å•èµ·è§ï¼Œç›´æ¥é‡æ–°æ¸²æŸ“å¹¶æ”¶èµ·
        isLimitExpanded = false;
        showView('apply');
        if(window.showAlertModal) showAlertModal('æç¤º', 'é™é¢è®¾ç½®å·²é‡ç½®ä¸ºé»˜è®¤çŠ¶æ€ã€‚', 'success');
    }

    // ç‚¹å‡»â€œä¸‹ä¸€æ­¥â€ -> å¼¹å‡ºç¡®è®¤/æ”¯ä»˜å¼¹çª—
    window.handleApplyNext = function() {
        const bin = binList[selectedBinIndex];
        const qty = parseInt(document.getElementById('apply-qty').value);
        const nickname = document.getElementById('apply-nickname').value || 'æœªå‘½åå¡ç‰‡';
        
        // éªŒè¯
        const totalFee = bin.fee * qty;
        // å‡è®¾æ¯å¼ å¡æœ€ä½å……å€¼ 10 USD
        const minRechargePerCard = 10; 
        const totalRecharge = minRechargePerCard * qty;
        const totalCost = totalFee + totalRecharge;

        // å¼¹å‡ºç¡®è®¤æ”¯ä»˜æ¨¡æ€çª— (å¤ç”¨å¹¶æ”¹é€  openCreateCardModal çš„é€»è¾‘ï¼Œæˆ–è€…æ‰‹å†™ä¸€ä¸ªæ›´åŒ¹é…çš„)
        const modalHTML = `
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[80] flex items-center justify-center fade-in">
            <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                    <h3 class="font-bold text-slate-800">ç¡®è®¤å¼€å¡ä¿¡æ¯</h3>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
                </div>
                <div class="p-6">
                    <div class="bg-indigo-50 rounded-xl p-4 mb-6 border border-indigo-100">
                        <div class="flex justify-between mb-2"><span class="text-sm text-slate-500">å¡æ®µ (BIN)</span><span class="font-bold text-slate-800 font-mono">${bin.bin} (${bin.type})</span></div>
                        <div class="flex justify-between mb-2"><span class="text-sm text-slate-500">å¼€å¡æ•°é‡</span><span class="font-bold text-slate-800">${qty} å¼ </span></div>
                        <div class="flex justify-between"><span class="text-sm text-slate-500">å¡ç‰‡æ˜µç§°</span><span class="font-bold text-slate-800 truncate max-w-[150px]">${nickname}</span></div>
                    </div>

                    <div class="space-y-3 mb-8">
                        <div class="flex justify-between items-center"><span class="text-sm text-slate-500">å¼€å¡æ‰‹ç»­è´¹ ($${bin.fee} Ã— ${qty})</span><span class="font-bold text-slate-800">$${totalFee.toFixed(2)}</span></div>
                        <div class="flex justify-between items-center"><span class="text-sm text-slate-500">é¢„å……å€¼é‡‘é¢ (æ¯å¼  $${minRechargePerCard})</span><span class="font-bold text-slate-800">$${totalRecharge.toFixed(2)}</span></div>
                        <div class="w-full h-px bg-slate-100 my-2"></div>
                        <div class="flex justify-between items-center"><span class="font-bold text-slate-800">åˆè®¡æ‰£æ¬¾</span><span class="text-2xl font-bold text-red-600">$${totalCost.toFixed(2)}</span></div>
                    </div>

                    <input type="hidden" id="open-amount" value="${totalCost}"> 

                    <button onclick="processOpenCard()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg transition">ç¡®è®¤æ”¯ä»˜å¹¶å¼€é€š</button>
                </div>
            </div>
        </div>`;
        
        document.getElementById('modal-container').innerHTML = modalHTML;
    }
}
</script>
<script>
{
    // 1. é‡å†™ï¼šç¡®è®¤å¼€å¡å¼¹çª— (handleApplyNext)
    // ç›®çš„ï¼šåœ¨ç¡®è®¤å¼¹çª—ä¸­åŸ‹å…¥ qty (æ•°é‡) å’Œ nickname (æ˜µç§°) çš„éšè—å­—æ®µï¼Œä¼ ç»™ä¸‹ä¸€æ­¥
    window.handleApplyNext = function() {
        const bin = typeof binList !== 'undefined' ? binList[selectedBinIndex] : { fee: 2, bin: '5273', type: 'Virtual' };
        const qtyInput = document.getElementById('apply-qty');
        const qty = qtyInput ? parseInt(qtyInput.value) : 1;
        const nicknameInput = document.getElementById('apply-nickname');
        const nickname = (nicknameInput && nicknameInput.value) ? nicknameInput.value : 'æœªå‘½åå¡ç‰‡';
        
        // è´¹ç”¨è®¡ç®—
        const feePerCard = bin.fee || 2;
        const totalFee = feePerCard * qty;
        const minRecharge = 10; // å‡è®¾æ¯å¼ å¡é¢„å……å€¼10U
        const totalRecharge = minRecharge * qty;
        const totalCost = totalFee + totalRecharge;

        const modalHTML = `
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[80] flex items-center justify-center fade-in">
            <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                    <h3 class="font-bold text-slate-800">ç¡®è®¤å¼€å¡ä¿¡æ¯</h3>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
                </div>
                <div class="p-6">
                    <div class="bg-indigo-50 rounded-xl p-4 mb-6 border border-indigo-100">
                        <div class="flex justify-between mb-2"><span class="text-sm text-slate-500">å¡æ®µ (BIN)</span><span class="font-bold text-slate-800 font-mono">${bin.bin}</span></div>
                        <div class="flex justify-between mb-2"><span class="text-sm text-slate-500">å¼€å¡æ•°é‡</span><span class="font-bold text-slate-800">${qty} å¼ </span></div>
                        <div class="flex justify-between"><span class="text-sm text-slate-500">æ‰¹æ¬¡/æ˜µç§°</span><span class="font-bold text-slate-800 truncate max-w-[150px]">${nickname}</span></div>
                    </div>

                    <div class="space-y-3 mb-8">
                        <div class="flex justify-between items-center"><span class="text-sm text-slate-500">æ€»å¼€å¡è´¹ ($${feePerCard} Ã— ${qty})</span><span class="font-bold text-slate-800">$${totalFee.toFixed(2)}</span></div>
                        <div class="flex justify-between items-center"><span class="text-sm text-slate-500">æ€»é¢„å……å€¼ ($${minRecharge} Ã— ${qty})</span><span class="font-bold text-slate-800">$${totalRecharge.toFixed(2)}</span></div>
                        <div class="w-full h-px bg-slate-100 my-2"></div>
                        <div class="flex justify-between items-center"><span class="font-bold text-slate-800">åˆè®¡æ‰£æ¬¾</span><span class="text-2xl font-bold text-red-600">$${totalCost.toFixed(2)}</span></div>
                    </div>

                    <input type="hidden" id="open-amount" value="${totalCost}"> 
                    <input type="hidden" id="open-qty" value="${qty}">
                    <input type="hidden" id="open-single-recharge" value="${minRecharge}">
                    <input type="hidden" id="open-nickname" value="${nickname}">

                    <button onclick="processOpenCard()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg transition">ç¡®è®¤æ”¯ä»˜å¹¶å¼€é€š</button>
                </div>
            </div>
        </div>`;
        document.getElementById('modal-container').innerHTML = modalHTML;
    }

    // 2. é‡å†™ï¼šå¼€å¡å¤„ç†é€»è¾‘ (processOpenCard)
    // ç›®çš„ï¼šæ”¯æŒå¾ªç¯åˆ›å»ºå¤šå¼ å¡ç‰‡ï¼Œå¹¶ä¼ é€’æ•°ç»„ç»™æˆåŠŸå¼¹çª—
    window.processOpenCard = function() {
        const btn = event.target;
        const amount = parseFloat(document.getElementById('open-amount').value);
        const qty = parseInt(document.getElementById('open-qty').value) || 1;
        const singleRecharge = parseFloat(document.getElementById('open-single-recharge').value) || 10;
        const nickname = document.getElementById('open-nickname').value;

        if (amount > currentUser.balance) return alert('ä½™é¢ä¸è¶³');

        btn.innerText = `æ­£åœ¨åˆ›å»º ${qty} å¼ å¡ç‰‡...`;
        btn.disabled = true;
        
        setTimeout(() => {
            closeModal();
            if(window.removeGuide) window.removeGuide();

            // æ‰¹é‡ç”Ÿæˆå¡ç‰‡
            const newCardsBatch = [];
            for (let i = 0; i < qty; i++) {
                const newCard = { 
                    id: 'c_' + Date.now() + '_' + i, 
                    name: qty > 1 ? `${nickname} #${i+1}` : nickname, // æ‰¹é‡æ—¶è‡ªåŠ¨åŠ ç¼–å·
                    number: '5273' + Math.floor(Math.random() * 100000000000), 
                    cvv: Math.floor(100 + Math.random() * 900), 
                    exp: '12/29', 
                    balance: singleRecharge, 
                    status: 'active', 
                    type: 'Mastercard', 
                    product: 'Facebook å¹¿å‘Šå¡',
                    limit: 5000
                };
                myCards.unshift(newCard);
                newCardsBatch.push(newCard);
            }
            
            // æ‰£æ¬¾
            currentUser.balance -= amount; 
            currentUser.cardBalance += (singleRecharge * qty);
            document.getElementById('nav-total-balance').innerText = (currentUser.balance + currentUser.cardBalance).toLocaleString(undefined, {minimumFractionDigits: 2});

            // === è°ƒç”¨æ–°çš„å…¼å®¹ç‰ˆæˆåŠŸå¼¹çª— (ä¼ å…¥æ•°ç»„) ===
            showOpenCardSuccess(newCardsBatch);

            // åˆ·æ–°åˆ—è¡¨
            if(typeof showView === 'function') showView('cards');
        }, 1500);
    }

    // 3. é‡å†™ï¼šæˆåŠŸå¼¹çª— (showOpenCardSuccess)
    // ç›®çš„ï¼šæ ¹æ®ä¼ å…¥æ˜¯ 1 å¼ å¡è¿˜æ˜¯ å¤šå¼ å¡ï¼Œæ¸²æŸ“ä¸åŒçš„ UI
    window.showOpenCardSuccess = function(cards) {
        // å¦‚æœä¼ å…¥çš„æ˜¯å•å¯¹è±¡ï¼Œè½¬ä¸ºæ•°ç»„
        const cardList = Array.isArray(cards) ? cards : [cards];
        const isBatch = cardList.length > 1;

        let contentHTML = '';

        if (!isBatch) {
            // === å•å¼ å¡ UI (ä¿æŒåŸæ ·) ===
            const card = cardList[0];
            contentHTML = `
                <div class="bg-slate-50 border border-slate-100 rounded-xl p-4 mb-8 flex items-center gap-4 text-left relative overflow-hidden shadow-sm">
                    <div class="absolute right-0 top-0 h-full w-1 bg-${card.type === 'Visa' ? 'blue' : 'orange'}-500"></div>
                    <div class="w-12 h-8 ${card.type === 'Visa' ? 'visa-bg' : 'master-bg'} rounded flex items-center justify-center text-[10px] text-white font-bold italic shadow-sm">${card.type}</div>
                    <div>
                        <p class="font-bold text-slate-700 text-sm">${card.name}</p>
                        <p class="text-xs text-slate-400 font-mono mt-0.5">${card.number}</p>
                    </div>
                </div>`;
        } else {
            // === æ‰¹é‡å¡ UI (åˆ—è¡¨æ¸…å•) ===
            contentHTML = `
                <div class="bg-slate-50 border border-slate-200 rounded-xl overflow-hidden mb-6 text-left">
                    <div class="px-4 py-2 bg-slate-100 border-b border-slate-200 flex justify-between items-center">
                        <span class="text-xs font-bold text-slate-600">å·²ç”Ÿæˆ ${cardList.length} å¼ å¡ç‰‡</span>
                        <button class="text-[10px] text-indigo-600 font-bold hover:underline">å¯¼å‡º Excel</button>
                    </div>
                    <div class="max-h-48 overflow-y-auto custom-scrollbar divide-y divide-slate-100">
                        ${cardList.map((c, i) => `
                            <div class="px-4 py-3 flex justify-between items-center hover:bg-white transition">
                                <div class="flex items-center gap-3">
                                    <span class="text-xs text-slate-400 font-mono w-4">${i+1}.</span>
                                    <div>
                                        <p class="text-xs font-bold text-slate-700 font-mono">${c.number}</p>
                                        <p class="text-[10px] text-slate-400">${c.name}</p>
                                    </div>
                                </div>
                                <span class="text-xs font-bold text-green-600">$${c.balance}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
        }

        const modalHTML = `
        <div class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[90] flex items-center justify-center fade-in">
            <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden transform transition-all scale-100 relative">
                <div class="h-2 w-full bg-gradient-to-r from-green-400 to-emerald-600"></div>
                
                <div class="p-8 text-center">
                    <div class="w-16 h-16 bg-green-50 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce">
                        <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center shadow-lg shadow-green-200">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </div>
                    </div>
                    
                    <h2 class="text-xl font-bold text-slate-800 mb-1">${isBatch ? 'æ‰¹é‡å¼€å¡æˆåŠŸï¼' : 'å¼€å¡æˆåŠŸï¼'}</h2>
                    <p class="text-slate-500 text-xs mb-6">å¡ç‰‡å·²æ¿€æ´»ï¼Œæ‚¨å¯ä»¥ç«‹å³ä½¿ç”¨ã€‚</p>

                    ${contentHTML}
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="closeModal(); showView('cards')" class="py-3 border border-slate-200 text-slate-600 font-bold rounded-xl hover:bg-slate-50 transition">ç®¡ç†å¡ç‰‡</button>
                        <button onclick="closeModal(); showView('apply')" class="py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 shadow-lg shadow-indigo-100 transition">ç»§ç»­å¼€å¡</button>
                    </div>
                </div>
            </div>
        </div>`;
        
        document.getElementById('modal-container').innerHTML = modalHTML;
    }
}
</script>
<script>
{
    // 1. ã€ä¿®å¤ç‚¹ã€‘é‡æ–°å®šä¹‰ç¼ºå¤±çš„çŠ¶æ€å˜é‡
    let selectedBinIndex = 0; 
    let isLimitExpanded = false;

    // 2. å®šä¹‰å¡æ®µæ•°æ® (å»é™¤æˆåŠŸç‡å­—æ®µï¼Œæ›´æ–°ä¸ºç³»ç»Ÿé…è‰²é£æ ¼æ•°æ®)
    const binList = [
        { bin: '52737560', net: 'Mastercard', type: 'Credit', platforms: ['wechat', 'alipay', 'paypal', 'amazon'], label: 'ç”µå•†é¦–é€‰', fee: 2.0 },
        { bin: '54492360', net: 'Mastercard', type: 'Credit', platforms: ['google', 'amazon', 'paypal'], label: 'å¹¿å‘Šä¸“ç”¨', fee: 3.5 },
        { bin: '48593220', net: 'Visa', type: 'Debit', platforms: ['openai', 'midjourney', 'notion'], label: 'AI è®¢é˜…', fee: 1.0 },
        { bin: '55832510', net: 'Mastercard', type: 'Prepaid', platforms: ['booking', 'agoda', 'uber'], label: 'å•†æ—…å‡ºè¡Œ', fee: 0.0 },
        { bin: '42881199', net: 'Visa', type: 'Credit', platforms: ['shopify', 'tiktok', 'facebook'], label: 'ç»¼åˆé€šç”¨', fee: 2.5 },
        { bin: '53211359', net: 'Mastercard', type: 'Debit', platforms: ['steam', 'nintendo', 'apple'], label: 'æ•°å­—å¨±ä¹', fee: 1.5 }
    ];

    // 3. é‡å†™ Apply è§†å›¾
    views.apply = () => {
        // ç¡®ä¿ç´¢å¼•ä¸è¶Šç•Œ
        if (selectedBinIndex >= binList.length) selectedBinIndex = 0;
        const selectedBin = binList[selectedBinIndex];
        
        // å¹³å°æ ‡ç­¾æ¸²æŸ“
        const renderTags = (platforms) => {
            const map = {
                'wechat': 'å¾®ä¿¡', 'alipay': 'æ”¯ä»˜å®', 'paypal': 'PayPal', 'amazon': 'äºšé©¬é€Š',
                'google': 'Google', 'openai': 'ChatGPT', 'facebook': 'FB Ads', 'tiktok': 'TikTok'
            };
            return platforms.slice(0, 4).map(p => map[p] || p).map(t => `<span class="text-[10px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded">${t}</span>`).join('');
        };

        // è®¡ç®—å½“å‰é€‰ä¸­å¡ç‰‡çš„æ€»ä»·é¢„è§ˆ
        const qty = document.getElementById('apply-qty') ? parseInt(document.getElementById('apply-qty').value) : 1;
        const previewTotal = (selectedBin.fee * qty) + (10 * qty); // å‡è®¾é¢„å……10

        return `
        <div class="max-w-6xl mx-auto fade-in pb-20">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-xl font-bold text-slate-800">ç”³è¯·æ–°å¡ (Issue Card)</h2>
                        <p class="text-xs text-slate-400 mt-1">è¯·é€‰æ‹©é€‚åˆæ‚¨ä¸šåŠ¡åœºæ™¯çš„å¡æ®µ</p>
                    </div>
                    <div class="flex gap-2">
                         <span class="px-3 py-1 bg-indigo-50 text-indigo-600 rounded-full text-xs font-bold">ä½™é¢: $${currentUser.balance.toLocaleString(undefined, {minimumFractionDigits: 2})}</span>
                    </div>
                </div>
                
                <div class="mb-6 border-b border-slate-100">
                    <div class="flex gap-6">
                        <button class="pb-3 text-sm font-bold text-indigo-600 border-b-2 border-indigo-600 transition">å…¨éƒ¨å¡æ®µ</button>
                        <button class="pb-3 text-sm font-medium text-slate-500 hover:text-slate-700 transition">å¹¿å‘ŠæŠ•æ”¾</button>
                        <button class="pb-3 text-sm font-medium text-slate-500 hover:text-slate-700 transition">ç”µå•†æµ·æ·˜</button>
                        <button class="pb-3 text-sm font-medium text-slate-500 hover:text-slate-700 transition">ä¼ä¸šæœåŠ¡</button>
                    </div>
                </div>

                <div class="mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${binList.map((item, index) => {
                            const isSelected = selectedBinIndex === index;
                            return `
                            <div onclick="selectBinItem(${index})" class="relative border-2 rounded-xl p-5 cursor-pointer transition-all duration-200 group ${isSelected ? 'border-indigo-600 bg-indigo-50/30 shadow-sm ring-1 ring-indigo-600' : 'border-slate-100 hover:border-indigo-300 hover:shadow-md bg-white'}">
                                ${isSelected ? '<div class="absolute -top-2 -right-2 w-6 h-6 bg-indigo-600 rounded-full flex items-center justify-center shadow-sm z-10"><svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-width="3"/></svg></div>' : ''}
                                
                                <div class="flex justify-between items-start mb-3">
                                    <div class="flex items-center gap-2">
                                        <div class="w-10 h-6 ${item.net === 'Visa' ? 'visa-bg' : 'master-bg'} rounded flex items-center justify-center text-[10px] text-white font-bold italic shadow-sm">${item.net}</div>
                                        <span class="text-xs font-bold px-2 py-0.5 bg-white border border-slate-200 rounded text-slate-500">${item.type}</span>
                                    </div>
                                    <span class="text-xs font-bold text-indigo-600 bg-white px-2 py-1 rounded border border-indigo-100">$${item.fee}/å¼ </span>
                                </div>
                                
                                <div class="mb-4">
                                    <p class="text-2xl font-mono font-bold text-slate-800 tracking-tight">${item.bin}</p>
                                    <p class="text-xs text-slate-400 mt-1">${item.label}</p>
                                </div>
                                
                                <div class="flex flex-wrap gap-1.5 pt-3 border-t border-slate-100/50">
                                    ${renderTags(item.platforms)}
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>

                <div class="bg-slate-50 rounded-xl p-6 border border-slate-100 mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-2">å¼€å¡æ•°é‡</label>
                            <div class="relative">
                                <select id="apply-qty" onchange="updatePreviewCost()" class="w-full px-4 py-3 border border-slate-200 rounded-xl text-sm font-bold text-slate-800 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none appearance-none bg-white">
                                    <option value="1">1 å¼ </option>
                                    <option value="5">5 å¼ </option>
                                    <option value="10">10 å¼  (æ‰¹é‡)</option>
                                    <option value="50">50 å¼  (æ‰¹é‡)</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7" stroke-width="2"/></svg></div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-2">å¡ç‰‡æ˜µç§° / æ‰¹æ¬¡å·</label>
                            <input type="text" id="apply-nickname" class="w-full px-4 py-3 border border-slate-200 rounded-xl text-sm font-bold text-slate-800 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none" placeholder="ä¾‹å¦‚ï¼šFB_Ads_Group_01">
                        </div>
                    </div>

                    <div class="border-t border-slate-200 pt-4">
                        <div onclick="toggleLimitSection()" class="flex items-center justify-between cursor-pointer group select-none">
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-bold text-slate-700 group-hover:text-indigo-600 transition">é«˜çº§è®¾ç½®ï¼šäº¤æ˜“é™é¢</span>
                                <span class="text-[10px] text-slate-400 bg-white border border-slate-200 px-1.5 rounded">é€‰å¡«</span>
                            </div>
                            <svg class="w-4 h-4 text-slate-400 transition transform ${isLimitExpanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7" stroke-width="2"/></svg>
                        </div>
                        <div class="${isLimitExpanded ? 'block' : 'hidden'} mt-4 grid grid-cols-1 md:grid-cols-3 gap-4 fade-in">
                            <div><label class="text-[10px] font-bold text-slate-400 mb-1 block">å•ç¬”é™é¢</label><div class="relative"><span class="absolute left-3 top-2 text-slate-400 text-xs">$</span><input type="number" class="w-full pl-6 pr-3 py-2 border border-slate-200 rounded-lg text-sm focus:border-indigo-500 outline-none" placeholder="No Limit"></div></div>
                            <div><label class="text-[10px] font-bold text-slate-400 mb-1 block">æ—¥é™é¢</label><div class="relative"><span class="absolute left-3 top-2 text-slate-400 text-xs">$</span><input type="number" class="w-full pl-6 pr-3 py-2 border border-slate-200 rounded-lg text-sm focus:border-indigo-500 outline-none" placeholder="No Limit"></div></div>
                            <div><label class="text-[10px] font-bold text-slate-400 mb-1 block">æœˆé™é¢</label><div class="relative"><span class="absolute left-3 top-2 text-slate-400 text-xs">$</span><input type="number" class="w-full pl-6 pr-3 py-2 border border-slate-200 rounded-lg text-sm focus:border-indigo-500 outline-none" placeholder="No Limit"></div></div>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row items-center justify-between gap-6 border-t border-slate-100 pt-6">
                    <div class="text-sm space-y-1 w-full md:w-auto">
                        <div class="flex flex-wrap items-center gap-x-6 gap-y-2 text-slate-600">
                            <span>å•å¡è´¹ç”¨: <span class="font-bold text-slate-800">$${selectedBin.fee.toFixed(2)}</span></span>
                            <span>é¢„è®¡æ€»æ‰£è´¹: <span class="font-bold text-red-600 text-lg" id="preview-cost">$${previewTotal.toFixed(2)}</span></span>
                        </div>
                        <p class="text-[10px] text-slate-400 mt-1">* åŒ…å«å¼€å¡è´¹åŠæœ€ä½é¢„å……å€¼é‡‘é¢ ($10/å¼ )</p>
                    </div>
                    <div class="flex gap-4 w-full md:w-auto justify-end">
                        <button onclick="showView('dashboard')" class="px-6 py-3 border border-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-50 transition">å–æ¶ˆ</button>
                        <button onclick="handleApplyNext()" class="px-8 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-100 transition flex items-center gap-2">
                            <span>ç¡®è®¤å¼€å¡</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M14 5l7 7m0 0l-7 7m7-7H3" stroke-width="2"/></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>`;
    }

    // 4. é‡æ–°å®šä¹‰è¾…åŠ©å‡½æ•°
    window.selectBinItem = function(index) {
        selectedBinIndex = index;
        showView('apply');
    }

    window.toggleLimitSection = function() {
        isLimitExpanded = !isLimitExpanded;
        showView('apply');
        // ä¿æŒæ•°é‡é€‰æ‹©æ¡†çš„å€¼ï¼ˆç®€å•å¤„ç†ï¼‰
        // å®é™…é¡¹ç›®ä¸­åº”ç»‘å®šçŠ¶æ€
    }

    window.updatePreviewCost = function() {
        const el = document.getElementById('preview-cost');
        const qtyEl = document.getElementById('apply-qty');
        if (!el || !qtyEl) return;
        
        const bin = binList[selectedBinIndex];
        const qty = parseInt(qtyEl.value);
        const cost = (bin.fee * qty) + (10 * qty); 
        el.innerText = '$' + cost.toFixed(2);
    }
}
</script>
<script>
{
    // 1. ç¡®ä¿çŠ¶æ€å˜é‡å­˜åœ¨
    if (typeof selectedBinIndex === 'undefined') var selectedBinIndex = 0;
    if (typeof isLimitExpanded === 'undefined') var isLimitExpanded = false;

    // 2. å®šä¹‰æ•°æ® (ä¿æŒä¸å˜)
    const binList = [
        { bin: '54492360', net: 'Mastercard', type: 'Credit', platforms: ['google', 'amazon', 'paypal'], label: 'å¹¿å‘Šä¸“ç”¨', fee: 3.5 },
        { bin: '52737560', net: 'Mastercard', type: 'Credit', platforms: ['wechat', 'alipay', 'paypal', 'amazon'], label: 'ç”µå•†é¦–é€‰', fee: 2.0 },
        { bin: '48593220', net: 'Visa', type: 'Debit', platforms: ['openai', 'midjourney', 'notion'], label: 'AI è®¢é˜…', fee: 1.0 },
        { bin: '55832510', net: 'Mastercard', type: 'Prepaid', platforms: ['booking', 'agoda', 'uber'], label: 'å•†æ—…å‡ºè¡Œ', fee: 0.0 },
        { bin: '42881199', net: 'Visa', type: 'Credit', platforms: ['shopify', 'tiktok', 'facebook'], label: 'ç»¼åˆé€šç”¨', fee: 2.5 },
        { bin: '53211359', net: 'Mastercard', type: 'Debit', platforms: ['steam', 'nintendo', 'apple'], label: 'æ•°å­—å¨±ä¹', fee: 1.5 }
    ];

    // 3. é‡å†™ Apply è§†å›¾
    views.apply = () => {
        if (selectedBinIndex >= binList.length) selectedBinIndex = 0;
        const selectedBin = binList[selectedBinIndex];
        
        const renderTags = (platforms) => {
            const map = {
                'wechat': 'å¾®ä¿¡', 'alipay': 'æ”¯ä»˜å®', 'paypal': 'PayPal', 'amazon': 'äºšé©¬é€Š',
                'google': 'Google', 'openai': 'ChatGPT', 'facebook': 'FB Ads', 'tiktok': 'TikTok'
            };
            return platforms.slice(0, 4).map(p => map[p] || p).map(t => `<span class="text-[10px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded">${t}</span>`).join('');
        };

        const qty = document.getElementById('apply-qty') ? parseInt(document.getElementById('apply-qty').value) : 1;
        const previewTotal = (selectedBin.fee * qty) + (10 * qty);

        return `
        <div class="max-w-6xl mx-auto fade-in pb-20">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-slate-800">ç”³è¯·æ–°å¡ (Issue Card)</h2>
                        <p class="text-xs text-slate-400 mt-1">é…ç½®æ‚¨çš„è™šæ‹Ÿå¡å‚æ•°</p>
                    </div>
                    <span class="px-3 py-1 bg-indigo-50 text-indigo-600 rounded-full text-xs font-bold">ä½™é¢: $${currentUser.balance.toLocaleString(undefined, {minimumFractionDigits: 2})}</span>
                </div>

                <div class="mb-6">
                    <label class="block text-xs font-bold text-slate-500 mb-2">å¸ç§ (Currency)</label>
                    <div class="relative max-w-xs">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <img src="https://flagcdn.com/w20/us.png" class="w-5 h-3.5 rounded-sm shadow-sm">
                        </div>
                        <select class="w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-bold text-slate-700 outline-none appearance-none cursor-not-allowed" disabled>
                            <option>USD - ç¾å…ƒ</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                            <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7" stroke-width="2"/></svg>
                        </div>
                    </div>
                </div>
                
                <div class="mb-6 border-b border-slate-100">
                    <div class="flex gap-8">
                        <button class="pb-3 text-sm font-bold text-indigo-600 border-b-2 border-indigo-600 transition">å¹¿å‘ŠæŠ•æ”¾</button>
                        <button class="pb-3 text-sm font-medium text-slate-500 hover:text-slate-700 transition">ç”µå•†æµ·æ·˜</button>
                        <button class="pb-3 text-sm font-medium text-slate-500 hover:text-slate-700 transition">ä¼ä¸šä¸šåŠ¡</button>
                    </div>
                </div>

                <div class="mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${binList.map((item, index) => {
                            const isSelected = selectedBinIndex === index;
                            return `
                            <div onclick="selectBinItem(${index})" class="relative border-2 rounded-xl p-5 cursor-pointer transition-all duration-200 group ${isSelected ? 'border-indigo-600 bg-indigo-50/30 shadow-sm ring-1 ring-indigo-600' : 'border-slate-100 hover:border-indigo-300 hover:shadow-md bg-white'}">
                                ${isSelected ? '<div class="absolute -top-2 -right-2 w-6 h-6 bg-indigo-600 rounded-full flex items-center justify-center shadow-sm z-10"><svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-width="3"/></svg></div>' : ''}
                                
                                <div class="flex justify-between items-start mb-3">
                                    <div class="flex items-center gap-2">
                                        <div class="w-10 h-6 ${item.net === 'Visa' ? 'visa-bg' : 'master-bg'} rounded flex items-center justify-center text-[10px] text-white font-bold italic shadow-sm">${item.net}</div>
                                        <span class="text-xs font-bold px-2 py-0.5 bg-white border border-slate-200 rounded text-slate-500">${item.type}</span>
                                    </div>
                                    <span class="text-xs font-bold text-indigo-600 bg-white px-2 py-1 rounded border border-indigo-100">$${item.fee}/å¼ </span>
                                </div>
                                
                                <div class="mb-4">
                                    <p class="text-2xl font-mono font-bold text-slate-800 tracking-tight">${item.bin}</p>
                                    <p class="text-xs text-slate-400 mt-1">${item.label}</p>
                                </div>
                                
                                <div class="flex flex-wrap gap-1.5 pt-3 border-t border-slate-100/50">
                                    ${renderTags(item.platforms)}
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>

                <div class="bg-slate-50 rounded-xl p-6 border border-slate-100 mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-2">å¼€å¡æ•°é‡</label>
                            <div class="relative">
                                <select id="apply-qty" onchange="updatePreviewCost()" class="w-full px-4 py-3 border border-slate-200 rounded-xl text-sm font-bold text-slate-800 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none appearance-none bg-white">
                                    <option value="1">1 å¼ </option>
                                    <option value="5">5 å¼ </option>
                                    <option value="10">10 å¼  (æ‰¹é‡)</option>
                                    <option value="50">50 å¼  (æ‰¹é‡)</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7" stroke-width="2"/></svg></div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-2">å¡ç‰‡æ˜µç§° / æ‰¹æ¬¡å·</label>
                            <input type="text" id="apply-nickname" class="w-full px-4 py-3 border border-slate-200 rounded-xl text-sm font-bold text-slate-800 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none" placeholder="ä¾‹å¦‚ï¼šFB_Ads_Group_01">
                        </div>
                    </div>

                    <div class="border-t border-slate-200 pt-4">
                        <div onclick="toggleLimitSection()" class="flex items-center justify-between cursor-pointer group select-none">
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-bold text-slate-700 group-hover:text-indigo-600 transition">é«˜çº§è®¾ç½®ï¼šäº¤æ˜“é™é¢</span>
                                <span class="text-[10px] text-slate-400 bg-white border border-slate-200 px-1.5 rounded">é€‰å¡«</span>
                            </div>
                            <svg class="w-4 h-4 text-slate-400 transition transform ${isLimitExpanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7" stroke-width="2"/></svg>
                        </div>
                        <div class="${isLimitExpanded ? 'block' : 'hidden'} mt-4 grid grid-cols-1 md:grid-cols-3 gap-4 fade-in">
                            <div><label class="text-[10px] font-bold text-slate-400 mb-1 block">å•ç¬”é™é¢</label><div class="relative"><span class="absolute left-3 top-2 text-slate-400 text-xs">$</span><input type="number" class="w-full pl-6 pr-3 py-2 border border-slate-200 rounded-lg text-sm focus:border-indigo-500 outline-none" placeholder="No Limit"></div></div>
                            <div><label class="text-[10px] font-bold text-slate-400 mb-1 block">æ—¥é™é¢</label><div class="relative"><span class="absolute left-3 top-2 text-slate-400 text-xs">$</span><input type="number" class="w-full pl-6 pr-3 py-2 border border-slate-200 rounded-lg text-sm focus:border-indigo-500 outline-none" placeholder="No Limit"></div></div>
                            <div><label class="text-[10px] font-bold text-slate-400 mb-1 block">æœˆé™é¢</label><div class="relative"><span class="absolute left-3 top-2 text-slate-400 text-xs">$</span><input type="number" class="w-full pl-6 pr-3 py-2 border border-slate-200 rounded-lg text-sm focus:border-indigo-500 outline-none" placeholder="No Limit"></div></div>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row items-center justify-between gap-6 border-t border-slate-100 pt-6">
                    <div class="text-sm space-y-1 w-full md:w-auto">
                        <div class="flex flex-wrap items-center gap-x-6 gap-y-2 text-slate-600">
                            <span>å•å¡è´¹ç”¨: <span class="font-bold text-slate-800">$${selectedBin.fee.toFixed(2)}</span></span>
                            <span>é¢„è®¡æ€»æ‰£è´¹: <span class="font-bold text-red-600 text-lg" id="preview-cost">$${previewTotal.toFixed(2)}</span></span>
                        </div>
                        <p class="text-[10px] text-slate-400 mt-1">* åŒ…å«å¼€å¡è´¹åŠæœ€ä½é¢„å……å€¼é‡‘é¢ ($10/å¼ )</p>
                    </div>
                    <div class="flex gap-4 w-full md:w-auto justify-end">
                        <button onclick="showView('dashboard')" class="px-6 py-3 border border-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-50 transition">å–æ¶ˆ</button>
                        <button onclick="handleApplyNext()" class="px-8 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-100 transition flex items-center gap-2">
                            <span>ç¡®è®¤å¼€å¡</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M14 5l7 7m0 0l-7 7m7-7H3" stroke-width="2"/></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>`;
    }
}
</script>
<script>
{
    // 1. å®šä¹‰çŠ¶æ€å˜é‡ (ç¡®ä¿åœ¨å½“å‰ä½œç”¨åŸŸ)
    let selectedBinIndex = 0; 
    let isLimitExpanded = false; // æ§åˆ¶é™é¢å±•å¼€
    let currentTab = 'ads';      // å½“å‰é€‰ä¸­çš„ Tab: ads | ecom | enterprise

    // 2. å®šä¹‰å¡æ®µæ•°æ® (å¸¦åˆ†ç±»æ ‡ç­¾)
    const binList = [
        // å¹¿å‘ŠæŠ•æ”¾ (ads)
        { bin: '54492360', net: 'Mastercard', type: 'Credit', platforms: ['google', 'facebook', 'tiktok'], label: 'å¹¿å‘Šä¸“ç”¨', fee: 3.5, category: 'ads' },
        { bin: '42881199', net: 'Visa', type: 'Credit', platforms: ['facebook', 'tiktok', 'pinterest'], label: 'ç»¼åˆé€šç”¨', fee: 2.5, category: 'ads' },
        // ç”µå•†æµ·æ·˜ (ecom)
        { bin: '52737560', net: 'Mastercard', type: 'Credit', platforms: ['amazon', 'ebay', 'shopify'], label: 'ç”µå•†é¦–é€‰', fee: 2.0, category: 'ecom' },
        { bin: '53211359', net: 'Mastercard', type: 'Debit', platforms: ['steam', 'apple', 'amazon'], label: 'æ•°å­—å¨±ä¹', fee: 1.5, category: 'ecom' },
        // ä¼ä¸šä¸šåŠ¡ (enterprise)
        { bin: '48593220', net: 'Visa', type: 'Debit', platforms: ['openai', 'midjourney', 'notion'], label: 'AI è®¢é˜…', fee: 1.0, category: 'enterprise' },
        { bin: '55832510', net: 'Mastercard', type: 'Prepaid', platforms: ['booking', 'uber', 'airbnb'], label: 'å•†æ—…å‡ºè¡Œ', fee: 0.0, category: 'enterprise' }
    ];

    // 3. é‡å†™ Apply è§†å›¾
    views.apply = () => {
        // æ ¹æ® Tab ç­›é€‰å½“å‰æ˜¾ç¤ºçš„ BIN åˆ—è¡¨
        const filteredBins = binList.filter(item => item.category === currentTab);
        
        // ç¡®ä¿é€‰ä¸­ç´¢å¼•ä¸è¶Šç•Œ
        if (selectedBinIndex >= filteredBins.length) selectedBinIndex = 0;
        const selectedBin = filteredBins[selectedBinIndex] || filteredBins[0];
        
        // æ¸²æŸ“å¹³å°æ ‡ç­¾è¾…åŠ©å‡½æ•°
        const renderTags = (platforms) => {
            const map = {
                'wechat': 'å¾®ä¿¡', 'alipay': 'æ”¯ä»˜å®', 'paypal': 'PayPal', 'amazon': 'äºšé©¬é€Š',
                'google': 'Google', 'openai': 'ChatGPT', 'facebook': 'FB Ads', 'tiktok': 'TikTok'
            };
            return platforms.slice(0, 4).map(p => map[p] || p).map(t => `<span class="text-[10px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded">${t}</span>`).join('');
        };

        // Tab æ ·å¼è¾…åŠ©å‡½æ•°
        const getTabClass = (tabName) => {
            return currentTab === tabName 
                ? 'text-indigo-600 border-b-2 border-indigo-600' 
                : 'text-slate-500 hover:text-slate-700 border-b-2 border-transparent hover:border-slate-200';
        };

        return `
        <div class="max-w-6xl mx-auto fade-in pb-20">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-slate-800">ç”³è¯·æ–°å¡ (Issue Card)</h2>
                        <p class="text-xs text-slate-400 mt-1">è¯·é€‰æ‹©é€‚åˆæ‚¨ä¸šåŠ¡åœºæ™¯çš„å¡æ®µ</p>
                    </div>
                    <span class="px-3 py-1 bg-indigo-50 text-indigo-600 rounded-full text-xs font-bold">ä½™é¢: $${currentUser.balance.toLocaleString(undefined, {minimumFractionDigits: 2})}</span>
                </div>

                <div class="mb-6">
                    <label class="block text-xs font-bold text-slate-500 mb-2">å¸ç§ (Currency)</label>
                    <div class="relative max-w-xs">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <img src="https://flagcdn.com/w20/us.png" class="w-5 h-3.5 rounded-sm shadow-sm">
                        </div>
                        <select class="w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-bold text-slate-700 outline-none appearance-none cursor-not-allowed" disabled>
                            <option>USD - ç¾å…ƒ</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7" stroke-width="2"/></svg></div>
                    </div>
                </div>
                
                <div class="mb-6 border-b border-slate-100">
                    <div class="flex gap-8">
                        <button onclick="switchApplyTab('ads')" class="pb-3 text-sm font-bold transition ${getTabClass('ads')}">å¹¿å‘ŠæŠ•æ”¾</button>
                        <button onclick="switchApplyTab('ecom')" class="pb-3 text-sm font-bold transition ${getTabClass('ecom')}">ç”µå•†æµ·æ·˜</button>
                        <button onclick="switchApplyTab('enterprise')" class="pb-3 text-sm font-bold transition ${getTabClass('enterprise')}">ä¼ä¸šä¸šåŠ¡</button>
                    </div>
                </div>

                <div class="mb-8 min-h-[200px]">
                    ${filteredBins.length > 0 ? `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${filteredBins.map((item, index) => {
                            const isSelected = selectedBinIndex === index;
                            return `
                            <div onclick="selectBinItem(${index})" class="relative border-2 rounded-xl p-5 cursor-pointer transition-all duration-200 group ${isSelected ? 'border-indigo-600 bg-indigo-50/30 shadow-sm ring-1 ring-indigo-600' : 'border-slate-100 hover:border-indigo-300 hover:shadow-md bg-white'}">
                                ${isSelected ? '<div class="absolute -top-2 -right-2 w-6 h-6 bg-indigo-600 rounded-full flex items-center justify-center shadow-sm z-10"><svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-width="3"/></svg></div>' : ''}
                                
                                <div class="flex justify-between items-start mb-3">
                                    <div class="flex items-center gap-2">
                                        <div class="w-10 h-6 ${item.net === 'Visa' ? 'visa-bg' : 'master-bg'} rounded flex items-center justify-center text-[10px] text-white font-bold italic shadow-sm">${item.net}</div>
                                        <span class="text-xs font-bold px-2 py-0.5 bg-white border border-slate-200 rounded text-slate-500">${item.type}</span>
                                    </div>
                                    <span class="text-xs font-bold text-indigo-600 bg-white px-2 py-1 rounded border border-indigo-100">$${item.fee}/å¼ </span>
                                </div>
                                
                                <div class="mb-4">
                                    <p class="text-2xl font-mono font-bold text-slate-800 tracking-tight">${item.bin}</p>
                                    <p class="text-xs text-slate-400 mt-1">${item.label}</p>
                                </div>
                                
                                <div class="flex flex-wrap gap-1.5 pt-3 border-t border-slate-100/50">
                                    ${renderTags(item.platforms)}
                                </div>
                            </div>`;
                        }).join('')}
                    </div>` : `<div class="text-center py-10 text-slate-400 bg-slate-50 rounded-xl border-2 border-dashed border-slate-200">è¯¥åˆ†ç±»ä¸‹æš‚æ— å¯ç”¨å¡æ®µ</div>`}
                </div>

                <div class="bg-slate-50 rounded-xl p-6 border border-slate-100 mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-2">å¼€å¡æ•°é‡</label>
                            <div class="relative">
                                <select id="apply-qty" onchange="updatePreviewCost()" class="w-full px-4 py-3 border border-slate-200 rounded-xl text-sm font-bold text-slate-800 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none appearance-none bg-white">
                                    <option value="1">1 å¼ </option>
                                    <option value="5">5 å¼ </option>
                                    <option value="10">10 å¼  (æ‰¹é‡)</option>
                                    <option value="50">50 å¼  (æ‰¹é‡)</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7" stroke-width="2"/></svg></div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-2">å¡ç‰‡æ˜µç§° / æ‰¹æ¬¡å·</label>
                            <input type="text" id="apply-nickname" class="w-full px-4 py-3 border border-slate-200 rounded-xl text-sm font-bold text-slate-800 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none" placeholder="ä¾‹å¦‚ï¼šFB_Ads_Group_01">
                        </div>
                    </div>

                    <div class="border-t border-slate-200 pt-4">
                        <div onclick="toggleLimitSection()" class="flex items-center justify-between cursor-pointer group select-none py-2">
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-bold text-slate-700 group-hover:text-indigo-600 transition">é«˜çº§è®¾ç½®ï¼šäº¤æ˜“é™é¢</span>
                                <span class="text-[10px] text-slate-400 bg-white border border-slate-200 px-1.5 rounded">é€‰å¡«</span>
                            </div>
                            <svg class="w-4 h-4 text-slate-400 transition transform ${isLimitExpanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7" stroke-width="2"/></svg>
                        </div>
                        <div class="${isLimitExpanded ? 'block' : 'hidden'} mt-4 grid grid-cols-1 md:grid-cols-3 gap-4 fade-in bg-white p-4 rounded-xl border border-slate-100">
                            <div><label class="text-[10px] font-bold text-slate-400 mb-1 block">å•ç¬”é™é¢</label><div class="relative"><span class="absolute left-3 top-2 text-slate-400 text-xs">$</span><input type="number" class="w-full pl-6 pr-3 py-2 border border-slate-200 rounded-lg text-sm focus:border-indigo-500 outline-none" placeholder="No Limit"></div></div>
                            <div><label class="text-[10px] font-bold text-slate-400 mb-1 block">æ—¥é™é¢</label><div class="relative"><span class="absolute left-3 top-2 text-slate-400 text-xs">$</span><input type="number" class="w-full pl-6 pr-3 py-2 border border-slate-200 rounded-lg text-sm focus:border-indigo-500 outline-none" placeholder="No Limit"></div></div>
                            <div><label class="text-[10px] font-bold text-slate-400 mb-1 block">æœˆé™é¢</label><div class="relative"><span class="absolute left-3 top-2 text-slate-400 text-xs">$</span><input type="number" class="w-full pl-6 pr-3 py-2 border border-slate-200 rounded-lg text-sm focus:border-indigo-500 outline-none" placeholder="No Limit"></div></div>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row items-center justify-between gap-6 border-t border-slate-100 pt-6">
                    <div class="text-sm space-y-1 w-full md:w-auto">
                        <div class="flex flex-wrap items-center gap-x-6 gap-y-2 text-slate-600">
                            <span>å•å¡è´¹ç”¨: <span class="font-bold text-slate-800">$${selectedBin ? selectedBin.fee.toFixed(2) : '0.00'}</span></span>
                            <span>é¢„è®¡æ€»æ‰£è´¹: <span class="font-bold text-red-600 text-lg" id="preview-cost">$0.00</span></span>
                        </div>
                        <p class="text-[10px] text-slate-400 mt-1">* åŒ…å«å¼€å¡è´¹åŠæœ€ä½é¢„å……å€¼é‡‘é¢ ($10/å¼ )</p>
                    </div>
                    <div class="flex gap-4 w-full md:w-auto justify-end">
                        <button onclick="showView('dashboard')" class="px-6 py-3 border border-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-50 transition">å–æ¶ˆ</button>
                        <button onclick="handleApplyNext()" class="px-8 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-100 transition flex items-center gap-2">
                            <span>ç¡®è®¤å¼€å¡</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M14 5l7 7m0 0l-7 7m7-7H3" stroke-width="2"/></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>`;
    }

    // 4. äº¤äº’å‡½æ•°
    window.switchApplyTab = function(tab) {
        currentTab = tab;
        selectedBinIndex = 0; // åˆ‡æ¢åˆ†ç±»æ—¶é‡ç½®é€‰ä¸­é¡¹
        showView('apply');
        setTimeout(updatePreviewCost, 0);
    }

    window.selectBinItem = function(index) {
        selectedBinIndex = index;
        showView('apply');
        setTimeout(updatePreviewCost, 0);
    }

    window.toggleLimitSection = function() {
        isLimitExpanded = !isLimitExpanded;
        showView('apply');
    }

    window.updatePreviewCost = function() {
        const el = document.getElementById('preview-cost');
        const qtyEl = document.getElementById('apply-qty');
        if (!el || !qtyEl) return;
        
        // é‡æ–°è·å–å½“å‰ç­›é€‰åçš„åˆ—è¡¨æ¥è®¡ç®—ï¼Œé˜²æ­¢ç´¢å¼•é”™ä½
        const filteredBins = binList.filter(item => item.category === currentTab);
        const bin = filteredBins[selectedBinIndex] || filteredBins[0];
        
        if(!bin) return;

        const qty = parseInt(qtyEl.value);
        const cost = (bin.fee * qty) + (10 * qty);
        el.innerText = '$' + cost.toFixed(2);
    }
}
</script>
<script>
{
    // 1. å…¨å±€çŠ¶æ€
    window._applyState = window._applyState || {
        cardType: 'prepaid',
        tab: 'ads', 
        binIndex: 0,          
        limitExpanded: false, 
        qty: 1                
    };

    // 2. åŠ¨æ€åˆ†ç±»é…ç½® (å¯éšæ„å¢åŠ )
    const _categories = [
        { id: 'ads', name: 'å¹¿å‘ŠæŠ•æ”¾', icon: 'ğŸ“¢' },
        { id: 'ecom', name: 'ç”µå•†æµ·æ·˜', icon: 'ğŸ›’' },
        { id: 'enterprise', name: 'ä¼ä¸šä¸šåŠ¡', icon: 'ğŸ¢' },
        { id: 'dev', name: 'å¼€å‘è€… API', icon: 'ğŸ”Œ' } // æ¼”ç¤ºæ‰©å±•æ€§
    ];

    // 3. å¡æ®µæ•°æ® (å¢åŠ  dev åˆ†ç±»æ•°æ®ä»¥æ¼”ç¤º)
    const _binListData = [
        { bin: '54492360', net: 'Mastercard', type: 'Credit', platforms: ['google', 'facebook'], label: 'å¹¿å‘Šä¸“ç”¨', fee: 3.5, category: 'ads', supportShared: true },
        { bin: '42881199', net: 'Visa', type: 'Credit', platforms: ['tiktok', 'pinterest'], label: 'ç»¼åˆé€šç”¨', fee: 2.5, category: 'ads', supportShared: false },
        { bin: '52737560', net: 'Mastercard', type: 'Credit', platforms: ['amazon', 'shopify'], label: 'ç”µå•†é¦–é€‰', fee: 2.0, category: 'ecom', supportShared: true },
        { bin: '53211359', net: 'Mastercard', type: 'Debit', platforms: ['steam', 'apple'], label: 'æ•°å­—å¨±ä¹', fee: 1.5, category: 'ecom', supportShared: false },
        { bin: '48593220', net: 'Visa', type: 'Debit', platforms: ['openai', 'midjourney'], label: 'AI è®¢é˜…', fee: 1.0, category: 'enterprise', supportShared: true },
        { bin: '55832510', net: 'Mastercard', type: 'Prepaid', platforms: ['booking', 'uber'], label: 'å•†æ—…å‡ºè¡Œ', fee: 0.0, category: 'enterprise', supportShared: true },
        { bin: '49342211', net: 'Visa', type: 'Virtual', platforms: ['api', 'cloud'], label: 'APIæµ‹è¯•å¡', fee: 0.5, category: 'dev', supportShared: true }
    ];

    // 4. ç­›é€‰é€»è¾‘
    const getFilteredBins = () => {
        return _binListData.filter(item => {
            if (item.category !== window._applyState.tab) return false;
            if (window._applyState.cardType === 'shared' && !item.supportShared) return false;
            return true;
        });
    };

    const getCurrentBin = () => {
        const list = getFilteredBins();
        if (window._applyState.binIndex >= list.length) window._applyState.binIndex = 0;
        return list[window._applyState.binIndex] || null;
    };

    // 5. è§†å›¾æ¸²æŸ“
    views.apply = () => {
        const currentBin = getCurrentBin();
        const filteredList = getFilteredBins();
        const isSharedMode = window._applyState.cardType === 'shared';
        
        // è´¹ç”¨è®¡ç®—
        const preCharge = isSharedMode ? 0 : 10;
        const fee = currentBin ? currentBin.fee : 0;
        const totalCost = (fee * window._applyState.qty) + (preCharge * window._applyState.qty);

        // æ ‡ç­¾è¾…åŠ©
        const renderTags = (platforms) => platforms.slice(0, 3).map(p => `<span class="text-[10px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded uppercase border border-slate-200">${p}</span>`).join('');

        return `
        <div class="max-w-6xl mx-auto fade-in pb-20">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8">
                <div class="flex justify-between items-start mb-8">
                    <div><h2 class="text-xl font-bold text-slate-800">ç”³è¯·æ–°å¡ (Issue Card)</h2><p class="text-xs text-slate-400 mt-1">æŒ‰æ­¥éª¤é…ç½®æ‚¨çš„è™šæ‹Ÿå¡èµ„äº§</p></div>
                    <span class="px-3 py-1 bg-indigo-50 text-indigo-600 rounded-full text-xs font-bold">ä½™é¢: $${currentUser.balance.toLocaleString(undefined, {minimumFractionDigits: 2})}</span>
                </div>

                <div class="mb-8">
                    <label class="block text-xs font-bold text-slate-500 mb-3 uppercase tracking-wider">Step 1: èµ„é‡‘æ¨¡å¼</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div onclick="window._setCardType('prepaid')" class="relative p-4 rounded-xl border-2 cursor-pointer transition flex items-center gap-3 ${!isSharedMode ? 'border-indigo-600 bg-indigo-50/50' : 'border-slate-200 bg-white hover:border-slate-300'}">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center ${!isSharedMode ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-400'}"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" stroke-width="2"/></svg></div>
                            <div><h3 class="font-bold text-sm ${!isSharedMode?'text-indigo-700':'text-slate-700'}">æ™®é€šå¡ (Prepaid)</h3><p class="text-[10px] text-slate-500 mt-0.5">ç‹¬ç«‹èµ„é‡‘è´¦æˆ·ï¼Œéœ€æ‰‹åŠ¨åˆ’è½¬ã€‚</p></div>
                            ${!isSharedMode ? '<div class="absolute top-2 right-2"><svg class="w-5 h-5 text-indigo-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg></div>' : ''}
                        </div>
                        <div onclick="window._setCardType('shared')" class="relative p-4 rounded-xl border-2 cursor-pointer transition flex items-center gap-3 ${isSharedMode ? 'border-purple-600 bg-purple-50/50' : 'border-slate-200 bg-white hover:border-slate-300'}">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center ${isSharedMode ? 'bg-purple-600 text-white' : 'bg-slate-100 text-slate-400'}"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" stroke-width="2"/></svg></div>
                            <div><h3 class="font-bold text-sm ${isSharedMode?'text-purple-700':'text-slate-700'}">å…±äº«å¡ (Shared)</h3><p class="text-[10px] text-slate-500 mt-0.5">ç›´æ¥æ¶ˆè€—ä¸»ä½™é¢ï¼Œæ— éœ€å……å€¼ã€‚</p></div>
                            ${isSharedMode ? '<div class="absolute top-2 right-2"><svg class="w-5 h-5 text-purple-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg></div>' : ''}
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-xs font-bold text-slate-500 mb-3 uppercase tracking-wider">Step 2: ä¸šåŠ¡åœºæ™¯</label>
                    
                    <div class="flex flex-wrap gap-3 mb-6">
                        ${_categories.map(cat => {
                            const isActive = window._applyState.tab === cat.id;
                            const activeClass = 'bg-indigo-600 text-white shadow-md border-transparent';
                            const inactiveClass = 'bg-slate-100 text-slate-600 hover:bg-slate-200 border-transparent';
                            return `
                            <button onclick="window._switchTab('${cat.id}')" class="px-5 py-2.5 rounded-full text-sm font-bold border transition-all duration-200 flex items-center gap-2 ${isActive ? activeClass : inactiveClass}">
                                <span>${cat.icon}</span>
                                <span>${cat.name}</span>
                            </button>`;
                        }).join('')}
                    </div>

                    <div class="min-h-[150px]">
                        ${filteredList.length > 0 ? `
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${filteredList.map((item, index) => {
                                const isSelected = window._applyState.binIndex === index;
                                return `
                                <div onclick="window._selectBin(${index})" class="relative border-2 rounded-xl p-4 cursor-pointer transition-all duration-200 group ${isSelected ? 'border-indigo-600 bg-indigo-50/30' : 'border-slate-100 hover:border-indigo-200 bg-white'}">
                                    <div class="flex justify-between items-start mb-2">
                                        <div class="flex items-center gap-2">
                                            <div class="px-1.5 py-0.5 border border-slate-200 rounded text-[10px] font-bold text-slate-600 bg-white">${item.net}</div>
                                            ${item.supportShared ? '<span class="text-[10px] text-purple-600 bg-purple-50 px-1 rounded">å…±äº«</span>' : ''}
                                        </div>
                                        <span class="text-xs font-bold text-indigo-600">$${item.fee}</span>
                                    </div>
                                    <div class="mb-3"><p class="text-xl font-mono font-bold text-slate-800 tracking-tight">${item.bin}</p><p class="text-[10px] text-slate-400">${item.label}</p></div>
                                    <div class="flex gap-1 flex-wrap">${renderTags(item.platforms)}</div>
                                </div>`;
                            }).join('')}
                        </div>` 
                        : 
                        `<div class="flex flex-col items-center justify-center py-8 bg-slate-50 rounded-xl border-2 border-dashed border-slate-200">
                            <p class="text-slate-500 font-bold mb-1 text-sm">è¯¥åœºæ™¯æ— å¯ç”¨å¡æ®µ</p>
                            <p class="text-xs text-slate-400">å½“å‰é€‰æ‹©çš„"${isSharedMode?'å…±äº«æ¨¡å¼':'æ™®é€šæ¨¡å¼'}"åœ¨æ­¤åœºæ™¯ä¸‹æš‚æ— å¡æ®µ</p>
                        </div>`}
                    </div>
                </div>

                <div class="bg-slate-50 rounded-xl p-6 border border-slate-100 mb-8 ${!currentBin ? 'opacity-50 pointer-events-none' : ''}">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-2">å¼€å¡æ•°é‡</label>
                            <div class="relative"><select id="apply-qty" onchange="window._updateQty(this.value)" class="w-full px-4 py-3 border border-slate-200 rounded-xl text-sm font-bold text-slate-800 outline-none bg-white focus:border-indigo-500"><option value="1">1 å¼ </option><option value="5">5 å¼ </option><option value="10">10 å¼ </option></select></div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-2">å¡ç‰‡æ˜µç§°</label>
                            <input type="text" id="apply-nickname" class="w-full px-4 py-3 border border-slate-200 rounded-xl text-sm font-bold text-slate-800 outline-none focus:border-indigo-500" placeholder="ä¾‹å¦‚ï¼šTeams_Ads_01">
                        </div>
                    </div>

                    <div class="border-t border-slate-200 pt-4">
                        <div onclick="window._toggleLimit()" class="flex items-center justify-between cursor-pointer group select-none py-2">
                            <div class="flex items-center gap-2"><span class="text-sm font-bold text-slate-700 group-hover:text-indigo-600 transition">äº¤æ˜“é™é¢è®¾ç½®</span>${isSharedMode ? '<span class="text-[10px] text-purple-600 bg-purple-50 px-1.5 rounded font-bold">å»ºè®®è®¾ç½®</span>' : '<span class="text-[10px] text-slate-400 bg-white border border-slate-200 px-1.5 rounded">é€‰å¡«</span>'}</div>
                            <svg class="w-4 h-4 text-slate-400 transition transform ${window._applyState.limitExpanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7" stroke-width="2"/></svg>
                        </div>
                        <div class="${window._applyState.limitExpanded ? 'block' : 'hidden'} mt-4 grid grid-cols-3 gap-4 fade-in">
                            <input type="number" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm bg-white" placeholder="å•ç¬”é™é¢">
                            <input type="number" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm bg-white" placeholder="æ—¥é™é¢">
                            <input type="number" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm bg-white" placeholder="æœˆé™é¢">
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-center pt-2">
                    <div class="text-sm text-slate-600">
                        é¢„è®¡æ‰£è´¹: <span class="font-bold text-red-600 text-lg">$${totalCost.toFixed(2)}</span>
                        <span class="text-xs text-slate-400 ml-2">(${isSharedMode ? 'å…é¢„å……å€¼' : 'å«$10é¢„å……å€¼'})</span>
                    </div>
                    <button onclick="window.handleApplyNext()" ${!currentBin ? 'disabled' : ''} class="px-8 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed">ç¡®è®¤å¼€å¡</button>
                </div>
            </div>
        </div>`;
    }

    // 6. äº¤äº’å‡½æ•°
    window._setCardType = (type) => { window._applyState.cardType = type; window._applyState.binIndex = 0; if (type === 'shared') window._applyState.limitExpanded = true; showView('apply'); }
    window._switchTab = (tab) => { window._applyState.tab = tab; window._applyState.binIndex = 0; showView('apply'); }
    window._selectBin = (index) => { window._applyState.binIndex = index; showView('apply'); }
    window._toggleLimit = () => { window._applyState.limitExpanded = !window._applyState.limitExpanded; showView('apply'); }
    window._updateQty = (val) => { window._applyState.qty = parseInt(val); showView('apply'); }

    // è‡ªåŠ¨åˆ·æ–°
    if(document.getElementById('page-title').innerText.includes('ç”³è¯·')) showView('apply');
}
</script>
<script>
{
    // 1. é‡å†™ï¼šå¡ç‰‡ä¸­å¿ƒåˆ—è¡¨ (views.cards)
    views.cards = () => `
        <div class="fade-in space-y-6 pb-20">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <h2 class="text-xl font-bold text-slate-800">å¡ç‰‡ç®¡ç†</h2>
                    <span class="px-2 py-1 bg-slate-100 text-slate-500 text-xs rounded-md font-bold">${myCards.length} å¼ </span>
                </div>
                <div class="relative">
                    <input type="text" placeholder="æœç´¢å¡å·/åˆ«å..." class="pl-9 pr-4 py-2 border border-slate-200 rounded-lg text-sm w-64 focus:border-indigo-500 outline-none transition">
                    <svg class="w-4 h-4 text-slate-400 absolute left-3 top-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-width="2"/></svg>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                ${myCards.map(card => {
                    const isShared = card.mode === 'shared';
                    const isFrozen = card.status === 'frozen';
                    
                    // å·®å¼‚åŒ–æ ·å¼é…ç½®
                    const typeBadge = isShared 
                        ? '<span class="bg-purple-100 text-purple-700 border border-purple-200 text-[10px] px-2 py-0.5 rounded font-bold flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" stroke-width="2"/></svg>å…±äº«å¡</span>'
                        : '<span class="bg-indigo-50 text-indigo-600 border border-indigo-100 text-[10px] px-2 py-0.5 rounded font-bold flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" stroke-width="2"/></svg>æ™®é€šå¡</span>';
                    
                    const balanceDisplay = isShared 
                        ? `<div class="text-right"><p class="text-[10px] text-slate-400 uppercase font-bold">å…±äº«ä¸»ä½™é¢</p><p class="text-lg font-bold text-purple-600 flex items-center justify-end gap-1"><span class="text-xs opacity-50">LINK</span> âˆ</p></div>`
                        : `<div class="text-right"><p class="text-[10px] text-slate-400 uppercase font-bold">å¡å†…ä½™é¢</p><p class="text-lg font-bold text-slate-800">$${card.balance.toFixed(2)}</p></div>`;

                    const actionBtn = isShared
                        ? `<button onclick="openSetLimitModal('${card.id}')" class="px-3 py-1.5 border border-slate-200 hover:border-purple-300 text-slate-600 hover:text-purple-600 rounded-lg text-xs font-bold transition">é™é¢</button>`
                        : `<button onclick="openRechargeCardModal('${card.id}')" class="px-3 py-1.5 bg-indigo-50 text-indigo-600 hover:bg-indigo-100 rounded-lg text-xs font-bold transition">å……å€¼</button>`;

                    return `
                    <div class="bg-white rounded-xl p-5 border border-slate-200 hover:shadow-md transition group relative overflow-hidden flex flex-col justify-between h-32">
                        <div class="absolute left-0 top-0 bottom-0 w-1 ${isShared ? 'bg-purple-500' : 'bg-indigo-500'}"></div>
                        
                        <div class="flex justify-between items-start">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-8 ${card.type === 'Visa' ? 'visa-bg' : 'master-bg'} rounded flex items-center justify-center text-[10px] text-white font-bold italic shadow-sm relative">
                                    ${card.type}
                                    ${isFrozen ? '<div class="absolute inset-0 bg-black/50 rounded flex items-center justify-center"><svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" stroke-width="2"/></svg></div>' : ''}
                                </div>
                                <div>
                                    <div class="flex items-center gap-2">
                                        <h4 class="font-bold text-slate-700 text-sm">${card.name}</h4>
                                        ${typeBadge}
                                    </div>
                                    <p class="text-xs text-slate-400 font-mono mt-0.5">â€¢â€¢â€¢â€¢ ${card.number.slice(-4)} <span class="mx-1">|</span> ${card.exp}</p>
                                </div>
                            </div>
                            ${balanceDisplay}
                        </div>

                        <div class="flex justify-between items-end mt-2 pt-3 border-t border-slate-50">
                            <div class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full ${isFrozen ? 'bg-red-500' : 'bg-green-500'}"></span>
                                <span class="text-xs font-medium ${isFrozen ? 'text-red-500' : 'text-green-600'}">${isFrozen ? 'å·²å†»ç»“' : 'æ´»è·ƒä¸­'}</span>
                            </div>
                            <div class="flex gap-2">
                                ${actionBtn}
                                <button onclick="showCardDetails('${card.id}')" class="px-3 py-1.5 bg-slate-800 text-white hover:bg-slate-700 rounded-lg text-xs font-bold transition shadow-sm">è¯¦æƒ…</button>
                            </div>
                        </div>
                    </div>`;
                }).join('')}
            </div>
            
            ${myCards.length === 0 ? `<div class="text-center py-20 bg-white rounded-xl border-2 border-dashed border-slate-200"><p class="text-slate-400 mb-4">æš‚æ— å¡ç‰‡</p><button onclick="showView('apply')" class="px-6 py-2 bg-indigo-600 text-white rounded-lg text-sm font-bold hover:bg-indigo-700">ç«‹å³ç”³è¯·</button></div>` : ''}
        </div>`;

    // 2. é‡å†™ï¼šå¡ç‰‡è¯¦æƒ…å¼¹çª— (showCardDetails) - æ·±åº¦å·®å¼‚åŒ–
    window.showCardDetails = function(cardId) {
        const card = myCards.find(c => c.id == cardId);
        if (!card) return;
        
        const isShared = card.mode === 'shared';
        const isFrozen = card.status === 'frozen';
        
        // åŠ¨æ€ä¸»é¢˜è‰²
        const themeColor = isShared ? 'purple' : 'indigo';
        const themeBg = isShared ? 'bg-purple-600' : 'bg-indigo-600';
        const themeText = isShared ? 'text-purple-600' : 'text-indigo-600';
        const themeLight = isShared ? 'bg-purple-50' : 'bg-indigo-50';

        // ä½™é¢åŒºåŸŸ HTML (æ ¸å¿ƒå·®å¼‚)
        let balanceSection = '';
        if (isShared) {
            balanceSection = `
            <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-4 border border-purple-100 mb-6 relative overflow-hidden">
                <div class="flex justify-between items-start relative z-10">
                    <div>
                        <p class="text-xs text-purple-800 font-bold mb-1 flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" stroke-width="2"/></svg>
                            èµ„é‡‘æ¥æºï¼šä¸»é’±åŒ… (Shared Wallet)
                        </p>
                        <h3 class="text-2xl font-bold text-slate-800">$${currentUser.balance.toLocaleString()} <span class="text-xs font-normal text-slate-500">å¯ç”¨</span></h3>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-slate-500 mb-1">æœ¬å¡å·²ç”¨</p>
                        <p class="text-sm font-bold text-slate-700">$0.00</p>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-t border-purple-200/50 flex items-center justify-between text-xs">
                    <span class="text-purple-700">âš¡ æ­¤å¡æ— éœ€å……å€¼ï¼Œç›´æ¥æ‰£é™¤ä¸»è´¦æˆ·ä½™é¢</span>
                </div>
            </div>`;
        } else {
            balanceSection = `
            <div class="bg-slate-50 rounded-xl p-4 border border-slate-200 mb-6 flex justify-between items-center">
                <div>
                    <p class="text-xs text-slate-500 font-bold mb-1">å½“å‰å¡å†…ä½™é¢ (Balance)</p>
                    <h3 class="text-2xl font-bold text-slate-800">$${card.balance.toFixed(2)}</h3>
                </div>
                <button onclick="closeModal(); openRechargeCardModal('${card.id}')" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-bold shadow-md transition flex items-center gap-2" ${isFrozen?'disabled opacity-50':''}>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 6v6m0 0v6m0-6h6m-6 0H6" stroke-width="2"/></svg>
                    å……å€¼
                </button>
            </div>`;
        }

        // åº•éƒ¨æ“ä½œæŒ‰é’® (æ ¸å¿ƒå·®å¼‚)
        let actionButtons = '';
        if (isShared) {
            actionButtons = `
            <button onclick="closeModal(); openSetLimitModal('${card.id}')" class="py-3 bg-purple-600 text-white rounded-xl font-bold text-sm hover:bg-purple-700 shadow-lg shadow-purple-100 transition flex items-center justify-center gap-2" ${isFrozen?'disabled opacity-50':''}>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" stroke-width="2"/></svg>
                é…ç½®äº¤æ˜“é™é¢ (Limits)
            </button>
            <button onclick="toggleCardFreeze('${card.id}')" class="py-3 border border-slate-200 text-slate-600 rounded-xl font-bold text-sm hover:bg-slate-50 transition">${isFrozen ? 'è§£å†»å¡ç‰‡' : 'å†»ç»“å¡ç‰‡'}</button>`;
        } else {
            actionButtons = `
            <button onclick="closeModal(); openTransferModal()" class="py-3 border border-slate-200 text-slate-600 rounded-xl font-bold text-sm hover:bg-slate-50 transition">èµ„é‡‘æç° (Withdraw)</button>
            <button onclick="toggleCardFreeze('${card.id}')" class="py-3 border border-red-200 text-red-600 rounded-xl font-bold text-sm hover:bg-red-50 transition">${isFrozen ? 'è§£å†»å¡ç‰‡' : 'å†»ç»“å¡ç‰‡'}</button>`;
        }

        // æ¨¡æ€çª— HTML
        const modalHTML = `
        <div class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[80] flex items-center justify-center fade-in" id="modal-overlay">
            <div class="bg-white rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden flex flex-col md:flex-row max-h-[90vh] md:max-h-none overflow-y-auto">
                
                <div class="w-full md:w-2/5 bg-slate-900 p-6 flex flex-col items-center justify-center relative overflow-hidden min-h-[240px]">
                    <div class="absolute top-0 right-0 w-64 h-64 ${isShared ? 'bg-purple-500' : 'bg-indigo-500'} rounded-full blur-3xl opacity-20 -translate-y-1/2 translate-x-1/2"></div>
                    
                    <div class="w-full aspect-[1.58/1] rounded-xl ${card.type === 'Visa' ? 'visa-bg' : 'master-bg'} p-5 text-white shadow-2xl relative flex flex-col justify-between transform transition hover:scale-105 duration-500 group">
                        <div class="flex justify-between items-start">
                            <span class="font-bold italic tracking-wider opacity-80">${card.type.toUpperCase()}</span>
                            ${isShared ? '<span class="text-[9px] bg-black/20 backdrop-blur border border-white/20 px-2 py-0.5 rounded-full">SHARED</span>' : '<span class="text-[9px] bg-white/20 px-2 py-0.5 rounded">PREPAID</span>'}
                        </div>
                        <div class="font-mono text-lg tracking-widest drop-shadow-md text-center my-2">${card.number}</div>
                        <div class="flex justify-between items-end">
                            <div><p class="text-[8px] opacity-60 uppercase">Card Holder</p><p class="text-xs font-medium tracking-wide">USER DEMO</p></div>
                            <div><p class="text-[8px] opacity-60 uppercase">Expires</p><p class="text-xs font-mono">${card.exp}</p></div>
                        </div>
                        ${isFrozen ? '<div class="absolute inset-0 bg-black/60 backdrop-blur-[1px] rounded-xl flex items-center justify-center z-20"><span class="border-2 border-white px-3 py-1 text-white font-bold text-lg -rotate-12 opacity-90 tracking-widest">FROZEN</span></div>' : ''}
                    </div>

                    <div class="mt-6 flex items-center gap-2 bg-white/10 px-3 py-1.5 rounded-full backdrop-blur-sm">
                        <span class="w-2 h-2 rounded-full ${isFrozen ? 'bg-red-500 animate-pulse' : 'bg-green-400'}"></span>
                        <span class="text-xs text-white/90 font-medium">${isFrozen ? 'å¡ç‰‡å·²å†»ç»“' : 'å¡ç‰‡æ­£å¸¸æ´»è·ƒ'}</span>
                    </div>
                </div>

                <div class="w-full md:w-3/5 p-8 flex flex-col">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <div class="flex items-center gap-2">
                                <h3 class="text-xl font-bold text-slate-800">${card.name}</h3>
                                ${isShared 
                                    ? '<span class="text-[10px] bg-purple-100 text-purple-700 px-2 py-0.5 rounded font-bold border border-purple-200">å…±äº«å¡</span>'
                                    : '<span class="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded font-bold border border-indigo-100">æ™®é€šå¡</span>'
                                }
                            </div>
                            <p class="text-xs text-slate-400 font-mono mt-1">ID: ${card.id}</p>
                        </div>
                        <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 text-2xl leading-none transition">&times;</button>
                    </div>

                    ${balanceSection}

                    <div class="space-y-4 mb-8 flex-1 text-sm">
                        <div class="flex justify-between items-center py-2 border-b border-slate-50">
                            <span class="text-slate-500">å•ç¬”äº¤æ˜“é™é¢</span>
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-slate-800">$${(card.limit||5000).toLocaleString()}</span>
                                <button onclick="closeModal(); openSetLimitModal('${card.id}')" class="text-xs ${themeText} hover:underline">ä¿®æ”¹</button>
                            </div>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-slate-50">
                            <span class="text-slate-500">CVV å®‰å…¨ç </span>
                            <div class="flex items-center gap-3">
                                <span class="font-mono font-bold bg-slate-100 text-slate-500 px-2 py-0.5 rounded tracking-widest min-w-[3rem] text-center">***</span>
                                <button onclick="toggleCVV(this, '${card.cvv}')" class="text-xs ${themeText} font-bold hover:underline">æŸ¥çœ‹</button>
                            </div>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-slate-50">
                            <span class="text-slate-500">è´¦å•åœ°å€</span>
                            <span class="text-xs text-slate-600 bg-slate-50 px-2 py-1 rounded max-w-[180px] truncate" title="4522 SW 3rd St, Miami, FL 33125">4522 SW 3rd St, Miami...</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mt-auto">
                        ${actionButtons}
                    </div>
                </div>
            </div>
        </div>`;
        
        document.getElementById('modal-container').innerHTML = modalHTML;
    }
}
</script>
<script>
{
    // å¾€ç°æœ‰åˆ—è¡¨é‡Œè¿½åŠ  2 å¼ å…±äº«å¡æ•°æ®
    const demoSharedCards = [
        { 
            id: 'share_01', 
            name: 'Team A (Shared)', 
            number: '5583250000008888', 
            cvv: '123', 
            exp: '12/30', 
            balance: 0, // å…±äº«å¡ä½™é¢æ˜¾ç¤ºä¸º0æˆ–æ— é™ï¼Œç”± UI æ§åˆ¶
            status: 'active', 
            type: 'Mastercard', 
            product: 'ä¼ä¸šå…±äº«å¡',
            mode: 'shared', // å…³é”®æ ‡è®°
            limit: 50000 
        },
        { 
            id: 'share_02', 
            name: 'Marketing Ops', 
            number: '4859320000009999', 
            cvv: '456', 
            exp: '11/28', 
            balance: 0, 
            status: 'frozen', 
            type: 'Visa', 
            product: 'ä¼ä¸šå…±äº«å¡',
            mode: 'shared', // å…³é”®æ ‡è®°
            limit: 2000 
        }
    ];

    // é˜²æ­¢é‡å¤æ·»åŠ  (å¦‚æœåˆ·æ–°é¡µé¢)
    if (!myCards.some(c => c.mode === 'shared')) {
        myCards.unshift(...demoSharedCards);
    }

    // å¼ºåˆ¶åˆ·æ–°å½“å‰è§†å›¾ä»¥æ˜¾ç¤ºæ–°æ•°æ®
    if (document.querySelector('h2').innerText.includes('å¡ç‰‡')) {
        showView('cards');
    }
}
</script>
<script>
{
    // --- 1. å…¨å±€çŠ¶æ€ ---
    window._cardState = window._cardState || {
        filter: 'all',
        detailId: null,
        activeTab: 'overview',
        searchQuery: ''
    };

    // --- 2. è¾…åŠ©ï¼šç”Ÿæˆé«˜æ‹ŸçœŸå¡ç‰‡ (å¢åŠ  DOM ID ç”¨äºäº¤äº’) ---
    const renderRealisticCard = (card) => {
        const isVisa = card.type === 'Visa';
        const isShared = card.mode === 'shared';
        const bgClass = isShared 
            ? 'bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900' 
            : (isVisa ? 'bg-gradient-to-br from-blue-600 to-indigo-700' : 'bg-gradient-to-br from-orange-400 to-red-500');
        
        // é»˜è®¤æ©ç æ˜¾ç¤º
        const maskedNumber = card.number.slice(0, 4) + ' **** **** ' + card.number.slice(-4);

        return `
        <div class="relative w-full aspect-[1.586/1] rounded-2xl ${bgClass} p-6 text-white shadow-2xl overflow-hidden group select-none transition-all duration-500">
            <div class="absolute inset-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')]"></div>
            <div class="absolute -top-24 -right-24 w-64 h-64 bg-white/10 rounded-full blur-3xl pointer-events-none"></div>
            
            <div class="relative z-10 flex flex-col justify-between h-full">
                <div class="flex justify-between items-start">
                    <span class="font-bold italic text-lg tracking-wider opacity-90">${card.type.toUpperCase()}</span>
                    ${isShared 
                        ? '<div class="px-2 py-1 rounded-md bg-white/10 backdrop-blur-md border border-white/10 text-[10px] font-bold tracking-wider">ä¼ä¸šå…±äº«å¡</div>'
                        : '<div class="px-2 py-1 rounded-md bg-white/10 backdrop-blur-md border border-white/10 text-[10px] font-bold tracking-wider">é¢„ä»˜è´¹å¡</div>'
                    }
                </div>
                
                <div class="my-auto">
                    <div class="flex items-center gap-4 mb-2">
                        <div class="w-10 h-7 bg-yellow-200/20 rounded flex items-center justify-center backdrop-blur-sm border border-white/10"><div class="w-6 h-4 border border-white/30 rounded-sm"></div></div>
                        <svg class="w-6 h-6 text-white/80" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"></path></svg>
                    </div>
                    <p id="visual-card-number-${card.id}" class="font-mono text-2xl tracking-[0.15em] drop-shadow-md text-shadow transition-all duration-300">${maskedNumber}</p>
                </div>

                <div class="flex justify-between items-end">
                    <div>
                        <p class="text-[9px] uppercase opacity-60 tracking-widest mb-0.5">æŒå¡äºº</p>
                        <p class="text-sm font-medium tracking-wide">USER DEMO</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[9px] uppercase opacity-60 tracking-widest mb-0.5">æœ‰æ•ˆæœŸ</p>
                        <p class="text-sm font-mono">${card.exp}</p>
                    </div>
                </div>
            </div>
            
            ${card.status === 'frozen' ? '<div class="absolute inset-0 bg-slate-900/60 backdrop-blur-[2px] z-20 flex items-center justify-center"><div class="border-2 border-white/80 px-6 py-2 rounded-lg text-xl font-bold tracking-[0.2em] transform -rotate-12">å·²å†»ç»“</div></div>' : ''}
        </div>`;
    };

    // --- 3. è§†å›¾ï¼šå¡ç‰‡åˆ—è¡¨ (ä¿æŒä¸å˜) ---
    views.cards = () => {
        const list = myCards.filter(c => {
            const matchType = _cardState.filter === 'all' || (_cardState.filter === 'shared' ? c.mode === 'shared' : c.mode !== 'shared');
            const matchSearch = ! _cardState.searchQuery || c.name.toLowerCase().includes(_cardState.searchQuery.toLowerCase()) || c.number.includes(_cardState.searchQuery);
            return matchType && matchSearch;
        });
        const activeCount = list.filter(c => c.status === 'active').length;
        const totalBalance = list.reduce((sum, c) => sum + (c.mode==='shared'?0:c.balance), 0);

        return `
        <div class="max-w-[1200px] mx-auto fade-in pb-20">
            <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
                <div><h2 class="text-2xl font-bold text-slate-900 tracking-tight">å¡ç‰‡ç®¡ç†</h2><div class="flex items-center gap-4 mt-2 text-sm text-slate-500"><span>æ´»è·ƒå¡ç‰‡: <b class="text-slate-800">${activeCount}</b></span><span class="w-1 h-1 bg-slate-300 rounded-full"></span><span>ç‹¬ç«‹æ€»ä½™é¢: <b class="text-slate-800">$${totalBalance.toLocaleString()}</b></span></div></div>
                <div class="flex gap-3"><button onclick="showView('apply')" class="px-5 py-2.5 bg-slate-900 hover:bg-slate-800 text-white rounded-lg text-sm font-semibold shadow-lg shadow-slate-200 transition flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>ç”³è¯·æ–°å¡</button></div>
            </div>
            <div class="bg-white border border-slate-200 rounded-xl p-1.5 flex justify-between items-center mb-6 shadow-sm">
                <div class="flex gap-1"><button onclick="window._setCardFilter('all')" class="px-4 py-2 rounded-lg text-sm font-medium transition ${_cardState.filter === 'all' ? 'bg-slate-100 text-slate-900 shadow-sm' : 'text-slate-500 hover:bg-slate-50 hover:text-slate-700'}">å…¨éƒ¨</button><button onclick="window._setCardFilter('prepaid')" class="px-4 py-2 rounded-lg text-sm font-medium transition ${_cardState.filter === 'prepaid' ? 'bg-indigo-50 text-indigo-600 shadow-sm' : 'text-slate-500 hover:bg-slate-50 hover:text-slate-700'}">æ™®é€šå¡</button><button onclick="window._setCardFilter('shared')" class="px-4 py-2 rounded-lg text-sm font-medium transition ${_cardState.filter === 'shared' ? 'bg-purple-50 text-purple-600 shadow-sm' : 'text-slate-500 hover:bg-slate-50 hover:text-slate-700'}">å…±äº«å¡</button></div>
                <div class="relative mr-2 hidden md:block"><input type="text" placeholder="æœç´¢å¡å· / å¤‡æ³¨å..." oninput="window._searchCard(this.value)" class="pl-9 pr-4 py-2 bg-slate-50 border-none rounded-lg text-sm w-64 focus:ring-2 focus:ring-indigo-500/20 text-slate-800 placeholder:text-slate-400 outline-none transition"><svg class="w-4 h-4 text-slate-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg></div>
            </div>
            <div class="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 border-b border-slate-200 text-slate-500"><tr><th class="px-6 py-4 font-medium w-64">å¡ç‰‡ä¿¡æ¯</th><th class="px-6 py-4 font-medium">å®Œæ•´å¡å·</th><th class="px-6 py-4 font-medium">ç±»å‹</th><th class="px-6 py-4 font-medium text-right">å¯ç”¨ä½™é¢/é™é¢</th><th class="px-6 py-4 font-medium text-center">çŠ¶æ€</th><th class="px-6 py-4 font-medium text-right">æ“ä½œ</th></tr></thead>
                    <tbody class="divide-y divide-slate-100">${list.length > 0 ? list.map(c => `<tr onclick="window._goToDetail('${c.id}')" class="hover:bg-slate-50/80 transition cursor-pointer group"><td class="px-6 py-4 font-medium text-slate-900">${c.name}<div class="text-[10px] font-normal text-slate-400 mt-0.5">${c.product}</div></td><td class="px-6 py-4 font-mono text-slate-600">â€¢â€¢â€¢â€¢ ${c.number.slice(-4)}</td><td class="px-6 py-4">${c.mode === 'shared' ? '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-50 text-purple-700">å…±äº«å¡</span>' : '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-600">æ™®é€šå¡</span>'}</td><td class="px-6 py-4 text-right">${c.mode === 'shared' ? '<span class="text-slate-400 text-xs">å…±äº«ä¸»è´¦æˆ·</span>' : `<span class="font-bold text-slate-800">$${c.balance.toFixed(2)}</span>`}</td><td class="px-6 py-4 text-center"><span class="inline-flex w-2.5 h-2.5 rounded-full ${c.status === 'active' ? 'bg-emerald-500' : 'bg-rose-500'}"></span></td><td class="px-6 py-4 text-right text-slate-400"><span class="text-xs group-hover:text-indigo-600 transition">æŸ¥çœ‹è¯¦æƒ… ></span></td></tr>`).join('') : '<tr><td colspan="6" class="p-12 text-center text-slate-400">æš‚æ— ç¬¦åˆæ¡ä»¶çš„å¡ç‰‡</td></tr>'}</tbody>
                </table>
            </div>
        </div>`;
    };

    // --- 4. è§†å›¾ï¼šå¡ç‰‡è¯¦æƒ…é¡µ (ä¿®å¤ç‰ˆ) ---
    views.card_detail = () => {
        const c = myCards.find(item => item.id === window._cardState.detailId);
        if (!c) return views.cards();

        const isShared = c.mode === 'shared';
        const isFrozen = c.status === 'frozen';
        
        // å…³é”®ï¼šæ ‡å‡†åŒ–é™é¢å¯¹è±¡ (ç¡®ä¿ä¸‰çº§é™é¢å­˜åœ¨)
        // å¦‚æœæ•°æ®é‡Œæ²¡æœ‰ limits å¯¹è±¡ï¼Œç”¨æ—§æ•°æ®æ„å»ºä¸€ä¸ª
        const limits = c.limits || { 
            single: c.limit || 5000, 
            daily: (c.limit || 5000) * 2, 
            monthly: (c.limit || 5000) * 10 
        };

        // æ¨¡æ‹Ÿå·²ç”¨é¢åº¦ (ä¸ºäº†æ¼”ç¤ºè¿›åº¦æ¡)
        const spentSingle = 0;
        const spentDaily = 120.50;
        const spentMonthly = 1450.20;

        // è¿›åº¦æ¡æ¸²æŸ“å‡½æ•°
        const renderLimitBar = (title, max, used) => {
            const pct = max > 0 ? Math.min((used / max) * 100, 100) : 0;
            return `
            <div class="mb-5">
                <div class="flex justify-between text-xs mb-1.5">
                    <span class="text-slate-700 font-bold">${title}</span>
                    <span class="text-slate-500">å·²ç”¨ $${used.toLocaleString()} / <span class="text-slate-900">$${max.toLocaleString()}</span></span>
                </div>
                <div class="w-full h-2.5 bg-slate-100 rounded-full overflow-hidden border border-slate-50">
                    <div class="h-full ${isShared?'bg-purple-500':'bg-indigo-500'}" style="width: ${pct}%"></div>
                </div>
            </div>`;
        };

        return `
        <div class="max-w-[1200px] mx-auto fade-in pb-20">
            <div class="flex items-center gap-3 text-sm text-slate-500 mb-8">
                <button onclick="showView('cards')" class="hover:text-indigo-600 transition flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>è¿”å›åˆ—è¡¨
                </button>
                <span class="text-slate-300">/</span>
                <span class="font-medium text-slate-900">${c.name}</span>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                
                <div class="lg:col-span-4 space-y-6">
                    ${renderRealisticCard(c)}
                    
                    <div class="bg-white border border-slate-200 rounded-xl p-5 shadow-sm">
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">å¿«æ·æ“ä½œ</h3>
                        <div class="space-y-3">
                            ${!isShared ? `
                            <button onclick="openRechargeCardModal('${c.id}')" class="w-full py-2.5 px-4 bg-slate-900 hover:bg-slate-800 text-white rounded-lg text-sm font-medium transition flex items-center justify-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg> å……å€¼èµ„é‡‘
                            </button>` : ''}
                            
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="window._toggleCardReveal('${c.id}')" id="btn-reveal-${c.id}" class="py-2.5 px-2 bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 rounded-lg text-xs font-bold transition flex items-center justify-center gap-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" stroke-width="2"/><path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" stroke-width="2"/></svg>
                                    æŸ¥çœ‹å®Œæ•´å¡å¯†
                                </button>
                                <button onclick="toggleCardFreeze('${c.id}')" class="py-2.5 px-2 bg-white border border-slate-200 hover:bg-red-50 hover:text-red-600 hover:border-red-200 text-slate-700 rounded-lg text-xs font-bold transition">${isFrozen?'è§£å†»å¡ç‰‡':'å†»ç»“å¡ç‰‡'}</button>
                            </div>
                            
                            <button onclick="openSetLimitModal('${c.id}')" class="w-full py-2.5 px-4 bg-white border border-slate-200 hover:border-indigo-500 hover:text-indigo-600 text-slate-700 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2">
                                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/></svg> è°ƒæ•´é£æ§é™é¢
                            </button>
                        </div>
                    </div>

                    <div class="bg-white border border-slate-200 rounded-xl p-5 shadow-sm space-y-4">
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider">å¡ç‰‡ä¿¡æ¯</h3>
                        
                        <div class="flex justify-between items-center py-2 border-b border-slate-50">
                            <span class="text-sm text-slate-500">CVV å®‰å…¨ç </span>
                            <div class="flex items-center gap-2">
                                <span id="cvv-text-${c.id}" class="font-mono font-bold bg-slate-100 text-slate-500 px-2 py-0.5 rounded tracking-widest text-xs min-w-[30px] text-center">***</span>
                                <button onclick="toggleCVV(this, '${c.cvv}')" class="text-xs text-indigo-600 font-bold hover:underline">æŸ¥çœ‹</button>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center py-2 border-b border-slate-50">
                            <span class="text-sm text-slate-500">è´¦å•åœ°å€</span>
                            <span class="text-xs text-slate-600 truncate max-w-[150px]" title="4522 SW 3rd St">4522 SW 3rd St...</span>
                        </div>
                        
                        <div class="flex justify-between items-center py-2">
                            <span class="text-sm text-slate-500">åˆ›å»ºæ—¥æœŸ</span>
                            <span class="text-xs text-slate-700 font-mono">2025-11-20</span>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-8 space-y-6">
                    <div class="bg-white border border-slate-200 rounded-xl shadow-sm min-h-[500px] flex flex-col">
                        <div class="flex border-b border-slate-100 px-6">
                            <button onclick="window._setTab('overview')" class="py-4 mr-6 text-sm font-medium border-b-2 transition ${ _cardState.activeTab==='overview'?'border-slate-800 text-slate-800':'border-transparent text-slate-500 hover:text-slate-700'}">æ¦‚è§ˆåˆ†æ</button>
                            <button onclick="window._setTab('limits')" class="py-4 mr-6 text-sm font-medium border-b-2 transition ${ _cardState.activeTab==='limits'?'border-slate-800 text-slate-800':'border-transparent text-slate-500 hover:text-slate-700'}">é£æ§é™é¢</button>
                            <button onclick="window._setTab('transactions')" class="py-4 mr-6 text-sm font-medium border-b-2 transition ${ _cardState.activeTab==='transactions'?'border-slate-800 text-slate-800':'border-transparent text-slate-500 hover:text-slate-700'}">äº¤æ˜“æµæ°´</button>
                        </div>

                        <div class="p-6 flex-1">
                            ${_renderTabContent(c, limits, spentSingle, spentDaily, spentMonthly)}
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
    };

    // --- 5. Tab å†…å®¹æ¸²æŸ“å™¨ (å«ä¿®å¤åçš„é™é¢Tab) ---
    const _renderTabContent = (c, limits, spentS, spentD, spentM) => {
        const isShared = c.mode === 'shared';
        
        // æ¸²æŸ“è¿›åº¦æ¡è¾…åŠ©
        const renderLimitBar = (title, max, used) => {
            const pct = max > 0 ? Math.min((used / max) * 100, 100) : 0;
            return `
            <div class="mb-6">
                <div class="flex justify-between text-sm mb-2">
                    <span class="text-slate-700 font-bold">${title}</span>
                    <span class="text-slate-500 text-xs">å·²ç”¨ $${used.toLocaleString()} / <span class="text-slate-900 font-bold">$${max.toLocaleString()}</span></span>
                </div>
                <div class="w-full h-3 bg-slate-100 rounded-full overflow-hidden border border-slate-50 relative">
                    <div class="h-full ${isShared?'bg-purple-500':'bg-indigo-500'} transition-all duration-1000" style="width: ${pct}%"></div>
                </div>
            </div>`;
        };

        if (_cardState.activeTab === 'limits') {
            // è¿™é‡Œå°±æ˜¯æ‚¨è¦æ±‚çš„ï¼šå±•ç¤ºä¸‰ä¸ªç»´åº¦çš„é™é¢
            return `
            <div class="p-4">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h3 class="text-lg font-bold text-slate-800">äº¤æ˜“é™é¢ç›‘æ§</h3>
                        <p class="text-xs text-slate-500 mt-1">å®æ—¶ç›‘æ§å¡ç‰‡åœ¨ä¸åŒæ—¶é—´ç»´åº¦çš„æ¶ˆè´¹æƒ…å†µã€‚</p>
                    </div>
                    <button onclick="openSetLimitModal('${c.id}')" class="px-4 py-2 border border-indigo-200 text-indigo-600 bg-indigo-50 rounded-lg text-xs font-bold hover:bg-indigo-100 transition">ä¿®æ”¹é…ç½®</button>
                </div>
                
                <div class="bg-slate-50 rounded-xl p-6 border border-slate-100">
                    ${renderLimitBar('å•ç¬”äº¤æ˜“é™é¢ (Single Transaction)', limits.single, 0)}
                    ${renderLimitBar('å•æ—¥äº¤æ˜“é™é¢ (Daily Limit)', limits.daily, 120.50)}
                    ${renderLimitBar('å•æœˆäº¤æ˜“é™é¢ (Monthly Limit)', limits.monthly, 1450.20)}
                </div>
                
                <p class="text-xs text-slate-400 mt-4 text-center">* ç»Ÿè®¡å‘¨æœŸä¸º UTC æ—¶é—´ã€‚ä¿®æ”¹é™é¢åå®æ—¶ç”Ÿæ•ˆã€‚</p>
            </div>`;
        }

        if (_cardState.activeTab === 'overview') {
            return `
            <div class="space-y-8">
                ${isShared 
                    ? `<div class="p-5 bg-purple-50 rounded-xl border border-purple-100 flex items-center justify-between">
                         <div><p class="text-xs text-purple-800 font-bold mb-1">èµ„é‡‘æ¥æº</p><p class="text-sm text-purple-900 font-bold">ä¼ä¸šå…±äº«èµ„é‡‘æ±  (Shared Wallet)</p></div>
                         <div class="text-right"><p class="text-xs text-purple-600 mb-1">æœ¬æœˆæ¶ˆè€—</p><p class="text-xl font-bold text-slate-800">$${spentM.toLocaleString()}</p></div>
                       </div>`
                    : `<div class="p-5 bg-indigo-50 rounded-xl border border-indigo-100 flex items-center justify-between">
                         <div><p class="text-xs text-indigo-800 font-bold mb-1">å¡ç‰‡ä½™é¢</p><p class="text-2xl font-bold text-slate-800">$${c.balance.toFixed(2)}</p></div>
                       </div>`
                }
                <div>
                    <h4 class="text-sm font-bold text-slate-900 mb-4">æ”¯å‡ºè¶‹åŠ¿</h4>
                    <div class="h-40 bg-white border border-slate-100 rounded-lg flex items-end justify-around p-4 pb-0 gap-2">
                        <div class="w-full bg-slate-100 rounded-t h-[40%] hover:bg-indigo-200 transition"></div>
                        <div class="w-full bg-slate-100 rounded-t h-[60%] hover:bg-indigo-200 transition"></div>
                        <div class="w-full bg-slate-100 rounded-t h-[30%] hover:bg-indigo-200 transition"></div>
                        <div class="w-full bg-slate-100 rounded-t h-[80%] hover:bg-indigo-200 transition"></div>
                        <div class="w-full bg-slate-100 rounded-t h-[50%] hover:bg-indigo-200 transition"></div>
                    </div>
                </div>
            </div>`;
        }
        
        if (_cardState.activeTab === 'transactions') {
            const txs = [
                { m: 'AWS WEB SERVICES', d: 'ä»Šå¤© 10:23', a: -120.50, s: 'success' },
                { m: 'FACEBOOK ADS *INC', d: 'æ˜¨å¤© 16:15', a: -450.00, s: 'success' },
                { m: 'GOOGLE GSUITE', d: '11æœˆ18æ—¥ 09:00', a: -12.00, s: 'success' },
                { m: 'High Risk Merchant', d: '11æœˆ15æ—¥ 02:30', a: -99.00, s: 'declined' }
            ];
            return `
            <table class="w-full text-sm text-left">
                <thead class="text-slate-500 border-b border-slate-100"><tr><th class="py-3 font-medium">äº¤æ˜“å•†æˆ·</th><th class="py-3 font-medium">æ—¶é—´</th><th class="py-3 font-medium text-right">é‡‘é¢</th><th class="py-3 font-medium text-right">çŠ¶æ€</th></tr></thead>
                <tbody class="divide-y divide-slate-50">
                    ${txs.map(t => `
                        <tr class="group hover:bg-slate-50 transition">
                            <td class="py-4 font-medium text-slate-800">${t.m}</td>
                            <td class="py-4 text-slate-500">${t.d}</td>
                            <td class="py-4 text-right font-mono text-slate-800">$${Math.abs(t.a).toFixed(2)}</td>
                            <td class="py-4 text-right"><span class="px-2 py-1 rounded text-xs font-bold ${t.s==='success'?'text-green-600 bg-green-50':'text-red-600 bg-red-50'}">${t.s==='success'?'æˆåŠŸ':'å¤±è´¥'}</span></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>`;
        }
    };

    // --- 6. äº¤äº’é€»è¾‘ ---
    window._setCardFilter = (f) => { _cardState.filter = f; showView('cards'); }
    window._searchCard = (q) => { _cardState.searchQuery = q.toLowerCase(); showView('cards'); }
    
    // è·¯ç”±åˆ°è¯¦æƒ…é¡µ
    window._goToDetail = (id) => { 
        _cardState.detailId = id; 
        _cardState.activeTab = 'overview'; // é»˜è®¤è¿›æ¦‚è§ˆ
        const container = document.getElementById('content-area');
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        container.innerHTML = views.card_detail();
        document.querySelector('main').scrollTop = 0;
    }
    
    window._setTab = (t) => {
        _cardState.activeTab = t;
        const container = document.getElementById('content-area');
        container.innerHTML = views.card_detail();
    }

    // æ–°å¢ï¼šåˆ‡æ¢å¡å·è§£å¯† (Visual Toggle)
    window._toggleCardReveal = (cardId) => {
        const el = document.getElementById(`visual-card-number-${cardId}`);
        const btn = document.getElementById(`btn-reveal-${cardId}`);
        const card = myCards.find(c => c.id === cardId);
        
        if (!el || !card) return;

        if (btn.innerText.includes('æŸ¥çœ‹')) {
            // è§£å¯†ï¼šæ˜¾ç¤ºçœŸå®å¡å· (å¸¦ç©ºæ ¼æ ¼å¼åŒ–)
            el.innerText = card.number.match(/.{1,4}/g).join(' ');
            el.classList.add('text-yellow-300'); // é«˜äº®ä¸€ä¸‹
            btn.innerHTML = `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> éšè—å¡å·`;
        } else {
            // åŠ å¯†
            el.innerText = card.number.slice(0, 4) + ' **** **** ' + card.number.slice(-4);
            el.classList.remove('text-yellow-300');
            btn.innerHTML = `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" stroke-width="2"/><path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" stroke-width="2"/></svg> æŸ¥çœ‹å®Œæ•´å¡å¯†`;
        }
    }

    // åˆå§‹åŒ–
    if(document.querySelector('h2') && document.querySelector('h2').innerText.includes('å¡ç‰‡')) showView('cards');
}
</script>
<script>
{
    // --- 1. å…¨å±€çŠ¶æ€ ---
    window._cardState = window._cardState || { filter: 'all', detailId: null, activeTab: 'overview', searchQuery: '' };

    // --- 2. æ ¸å¿ƒç»„ä»¶ï¼šé«˜äº¤äº’æ‹ŸçœŸå¡é¢ (é›†æˆæ˜¾éš+CVV) ---
    const renderInteractiveCard = (card) => {
        const isVisa = card.type === 'Visa';
        const isShared = card.mode === 'shared';
        // åŠ¨æ€èƒŒæ™¯è‰²
        const bgClass = isShared 
            ? 'bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900' 
            : (isVisa ? 'bg-gradient-to-br from-blue-600 to-indigo-700' : 'bg-gradient-to-br from-orange-400 to-red-500');
        
        // åˆå§‹æ©ç çŠ¶æ€
        const maskedNum = card.number.slice(0, 4) + ' â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ ' + card.number.slice(-4);

        return `
        <div class="relative w-full aspect-[1.586/1] rounded-2xl ${bgClass} p-6 text-white shadow-2xl overflow-hidden group select-none transition-transform hover:scale-[1.01] duration-500">
            <div class="absolute inset-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')]"></div>
            <div class="absolute -top-24 -right-24 w-64 h-64 bg-white/10 rounded-full blur-3xl pointer-events-none"></div>
            
            <div class="relative z-10 flex flex-col justify-between h-full">
                <div class="flex justify-between items-start">
                    <span class="font-bold italic text-lg tracking-wider opacity-90">${card.type.toUpperCase()}</span>
                    <div class="flex gap-2">
                        ${card.status === 'frozen' ? '<span class="px-2 py-0.5 bg-red-500 text-white text-[10px] font-bold rounded animate-pulse">FROZEN</span>' : ''}
                        ${isShared ? '<span class="px-2 py-0.5 bg-white/20 text-[10px] font-bold rounded border border-white/10">SHARED</span>' : '<span class="px-2 py-0.5 bg-white/20 text-[10px] font-bold rounded border border-white/10">PREPAID</span>'}
                    </div>
                </div>
                
                <div class="my-auto">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-9 h-6 bg-yellow-200/20 rounded flex items-center justify-center border border-white/20 backdrop-blur-sm"><div class="w-5 h-3 border border-white/40 rounded-sm"></div></div>
                        <svg class="w-5 h-5 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"></path></svg>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <p id="card-num-${card.id}" class="font-mono text-2xl tracking-[0.12em] drop-shadow-md cursor-pointer hover:text-indigo-100 transition truncate mr-2" onclick="copyText('${card.number}', 'å¡å·')" title="ç‚¹å‡»å¤åˆ¶">
                            ${maskedNum}
                        </p>
                        <button onclick="window._toggleCardReveal('${card.id}')" class="p-2 hover:bg-white/20 rounded-full transition text-white/70 hover:text-white focus:outline-none" title="æ˜¾ç¤º/éšè—å¡å·">
                            <svg id="eye-icon-${card.id}" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                        </button>
                    </div>
                </div>

                <div class="flex justify-between items-end">
                    <div>
                        <p class="text-[8px] uppercase opacity-60 tracking-widest mb-0.5">Holder Name</p>
                        <p class="text-sm font-medium tracking-wide">USER DEMO</p>
                    </div>
                    <div class="flex gap-6 text-right">
                        <div>
                            <p class="text-[8px] uppercase opacity-60 tracking-widest mb-0.5">Expires</p>
                            <p class="text-sm font-mono tracking-wide">${card.exp}</p>
                        </div>
                        <div>
                            <p class="text-[8px] uppercase opacity-60 tracking-widest mb-0.5">CVV</p>
                            <p id="card-cvv-${card.id}" class="text-sm font-mono tracking-widest cursor-pointer hover:text-yellow-300 font-bold underline decoration-dotted underline-offset-4" onclick="window._toggleCVVOnCard('${card.id}')" title="ç‚¹å‡»æŸ¥çœ‹">***</p>
                        </div>
                    </div>
                </div>
            </div>
            
            ${card.status === 'frozen' ? '<div class="absolute inset-0 bg-slate-900/60 backdrop-blur-[2px] z-20 flex items-center justify-center"><div class="border-2 border-white/80 px-6 py-2 rounded-lg text-xl font-bold tracking-[0.2em] transform -rotate-12">å·²å†»ç»“</div></div>' : ''}
        </div>`;
    };

    // --- 3. è§†å›¾ï¼šå¡ç‰‡åˆ—è¡¨ (ä¿æŒä¸å˜) ---
    views.cards = () => {
        const list = myCards.filter(c => {
            const matchType = _cardState.filter === 'all' || (_cardState.filter === 'shared' ? c.mode === 'shared' : c.mode !== 'shared');
            const matchSearch = ! _cardState.searchQuery || c.name.toLowerCase().includes(_cardState.searchQuery.toLowerCase()) || c.number.includes(_cardState.searchQuery);
            return matchType && matchSearch;
        });
        const activeCount = list.filter(c => c.status === 'active').length;
        const totalBalance = list.reduce((sum, c) => sum + (c.mode==='shared'?0:c.balance), 0);

        return `
        <div class="max-w-[1200px] mx-auto fade-in pb-20">
            <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
                <div><h2 class="text-2xl font-bold text-slate-900 tracking-tight">å¡ç‰‡ç®¡ç†</h2><div class="flex items-center gap-4 mt-2 text-sm text-slate-500"><span>æ´»è·ƒå¡ç‰‡: <b class="text-slate-800">${activeCount}</b></span><span class="w-1 h-1 bg-slate-300 rounded-full"></span><span>ç‹¬ç«‹æ€»ä½™é¢: <b class="text-slate-800">$${totalBalance.toLocaleString()}</b></span></div></div>
                <div class="flex gap-3"><button onclick="showView('apply')" class="px-5 py-2.5 bg-slate-900 hover:bg-slate-800 text-white rounded-lg text-sm font-semibold shadow-lg shadow-slate-200 transition flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>ç”³è¯·æ–°å¡</button></div>
            </div>
            <div class="bg-white border border-slate-200 rounded-xl p-1.5 flex justify-between items-center mb-6 shadow-sm">
                <div class="flex gap-1"><button onclick="window._setCardFilter('all')" class="px-4 py-2 rounded-lg text-sm font-medium transition ${_cardState.filter === 'all' ? 'bg-slate-100 text-slate-900 shadow-sm' : 'text-slate-500 hover:bg-slate-50 hover:text-slate-700'}">å…¨éƒ¨</button><button onclick="window._setCardFilter('prepaid')" class="px-4 py-2 rounded-lg text-sm font-medium transition ${_cardState.filter === 'prepaid' ? 'bg-indigo-50 text-indigo-600 shadow-sm' : 'text-slate-500 hover:bg-slate-50 hover:text-slate-700'}">æ™®é€šå¡</button><button onclick="window._setCardFilter('shared')" class="px-4 py-2 rounded-lg text-sm font-medium transition ${_cardState.filter === 'shared' ? 'bg-purple-50 text-purple-600 shadow-sm' : 'text-slate-500 hover:bg-slate-50 hover:text-slate-700'}">å…±äº«å¡</button></div>
                <div class="relative mr-2 hidden md:block"><input type="text" placeholder="æœç´¢å¡å· / å¤‡æ³¨å..." oninput="window._searchCard(this.value)" class="pl-9 pr-4 py-2 bg-slate-50 border-none rounded-lg text-sm w-64 focus:ring-2 focus:ring-indigo-500/20 text-slate-800 placeholder:text-slate-400 outline-none transition"><svg class="w-4 h-4 text-slate-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg></div>
            </div>
            <div class="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 border-b border-slate-200 text-slate-500"><tr><th class="px-6 py-4 font-medium w-64">å¡ç‰‡ä¿¡æ¯</th><th class="px-6 py-4 font-medium">å®Œæ•´å¡å·</th><th class="px-6 py-4 font-medium">ç±»å‹</th><th class="px-6 py-4 font-medium text-right">å¯ç”¨ä½™é¢/é™é¢</th><th class="px-6 py-4 font-medium text-center">çŠ¶æ€</th><th class="px-6 py-4 font-medium text-right">æ“ä½œ</th></tr></thead>
                    <tbody class="divide-y divide-slate-100">${list.length > 0 ? list.map(c => `<tr onclick="window._goToDetail('${c.id}')" class="hover:bg-slate-50/80 transition cursor-pointer group"><td class="px-6 py-4 font-medium text-slate-900">${c.name}<div class="text-[10px] font-normal text-slate-400 mt-0.5">${c.product}</div></td><td class="px-6 py-4 font-mono text-slate-600">â€¢â€¢â€¢â€¢ ${c.number.slice(-4)}</td><td class="px-6 py-4">${c.mode === 'shared' ? '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-50 text-purple-700">å…±äº«å¡</span>' : '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-600">æ™®é€šå¡</span>'}</td><td class="px-6 py-4 text-right">${c.mode === 'shared' ? '<span class="text-slate-400 text-xs">å…±äº«ä¸»è´¦æˆ·</span>' : `<span class="font-bold text-slate-800">$${c.balance.toFixed(2)}</span>`}</td><td class="px-6 py-4 text-center"><span class="inline-flex w-2.5 h-2.5 rounded-full ${c.status === 'active' ? 'bg-emerald-500' : 'bg-rose-500'}"></span></td><td class="px-6 py-4 text-right text-slate-400"><span class="text-xs group-hover:text-indigo-600 transition">æŸ¥çœ‹è¯¦æƒ… ></span></td></tr>`).join('') : '<tr><td colspan="6" class="p-12 text-center text-slate-400">æš‚æ— ç¬¦åˆæ¡ä»¶çš„å¡ç‰‡</td></tr>'}</tbody>
                </table>
            </div>
        </div>`;
    };

    // --- 4. è§†å›¾ï¼šå¡ç‰‡è¯¦æƒ…é¡µ (ç‹¬ç«‹é¡µé¢) ---
    views.card_detail = () => {
        const c = myCards.find(item => item.id === window._cardState.detailId);
        if (!c) return views.cards();

        const isShared = c.mode === 'shared';
        const isFrozen = c.status === 'frozen';
        
        // åˆå§‹åŒ–ä¸‰çº§é™é¢
        const defaultLimit = c.limit || 5000;
        const limits = c.limits || { single: defaultLimit, daily: defaultLimit * 2, monthly: defaultLimit * 10 };
        const usedData = { daily: 120.50, monthly: 1450.20 };

        return `
        <div class="max-w-[1200px] mx-auto fade-in pb-20">
            <div class="flex items-center gap-3 text-sm text-slate-500 mb-8">
                <button onclick="showView('cards')" class="hover:text-indigo-600 transition flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>è¿”å›åˆ—è¡¨
                </button>
                <span class="text-slate-300">/</span>
                <span class="font-medium text-slate-900">${c.name}</span>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                
                <div class="lg:col-span-4 space-y-6">
                    ${renderInteractiveCard(c)}
                    
                    <div class="bg-white border border-slate-200 rounded-xl p-5 shadow-sm">
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">å¿«æ·æ“ä½œ</h3>
                        <div class="space-y-3">
                            ${!isShared ? `
                            <button onclick="openRechargeCardModal('${c.id}')" class="w-full py-2.5 px-4 bg-slate-900 hover:bg-slate-800 text-white rounded-lg text-sm font-medium transition flex items-center justify-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg> å……å€¼èµ„é‡‘
                            </button>` : ''}
                            
                            <button onclick="window.openLimitsModal('${c.id}')" class="w-full py-2.5 px-4 bg-white border border-slate-200 hover:border-indigo-500 hover:text-indigo-600 text-slate-700 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2">
                                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/></svg> è°ƒæ•´é£æ§é™é¢
                            </button>
                            
                            <button onclick="toggleCardFreeze('${c.id}')" class="w-full py-2.5 px-4 bg-white border border-slate-200 hover:bg-red-50 hover:text-red-600 hover:border-red-200 text-slate-600 rounded-lg text-sm font-medium transition">${c.status==='frozen'?'è§£å†»å¡ç‰‡':'å†»ç»“å¡ç‰‡'}</button>
                        </div>
                    </div>

                    <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-4 shadow-sm relative group">
                        <div class="flex justify-between items-start mb-2">
                            <p class="text-[10px] font-bold text-indigo-400 uppercase tracking-wider flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" stroke-width="2"/><path d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" stroke-width="2"/></svg>
                                è´¦å•åœ°å€ (Billing Address)
                            </p>
                            <button onclick="copyText('4522 SW 3rd St, Miami, FL 33125, US', 'è´¦å•åœ°å€')" class="text-xs text-indigo-600 hover:text-indigo-800 font-bold">å¤åˆ¶</button>
                        </div>
                        <p class="text-sm text-slate-700 font-mono leading-relaxed select-all">4522 SW 3rd St, Miami, FL 33125, US</p>
                        <div class="mt-3 pt-3 border-t border-indigo-200/50 text-[10px] text-indigo-500/80 leading-tight">
                            * æ”¯ä»˜æ—¶è¯·åŠ¡å¿…å¡«å†™æ­¤åœ°å€ï¼Œå¦åˆ™å¯èƒ½å›  AVS éªŒè¯å¤±è´¥å¯¼è‡´æ‹’ä»˜ã€‚
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-8 bg-white border border-slate-200 rounded-xl shadow-sm min-h-[500px] flex flex-col">
                    <div class="flex border-b border-slate-100 px-6">
                        <button onclick="window._setTab('overview')" class="py-4 mr-6 text-sm font-medium border-b-2 transition ${ _cardState.activeTab==='overview'?'border-slate-800 text-slate-800':'border-transparent text-slate-500 hover:text-slate-700'}">æ¦‚è§ˆåˆ†æ</button>
                        <button onclick="window._setTab('limits')" class="py-4 mr-6 text-sm font-medium border-b-2 transition ${ _cardState.activeTab==='limits'?'border-slate-800 text-slate-800':'border-transparent text-slate-500 hover:text-slate-700'}">é£æ§é™é¢</button>
                        <button onclick="window._setTab('transactions')" class="py-4 text-sm font-medium border-b-2 transition ${ _cardState.activeTab==='transactions'?'border-slate-800 text-slate-800':'border-transparent text-slate-500 hover:text-slate-700'}">äº¤æ˜“æµæ°´</button>
                    </div>

                    <div class="p-6 flex-1">
                        ${_renderTabContent(c, limits, usedData)}
                    </div>
                </div>
            </div>
        </div>`;
    };

    // --- 4. Tab å†…å®¹æ¸²æŸ“ (å«è¿›åº¦æ¡) ---
    const _renderTabContent = (c, limits, used) => {
        const isShared = c.mode === 'shared';
        
        const renderProgress = (label, max, current, color = 'bg-indigo-500') => {
            const pct = max > 0 ? Math.min((current / max) * 100, 100) : 0;
            return `
            <div class="mb-6">
                <div class="flex justify-between text-sm mb-2">
                    <span class="text-slate-700 font-bold">${label}</span>
                    <span class="text-slate-500 text-xs">å·²ç”¨ $${current.toLocaleString()} / <span class="text-slate-900 font-bold">$${max.toLocaleString()}</span></span>
                </div>
                <div class="w-full h-2.5 bg-slate-100 rounded-full overflow-hidden border border-slate-50 relative">
                    <div class="h-full ${color} transition-all duration-1000" style="width: ${pct}%"></div>
                </div>
            </div>`;
        };

        if (_cardState.activeTab === 'limits') {
            return `
            <div class="p-4">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h3 class="text-lg font-bold text-slate-800">é£æ§é™é¢ç›‘æ§</h3>
                        <p class="text-xs text-slate-500 mt-1">ç®¡ç†å¡ç‰‡åœ¨ä¸åŒæ—¶é—´ç»´åº¦çš„æ¶ˆè´¹ä¸Šé™ã€‚</p>
                    </div>
                    <button onclick="window.openLimitsModal('${c.id}')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-xs font-bold hover:bg-indigo-700 shadow-sm transition">ä¿®æ”¹é…ç½®</button>
                </div>
                <div class="bg-slate-50 rounded-xl p-8 border border-slate-100">
                    ${renderProgress('å•ç¬”äº¤æ˜“é™é¢ (Per Transaction)', limits.single, 0, 'bg-emerald-500')}
                    ${renderProgress('å•æ—¥äº¤æ˜“é™é¢ (Daily Limit)', limits.daily, used.daily, 'bg-blue-500')}
                    ${renderProgress('å•æœˆäº¤æ˜“é™é¢ (Monthly Limit)', limits.monthly, used.monthly, 'bg-purple-500')}
                </div>
            </div>`;
        }
        
        if (_cardState.activeTab === 'overview') {
            return `
            <div class="space-y-6">
                ${isShared 
                    ? `<div class="p-5 bg-purple-50 rounded-xl border border-purple-100 flex items-center justify-between">
                         <div><p class="text-xs text-purple-800 font-bold mb-1">èµ„é‡‘æ¥æº</p><p class="text-sm text-purple-900">å…±äº«ä¸»é’±åŒ…ä½™é¢</p></div>
                         <div class="text-right"><p class="text-2xl font-bold text-slate-800">$${currentUser.balance.toLocaleString()}</p></div>
                       </div>`
                    : `<div class="p-5 bg-indigo-50 rounded-xl border border-indigo-100 flex items-center justify-between">
                         <div><p class="text-xs text-indigo-800 font-bold mb-1">èµ„é‡‘çŠ¶æ€</p><p class="text-sm text-indigo-900">å¡ç‰‡ç‹¬ç«‹ä½™é¢</p></div>
                         <div class="text-right"><p class="text-2xl font-bold text-slate-800">$${c.balance.toFixed(2)}</p></div>
                       </div>`
                }
                <div class="border border-dashed border-slate-200 rounded-xl h-48 flex items-center justify-center text-slate-400 text-xs bg-slate-50/50">[å›¾è¡¨åŒºåŸŸ]</div>
            </div>`;
        }

        if (_cardState.activeTab === 'transactions') {
            return `<div class="text-center py-10 text-slate-400 text-sm">æš‚æ— è¿‘æœŸäº¤æ˜“è®°å½•</div>`;
        }
    };

    // --- 5. äº¤äº’é€»è¾‘ ---

    // å¡é¢äº¤äº’ï¼šæ˜¾éšå¡å· (ç‚¹å‡»çœ¼ç›)
    window._toggleCardReveal = (id) => {
        const numEl = document.getElementById(`card-num-${id}`);
        const iconEl = document.getElementById(`eye-icon-${id}`);
        const card = myCards.find(c => c.id == id);
        if(!card) return;

        const isHidden = numEl.innerText.includes('â€¢â€¢â€¢â€¢');
        if (isHidden) {
            numEl.innerText = card.number.match(/.{1,4}/g).join(' '); 
            iconEl.classList.add('text-white');
            iconEl.classList.remove('text-white/70');
        } else {
            numEl.innerText = card.number.slice(0, 4) + ' â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ ' + card.number.slice(-4);
            iconEl.classList.remove('text-white');
            iconEl.classList.add('text-white/70');
        }
    }

    // å¡é¢äº¤äº’ï¼šæ˜¾éšCVV (ç‚¹å‡»CVVæ–‡æœ¬)
    window._toggleCVVOnCard = (id) => {
        const el = document.getElementById(`card-cvv-${id}`);
        const card = myCards.find(c => c.id == id);
        if(!card) return;
        if(el.innerText === '***') {
            el.innerText = card.cvv;
        } else {
            el.innerText = '***';
        }
    }

    // è®¾ç½®é™é¢å¼¹çª— (ä¸¥æ ¼ä¸‰çº§é™é¢)
    window.openLimitsModal = function(cardId) {
        const card = myCards.find(c => c.id == cardId);
        if (!card) return;
        const limits = card.limits || { single: card.limit||5000, daily: (card.limit||5000)*2, monthly: (card.limit||5000)*10 };

        const modalHTML = `
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[90] flex items-center justify-center fade-in">
            <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                    <h3 class="font-bold text-slate-800">é…ç½®é£æ§é™é¢</h3>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
                </div>
                <div class="p-6 space-y-5">
                    <div class="space-y-4">
                        <div><label class="flex justify-between text-xs font-bold text-slate-600 mb-1.5">âš¡ å•ç¬”é™é¢</label><div class="relative"><span class="absolute left-3 top-2.5 text-slate-400 font-bold">$</span><input type="number" id="limit-s" class="w-full pl-7 pr-4 py-2.5 border border-slate-200 rounded-lg text-sm font-bold text-slate-800 outline-none focus:border-indigo-500" value="${limits.single}"></div></div>
                        <div><label class="flex justify-between text-xs font-bold text-slate-600 mb-1.5">ğŸ“… å•æ—¥é™é¢</label><div class="relative"><span class="absolute left-3 top-2.5 text-slate-400 font-bold">$</span><input type="number" id="limit-d" class="w-full pl-7 pr-4 py-2.5 border border-slate-200 rounded-lg text-sm font-bold text-slate-800 outline-none focus:border-indigo-500" value="${limits.daily}"></div></div>
                        <div><label class="flex justify-between text-xs font-bold text-slate-600 mb-1.5">ğŸ—“ å•æœˆé™é¢</label><div class="relative"><span class="absolute left-3 top-2.5 text-slate-400 font-bold">$</span><input type="number" id="limit-m" class="w-full pl-7 pr-4 py-2.5 border border-slate-200 rounded-lg text-sm font-bold text-slate-800 outline-none focus:border-indigo-500" value="${limits.monthly}"></div></div>
                    </div>
                    <button onclick="window._saveLimits('${card.id}')" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg transition">ä¿å­˜ç­–ç•¥</button>
                </div>
            </div>
        </div>`;
        document.getElementById('modal-container').innerHTML = modalHTML;
    }

    window._saveLimits = (id) => {
        const s = parseFloat(document.getElementById('limit-s').value) || 0;
        const d = parseFloat(document.getElementById('limit-d').value) || 0;
        const m = parseFloat(document.getElementById('limit-m').value) || 0;
        
        if (s > d || d > m) return alert('é€»è¾‘é”™è¯¯ï¼šå•ç¬”é™é¢ä¸èƒ½å¤§äºæ—¥é™é¢ï¼Œæ—¥é™é¢ä¸èƒ½å¤§äºæœˆé™é¢ã€‚');
        
        const card = myCards.find(c => c.id == id);
        if(card) {
            card.limits = { single: s, daily: d, monthly: m };
            card.limit = s; 
            alert('âœ… é£æ§ç­–ç•¥å·²æ›´æ–°');
            closeModal();
            window._goToDetail(id); 
        }
    }

    // è¾…åŠ©
    window.copyText = (text, label) => { navigator.clipboard.writeText(text).then(() => alert(`${label} å·²å¤åˆ¶`)); }
    window._setCardFilter = (f) => { _cardState.filter = f; showView('cards'); }
    window._searchCard = (q) => { _cardState.searchQuery = q.toLowerCase(); showView('cards'); }
    window._goToDetail = (id) => { _cardState.detailId = id; _cardState.activeTab = 'overview'; const c = document.getElementById('content-area'); document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active')); c.innerHTML = views.card_detail(); document.querySelector('main').scrollTop = 0; }
    window._setTab = (t) => { _cardState.activeTab = t; document.getElementById('content-area').innerHTML = views.card_detail(); }

    if(document.querySelector('h2') && document.querySelector('h2').innerText.includes('å¡ç‰‡')) showView('cards');
}
</script>
<script>
{
    // --- 1. å…¨å±€çŠ¶æ€ä¸æ¨¡æ‹Ÿæ•°æ® ---
    window._cardState = window._cardState || { filter: 'all', detailId: null, activeTab: 'overview', searchQuery: '' };

    // æ¨¡æ‹Ÿäº¤æ˜“æ•°æ®ç”Ÿæˆå™¨
    const getMockTransactions = (cardId) => {
        return [
            { id: 'tx_1', m: 'AWS WEB SERVICES', d: '2025-11-21 14:20', a: -120.50, s: 'success', type: 'äº‘æœåŠ¡' },
            { id: 'tx_2', m: 'FACEBOOK ADS *INC', d: '2025-11-20 09:15', a: -450.00, s: 'success', type: 'å¹¿å‘Š' },
            { id: 'tx_3', m: 'GOOGLE GSUITE', d: '2025-11-18 10:00', a: -12.00, s: 'success', type: 'è®¢é˜…' },
            { id: 'tx_4', m: 'Suspicious Merch', d: '2025-11-15 03:40', a: -99.00, s: 'declined', type: 'é£é™©' },
            { id: 'tx_5', m: 'OpenAI API', d: '2025-11-12 18:22', a: -20.00, s: 'success', type: 'AI' }
        ];
    };

    // --- 2. æ ¸å¿ƒç»„ä»¶ï¼šå¡é¢ (æ”¯æŒ å¡å·/CVV åŒç‹¬ç«‹æ˜¾éš) ---
    const renderInteractiveCard = (card) => {
        const isVisa = card.type === 'Visa';
        const isShared = card.mode === 'shared';
        const bgClass = isShared 
            ? 'bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900' 
            : (isVisa ? 'bg-gradient-to-br from-blue-600 to-indigo-700' : 'bg-gradient-to-br from-orange-400 to-red-500');
        
        // åˆå§‹çŠ¶æ€ï¼šå¡å·æ‰“ç ï¼ŒCVVæ‰“ç 
        // æˆ‘ä»¬åˆ©ç”¨ HTML data å±æ€§æ¥å­˜å‚¨çœŸå®å€¼ï¼Œé€šè¿‡ JS åˆ‡æ¢æ˜¾ç¤ºå†…å®¹
        const maskedNum = card.number.slice(0, 4) + ' â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ ' + card.number.slice(-4);
        const realNumFormatted = card.number.match(/.{1,4}/g).join(' ');

        return `
        <div class="relative w-full aspect-[1.586/1] rounded-2xl ${bgClass} p-6 text-white shadow-2xl overflow-hidden group select-none transition-transform hover:scale-[1.01] duration-500">
            <div class="absolute inset-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')]"></div>
            <div class="absolute -top-24 -right-24 w-64 h-64 bg-white/10 rounded-full blur-3xl pointer-events-none"></div>
            
            <div class="relative z-10 flex flex-col justify-between h-full">
                <div class="flex justify-between items-start">
                    <span class="font-bold italic text-lg tracking-wider opacity-90">${card.type.toUpperCase()}</span>
                    <div class="flex gap-2">
                        ${card.status === 'frozen' ? '<span class="px-2 py-0.5 bg-red-500 text-white text-[10px] font-bold rounded animate-pulse">FROZEN</span>' : ''}
                        ${isShared ? '<span class="px-2 py-0.5 bg-white/20 text-[10px] font-bold rounded border border-white/10">SHARED</span>' : '<span class="px-2 py-0.5 bg-white/20 text-[10px] font-bold rounded border border-white/10">PREPAID</span>'}
                    </div>
                </div>
                
                <div class="my-auto">
                    <div class="flex items-center gap-3 mb-1">
                        <div class="w-8 h-5 bg-yellow-200/20 rounded flex items-center justify-center border border-white/20"><div class="w-5 h-3 border border-white/40 rounded-sm"></div></div>
                        <svg class="w-5 h-5 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"></path></svg>
                    </div>
                    <div class="flex items-center justify-between group/pan">
                        <p id="card-num-${card.id}" 
                           data-real="${realNumFormatted}" 
                           data-mask="${maskedNum}"
                           data-state="masked"
                           class="font-mono text-2xl tracking-[0.12em] drop-shadow-md cursor-pointer hover:text-indigo-100 transition" 
                           onclick="window._toggleNum('${card.id}')" 
                           title="ç‚¹å‡»åˆ‡æ¢æ˜¾éš">${maskedNum}</p>
                        
                        <button onclick="window._toggleNum('${card.id}')" class="p-2 hover:bg-white/10 rounded-full transition text-white/70 hover:text-white" title="æ˜¾ç¤º/éšè—">
                            <svg id="icon-num-${card.id}" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </button>
                    </div>
                </div>

                <div class="flex justify-between items-end">
                    <div class="flex gap-6">
                        <div><p class="text-[8px] uppercase opacity-60 tracking-widest mb-0.5">Expires</p><p class="text-sm font-mono tracking-wide">${card.exp}</p></div>
                        <div>
                            <p class="text-[8px] uppercase opacity-60 tracking-widest mb-0.5">CVV</p>
                            <p id="card-cvv-${card.id}" 
                               data-real="${card.cvv}" 
                               data-state="masked"
                               class="text-sm font-mono tracking-widest cursor-pointer hover:text-yellow-300 font-bold underline decoration-dotted underline-offset-4" 
                               onclick="window._toggleCVV('${card.id}')" 
                               title="ç‚¹å‡»æŸ¥çœ‹/éšè—">***</p>
                        </div>
                    </div>
                    <div class="text-right"><p class="text-[8px] uppercase opacity-60 tracking-widest mb-0.5">Holder Name</p><p class="text-sm font-medium tracking-wide">USER DEMO</p></div>
                </div>
            </div>
            ${card.status === 'frozen' ? '<div class="absolute inset-0 bg-slate-900/60 backdrop-blur-[2px] z-20 flex items-center justify-center"><div class="border-2 border-white/80 px-6 py-2 rounded-lg text-xl font-bold tracking-[0.2em] transform -rotate-12">å·²å†»ç»“</div></div>' : ''}
        </div>`;
    };

    // --- 3. è§†å›¾ï¼šå¡ç‰‡è¯¦æƒ…é¡µæ¡†æ¶ ---
    views.card_detail = () => {
        const c = myCards.find(item => item.id === window._cardState.detailId);
        if (!c) return views.cards();

        const isShared = c.mode === 'shared';
        const isFrozen = c.status === 'frozen';
        
        // ç¡®ä¿ä¸‰çº§é™é¢å¯¹è±¡å­˜åœ¨
        const limits = c.limits || { single: 5000, daily: 10000, monthly: 50000 };
        const used = { daily: 120.50, monthly: 1450.20 }; // æ¨¡æ‹Ÿæ•°æ®

        return `
        <div class="max-w-[1200px] mx-auto fade-in pb-20">
            <div class="flex items-center gap-3 text-sm text-slate-500 mb-8">
                <button onclick="showView('cards')" class="hover:text-indigo-600 transition flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>è¿”å›åˆ—è¡¨
                </button>
                <span class="text-slate-300">/</span>
                <span class="font-medium text-slate-900">${c.name}</span>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                
                <div class="lg:col-span-4 space-y-6">
                    ${renderInteractiveCard(c)}
                    
                    <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-4 shadow-sm relative group">
                        <div class="flex justify-between items-start mb-2">
                            <p class="text-[10px] font-bold text-indigo-400 uppercase tracking-wider flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" stroke-width="2"/><path d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" stroke-width="2"/></svg>
                                è´¦å•åœ°å€ (Billing Address)
                            </p>
                            <button onclick="copyText('4522 SW 3rd St, Miami, FL 33125, US', 'è´¦å•åœ°å€')" class="text-xs text-indigo-600 hover:text-indigo-800 font-bold">å¤åˆ¶</button>
                        </div>
                        <p class="text-sm text-slate-700 font-mono leading-relaxed select-all">4522 SW 3rd St, Miami, FL 33125, US</p>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        ${!isShared ? `<button onclick="openRechargeCardModal('${c.id}')" class="col-span-2 py-3 bg-slate-900 hover:bg-slate-800 text-white rounded-xl text-sm font-bold shadow-md transition">å……å€¼èµ„é‡‘</button>` : ''}
                        <button onclick="window.openLimitsModal('${c.id}')" class="py-3 border border-slate-200 bg-white hover:border-indigo-500 hover:text-indigo-600 text-slate-700 rounded-xl text-sm font-bold transition">é£æ§é…ç½®</button>
                        <button onclick="window._confirmFreeze('${c.id}')" class="py-3 border border-slate-200 bg-white hover:bg-red-50 hover:text-red-600 hover:border-red-200 text-slate-600 rounded-xl text-sm font-bold transition">${isFrozen?'è§£å†»å¡ç‰‡':'å†»ç»“å¡ç‰‡'}</button>
                    </div>
                </div>

                <div class="lg:col-span-8 bg-white border border-slate-200 rounded-xl shadow-sm min-h-[500px] flex flex-col">
                    <div class="flex border-b border-slate-100 px-6">
                        <button onclick="window._setTab('overview')" class="py-4 mr-6 text-sm font-medium border-b-2 transition ${ _cardState.activeTab==='overview'?'border-slate-800 text-slate-800':'border-transparent text-slate-500 hover:text-slate-700'}">æ¦‚è§ˆåˆ†æ</button>
                        <button onclick="window._setTab('transactions')" class="py-4 mr-6 text-sm font-medium border-b-2 transition ${ _cardState.activeTab==='transactions'?'border-slate-800 text-slate-800':'border-transparent text-slate-500 hover:text-slate-700'}">äº¤æ˜“æµæ°´</button>
                        <button onclick="window._setTab('limits')" class="py-4 text-sm font-medium border-b-2 transition ${ _cardState.activeTab==='limits'?'border-slate-800 text-slate-800':'border-transparent text-slate-500 hover:text-slate-700'}">é£æ§é™é¢</button>
                    </div>

                    <div class="p-6 flex-1">
                        ${_renderTabContent(c, limits, used)}
                    </div>
                </div>
            </div>
        </div>`;
    };

    // --- 4. Tab å†…å®¹æ¸²æŸ“å™¨ (æ·±åº¦å®Œå–„) ---
    const _renderTabContent = (c, limits, used) => {
        const isShared = c.mode === 'shared';
        
        // æ¦‚è§ˆåˆ†æ (æ·±åº¦å®Œå–„)
        if (_cardState.activeTab === 'overview') {
            return `
            <div class="space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${isShared 
                        ? `<div class="p-5 bg-purple-50 rounded-xl border border-purple-100"><p class="text-xs text-purple-800 font-bold mb-1">èµ„é‡‘æ± æ¨¡å¼</p><p class="text-lg font-bold text-slate-800">å…±äº«ä¸»è´¦æˆ·ä½™é¢</p><p class="text-2xl font-bold text-indigo-600 mt-2">$${currentUser.balance.toLocaleString()}</p></div>`
                        : `<div class="p-5 bg-indigo-50 rounded-xl border border-indigo-100"><p class="text-xs text-indigo-800 font-bold mb-1">é¢„ä»˜è´¹æ¨¡å¼</p><p class="text-lg font-bold text-slate-800">å½“å‰å¡å†…ä½™é¢</p><p class="text-2xl font-bold text-indigo-600 mt-2">$${c.balance.toFixed(2)}</p></div>`
                    }
                    <div class="p-5 bg-slate-50 rounded-xl border border-slate-100">
                        <p class="text-xs text-slate-500 font-bold mb-1">æœ¬æœˆæ”¯å‡º</p>
                        <p class="text-lg font-bold text-slate-800">æ”¯å‡ºç»Ÿè®¡</p>
                        <p class="text-2xl font-bold text-slate-800 mt-2">$${used.monthly.toLocaleString()}</p>
                    </div>
                </div>

                <div>
                    <h4 class="text-sm font-bold text-slate-900 mb-4 flex items-center gap-2"><svg class="w-4 h-4 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>æ¯æ—¥æ”¯å‡ºè¶‹åŠ¿ (è¿‘7å¤©)</h4>
                    <div class="h-40 flex items-end justify-between gap-2 px-2">
                        ${[20, 45, 10, 80, 50, 30, 65].map(h => `
                            <div class="w-full bg-indigo-100 rounded-t hover:bg-indigo-500 transition-all duration-300 relative group" style="height: ${h}%">
                                <div class="absolute -top-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-[10px] py-1 px-2 rounded opacity-0 group-hover:opacity-100 transition">$${h*10}</div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="flex justify-between mt-2 text-[10px] text-slate-400 font-mono"><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span><span>Sun</span></div>
                </div>

                <div>
                    <h4 class="text-sm font-bold text-slate-900 mb-3">æ”¯å‡ºåˆ†ç±»å æ¯”</h4>
                    <div class="space-y-3">
                        <div class="flex items-center text-xs text-slate-600 mb-1 justify-between"><span>å¹¿å‘Šè¥é”€ (Ads)</span><span class="font-bold">65%</span></div>
                        <div class="w-full h-2 bg-slate-100 rounded-full overflow-hidden"><div class="h-full bg-blue-500" style="width: 65%"></div></div>
                        
                        <div class="flex items-center text-xs text-slate-600 mb-1 justify-between"><span>äº‘æœåŠ¡ (SaaS)</span><span class="font-bold">25%</span></div>
                        <div class="w-full h-2 bg-slate-100 rounded-full overflow-hidden"><div class="h-full bg-purple-500" style="width: 25%"></div></div>
                    </div>
                </div>
            </div>`;
        }

        // äº¤æ˜“æµæ°´ (çœŸå®å¡«å……)
        if (_cardState.activeTab === 'transactions') {
            const txs = getMockTransactions();
            return `
            <table class="w-full text-sm text-left">
                <thead class="text-slate-500 border-b border-slate-100 bg-slate-50/50"><tr><th class="py-3 pl-4 font-medium">äº¤æ˜“å•†æˆ·</th><th class="py-3 font-medium">ç±»å‹</th><th class="py-3 font-medium">æ—¶é—´</th><th class="py-3 font-medium text-right">é‡‘é¢</th><th class="py-3 pr-4 font-medium text-right">çŠ¶æ€</th></tr></thead>
                <tbody class="divide-y divide-slate-50">
                    ${txs.map(t => `
                        <tr class="group hover:bg-slate-50 transition">
                            <td class="py-4 pl-4 font-bold text-slate-800">${t.m}</td>
                            <td class="py-4"><span class="px-2 py-0.5 bg-slate-100 text-slate-500 text-[10px] rounded">${t.type}</span></td>
                            <td class="py-4 text-slate-500 text-xs">${t.d}</td>
                            <td class="py-4 text-right font-mono text-slate-800">$${Math.abs(t.a).toFixed(2)}</td>
                            <td class="py-4 pr-4 text-right"><span class="px-2 py-1 rounded text-xs font-bold ${t.s==='success'?'text-green-600 bg-green-50':'text-red-600 bg-red-50'}">${t.s.toUpperCase()}</span></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            <div class="text-center mt-6"><button class="text-xs text-indigo-600 font-bold hover:underline">åŠ è½½æ›´å¤šæµæ°´...</button></div>`;
        }

        // é£æ§é™é¢ (è¿›åº¦æ¡)
        if (_cardState.activeTab === 'limits') {
            const renderLimitBar = (title, max, current, color) => {
                const pct = max > 0 ? Math.min((current / max) * 100, 100) : 0;
                return `
                <div class="mb-6">
                    <div class="flex justify-between text-sm mb-2">
                        <span class="text-slate-700 font-bold">${title}</span>
                        <span class="text-slate-500 text-xs">å·²ç”¨ $${current.toLocaleString()} / <span class="text-slate-900 font-bold">$${max.toLocaleString()}</span></span>
                    </div>
                    <div class="w-full h-2.5 bg-slate-100 rounded-full overflow-hidden border border-slate-50 relative">
                        <div class="h-full ${color} transition-all duration-1000" style="width: ${pct}%"></div>
                    </div>
                </div>`;
            };
            return `
            <div class="p-4">
                <div class="flex justify-between items-center mb-8">
                    <div><h3 class="text-lg font-bold text-slate-800">ä¸‰çº§é£æ§é™é¢</h3><p class="text-xs text-slate-500 mt-1">ç®¡ç†å¡ç‰‡åœ¨ä¸åŒæ—¶é—´ç»´åº¦çš„æ¶ˆè´¹ä¸Šé™ã€‚</p></div>
                    <button onclick="window.openLimitsModal('${c.id}')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-xs font-bold hover:bg-indigo-700 shadow-sm transition">è°ƒæ•´ç­–ç•¥</button>
                </div>
                <div class="bg-slate-50 rounded-xl p-8 border border-slate-100">
                    ${renderLimitBar('å•ç¬”äº¤æ˜“é™é¢ (Per Transaction)', limits.single, 0, 'bg-emerald-500')}
                    ${renderLimitBar('å•æ—¥äº¤æ˜“é™é¢ (Daily Limit)', limits.daily, used.daily, 'bg-blue-500')}
                    ${renderLimitBar('å•æœˆäº¤æ˜“é™é¢ (Monthly Limit)', limits.monthly, used.monthly, 'bg-purple-500')}
                </div>
            </div>`;
        }
    };

    // --- 5. äº¤äº’é€»è¾‘ ---

    // æ˜¾éšå¡å·é€»è¾‘
    window._toggleNum = (id) => {
        const el = document.getElementById(`card-num-${id}`);
        const icon = document.getElementById(`icon-num-${id}`);
        if(el.dataset.state === 'masked') {
            el.innerText = el.dataset.real;
            el.dataset.state = 'real';
            el.classList.add('text-yellow-300');
            icon.classList.remove('text-white/70'); icon.classList.add('text-white');
        } else {
            el.innerText = el.dataset.mask;
            el.dataset.state = 'masked';
            el.classList.remove('text-yellow-300');
            icon.classList.add('text-white/70'); icon.classList.remove('text-white');
        }
    };

    // æ˜¾éš CVV é€»è¾‘
    window._toggleCVV = (id) => {
        const el = document.getElementById(`card-cvv-${id}`);
        if(el.dataset.state === 'masked') {
            el.innerText = el.dataset.real;
            el.dataset.state = 'real';
        } else {
            el.innerText = '***';
            el.dataset.state = 'masked';
        }
    };

    // å†»ç»“ç¡®è®¤æ¨¡æ€çª— (è°ƒç”¨ä¹‹å‰çš„ showConfirmModal)
    window._confirmFreeze = (id) => {
        const c = myCards.find(card => card.id === id);
        if(!c) return;
        
        if (c.status === 'active') {
            if(window.showConfirmModal) {
                showConfirmModal('å†»ç»“å¡ç‰‡', `ç¡®å®šè¦å†»ç»“å°¾å· <b>${c.number.slice(-4)}</b> çš„å¡ç‰‡å—ï¼Ÿ<br>å†»ç»“åå°†æ— æ³•äº¤æ˜“ã€‚`, 'danger', () => {
                    c.status = 'frozen';
                    window._goToDetail(id); // åˆ·æ–°
                });
            } else {
                if(confirm('ç¡®å®šè¦å†»ç»“å—ï¼Ÿ')) { c.status = 'frozen'; window._goToDetail(id); }
            }
        } else {
            if(window.showConfirmModal) {
                showConfirmModal('è§£å†»å¡ç‰‡', `æ¢å¤å¡ç‰‡ <b>${c.number.slice(-4)}</b> çš„ä½¿ç”¨æƒé™ï¼Ÿ`, 'primary', () => {
                    c.status = 'active';
                    window._goToDetail(id); // åˆ·æ–°
                });
            } else {
                if(confirm('ç¡®å®šè¦è§£å†»å—ï¼Ÿ')) { c.status = 'active'; window._goToDetail(id); }
            }
        }
    };

    // è·¯ç”±ä¸å…¶ä»–è¾…åŠ©
    window._setTab = (t) => { _cardState.activeTab = t; document.getElementById('content-area').innerHTML = views.card_detail(); }
    window._goToDetail = (id) => { _cardState.detailId = id; _cardState.activeTab = 'overview'; const c = document.getElementById('content-area'); document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active')); c.innerHTML = views.card_detail(); document.querySelector('main').scrollTop = 0; }
    window.copyText = (text, label) => { navigator.clipboard.writeText(text).then(() => alert(`${label} å·²å¤åˆ¶`)); }

    // åˆå§‹åŒ–
    if(document.querySelector('h2') && document.querySelector('h2').innerText.includes('å¡ç‰‡')) showView('cards');
}
</script>
<script>
{
    // --- 1. å…¨å±€çŠ¶æ€ ---
    window._cardState = window._cardState || { filter: 'all', detailId: null, activeTab: 'overview', searchQuery: '' };

    // --- 2. æ ¸å¿ƒç»„ä»¶ï¼šé«˜äº¤äº’å¡é¢ (ä¿®å¤ CVV ç‚¹å‡»äº‹ä»¶) ---
    const renderInteractiveCard = (card) => {
        const isVisa = card.type === 'Visa';
        const isShared = card.mode === 'shared';
        const bgClass = isShared 
            ? 'bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900' 
            : (isVisa ? 'bg-gradient-to-br from-blue-600 to-indigo-700' : 'bg-gradient-to-br from-orange-400 to-red-500');
        
        // å¡å·é»˜è®¤æ©ç 
        const maskedNum = card.number.slice(0, 4) + ' â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ ' + card.number.slice(-4);

        return `
        <div class="relative w-full aspect-[1.586/1] rounded-2xl ${bgClass} p-6 text-white shadow-2xl overflow-hidden group select-none transition-transform hover:scale-[1.01] duration-500">
            <div class="absolute inset-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')]"></div>
            <div class="absolute -top-24 -right-24 w-64 h-64 bg-white/10 rounded-full blur-3xl pointer-events-none"></div>
            
            <div class="relative z-10 flex flex-col justify-between h-full">
                <div class="flex justify-between items-start">
                    <span class="font-bold italic text-lg tracking-wider opacity-90">${card.type.toUpperCase()}</span>
                    <div class="flex gap-2">
                        ${card.status === 'frozen' ? '<span class="px-2 py-0.5 bg-red-500 text-white text-[10px] font-bold rounded animate-pulse">FROZEN</span>' : ''}
                        ${isShared ? '<span class="px-2 py-0.5 bg-white/20 text-[10px] font-bold rounded border border-white/10">SHARED</span>' : '<span class="px-2 py-0.5 bg-white/20 text-[10px] font-bold rounded border border-white/10">PREPAID</span>'}
                    </div>
                </div>
                
                <div class="my-auto">
                    <div class="flex items-center gap-3 mb-1">
                        <div class="w-8 h-5 bg-yellow-200/20 rounded flex items-center justify-center border border-white/20"><div class="w-5 h-3 border border-white/40 rounded-sm"></div></div>
                        <svg class="w-5 h-5 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"></path></svg>
                    </div>
                    <div class="flex items-center justify-between">
                        <p id="card-num-${card.id}" 
                           class="font-mono text-2xl tracking-[0.12em] drop-shadow-md cursor-pointer hover:text-indigo-100 transition" 
                           onclick="window._toggleNum('${card.id}')" 
                           title="ç‚¹å‡»åˆ‡æ¢æ˜¾ç¤º/éšè—">${maskedNum}</p>
                        
                        <button onclick="window._toggleNum('${card.id}')" class="p-2 hover:bg-white/10 rounded-full transition text-white/70 hover:text-white">
                            <svg id="icon-num-${card.id}" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </button>
                    </div>
                </div>

                <div class="flex justify-between items-end">
                    <div class="flex gap-6">
                        <div><p class="text-[8px] uppercase opacity-60 tracking-widest mb-0.5">Expires</p><p class="text-sm font-mono tracking-wide">${card.exp}</p></div>
                        <div>
                            <p class="text-[8px] uppercase opacity-60 tracking-widest mb-0.5">CVV</p>
                            <p id="card-cvv-${card.id}" 
                               class="text-sm font-mono tracking-widest cursor-pointer hover:text-yellow-300 font-bold underline decoration-dotted underline-offset-4" 
                               onclick="window._toggleCVV('${card.id}')" 
                               title="ç‚¹å‡»æŸ¥çœ‹/éšè—">***</p>
                        </div>
                    </div>
                    <div class="text-right"><p class="text-[8px] uppercase opacity-60 tracking-widest mb-0.5">Holder Name</p><p class="text-sm font-medium tracking-wide">USER DEMO</p></div>
                </div>
            </div>
            ${card.status === 'frozen' ? '<div class="absolute inset-0 bg-slate-900/60 backdrop-blur-[2px] z-20 flex items-center justify-center"><div class="border-2 border-white/80 px-6 py-2 rounded-lg text-xl font-bold tracking-[0.2em] transform -rotate-12">å·²å†»ç»“</div></div>' : ''}
        </div>`;
    };

    // --- 3. è§†å›¾ï¼šå¡ç‰‡è¯¦æƒ…é¡µ (ä¿®å¤å†»ç»“æŒ‰é’®è°ƒç”¨) ---
    views.card_detail = () => {
        const c = myCards.find(item => item.id === window._cardState.detailId);
        if (!c) return views.cards();

        const isShared = c.mode === 'shared';
        const isFrozen = c.status === 'frozen';
        
        // ä¸‰çº§é™é¢
        const limits = c.limits || { single: 5000, daily: 10000, monthly: 50000 };
        const used = { daily: 120.50, monthly: 1450.20 };

        return `
        <div class="max-w-[1200px] mx-auto fade-in pb-20">
            <div class="flex items-center gap-3 text-sm text-slate-500 mb-8">
                <button onclick="showView('cards')" class="hover:text-indigo-600 transition flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>è¿”å›åˆ—è¡¨
                </button>
                <span class="text-slate-300">/</span>
                <span class="font-medium text-slate-900">${c.name}</span>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-4 space-y-6">
                    ${renderInteractiveCard(c)}
                    
                    <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-4 shadow-sm relative group">
                        <div class="flex justify-between items-start mb-2">
                            <p class="text-[10px] font-bold text-indigo-400 uppercase tracking-wider flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" stroke-width="2"/><path d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" stroke-width="2"/></svg>
                                è´¦å•åœ°å€ (Billing Address)
                            </p>
                            <button onclick="copyText('4522 SW 3rd St, Miami, FL 33125, US', 'è´¦å•åœ°å€')" class="text-xs text-indigo-600 hover:text-indigo-800 font-bold">å¤åˆ¶</button>
                        </div>
                        <p class="text-sm text-slate-700 font-mono leading-relaxed select-all">4522 SW 3rd St, Miami, FL 33125, US</p>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        ${!isShared ? `<button onclick="openRechargeCardModal('${c.id}')" class="col-span-2 py-3 bg-slate-900 hover:bg-slate-800 text-white rounded-xl text-sm font-bold shadow-md transition">å……å€¼èµ„é‡‘</button>` : ''}
                        <button onclick="window.openLimitsModal('${c.id}')" class="py-3 border border-slate-200 bg-white hover:border-indigo-500 hover:text-indigo-600 text-slate-700 rounded-xl text-sm font-bold transition">é£æ§é…ç½®</button>
                        <button onclick="window._safeFreeze('${c.id}')" class="py-3 border border-slate-200 bg-white hover:bg-red-50 hover:text-red-600 hover:border-red-200 text-slate-600 rounded-xl text-sm font-bold transition">${isFrozen?'è§£å†»å¡ç‰‡':'å†»ç»“å¡ç‰‡'}</button>
                    </div>
                </div>

                <div class="lg:col-span-8 bg-white border border-slate-200 rounded-xl shadow-sm min-h-[500px] flex flex-col">
                    <div class="flex border-b border-slate-100 px-6">
                        <button onclick="window._setTab('overview')" class="py-4 mr-6 text-sm font-medium border-b-2 transition ${ _cardState.activeTab==='overview'?'border-slate-800 text-slate-800':'border-transparent text-slate-500 hover:text-slate-700'}">æ¦‚è§ˆåˆ†æ</button>
                        <button onclick="window._setTab('limits')" class="py-4 mr-6 text-sm font-medium border-b-2 transition ${ _cardState.activeTab==='limits'?'border-slate-800 text-slate-800':'border-transparent text-slate-500 hover:text-slate-700'}">é£æ§é™é¢</button>
                        <button onclick="window._setTab('transactions')" class="py-4 text-sm font-medium border-b-2 transition ${ _cardState.activeTab==='transactions'?'border-slate-800 text-slate-800':'border-transparent text-slate-500 hover:text-slate-700'}">äº¤æ˜“æµæ°´</button>
                    </div>
                    <div class="p-6 flex-1">${_renderTabContent(c, limits, used)}</div>
                </div>
            </div>
        </div>`;
    };

    // --- 4. Tab å†…å®¹ä¸åˆ—è¡¨è§†å›¾ (ä¿æŒä¸å˜ï¼Œçœç•¥éƒ¨åˆ†ä»£ç ä»¥èšç„¦ä¿®å¤) ---
    // (æ­¤å¤„ä»£ç ä¿æŒä¸ v3.4 ä¸€è‡´çš„ renderTabContent å’Œ views.cardsï¼Œç¡®ä¿å®Œæ•´æ€§)
    views.cards = () => {
        const list = myCards.filter(c => {
            if(_cardState.filter !== 'all' && (_cardState.filter === 'shared' ? c.mode !== 'shared' : c.mode === 'shared')) return false;
            if(_cardState.searchQuery && !c.name.toLowerCase().includes(_cardState.searchQuery) && !c.number.includes(_cardState.searchQuery)) return false;
            return true;
        });
        const activeCount = list.filter(c => c.status === 'active').length;
        const totalBalance = list.reduce((sum, c) => sum + (c.mode==='shared'?0:c.balance), 0);

        return `
        <div class="max-w-[1200px] mx-auto fade-in pb-20">
            <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
                <div><h2 class="text-2xl font-bold text-slate-900 tracking-tight">å¡ç‰‡ç®¡ç†</h2><div class="flex items-center gap-4 mt-2 text-sm text-slate-500"><span>æ´»è·ƒå¡ç‰‡: <b class="text-slate-800">${activeCount}</b></span><span class="w-1 h-1 bg-slate-300 rounded-full"></span><span>ç‹¬ç«‹æ€»ä½™é¢: <b class="text-slate-800">$${totalBalance.toLocaleString()}</b></span></div></div>
                <div class="flex gap-3"><button onclick="showView('apply')" class="px-5 py-2.5 bg-slate-900 hover:bg-slate-800 text-white rounded-lg text-sm font-semibold shadow-lg shadow-slate-200 transition flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>ç”³è¯·æ–°å¡</button></div>
            </div>
            <div class="bg-white border border-slate-200 rounded-xl p-1.5 flex justify-between items-center mb-6 shadow-sm">
                <div class="flex gap-1"><button onclick="window._setCardFilter('all')" class="px-4 py-2 rounded-lg text-sm font-medium transition ${_cardState.filter === 'all' ? 'bg-slate-100 text-slate-900 shadow-sm' : 'text-slate-500 hover:bg-slate-50 hover:text-slate-700'}">å…¨éƒ¨</button><button onclick="window._setCardFilter('prepaid')" class="px-4 py-2 rounded-lg text-sm font-medium transition ${_cardState.filter === 'prepaid' ? 'bg-indigo-50 text-indigo-600 shadow-sm' : 'text-slate-500 hover:bg-slate-50 hover:text-slate-700'}">æ™®é€šå¡</button><button onclick="window._setCardFilter('shared')" class="px-4 py-2 rounded-lg text-sm font-medium transition ${_cardState.filter === 'shared' ? 'bg-purple-50 text-purple-600 shadow-sm' : 'text-slate-500 hover:bg-slate-50 hover:text-slate-700'}">å…±äº«å¡</button></div>
                <div class="relative mr-2 hidden md:block"><input type="text" placeholder="æœç´¢å¡å· / å¤‡æ³¨å..." oninput="window._searchCard(this.value)" class="pl-9 pr-4 py-2 bg-slate-50 border-none rounded-lg text-sm w-64 focus:ring-2 focus:ring-indigo-500/20 text-slate-800 placeholder:text-slate-400 outline-none transition"><svg class="w-4 h-4 text-slate-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg></div>
            </div>
            <div class="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 border-b border-slate-200 text-slate-500"><tr><th class="px-6 py-4 font-medium w-64">å¡ç‰‡ä¿¡æ¯</th><th class="px-6 py-4 font-medium">å®Œæ•´å¡å·</th><th class="px-6 py-4 font-medium">ç±»å‹</th><th class="px-6 py-4 font-medium text-right">å¯ç”¨ä½™é¢/é™é¢</th><th class="px-6 py-4 font-medium text-center">çŠ¶æ€</th><th class="px-6 py-4 font-medium text-right">æ“ä½œ</th></tr></thead>
                    <tbody class="divide-y divide-slate-100">${list.length > 0 ? list.map(c => `<tr onclick="window._goToDetail('${c.id}')" class="hover:bg-slate-50/80 transition cursor-pointer group"><td class="px-6 py-4 font-medium text-slate-900">${c.name}<div class="text-[10px] font-normal text-slate-400 mt-0.5">${c.product}</div></td><td class="px-6 py-4 font-mono text-slate-600">â€¢â€¢â€¢â€¢ ${c.number.slice(-4)}</td><td class="px-6 py-4">${c.mode === 'shared' ? '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-50 text-purple-700">å…±äº«å¡</span>' : '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-600">æ™®é€šå¡</span>'}</td><td class="px-6 py-4 text-right">${c.mode === 'shared' ? '<span class="text-slate-400 text-xs">å…±äº«ä¸»è´¦æˆ·</span>' : `<span class="font-bold text-slate-800">$${c.balance.toFixed(2)}</span>`}</td><td class="px-6 py-4 text-center"><span class="inline-flex w-2.5 h-2.5 rounded-full ${c.status === 'active' ? 'bg-emerald-500' : 'bg-rose-500'}"></span></td><td class="px-6 py-4 text-right text-slate-400"><span class="text-xs group-hover:text-indigo-600 transition">æŸ¥çœ‹è¯¦æƒ… ></span></td></tr>`).join('') : '<tr><td colspan="6" class="p-12 text-center text-slate-400">æš‚æ— ç¬¦åˆæ¡ä»¶çš„å¡ç‰‡</td></tr>'}</tbody>
                </table>
            </div>
        </div>`;
    };

    const _renderTabContent = (c, limits, used) => {
        if (_cardState.activeTab === 'overview') {
            return `
            <div class="space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${c.mode==='shared' 
                        ? `<div class="p-5 bg-purple-50 rounded-xl border border-purple-100"><p class="text-xs text-purple-800 font-bold mb-1">èµ„é‡‘æ± æ¨¡å¼</p><p class="text-lg font-bold text-slate-800">å…±äº«ä¸»è´¦æˆ·ä½™é¢</p><p class="text-2xl font-bold text-indigo-600 mt-2">$${currentUser.balance.toLocaleString()}</p></div>`
                        : `<div class="p-5 bg-indigo-50 rounded-xl border border-indigo-100"><p class="text-xs text-indigo-800 font-bold mb-1">é¢„ä»˜è´¹æ¨¡å¼</p><p class="text-lg font-bold text-slate-800">å½“å‰å¡å†…ä½™é¢</p><p class="text-2xl font-bold text-indigo-600 mt-2">$${c.balance.toFixed(2)}</p></div>`
                    }
                    <div class="p-5 bg-slate-50 rounded-xl border border-slate-100"><p class="text-xs text-slate-500 font-bold mb-1">æœ¬æœˆæ”¯å‡º</p><p class="text-lg font-bold text-slate-800">æ”¯å‡ºç»Ÿè®¡</p><p class="text-2xl font-bold text-slate-800 mt-2">$${used.monthly.toLocaleString()}</p></div>
                </div>
            </div>`;
        }
        if (_cardState.activeTab === 'limits') {
            const renderProgress = (l, m, u, c) => `<div class="mb-6"><div class="flex justify-between text-sm mb-2"><span class="text-slate-700 font-bold">${l}</span><span class="text-slate-500 text-xs">$${u.toLocaleString()} / <span class="text-slate-900 font-bold">$${m.toLocaleString()}</span></span></div><div class="w-full h-2.5 bg-slate-100 rounded-full overflow-hidden border border-slate-50"><div class="h-full ${c}" style="width:${Math.min((u/m)*100,100)}%"></div></div></div>`;
            return `<div class="p-4"><div class="flex justify-between items-center mb-8"><div><h3 class="text-lg font-bold text-slate-800">ä¸‰çº§é£æ§é™é¢</h3><p class="text-xs text-slate-500 mt-1">ç®¡ç†å¡ç‰‡åœ¨ä¸åŒæ—¶é—´ç»´åº¦çš„æ¶ˆè´¹ä¸Šé™ã€‚</p></div><button onclick="window.openLimitsModal('${c.id}')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-xs font-bold hover:bg-indigo-700 shadow-sm transition">è°ƒæ•´ç­–ç•¥</button></div><div class="bg-slate-50 rounded-xl p-8 border border-slate-100">${renderProgress('å•ç¬”äº¤æ˜“é™é¢', limits.single, 0, 'bg-emerald-500')}${renderProgress('å•æ—¥äº¤æ˜“é™é¢', limits.daily, used.daily, 'bg-blue-500')}${renderProgress('å•æœˆäº¤æ˜“é™é¢', limits.monthly, used.monthly, 'bg-purple-500')}</div></div>`;
        }
        if (_cardState.activeTab === 'transactions') {
            return `<div class="text-center py-10 text-slate-400 text-sm">æš‚æ— è¿‘æœŸäº¤æ˜“è®°å½•</div>`;
        }
    };

    // --- 5. äº¤äº’é€»è¾‘ (ä¿®å¤) ---

    // ä¿®å¤ï¼šCVV æ˜¾éš (Toggle)
    window._toggleCVV = (id) => {
        const el = document.getElementById(`card-cvv-${id}`);
        const card = myCards.find(c => c.id == id);
        // å¦‚æœå½“å‰æ˜¯ ***ï¼Œæ˜¾ç¤ºçœŸå®ï¼›å¦åˆ™æ˜¾ç¤º ***
        if (el.innerText === '***') {
            el.innerText = card.cvv;
            el.classList.add('text-indigo-200'); // é«˜äº®æç¤º
        } else {
            el.innerText = '***';
            el.classList.remove('text-indigo-200');
        }
    }

    // ä¿®å¤ï¼šå¡å·æ˜¾éš (Toggle)
    window._toggleNum = (id) => {
        const el = document.getElementById(`card-num-${id}`);
        const icon = document.getElementById(`icon-num-${id}`);
        const card = myCards.find(c => c.id == id);
        
        if (el.innerText.includes('â€¢â€¢â€¢â€¢')) {
            el.innerText = card.number.match(/.{1,4}/g).join(' '); // æ ¼å¼åŒ–æ˜¾ç¤º
            icon.classList.add('text-white');
            icon.classList.remove('text-white/70');
        } else {
            el.innerText = card.number.slice(0, 4) + ' â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ ' + card.number.slice(-4);
            icon.classList.remove('text-white');
            icon.classList.add('text-white/70');
        }
    }

    // ä¿®å¤ï¼šå®‰å…¨å†»ç»“ (è°ƒç”¨æ¨¡æ€çª—)
    window._safeFreeze = (id) => {
        const c = myCards.find(card => card.id === id);
        if(!c) return;
        
        // æ ¸å¿ƒé€»è¾‘ï¼šè‡ªå·±ç”Ÿæˆæ¨¡æ€çª— HTMLï¼Œä¸ä¾èµ–å¤–éƒ¨ confirm å‡½æ•°
        const modalHTML = `
        <div class="fixed inset-0 bg-slate-900/70 backdrop-blur-sm z-[100] flex items-center justify-center fade-in">
            <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl p-6 text-center">
                <div class="w-12 h-12 rounded-full ${c.status==='active'?'bg-red-100 text-red-500':'bg-indigo-100 text-indigo-500'} flex items-center justify-center mx-auto mb-4">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                </div>
                <h3 class="text-lg font-bold text-slate-900 mb-2">${c.status==='active'?'ç¡®è®¤å†»ç»“å¡ç‰‡ï¼Ÿ':'ç¡®è®¤è§£é™¤å†»ç»“ï¼Ÿ'}</h3>
                <p class="text-sm text-slate-500 mb-6">${c.status==='active'?'å†»ç»“åå¡ç‰‡å°†æ— æ³•è¿›è¡Œä»»ä½•äº¤æ˜“ï¼Œä½†èµ„é‡‘ä¾ç„¶å®‰å…¨ã€‚':'æ¢å¤åå¡ç‰‡å°†ç«‹å³å¯ä»¥è¿›è¡Œäº¤æ˜“ã€‚'}</p>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="closeModal()" class="py-2.5 border border-slate-200 rounded-lg text-sm font-bold text-slate-600 hover:bg-slate-50">å–æ¶ˆ</button>
                    <button onclick="window._executeFreeze('${id}')" class="py-2.5 ${c.status==='active'?'bg-red-600 hover:bg-red-700':'bg-indigo-600 hover:bg-indigo-700'} text-white rounded-lg text-sm font-bold shadow-lg">ç¡®è®¤æ“ä½œ</button>
                </div>
            </div>
        </div>`;
        document.getElementById('modal-container').innerHTML = modalHTML;
    }

    // æ‰§è¡Œå†»ç»“
    window._executeFreeze = (id) => {
        const c = myCards.find(card => card.id === id);
        c.status = c.status === 'active' ? 'frozen' : 'active';
        closeModal();
        window._goToDetail(id); // åˆ·æ–°ç•Œé¢
    }

    // è·¯ç”±
    window._setCardFilter = (f) => { _cardState.filter = f; showView('cards'); }
    window._searchCard = (q) => { _cardState.searchQuery = q.toLowerCase(); showView('cards'); }
    window._goToDetail = (id) => { _cardState.detailId = id; _cardState.activeTab = 'overview'; const c = document.getElementById('content-area'); document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active')); c.innerHTML = views.card_detail(); document.querySelector('main').scrollTop = 0; }
    window._setTab = (t) => { _cardState.activeTab = t; document.getElementById('content-area').innerHTML = views.card_detail(); }
    window.copyText = (text, label) => { navigator.clipboard.writeText(text).then(() => alert(`${label} å·²å¤åˆ¶`)); }

    if(document.querySelector('h2') && document.querySelector('h2').innerText.includes('å¡ç‰‡')) showView('cards');
}
</script>
<script>
{
    // --- 1. å…¨å±€çŠ¶æ€ä¸æ¨¡æ‹Ÿæ•°æ® ---
    window._cardState = window._cardState || { filter: 'all', detailId: null, activeTab: 'overview', searchQuery: '' };

    // æ¨¡æ‹Ÿäº¤æ˜“æ•°æ® (æ‰¾å›)
    const getMockTransactions = () => [
        { m: 'AWS WEB SERVICES', d: '2025-11-21 14:20', a: -120.50, s: 'success', t: 'äº‘æœåŠ¡' },
        { m: 'FACEBOOK ADS *INC', d: '2025-11-20 09:15', a: -450.00, s: 'success', t: 'å¹¿å‘Šè´¹' },
        { m: 'GOOGLE GSUITE', d: '2025-11-18 10:00', a: -12.00, s: 'success', t: 'è½¯ä»¶è®¢é˜…' },
        { m: 'Suspicious Merch', d: '2025-11-15 03:40', a: -99.00, s: 'declined', t: 'é£æ§æ‹¦æˆª' },
        { m: 'OpenAI API', d: '2025-11-12 18:22', a: -20.00, s: 'success', t: 'AIæœåŠ¡' }
    ];

    // --- 2. æ ¸å¿ƒç»„ä»¶ï¼šå¡é¢ (CVV å¢åŠ å›¾æ ‡) ---
    const renderInteractiveCard = (card) => {
        const isVisa = card.type === 'Visa';
        const isShared = card.mode === 'shared';
        const bgClass = isShared 
            ? 'bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900' 
            : (isVisa ? 'bg-gradient-to-br from-blue-600 to-indigo-700' : 'bg-gradient-to-br from-orange-400 to-red-500');
        const maskedNum = card.number.slice(0, 4) + ' â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ ' + card.number.slice(-4);

        return `
        <div class="relative w-full aspect-[1.586/1] rounded-2xl ${bgClass} p-6 text-white shadow-2xl overflow-hidden group select-none transition-transform hover:scale-[1.01] duration-500">
            <div class="absolute inset-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')]"></div>
            
            <div class="relative z-10 flex flex-col justify-between h-full">
                <div class="flex justify-between items-start">
                    <span class="font-bold italic text-lg tracking-wider opacity-90">${card.type.toUpperCase()}</span>
                    <div class="flex gap-2">
                        ${card.status === 'frozen' ? '<span class="px-2 py-0.5 bg-red-500 text-white text-[10px] font-bold rounded animate-pulse">FROZEN</span>' : ''}
                        ${isShared ? '<span class="px-2 py-0.5 bg-white/20 text-[10px] font-bold rounded border border-white/10">SHARED</span>' : '<span class="px-2 py-0.5 bg-white/20 text-[10px] font-bold rounded border border-white/10">PREPAID</span>'}
                    </div>
                </div>
                
                <div class="my-auto">
                    <div class="flex items-center gap-3 mb-1">
                        <div class="w-8 h-5 bg-yellow-200/20 rounded flex items-center justify-center border border-white/20"><div class="w-5 h-3 border border-white/40 rounded-sm"></div></div>
                        <svg class="w-5 h-5 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"></path></svg>
                    </div>
                    <div class="flex items-center justify-between">
                        <p id="card-num-${card.id}" class="font-mono text-2xl tracking-[0.12em] drop-shadow-md cursor-pointer hover:text-indigo-100 transition" onclick="copyText('${card.number}', 'å¡å·')" title="ç‚¹å‡»å¤åˆ¶">${maskedNum}</p>
                        <button onclick="window._toggleNum('${card.id}')" class="p-2 hover:bg-white/10 rounded-full transition text-white/70 hover:text-white" title="æ˜¾ç¤º/éšè—å¡å·">
                            <svg id="icon-num-${card.id}" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </button>
                    </div>
                </div>

                <div class="flex justify-between items-end">
                    <div class="flex gap-6">
                        <div><p class="text-[8px] uppercase opacity-60 tracking-widest mb-0.5">Expires</p><p class="text-sm font-mono tracking-wide">${card.exp}</p></div>
                        <div>
                            <p class="text-[8px] uppercase opacity-60 tracking-widest mb-0.5">CVV</p>
                            <div class="flex items-center gap-2 group/cvv">
                                <p id="card-cvv-${card.id}" class="text-sm font-mono tracking-widest">***</p>
                                <button onclick="window._toggleCVV('${card.id}')" class="text-white/60 hover:text-white transition p-0.5" title="æŸ¥çœ‹CVV">
                                    <svg id="icon-cvv-${card.id}" class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="text-right"><p class="text-[8px] uppercase opacity-60 tracking-widest mb-0.5">Holder Name</p><p class="text-sm font-medium tracking-wide">USER DEMO</p></div>
                </div>
            </div>
            ${card.status === 'frozen' ? '<div class="absolute inset-0 bg-slate-900/60 backdrop-blur-[2px] z-20 flex items-center justify-center"><div class="border-2 border-white/80 px-6 py-2 rounded-lg text-xl font-bold tracking-[0.2em] transform -rotate-12">å·²å†»ç»“</div></div>' : ''}
        </div>`;
    };

    // --- 3. è§†å›¾ï¼šå¡ç‰‡è¯¦æƒ…é¡µ ---
    views.card_detail = () => {
        const c = myCards.find(item => item.id === window._cardState.detailId);
        if (!c) return views.cards();

        const isShared = c.mode === 'shared';
        const isFrozen = c.status === 'frozen';
        // ç¡®ä¿ä¸‰çº§é™é¢
        const limits = c.limits || { single: 5000, daily: 10000, monthly: 50000 };
        const used = { daily: 120.50, monthly: 1450.20 };

        return `
        <div class="max-w-[1200px] mx-auto fade-in pb-20">
            <div class="flex items-center gap-3 text-sm text-slate-500 mb-8">
                <button onclick="showView('cards')" class="hover:text-indigo-600 transition flex items-center gap-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>è¿”å›åˆ—è¡¨</button>
                <span class="text-slate-300">/</span>
                <span class="font-medium text-slate-900">${c.name}</span>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-4 space-y-6">
                    ${renderInteractiveCard(c)}
                    <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-4 shadow-sm relative group">
                        <div class="flex justify-between items-start mb-2">
                            <p class="text-[10px] font-bold text-indigo-400 uppercase tracking-wider flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" stroke-width="2"/><path d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" stroke-width="2"/></svg>è´¦å•åœ°å€ (Billing Address)</p>
                            <button onclick="copyText('4522 SW 3rd St, Miami, FL 33125, US', 'è´¦å•åœ°å€')" class="text-xs text-indigo-600 hover:text-indigo-800 font-bold">å¤åˆ¶</button>
                        </div>
                        <p class="text-sm text-slate-700 font-mono leading-relaxed select-all">4522 SW 3rd St, Miami, FL 33125, US</p>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        ${!isShared ? `<button onclick="openRechargeCardModal('${c.id}')" class="col-span-2 py-3 bg-slate-900 hover:bg-slate-800 text-white rounded-xl text-sm font-bold shadow-md transition">å……å€¼èµ„é‡‘</button>` : ''}
                        <button onclick="window.openLimitsModal('${c.id}')" class="py-3 border border-slate-200 bg-white hover:border-indigo-500 hover:text-indigo-600 text-slate-700 rounded-xl text-sm font-bold transition">é£æ§é…ç½®</button>
                        <button onclick="window._safeFreeze('${c.id}')" class="py-3 border border-slate-200 bg-white hover:bg-red-50 hover:text-red-600 hover:border-red-200 text-slate-600 rounded-xl text-sm font-bold transition">${isFrozen?'è§£å†»å¡ç‰‡':'å†»ç»“å¡ç‰‡'}</button>
                    </div>
                </div>

                <div class="lg:col-span-8 bg-white border border-slate-200 rounded-xl shadow-sm min-h-[500px] flex flex-col">
                    <div class="flex border-b border-slate-100 px-6">
                        <button onclick="window._setTab('overview')" class="py-4 mr-6 text-sm font-medium border-b-2 transition ${ _cardState.activeTab==='overview'?'border-slate-800 text-slate-800':'border-transparent text-slate-500 hover:text-slate-700'}">æ¦‚è§ˆåˆ†æ</button>
                        <button onclick="window._setTab('limits')" class="py-4 mr-6 text-sm font-medium border-b-2 transition ${ _cardState.activeTab==='limits'?'border-slate-800 text-slate-800':'border-transparent text-slate-500 hover:text-slate-700'}">é£æ§é™é¢</button>
                        <button onclick="window._setTab('transactions')" class="py-4 text-sm font-medium border-b-2 transition ${ _cardState.activeTab==='transactions'?'border-slate-800 text-slate-800':'border-transparent text-slate-500 hover:text-slate-700'}">äº¤æ˜“æµæ°´</button>
                    </div>
                    <div class="p-6 flex-1">${_renderTabContent(c, limits, used)}</div>
                </div>
            </div>
        </div>`;
    };

    // --- 4. Tab å†…å®¹æ¸²æŸ“å™¨ (æ‰¾å›é€»è¾‘) ---
    const _renderTabContent = (c, limits, used) => {
        // æ¦‚è§ˆ (æ¢å¤)
        if (_cardState.activeTab === 'overview') {
            return `
            <div class="space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${c.mode==='shared' 
                        ? `<div class="p-5 bg-purple-50 rounded-xl border border-purple-100"><p class="text-xs text-purple-800 font-bold mb-1">èµ„é‡‘æ± æ¨¡å¼</p><p class="text-lg font-bold text-slate-800">å…±äº«ä¸»è´¦æˆ·ä½™é¢</p><p class="text-2xl font-bold text-indigo-600 mt-2">$${currentUser.balance.toLocaleString()}</p></div>`
                        : `<div class="p-5 bg-indigo-50 rounded-xl border border-indigo-100"><p class="text-xs text-indigo-800 font-bold mb-1">é¢„ä»˜è´¹æ¨¡å¼</p><p class="text-lg font-bold text-slate-800">å½“å‰å¡å†…ä½™é¢</p><p class="text-2xl font-bold text-indigo-600 mt-2">$${c.balance.toFixed(2)}</p></div>`
                    }
                    <div class="p-5 bg-slate-50 rounded-xl border border-slate-100"><p class="text-xs text-slate-500 font-bold mb-1">æœ¬æœˆæ”¯å‡º</p><p class="text-lg font-bold text-slate-800">æ”¯å‡ºç»Ÿè®¡</p><p class="text-2xl font-bold text-slate-800 mt-2">$${used.monthly.toLocaleString()}</p></div>
                </div>
                
                <div>
                    <h4 class="text-sm font-bold text-slate-900 mb-4 flex items-center gap-2"><svg class="w-4 h-4 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>æ¯æ—¥æ”¯å‡ºè¶‹åŠ¿ (è¿‘7å¤©)</h4>
                    <div class="h-40 flex items-end justify-between gap-2 px-2">
                        ${[20, 45, 10, 80, 50, 30, 65].map(h => `<div class="w-full bg-indigo-100 rounded-t hover:bg-indigo-500 transition-all duration-300 relative group" style="height: ${h}%"><div class="absolute -top-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-[10px] py-1 px-2 rounded opacity-0 group-hover:opacity-100 transition">$${h*10}</div></div>`).join('')}
                    </div>
                    <div class="flex justify-between mt-2 text-[10px] text-slate-400 font-mono"><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span><span>Sun</span></div>
                </div>
                
                <div>
                    <h4 class="text-sm font-bold text-slate-900 mb-3">æ”¯å‡ºåˆ†ç±»å æ¯”</h4>
                    <div class="space-y-3">
                        <div class="flex items-center text-xs text-slate-600 mb-1 justify-between"><span>å¹¿å‘Šè¥é”€ (Ads)</span><span class="font-bold">65%</span></div><div class="w-full h-2 bg-slate-100 rounded-full overflow-hidden"><div class="h-full bg-blue-500" style="width: 65%"></div></div>
                        <div class="flex items-center text-xs text-slate-600 mb-1 justify-between"><span>äº‘æœåŠ¡ (SaaS)</span><span class="font-bold">25%</span></div><div class="w-full h-2 bg-slate-100 rounded-full overflow-hidden"><div class="h-full bg-purple-500" style="width: 25%"></div></div>
                    </div>
                </div>
            </div>`;
        }
        // é™é¢ (æ¢å¤)
        if (_cardState.activeTab === 'limits') {
            const renderProgress = (l, m, u, c) => `<div class="mb-6"><div class="flex justify-between text-sm mb-2"><span class="text-slate-700 font-bold">${l}</span><span class="text-slate-500 text-xs">$${u.toLocaleString()} / <span class="text-slate-900 font-bold">$${m.toLocaleString()}</span></span></div><div class="w-full h-2.5 bg-slate-100 rounded-full overflow-hidden border border-slate-50"><div class="h-full ${c}" style="width:${Math.min((u/m)*100,100)}%"></div></div></div>`;
            return `<div class="p-4"><div class="flex justify-between items-center mb-8"><div><h3 class="text-lg font-bold text-slate-800">ä¸‰çº§é£æ§é™é¢</h3><p class="text-xs text-slate-500 mt-1">ç®¡ç†å¡ç‰‡åœ¨ä¸åŒæ—¶é—´ç»´åº¦çš„æ¶ˆè´¹ä¸Šé™ã€‚</p></div><button onclick="window.openLimitsModal('${c.id}')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-xs font-bold hover:bg-indigo-700 shadow-sm transition">è°ƒæ•´ç­–ç•¥</button></div><div class="bg-slate-50 rounded-xl p-8 border border-slate-100">${renderProgress('å•ç¬”äº¤æ˜“é™é¢', limits.single, 0, 'bg-emerald-500')}${renderProgress('å•æ—¥äº¤æ˜“é™é¢', limits.daily, used.daily, 'bg-blue-500')}${renderProgress('å•æœˆäº¤æ˜“é™é¢', limits.monthly, used.monthly, 'bg-purple-500')}</div></div>`;
        }
        // äº¤æ˜“ (æ¢å¤)
        if (_cardState.activeTab === 'transactions') {
            const txs = getMockTransactions();
            return `
            <table class="w-full text-sm text-left">
                <thead class="text-slate-500 border-b border-slate-100 bg-slate-50/50"><tr><th class="py-3 pl-4 font-medium">äº¤æ˜“å•†æˆ·</th><th class="py-3 font-medium">ç±»å‹</th><th class="py-3 font-medium">æ—¶é—´</th><th class="py-3 font-medium text-right">é‡‘é¢</th><th class="py-3 pr-4 font-medium text-right">çŠ¶æ€</th></tr></thead>
                <tbody class="divide-y divide-slate-50">
                    ${txs.map(t => `<tr class="group hover:bg-slate-50 transition"><td class="py-4 pl-4 font-bold text-slate-800">${t.m}</td><td class="py-4"><span class="px-2 py-0.5 bg-slate-100 text-slate-500 text-[10px] rounded">${t.t}</span></td><td class="py-4 text-slate-500 text-xs">${t.d}</td><td class="py-4 text-right font-mono text-slate-800">$${Math.abs(t.a).toFixed(2)}</td><td class="py-4 pr-4 text-right"><span class="px-2 py-1 rounded text-xs font-bold ${t.s==='success'?'text-green-600 bg-green-50':'text-red-600 bg-red-50'}">${t.s.toUpperCase()}</span></td></tr>`).join('')}
                </tbody>
            </table>`;
        }
    };

    // --- 5. äº¤äº’é€»è¾‘ ---

    window._toggleNum = (id) => {
        const el = document.getElementById(`card-num-${id}`);
        const icon = document.getElementById(`icon-num-${id}`);
        const card = myCards.find(c => c.id == id);
        if(el.innerText.includes('â€¢â€¢â€¢â€¢')) {
            el.innerText = card.number.match(/.{1,4}/g).join(' ');
            icon.classList.remove('text-white/70'); icon.classList.add('text-white');
        } else {
            el.innerText = card.number.slice(0, 4) + ' â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ ' + card.number.slice(-4);
            icon.classList.add('text-white/70'); icon.classList.remove('text-white');
        }
    }

    // CVV æ˜¾éš (é€»è¾‘ä¿®æ­£ï¼šç‚¹å‡»åˆ‡æ¢çŠ¶æ€)
    window._toggleCVV = (id) => {
        const el = document.getElementById(`card-cvv-${id}`);
        const icon = document.getElementById(`icon-cvv-${id}`);
        const card = myCards.find(c => c.id == id);
        
        if(el.innerText === '***') {
            el.innerText = card.cvv;
            icon.classList.add('text-yellow-300');
        } else {
            el.innerText = '***';
            icon.classList.remove('text-yellow-300');
        }
    }

    // å†»ç»“æ¨¡æ€çª— (å†…ç½®é€»è¾‘)
    window._safeFreeze = (id) => {
        const c = myCards.find(card => card.id === id);
        if(!c) return;
        const modalHTML = `
        <div class="fixed inset-0 bg-slate-900/70 backdrop-blur-sm z-[100] flex items-center justify-center fade-in">
            <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl p-6 text-center">
                <div class="w-12 h-12 rounded-full ${c.status==='active'?'bg-red-100 text-red-500':'bg-indigo-100 text-indigo-500'} flex items-center justify-center mx-auto mb-4"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg></div>
                <h3 class="text-lg font-bold text-slate-900 mb-2">${c.status==='active'?'ç¡®è®¤å†»ç»“å¡ç‰‡ï¼Ÿ':'ç¡®è®¤è§£é™¤å†»ç»“ï¼Ÿ'}</h3>
                <p class="text-sm text-slate-500 mb-6">${c.status==='active'?'å†»ç»“åå¡ç‰‡å°†æ— æ³•äº¤æ˜“ï¼Œèµ„é‡‘ä¾ç„¶å®‰å…¨ã€‚':'æ¢å¤åå¡ç‰‡å°†ç«‹å³å¯ä»¥äº¤æ˜“ã€‚'}</p>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="closeModal()" class="py-2.5 border border-slate-200 rounded-lg text-sm font-bold text-slate-600 hover:bg-slate-50">å–æ¶ˆ</button>
                    <button onclick="window._executeFreeze('${id}')" class="py-2.5 ${c.status==='active'?'bg-red-600 hover:bg-red-700':'bg-indigo-600 hover:bg-indigo-700'} text-white rounded-lg text-sm font-bold shadow-lg">ç¡®è®¤</button>
                </div>
            </div>
        </div>`;
        document.getElementById('modal-container').innerHTML = modalHTML;
    }

    window._executeFreeze = (id) => {
        const c = myCards.find(card => card.id === id);
        c.status = c.status === 'active' ? 'frozen' : 'active';
        closeModal();
        window._goToDetail(id);
    }

    // è·¯ç”± (å¤ç”¨)
    window._setCardFilter = (f) => { _cardState.filter = f; showView('cards'); }
    window._searchCard = (q) => { _cardState.searchQuery = q.toLowerCase(); showView('cards'); }
    window._goToDetail = (id) => { _cardState.detailId = id; _cardState.activeTab = 'overview'; const c = document.getElementById('content-area'); document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active')); c.innerHTML = views.card_detail(); document.querySelector('main').scrollTop = 0; }
    window._setTab = (t) => { _cardState.activeTab = t; document.getElementById('content-area').innerHTML = views.card_detail(); }
    window.copyText = (text, label) => { navigator.clipboard.writeText(text).then(() => alert(`${label} å·²å¤åˆ¶`)); }
    
    // å¤ç”¨åˆ—è¡¨è§†å›¾ (ä¿è¯ cards è§†å›¾å­˜åœ¨)
    const originalCardsView = views.cards;
    if (!originalCardsView || originalCardsView.toString().length < 100) {
        // é˜²å¾¡æ€§ç¼–ç¨‹ï¼šå¦‚æœä¹‹å‰çš„åˆ—è¡¨ä»£ç è¢«åˆ äº†ï¼Œè¿™é‡Œè¡¥å……ä¸€ä¸ªæœ€å°åŒ–çš„åˆ—è¡¨æ¸²æŸ“é€»è¾‘ï¼Œé˜²æ­¢ç™½å±
        // ä½†ç”±äºæ‚¨æ˜¯å¤åˆ¶ç²˜è´´è¡¥ä¸ï¼Œç†è®ºä¸Š views.cards åœ¨ä¸Šä¸€ä¸ªè¡¥ä¸(3.1æˆ–3.2)é‡Œå·²ç»å®šä¹‰äº†ã€‚
        // ä¸ºäº†ä¿é™©ï¼Œè¿™é‡Œä¸é‡å¤å®šä¹‰ views.cardsï¼Œå‡è®¾æ‚¨ä¿ç•™äº† 3.1/3.2 çš„åˆ—è¡¨é€»è¾‘ï¼Œæˆ–è€…æ‚¨å¸Œæœ›æˆ‘å…¨é‡æä¾›ï¼Ÿ
        // é‰´äºæ‚¨è¦æ±‚"å®Œæ•´ä¿®å¤"ï¼Œæˆ‘è¿˜æ˜¯æŠŠåˆ—è¡¨é€»è¾‘ä¹Ÿå¸¦ä¸Šå§ï¼Œç¡®ä¿æ— è™ã€‚
        views.cards = () => {
            const list = myCards.filter(c => {
                const matchType = _cardState.filter === 'all' || (_cardState.filter === 'shared' ? c.mode === 'shared' : c.mode !== 'shared');
                const matchSearch = ! _cardState.searchQuery || c.name.toLowerCase().includes(_cardState.searchQuery.toLowerCase()) || c.number.includes(_cardState.searchQuery);
                return matchType && matchSearch;
            });
            const activeCount = list.filter(c => c.status === 'active').length;
            const totalBalance = list.reduce((sum, c) => sum + (c.mode==='shared'?0:c.balance), 0);
    
            return `
            <div class="max-w-[1200px] mx-auto fade-in pb-20">
                <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
                    <div><h2 class="text-2xl font-bold text-slate-900 tracking-tight">å¡ç‰‡ç®¡ç†</h2><div class="flex items-center gap-4 mt-2 text-sm text-slate-500"><span>æ´»è·ƒå¡ç‰‡: <b class="text-slate-800">${activeCount}</b></span><span class="w-1 h-1 bg-slate-300 rounded-full"></span><span>ç‹¬ç«‹æ€»ä½™é¢: <b class="text-slate-800">$${totalBalance.toLocaleString()}</b></span></div></div>
                    <div class="flex gap-3"><button onclick="showView('apply')" class="px-5 py-2.5 bg-slate-900 hover:bg-slate-800 text-white rounded-lg text-sm font-semibold shadow-lg shadow-slate-200 transition flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>ç”³è¯·æ–°å¡</button></div>
                </div>
                <div class="bg-white border border-slate-200 rounded-xl p-1.5 flex justify-between items-center mb-6 shadow-sm">
                    <div class="flex gap-1"><button onclick="window._setCardFilter('all')" class="px-4 py-2 rounded-lg text-sm font-medium transition ${_cardState.filter === 'all' ? 'bg-slate-100 text-slate-900 shadow-sm' : 'text-slate-500 hover:bg-slate-50 hover:text-slate-700'}">å…¨éƒ¨</button><button onclick="window._setCardFilter('prepaid')" class="px-4 py-2 rounded-lg text-sm font-medium transition ${_cardState.filter === 'prepaid' ? 'bg-indigo-50 text-indigo-600 shadow-sm' : 'text-slate-500 hover:bg-slate-50 hover:text-slate-700'}">æ™®é€šå¡</button><button onclick="window._setCardFilter('shared')" class="px-4 py-2 rounded-lg text-sm font-medium transition ${_cardState.filter === 'shared' ? 'bg-purple-50 text-purple-600 shadow-sm' : 'text-slate-500 hover:bg-slate-50 hover:text-slate-700'}">å…±äº«å¡</button></div>
                    <div class="relative mr-2 hidden md:block"><input type="text" placeholder="æœç´¢å¡å· / å¤‡æ³¨å..." oninput="window._searchCard(this.value)" class="pl-9 pr-4 py-2 bg-slate-50 border-none rounded-lg text-sm w-64 focus:ring-2 focus:ring-indigo-500/20 text-slate-800 placeholder:text-slate-400 outline-none transition"><svg class="w-4 h-4 text-slate-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg></div>
                </div>
                <div class="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 border-b border-slate-200 text-slate-500"><tr><th class="px-6 py-4 font-medium w-64">å¡ç‰‡ä¿¡æ¯</th><th class="px-6 py-4 font-medium">å®Œæ•´å¡å·</th><th class="px-6 py-4 font-medium">ç±»å‹</th><th class="px-6 py-4 font-medium text-right">å¯ç”¨ä½™é¢/é™é¢</th><th class="px-6 py-4 font-medium text-center">çŠ¶æ€</th><th class="px-6 py-4 font-medium text-right">æ“ä½œ</th></tr></thead>
                        <tbody class="divide-y divide-slate-100">${list.length > 0 ? list.map(c => `<tr onclick="window._goToDetail('${c.id}')" class="hover:bg-slate-50/80 transition cursor-pointer group"><td class="px-6 py-4 font-medium text-slate-900">${c.name}<div class="text-[10px] font-normal text-slate-400 mt-0.5">${c.product}</div></td><td class="px-6 py-4 font-mono text-slate-600">â€¢â€¢â€¢â€¢ ${c.number.slice(-4)}</td><td class="px-6 py-4">${c.mode === 'shared' ? '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-50 text-purple-700">å…±äº«å¡</span>' : '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-600">æ™®é€šå¡</span>'}</td><td class="px-6 py-4 text-right">${c.mode === 'shared' ? '<span class="text-slate-400 text-xs">å…±äº«ä¸»è´¦æˆ·</span>' : `<span class="font-bold text-slate-800">$${c.balance.toFixed(2)}</span>`}</td><td class="px-6 py-4 text-center"><span class="inline-flex w-2.5 h-2.5 rounded-full ${c.status === 'active' ? 'bg-emerald-500' : 'bg-rose-500'}"></span></td><td class="px-6 py-4 text-right text-slate-400"><span class="text-xs group-hover:text-indigo-600 transition">æŸ¥çœ‹è¯¦æƒ… ></span></td></tr>`).join('') : '<tr><td colspan="6" class="p-12 text-center text-slate-400">æš‚æ— ç¬¦åˆæ¡ä»¶çš„å¡ç‰‡</td></tr>'}</tbody>
                    </table>
                </div>
            </div>`;
        };
    }

    if(document.querySelector('h2') && document.querySelector('h2').innerText.includes('å¡ç‰‡')) showView('cards');
}
</script>
<script>
{
    // 1. è¾…åŠ©å‡½æ•°ï¼šä¸­æ–‡é—®å€™è¯­
    const getGreeting = () => {
        const hour = new Date().getHours();
        if (hour < 12) return 'ä¸Šåˆå¥½';
        if (hour < 18) return 'ä¸‹åˆå¥½';
        return 'æ™šä¸Šå¥½';
    };

    // 2. è¾…åŠ©æ•°æ®
    const weeklySpend = [120, 240, 80, 320, 150, 410, 200];
    const maxSpend = Math.max(...weeklySpend);

    // 3. é‡å†™ Dashboard è§†å›¾ (ä¸­æ–‡)
    views.dashboard = () => {
        const totalAssets = currentUser.balance + currentUser.cardBalance;
        const activeCards = myCards.filter(c => c.status === 'active').length;
        
        // æ¨¡æ‹Ÿæ•°æ®å…œåº•
        const recentTxs = (typeof transactions !== 'undefined' ? transactions : [
            { merchant: 'AWS EMEA', amount: -120.50, date: '10:23', status: 'success', card: '8891' },
            { merchant: 'FACEBOOK ADS', amount: -450.00, date: 'æ˜¨å¤©', status: 'success', card: '4421' },
            { merchant: 'Google Cloud', amount: -85.00, date: '11æœˆ18æ—¥', status: 'success', card: '8891' },
            { merchant: 'Slack Inc', amount: -12.00, date: '11æœˆ15æ—¥', status: 'success', card: '1122' },
            { merchant: 'Unauthorized', amount: -99.99, date: '11æœˆ12æ—¥', status: 'declined', card: '4421' }
        ]).slice(0, 5);

        return `
        <div class="max-w-[1200px] mx-auto fade-in pb-20">
            <div class="flex justify-between items-end mb-8">
                <div>
                    <p class="text-xs font-bold text-indigo-600 uppercase tracking-wider mb-1">${new Date().toLocaleDateString('zh-CN')}</p>
                    <h2 class="text-2xl font-bold text-slate-900">${getGreeting()}ï¼Œç®¡ç†å‘˜</h2>
                </div>
                <div class="flex gap-3">
                    <button class="p-2 text-slate-400 hover:text-indigo-600 transition bg-white border border-slate-200 rounded-lg shadow-sm" title="åˆ·æ–°æ•°æ®">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </button>
                    <button onclick="showView('apply')" class="px-4 py-2 bg-slate-900 hover:bg-slate-800 text-white text-sm font-bold rounded-lg shadow-lg flex items-center gap-2 transition">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4" stroke-width="2"/></svg> å¿«é€Ÿå¼€å¡
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                <div class="lg:col-span-2 bg-slate-900 rounded-2xl p-8 text-white relative overflow-hidden shadow-2xl flex flex-col justify-between min-h-[240px]">
                    <div class="absolute top-0 right-0 w-96 h-96 bg-indigo-600/20 rounded-full blur-3xl -translate-y-1/2 translate-x-1/3"></div>
                    <div class="absolute bottom-0 left-0 w-64 h-64 bg-purple-600/20 rounded-full blur-3xl translate-y-1/3 -translate-x-1/3"></div>
                    
                    <div class="relative z-10">
                        <div class="flex items-center gap-2 mb-1 opacity-80">
                            <span class="text-xs font-bold uppercase tracking-widest">è´¦æˆ·æ€»èµ„äº§ (Total Assets)</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                        </div>
                        <h1 class="text-5xl font-mono font-bold tracking-tight mb-6">$${totalAssets.toLocaleString(undefined, {minimumFractionDigits: 2})}</h1>
                        
                        <div class="flex gap-8 border-t border-white/10 pt-6">
                            <div>
                                <p class="text-[10px] text-slate-400 uppercase font-bold mb-1">é’±åŒ…å¯ç”¨ä½™é¢</p>
                                <p class="text-xl font-bold">$${currentUser.balance.toLocaleString()}</p>
                            </div>
                            <div class="w-px bg-white/10"></div>
                            <div>
                                <p class="text-[10px] text-slate-400 uppercase font-bold mb-1">å¡ç‰‡é¢„å……ä½™é¢</p>
                                <p class="text-xl font-bold text-indigo-300">$${currentUser.cardBalance.toLocaleString()}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white border border-slate-200 rounded-2xl p-6 shadow-sm flex flex-col">
                    <h3 class="text-sm font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <span class="w-1.5 h-1.5 rounded-full bg-indigo-500"></span> å¿«æ·å·¥ä½œå°
                    </h3>
                    <div class="grid grid-cols-2 gap-3 flex-1">
                        <button onclick="openDepositModal()" class="flex flex-col items-center justify-center p-3 rounded-xl bg-slate-50 hover:bg-indigo-50 border border-slate-100 hover:border-indigo-100 transition group">
                            <div class="w-10 h-10 rounded-full bg-white shadow-sm flex items-center justify-center mb-2 text-indigo-600 group-hover:scale-110 transition">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4" stroke-width="2"/></svg>
                            </div>
                            <span class="text-xs font-bold text-slate-600 group-hover:text-indigo-700">é’±åŒ…å……å€¼</span>
                        </button>
                        <button onclick="showView('apply')" class="flex flex-col items-center justify-center p-3 rounded-xl bg-slate-50 hover:bg-indigo-50 border border-slate-100 hover:border-indigo-100 transition group">
                            <div class="w-10 h-10 rounded-full bg-white shadow-sm flex items-center justify-center mb-2 text-purple-600 group-hover:scale-110 transition">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" stroke-width="2"/></svg>
                            </div>
                            <span class="text-xs font-bold text-slate-600 group-hover:text-purple-700">ç”³è¯·æ–°å¡</span>
                        </button>
                        <button onclick="showView('cards')" class="flex flex-col items-center justify-center p-3 rounded-xl bg-slate-50 hover:bg-indigo-50 border border-slate-100 hover:border-indigo-100 transition group">
                            <div class="w-10 h-10 rounded-full bg-white shadow-sm flex items-center justify-center mb-2 text-emerald-600 group-hover:scale-110 transition">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" stroke-width="2"/></svg>
                            </div>
                            <span class="text-xs font-bold text-slate-600 group-hover:text-emerald-700">ç®¡ç†å¡ç‰‡</span>
                        </button>
                        <button onclick="showView('wallet')" class="flex flex-col items-center justify-center p-3 rounded-xl bg-slate-50 hover:bg-indigo-50 border border-slate-100 hover:border-indigo-100 transition group">
                            <div class="w-10 h-10 rounded-full bg-white shadow-sm flex items-center justify-center mb-2 text-orange-600 group-hover:scale-110 transition">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" stroke-width="2"/></svg>
                            </div>
                            <span class="text-xs font-bold text-slate-600 group-hover:text-orange-700">èµ„é‡‘åˆ’è½¬</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                <div class="lg:col-span-2 bg-white border border-slate-200 rounded-2xl p-6 shadow-sm">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-sm font-bold text-slate-800">è¿‘ 7 æ—¥æ”¯å‡ºè¶‹åŠ¿</h3>
                        <span class="text-xs text-green-600 font-bold bg-green-50 px-2 py-1 rounded">æ—¥å‡: $217</span>
                    </div>
                    <div class="h-40 flex items-end justify-between gap-4 px-2">
                        ${weeklySpend.map((val, idx) => {
                            const height = (val / maxSpend) * 100;
                            const days = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
                            return `
                            <div class="w-full flex flex-col items-center gap-2 group cursor-pointer">
                                <div class="w-full bg-indigo-50 rounded-t-md relative h-full overflow-hidden">
                                    <div class="absolute bottom-0 left-0 w-full bg-indigo-500 rounded-t-md transition-all duration-500 group-hover:bg-indigo-600" style="height: ${height}%"></div>
                                    <div class="absolute -top-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-[10px] py-1 px-2 rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap z-10">$${val}</div>
                                </div>
                                <span class="text-[10px] text-slate-400 font-bold">${days[idx]}</span>
                            </div>`;
                        }).join('')}
                    </div>
                </div>

                <div class="bg-white border border-slate-200 rounded-2xl p-6 shadow-sm flex flex-col justify-center">
                    <h3 class="text-sm font-bold text-slate-800 mb-6">å¡ç‰‡çŠ¶æ€ç›‘æ§</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center text-xs font-bold">A</div>
                                <span class="text-sm font-medium text-slate-600">Active (æ´»è·ƒ)</span>
                            </div>
                            <span class="text-lg font-bold text-slate-800">${activeCards}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-red-100 text-red-600 flex items-center justify-center text-xs font-bold">F</div>
                                <span class="text-sm font-medium text-slate-600">Frozen (å†»ç»“)</span>
                            </div>
                            <span class="text-lg font-bold text-slate-800">${myCards.length - activeCards}</span>
                        </div>
                        <div class="w-full h-px bg-slate-100 my-2"></div>
                        <div class="flex items-center justify-between">
                            <span class="text-xs font-bold text-slate-400 uppercase">æŒå¡æ€»é‡</span>
                            <span class="text-xl font-bold text-slate-900">${myCards.length}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <h3 class="font-bold text-slate-800">æœ€æ–°äº¤æ˜“æµæ°´</h3>
                    <button onclick="showView('transactions')" class="text-xs font-bold text-indigo-600 hover:underline">æŸ¥çœ‹å…¨éƒ¨ ></button>
                </div>
                <table class="w-full text-left text-sm">
                    <thead class="text-slate-500 border-b border-slate-100">
                        <tr>
                            <th class="px-6 py-3 font-medium">å•†æˆ·åç§°</th>
                            <th class="px-6 py-3 font-medium">å¡ç‰‡</th>
                            <th class="px-6 py-3 font-medium">äº¤æ˜“æ—¶é—´</th>
                            <th class="px-6 py-3 font-medium text-right">é‡‘é¢</th>
                            <th class="px-6 py-3 font-medium text-right">çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        ${recentTxs.map(t => `
                            <tr class="hover:bg-slate-50 transition">
                                <td class="px-6 py-3.5 font-bold text-slate-700">${t.merchant}</td>
                                <td class="px-6 py-3.5 font-mono text-slate-500 text-xs">..${t.card}</td>
                                <td class="px-6 py-3.5 text-slate-400 text-xs">${t.date}</td>
                                <td class="px-6 py-3.5 text-right font-mono text-slate-800 font-bold">$${Math.abs(t.amount).toFixed(2)}</td>
                                <td class="px-6 py-3.5 text-right">
                                    <span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${t.status==='success'?'bg-green-100 text-green-700':(t.status==='declined'?'bg-red-100 text-red-700':'bg-slate-100 text-slate-600')}">${t.status}</span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>`;
    }

    // è‡ªåŠ¨åˆ·æ–°
    if(document.getElementById('page-title').innerText.includes('ä»ªè¡¨ç›˜') || document.querySelector('h2').innerText.includes('User')) showView('dashboard');
}
</script>
<script>
{
    // --- 1. æ•°æ®ç»“æ„å‡çº§ ---
    
    // åˆå§‹åŒ–å¤šå¸ç§é’±åŒ…æ•°æ® (å¦‚æœä¸å­˜åœ¨)
    if (!currentUser.wallets) {
        currentUser.wallets = [
            { code: 'USD', name: 'US Dollar', symbol: '$', balance: 12450.80, flag: 'ğŸ‡ºğŸ‡¸', rate: 1.0 },
            { code: 'EUR', name: 'Euro', symbol: 'â‚¬', balance: 450.00, flag: 'ğŸ‡ªğŸ‡º', rate: 1.08 }, // 1 EUR = 1.08 USD
            { code: 'GBP', name: 'British Pound', symbol: 'Â£', balance: 0.00, flag: 'ğŸ‡¬ğŸ‡§', rate: 1.26 }, // 1 GBP = 1.26 USD
            { code: 'HKD', name: 'HK Dollar', symbol: 'HK$', balance: 25000.00, flag: 'ğŸ‡­ğŸ‡°', rate: 0.13 } // 1 HKD = 0.13 USD
        ];
    }

    // æ‰©å±•æµæ°´æ•°æ® (å¢åŠ å¸ç§å­—æ®µ)
    const multiCurrencyHistory = [
        { id: 'W_001', type: 'deposit', title: 'USDT å……å€¼ (TRC20)', amount: 5000.00, currency: 'USD', date: '2025-11-21 10:42', status: 'success' },
        { id: 'W_002', type: 'exchange', title: 'è´§å¸å…‘æ¢ (USD -> EUR)', amount: 450.00, currency: 'EUR', date: '2025-11-21 09:15', status: 'success', note: 'Rate: 0.92' },
        { id: 'W_003', type: 'exchange', title: 'è´§å¸å…‘æ¢ (Sell USD)', amount: -489.13, currency: 'USD', date: '2025-11-21 09:15', status: 'success' },
        { id: 'W_004', type: 'deposit', title: 'æœ¬åœ°é“¶è¡Œè½¬è´¦', amount: 25000.00, currency: 'HKD', date: '2025-11-19 14:10', status: 'success' },
        { id: 'W_005', type: 'fee', title: 'æœˆåº¦ç®¡ç†è´¹', amount: -10.00, currency: 'USD', date: '2025-11-01 00:00', status: 'success' }
    ];

    // è®¡ç®—æ€»èµ„äº§ä¼°å€¼ (Total Estimated Value in USD)
    const calculateTotalAsset = () => {
        let total = 0;
        currentUser.wallets.forEach(w => {
            total += w.balance * w.rate;
        });
        return total;
    };

    // --- 2. è§†å›¾ï¼šå¤šå¸ç§é’±åŒ… (Dashboard Style) ---
    views.wallet = () => {
        const totalUSD = calculateTotalAsset();

        return `
        <div class="max-w-[1200px] mx-auto fade-in pb-20">
            <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-slate-900 tracking-tight">èµ„é‡‘é’±åŒ… (Wallets)</h2>
                    <div class="flex items-center gap-2 mt-2 text-sm text-slate-500">
                        <span>è´¦æˆ·æ€»ä¼°å€¼:</span>
                        <span class="text-lg font-bold text-slate-800 font-mono">â‰ˆ $${totalUSD.toLocaleString(undefined, {minimumFractionDigits: 2})} USD</span>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="window.openExchangeModal()" class="px-5 py-2.5 bg-white border border-slate-200 text-indigo-600 hover:border-indigo-500 hover:bg-indigo-50 rounded-lg text-sm font-bold transition flex items-center gap-2 shadow-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/></svg>
                        è´§å¸å…‘æ¢ (Swap)
                    </button>
                    <button onclick="openDepositModal()" class="px-5 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-bold shadow-lg shadow-indigo-200 transition flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        å……å€¼èµ„é‡‘
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                ${currentUser.wallets.map(w => `
                    <div class="bg-white border border-slate-200 rounded-xl p-5 shadow-sm hover:shadow-md transition relative group overflow-hidden">
                        <div class="absolute -right-6 -top-6 w-24 h-24 bg-slate-50 rounded-full group-hover:bg-indigo-50 transition-colors"></div>
                        
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-4">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl shadow-sm rounded-full">${w.flag}</span>
                                    <div>
                                        <h3 class="font-bold text-slate-800 leading-tight">${w.code}</h3>
                                        <p class="text-[10px] text-slate-400 uppercase">${w.name}</p>
                                    </div>
                                </div>
                                ${w.code === 'USD' ? '<span class="px-2 py-0.5 bg-indigo-100 text-indigo-600 text-[10px] font-bold rounded">ä¸»è´¦æˆ·</span>' : ''}
                            </div>
                            
                            <div class="mb-6">
                                <p class="text-2xl font-bold text-slate-900 font-mono tracking-tight">${w.symbol} ${w.balance.toLocaleString(undefined, {minimumFractionDigits: 2})}</p>
                                ${w.code !== 'USD' ? `<p class="text-xs text-slate-400 mt-1">â‰ˆ $${(w.balance * w.rate).toLocaleString(undefined, {maximumFractionDigits: 0})} USD</p>` : ''}
                            </div>

                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="openDepositModal('${w.code}')" class="py-2 bg-slate-900 hover:bg-slate-800 text-white rounded-lg text-xs font-bold transition">å……å€¼</button>
                                <button onclick="window.openExchangeModal('${w.code}')" class="py-2 border border-slate-200 text-slate-600 hover:border-indigo-300 hover:text-indigo-600 rounded-lg text-xs font-bold transition">å…‘æ¢</button>
                            </div>
                        </div>
                    </div>
                `).join('')}
                
                <div class="border-2 border-dashed border-slate-200 rounded-xl p-5 flex flex-col items-center justify-center text-slate-400 cursor-pointer hover:border-indigo-300 hover:text-indigo-500 transition hover:bg-slate-50 min-h-[200px]">
                    <svg class="w-8 h-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                    <span class="text-xs font-bold">å¼€é€šæ›´å¤šå¸ç§</span>
                </div>
            </div>

            <div class="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <h3 class="font-bold text-slate-800">èµ„é‡‘æµæ°´æ˜ç»† (Transactions)</h3>
                    <div class="flex gap-2">
                        <select class="text-xs border border-slate-200 rounded px-2 py-1 outline-none bg-white text-slate-600"><option>å…¨éƒ¨å¸ç§</option><option>USD</option><option>EUR</option></select>
                        <button class="text-xs text-indigo-600 font-bold hover:underline">å¯¼å‡ºè´¦å•</button>
                    </div>
                </div>
                <table class="w-full text-left text-sm">
                    <thead class="text-slate-500 border-b border-slate-100">
                        <tr>
                            <th class="px-6 py-3 font-medium">æ—¶é—´</th>
                            <th class="px-6 py-3 font-medium">ç±»å‹/è¯´æ˜</th>
                            <th class="px-6 py-3 font-medium">å¸ç§</th>
                            <th class="px-6 py-3 font-medium text-right">å˜åŠ¨é‡‘é¢</th>
                            <th class="px-6 py-3 font-medium text-right">çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        ${multiCurrencyHistory.map(item => `
                            <tr class="hover:bg-slate-50 transition">
                                <td class="px-6 py-4 text-slate-500 text-xs font-mono">${item.date}</td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center gap-2">
                                        <span class="px-2 py-0.5 rounded text-[10px] font-bold ${item.amount > 0 ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-600'}">${item.type.toUpperCase()}</span>
                                        <span class="font-bold text-slate-700">${item.title}</span>
                                    </div>
                                    ${item.note ? `<p class="text-[10px] text-slate-400 mt-0.5 pl-14">${item.note}</p>` : ''}
                                </td>
                                <td class="px-6 py-4 font-bold text-slate-700">${item.currency}</td>
                                <td class="px-6 py-4 text-right font-mono font-bold ${item.amount > 0 ? 'text-green-600' : 'text-slate-900'}">
                                    ${item.amount > 0 ? '+' : ''}${item.amount.toLocaleString(undefined, {minimumFractionDigits: 2})}
                                </td>
                                <td class="px-6 py-4 text-right"><span class="text-xs font-bold text-green-600 bg-green-50 px-2 py-1 rounded">Success</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>`;
    };

    // --- 3. æ–°å¢ï¼šè´§å¸å…‘æ¢å¼¹çª— (Exchange Modal) ---
    window.openExchangeModal = function(defaultTo = 'EUR') {
        const modalHTML = `
        <div class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[90] flex items-center justify-center fade-in">
            <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                    <h3 class="font-bold text-slate-800">è´§å¸å…‘æ¢ (Swap)</h3>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
                </div>
                
                <div class="p-6 space-y-6">
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-500 flex justify-between">
                            <span>å–å‡º (Sell)</span>
                            <span>ä½™é¢: $12,450.80</span>
                        </label>
                        <div class="flex gap-2">
                            <input type="number" class="flex-1 px-4 py-3 border border-slate-200 rounded-xl font-bold text-slate-800 outline-none focus:border-indigo-500" placeholder="100.00" value="100">
                            <div class="px-3 py-2 bg-slate-100 rounded-xl flex items-center gap-2 border border-slate-200 font-bold text-slate-700">
                                ğŸ‡ºğŸ‡¸ USD
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-center -my-2 relative z-10">
                        <div class="w-8 h-8 bg-white border border-slate-200 rounded-full flex items-center justify-center text-indigo-600 shadow-sm">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/></svg>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-500">ä¹°å…¥ (Buy)</label>
                        <div class="flex gap-2">
                            <input type="text" class="flex-1 px-4 py-3 border border-slate-200 rounded-xl font-bold text-slate-800 outline-none bg-slate-50" value="92.59" readonly>
                            <select class="px-2 py-2 bg-white rounded-xl border border-slate-200 font-bold text-slate-700 outline-none focus:border-indigo-500">
                                <option value="EUR" ${defaultTo==='EUR'?'selected':''}>ğŸ‡ªğŸ‡º EUR</option>
                                <option value="GBP" ${defaultTo==='GBP'?'selected':''}>ğŸ‡¬ğŸ‡§ GBP</option>
                                <option value="HKD" ${defaultTo==='HKD'?'selected':''}>ğŸ‡­ğŸ‡° HKD</option>
                            </select>
                        </div>
                    </div>

                    <div class="bg-slate-50 rounded-lg p-3 text-xs flex justify-between items-center text-slate-500">
                        <span>å‚è€ƒæ±‡ç‡</span>
                        <span class="font-mono font-bold text-slate-700">1 USD â‰ˆ 0.9259 EUR</span>
                    </div>

                    <button onclick="window._executeSwap()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg transition">ç¡®è®¤å…‘æ¢</button>
                </div>
            </div>
        </div>`;
        document.getElementById('modal-container').innerHTML = modalHTML;
    }

    window._executeSwap = () => {
        const btn = event.target;
        btn.innerText = 'å…‘æ¢ä¸­...';
        setTimeout(() => {
            closeModal();
            alert('âœ… å…‘æ¢æˆåŠŸï¼èµ„é‡‘å·²å…¥è´¦ EUR é’±åŒ…ã€‚');
            showView('wallet'); // åˆ·æ–°
        }, 1000);
    }

    // è‡ªåŠ¨åˆ·æ–°
    if(document.querySelector('h2') && document.querySelector('h2').innerText.includes('é’±åŒ…')) showView('wallet');
}
</script>
<script>
{
    // --- 1. å…¨å±€å˜é‡ï¼šç®¡ç†å€’è®¡æ—¶ ---
    let exchangeTimer = null;
    let exchangeTimeLeft = 60;
    
    // --- 2. æ¨¡æ‹Ÿé“¶è¡Œè´¦æˆ·æ•°æ® ---
    const bankAccounts = {
        'USD': { bank: 'Chase Bank', name: 'VCC TECH GLOBAL LTD', account: '9876543210', swift: 'CHASUS33', addr: '270 Park Avenue, New York, NY' },
        'EUR': { bank: 'Deutsche Bank', name: 'VCC TECH EU', account: 'DE89 3704 0044 0532', swift: 'DEUTDEFF', addr: 'Taunusanlage 12, Frankfurt' },
        'HKD': { bank: 'HSBC Hong Kong', name: 'VCC ASIA LIMITED', account: '004-123-456-789', swift: 'HSBCHKHH', addr: '1 Queen\'s Road Central, HK' }
    };

    // --- 3. é‡å†™ï¼šè´§å¸å…‘æ¢å¼¹çª— (å«å€’è®¡æ—¶é€»è¾‘) ---
    window.openExchangeModal = function(defaultTo = 'EUR') {
        // æ¯æ¬¡æ‰“å¼€é‡ç½®æ—¶é—´
        exchangeTimeLeft = 60; 
        
        const modalHTML = `
        <div class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[90] flex items-center justify-center fade-in">
            <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                    <h3 class="font-bold text-slate-800">è´§å¸å…‘æ¢ (Flash Swap)</h3>
                    <button onclick="window._closeExchange()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
                </div>
                
                <div class="p-6 space-y-6 relative">
                    <div class="flex justify-between items-center text-xs">
                        <span class="text-slate-500 font-medium">æ±‡ç‡é”å®šä¸­...</span>
                        <span id="timer-display" class="text-indigo-600 font-mono font-bold bg-indigo-50 px-2 py-0.5 rounded">60s</span>
                    </div>

                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-500 flex justify-between"><span>å–å‡º (Sell)</span><span>ä½™é¢: $${currentUser.balance.toLocaleString()}</span></label>
                        <div class="flex gap-2">
                            <input type="number" class="flex-1 px-4 py-3 border border-slate-200 rounded-xl font-bold text-slate-800 outline-none focus:border-indigo-500" placeholder="100.00" value="100">
                            <div class="px-3 py-2 bg-slate-100 rounded-xl flex items-center gap-2 border border-slate-200 font-bold text-slate-700">ğŸ‡ºğŸ‡¸ USD</div>
                        </div>
                    </div>

                    <div class="flex justify-center -my-2 relative z-10">
                        <div class="w-8 h-8 bg-white border border-slate-200 rounded-full flex items-center justify-center text-indigo-600 shadow-sm">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/></svg>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-500">ä¹°å…¥ (Buy)</label>
                        <div class="flex gap-2">
                            <input type="text" class="flex-1 px-4 py-3 border border-slate-200 rounded-xl font-bold text-slate-800 outline-none bg-slate-50" value="92.59" readonly>
                            <select class="px-2 py-2 bg-white rounded-xl border border-slate-200 font-bold text-slate-700 outline-none focus:border-indigo-500">
                                <option value="EUR" ${defaultTo==='EUR'?'selected':''}>ğŸ‡ªğŸ‡º EUR</option>
                                <option value="GBP" ${defaultTo==='GBP'?'selected':''}>ğŸ‡¬ğŸ‡§ GBP</option>
                                <option value="HKD" ${defaultTo==='HKD'?'selected':''}>ğŸ‡­ğŸ‡° HKD</option>
                            </select>
                        </div>
                    </div>

                    <div class="bg-slate-50 rounded-lg p-3 text-xs flex justify-between items-center text-slate-500 relative">
                        <span>å‚è€ƒæ±‡ç‡: 1 USD â‰ˆ 0.9259 EUR</span>
                        <span class="text-slate-400">å« 0.5% æ‰‹ç»­è´¹</span>
                        
                        <div id="expire-overlay" class="absolute inset-0 bg-slate-100/90 backdrop-blur-[1px] flex items-center justify-center rounded-lg hidden z-20">
                            <button onclick="window._refreshRate()" class="text-indigo-600 font-bold flex items-center gap-1 hover:underline">
                                <svg class="w-3 h-3 animate-spin-slow" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                æ±‡ç‡å·²è¿‡æœŸï¼Œç‚¹å‡»åˆ·æ–°
                            </button>
                        </div>
                    </div>

                    <button id="btn-swap" onclick="window._executeSwap()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg transition">ç¡®è®¤å…‘æ¢</button>
                </div>
            </div>
        </div>`;
        document.getElementById('modal-container').innerHTML = modalHTML;
        
        // å¯åŠ¨å€’è®¡æ—¶
        window._startExchangeTimer();
    }

    // å€’è®¡æ—¶é€»è¾‘
    window._startExchangeTimer = () => {
        if(exchangeTimer) clearInterval(exchangeTimer);
        const display = document.getElementById('timer-display');
        const btn = document.getElementById('btn-swap');
        const overlay = document.getElementById('expire-overlay');
        
        exchangeTimer = setInterval(() => {
            exchangeTimeLeft--;
            if (display) display.innerText = exchangeTimeLeft + 's';
            
            if (exchangeTimeLeft <= 0) {
                clearInterval(exchangeTimer);
                if(btn) {
                    btn.disabled = true;
                    btn.classList.add('bg-slate-300', 'cursor-not-allowed');
                    btn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                    btn.innerText = 'æ±‡ç‡å·²å¤±æ•ˆ';
                }
                if(overlay) overlay.classList.remove('hidden');
            }
        }, 1000);
    }

    // åˆ·æ–°æ±‡ç‡
    window._refreshRate = () => {
        const overlay = document.getElementById('expire-overlay');
        const btn = document.getElementById('btn-swap');
        
        // æ¨¡æ‹ŸåŠ è½½
        overlay.innerHTML = '<span class="text-slate-500">è·å–æœ€æ–°æ±‡ç‡...</span>';
        setTimeout(() => {
            exchangeTimeLeft = 60; // é‡ç½®
            window._startExchangeTimer();
            // æ¢å¤ UI
            if(overlay) {
                overlay.classList.add('hidden');
                overlay.innerHTML = '<button onclick="window._refreshRate()" class="text-indigo-600 font-bold flex items-center gap-1 hover:underline">æ±‡ç‡å·²è¿‡æœŸï¼Œç‚¹å‡»åˆ·æ–°</button>'; // è¿˜åŸæŒ‰é’®ä»¥å¤‡ä¸‹æ¬¡ç”¨
            }
            if(btn) {
                btn.disabled = false;
                btn.classList.remove('bg-slate-300', 'cursor-not-allowed');
                btn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                btn.innerText = 'ç¡®è®¤å…‘æ¢';
            }
        }, 500);
    }

    window._closeExchange = () => {
        if(exchangeTimer) clearInterval(exchangeTimer);
        closeModal();
    }

    window._executeSwap = () => {
        const btn = document.getElementById('btn-swap');
        btn.innerText = 'å…‘æ¢ä¸­...';
        setTimeout(() => {
            window._closeExchange();
            alert('âœ… å…‘æ¢æˆåŠŸï¼');
            if(typeof showView === 'function') showView('wallet');
        }, 1000);
    }


    // --- 4. é‡å†™ï¼šå……å€¼å¼¹çª— (æ”¯æŒ Crypto + Fiat Bank) ---
    window.openDepositModal = function(currency = 'USD') {
        // é»˜è®¤ tab
        let currentTab = 'crypto'; // 'crypto' | 'fiat'
        const bankInfo = bankAccounts[currency] || bankAccounts['USD'];

        const renderContent = () => {
            const container = document.getElementById('deposit-content');
            if (!container) return;

            if (currentTab === 'crypto') {
                container.innerHTML = `
                <div class="fade-in">
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-slate-500 mb-1.5">é€‰æ‹©å……å€¼ç½‘ç»œ</label>
                        <select class="w-full px-4 py-3 border border-slate-200 rounded-xl text-sm font-bold text-slate-700 outline-none bg-white">
                            <option>USDT - TRC20</option><option>USDT - ERC20</option>
                        </select>
                    </div>
                    <div class="bg-white border-2 border-slate-100 p-4 rounded-xl text-center mb-4">
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=TRC20_ADDR" class="mx-auto rounded-lg mb-3 w-32 h-32">
                        <p class="text-xs text-slate-400 mb-1">å……å€¼åœ°å€ (ç‚¹å‡»å¤åˆ¶)</p>
                        <p class="font-mono text-xs font-bold text-slate-700 break-all select-all cursor-pointer hover:text-indigo-600" onclick="copyText(this.innerText, 'åœ°å€')">TVJ2wMqCwXj5...8812</p>
                    </div>
                    <div class="bg-orange-50 rounded-lg p-3 text-[10px] text-orange-700 leading-relaxed">
                        * ä»…æ”¯æŒ USDT å……å€¼ï¼Œè´¹ç‡ 1%ã€‚<br>* æœ€ä½å……å€¼ 10 USDTï¼Œé¢„è®¡ 3 åˆ†é’Ÿåˆ°è´¦ã€‚
                    </div>
                </div>`;
            } else {
                container.innerHTML = `
                <div class="fade-in space-y-4">
                    <div class="bg-blue-50 border border-blue-100 rounded-xl p-4">
                        <h4 class="text-xs font-bold text-blue-700 mb-3 flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" stroke-width="2"/></svg>
                            æ”¶æ¬¾è´¦æˆ·ä¿¡æ¯ (Beneficiary)
                        </h4>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between"><span class="text-slate-500 text-xs">é“¶è¡Œåç§°</span><span class="font-bold text-slate-800 select-all">${bankInfo.bank}</span></div>
                            <div class="flex justify-between"><span class="text-slate-500 text-xs">è´¦æˆ·åç§°</span><span class="font-bold text-slate-800 select-all text-right">${bankInfo.name}</span></div>
                            <div class="flex justify-between"><span class="text-slate-500 text-xs">é“¶è¡Œè´¦å·</span><span class="font-bold text-slate-800 font-mono select-all">${bankInfo.account}</span></div>
                            <div class="flex justify-between"><span class="text-slate-500 text-xs">SWIFT/IBAN</span><span class="font-bold text-slate-800 font-mono select-all">${bankInfo.swift}</span></div>
                            <div class="pt-2 border-t border-blue-200/50">
                                <p class="text-xs text-slate-500 mb-1">é“¶è¡Œåœ°å€</p>
                                <p class="text-xs text-slate-700 leading-tight">${bankInfo.addr}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-100 rounded-xl p-3">
                        <p class="text-[10px] font-bold text-yellow-700 mb-1">âš ï¸ é‡è¦ï¼šè½¬è´¦é™„è¨€ (Reference Code)</p>
                        <div class="flex justify-between items-center bg-white border border-yellow-200 rounded px-2 py-1.5">
                            <span class="font-mono text-sm font-bold text-slate-800">UID-882910</span>
                            <button onclick="copyText('UID-882910', 'é™„è¨€')" class="text-xs text-indigo-600 font-bold">å¤åˆ¶</button>
                        </div>
                        <p class="text-[9px] text-yellow-600 mt-1">* è¯·åŠ¡å¿…åœ¨æ±‡æ¬¾é™„è¨€ä¸­å¡«å†™æ­¤ä»£ç ï¼Œå¦åˆ™æ— æ³•è‡ªåŠ¨å…¥è´¦ã€‚</p>
                    </div>
                </div>`;
            }
        };

        // åˆ‡æ¢ Tab çš„é€»è¾‘
        window._switchDepositTab = (tab) => {
            currentTab = tab;
            // æ›´æ–°æŒ‰é’®æ ·å¼
            document.getElementById('tab-crypto').className = `flex-1 py-2 text-sm font-bold rounded-lg transition ${tab==='crypto'?'bg-white text-indigo-600 shadow-sm':'text-slate-500 hover:text-slate-700'}`;
            document.getElementById('tab-fiat').className = `flex-1 py-2 text-sm font-bold rounded-lg transition ${tab==='fiat'?'bg-white text-indigo-600 shadow-sm':'text-slate-500 hover:text-slate-700'}`;
            renderContent();
        };

        const modalHTML = `
        <div class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[90] flex items-center justify-center fade-in">
            <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="font-bold text-lg text-slate-800">å……å€¼èµ„é‡‘ (${currency})</h3>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
                </div>
                
                <div class="p-6 overflow-y-auto">
                    <div class="bg-slate-100 p-1 rounded-xl flex mb-6">
                        <button id="tab-crypto" onclick="window._switchDepositTab('crypto')" class="flex-1 py-2 text-sm font-bold rounded-lg bg-white text-indigo-600 shadow-sm transition">åŠ å¯†è´§å¸ (USDT)</button>
                        <button id="tab-fiat" onclick="window._switchDepositTab('fiat')" class="flex-1 py-2 text-sm font-bold rounded-lg text-slate-500 hover:text-slate-700 transition">é“¶è¡Œè½¬è´¦ (Bank)</button>
                    </div>

                    <div id="deposit-content"></div>
                </div>

                <div class="p-4 border-t border-slate-100 bg-slate-50/50">
                    <button onclick="closeModal()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg transition">æˆ‘å·²å®Œæˆè½¬è´¦</button>
                </div>
            </div>
        </div>`;
        
        document.getElementById('modal-container').innerHTML = modalHTML;
        renderContent(); // åˆå§‹æ¸²æŸ“
    }
}
</script>
<script>
{
    // 1. é“¶è¡Œè´¦æˆ·æ•°æ®
    const bankAccounts = {
        'USD': { bank: 'Chase Bank', name: 'VCC TECH GLOBAL LTD', account: '9876543210', swift: 'CHASUS33', addr: '270 Park Avenue, New York, NY' },
        'EUR': { bank: 'Deutsche Bank', name: 'VCC TECH EU', account: 'DE89 3704 0044 0532', swift: 'DEUTDEFF', addr: 'Taunusanlage 12, Frankfurt' },
        'HKD': { bank: 'HSBC Hong Kong', name: 'VCC ASIA LIMITED', account: '004-123-456-789', swift: 'HSBCHKHH', addr: '1 Queen\'s Road Central, HK' },
        'GBP': { bank: 'Barclays London', name: 'VCC UK HQ', account: '20-45-67 88992211', swift: 'BARCGB22', addr: '1 Churchill Place, London' }
    };

    // 2. é‡å†™ï¼šå……å€¼å¼¹çª— (æ ¹æ®å¸ç§åŠ¨æ€æ˜¾ç¤º Tab)
    window.openDepositModal = function(currency = 'USD') {
        const isUSD = currency === 'USD';
        // å¦‚æœæ˜¯ USDï¼Œé»˜è®¤ cryptoï¼›å¦åˆ™å¼ºåˆ¶ fiat
        let currentTab = isUSD ? 'crypto' : 'fiat'; 
        const bankInfo = bankAccounts[currency] || bankAccounts['USD'];

        // å†…éƒ¨æ¸²æŸ“å‡½æ•°
        const renderContent = () => {
            const container = document.getElementById('deposit-content');
            if (!container) return;

            if (currentTab === 'crypto') {
                container.innerHTML = `
                <div class="fade-in">
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-slate-500 mb-1.5">é€‰æ‹©å……å€¼ç½‘ç»œ</label>
                        <select class="w-full px-4 py-3 border border-slate-200 rounded-xl text-sm font-bold text-slate-700 outline-none bg-white">
                            <option>USDT - TRC20</option><option>USDT - ERC20</option>
                        </select>
                    </div>
                    <div class="bg-white border-2 border-slate-100 p-4 rounded-xl text-center mb-4">
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=TRC20_ADDR" class="mx-auto rounded-lg mb-3 w-32 h-32">
                        <p class="text-xs text-slate-400 mb-1">å……å€¼åœ°å€ (ç‚¹å‡»å¤åˆ¶)</p>
                        <p class="font-mono text-xs font-bold text-slate-700 break-all select-all cursor-pointer hover:text-indigo-600" onclick="copyText(this.innerText, 'åœ°å€')">TVJ2wMqCwXj5...8812</p>
                    </div>
                    <div class="bg-orange-50 rounded-lg p-3 text-[10px] text-orange-700 leading-relaxed">
                        * ä»…æ”¯æŒ USDT å……å€¼ï¼Œè´¹ç‡ 1%ã€‚<br>* æœ€ä½å……å€¼ 10 USDTï¼Œé¢„è®¡ 3 åˆ†é’Ÿåˆ°è´¦ã€‚
                    </div>
                </div>`;
            } else {
                container.innerHTML = `
                <div class="fade-in space-y-4">
                    ${!isUSD ? `<div class="bg-indigo-50 text-indigo-600 px-3 py-2 rounded-lg text-xs font-bold flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>${currency} ä»…æ”¯æŒé“¶è¡Œè½¬è´¦å……å€¼</div>` : ''}
                    
                    <div class="bg-blue-50 border border-blue-100 rounded-xl p-4">
                        <h4 class="text-xs font-bold text-blue-700 mb-3 flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" stroke-width="2"/></svg>
                            æ”¶æ¬¾è´¦æˆ·ä¿¡æ¯ (${currency})
                        </h4>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between"><span class="text-slate-500 text-xs">é“¶è¡Œåç§°</span><span class="font-bold text-slate-800 select-all">${bankInfo.bank}</span></div>
                            <div class="flex justify-between"><span class="text-slate-500 text-xs">è´¦æˆ·åç§°</span><span class="font-bold text-slate-800 select-all text-right">${bankInfo.name}</span></div>
                            <div class="flex justify-between"><span class="text-slate-500 text-xs">é“¶è¡Œè´¦å·</span><span class="font-bold text-slate-800 font-mono select-all">${bankInfo.account}</span></div>
                            <div class="flex justify-between"><span class="text-slate-500 text-xs">SWIFT/IBAN</span><span class="font-bold text-slate-800 font-mono select-all">${bankInfo.swift}</span></div>
                            <div class="pt-2 border-t border-blue-200/50">
                                <p class="text-xs text-slate-500 mb-1">é“¶è¡Œåœ°å€</p>
                                <p class="text-xs text-slate-700 leading-tight">${bankInfo.addr}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-100 rounded-xl p-3">
                        <p class="text-[10px] font-bold text-yellow-700 mb-1">âš ï¸ é‡è¦ï¼šè½¬è´¦é™„è¨€ (Reference Code)</p>
                        <div class="flex justify-between items-center bg-white border border-yellow-200 rounded px-2 py-1.5">
                            <span class="font-mono text-sm font-bold text-slate-800">UID-882910</span>
                            <button onclick="copyText('UID-882910', 'é™„è¨€')" class="text-xs text-indigo-600 font-bold hover:underline">å¤åˆ¶</button>
                        </div>
                        <p class="text-[9px] text-yellow-600 mt-1">* å¿…é¡»å¡«å†™é™„è¨€ï¼Œå¦åˆ™æ— æ³•è‡ªåŠ¨å…¥è´¦ã€‚</p>
                    </div>
                </div>`;
            }
        };

        // åˆ‡æ¢ Tab çš„é€»è¾‘ (ä»… USD å¯ç”¨)
        window._switchDepositTab = (tab) => {
            currentTab = tab;
            const cryptoBtn = document.getElementById('tab-crypto');
            const fiatBtn = document.getElementById('tab-fiat');
            if(cryptoBtn) cryptoBtn.className = `flex-1 py-2 text-sm font-bold rounded-lg transition ${tab==='crypto'?'bg-white text-indigo-600 shadow-sm':'text-slate-500 hover:text-slate-700'}`;
            if(fiatBtn) fiatBtn.className = `flex-1 py-2 text-sm font-bold rounded-lg transition ${tab==='fiat'?'bg-white text-indigo-600 shadow-sm':'text-slate-500 hover:text-slate-700'}`;
            renderContent();
        };

        const modalHTML = `
        <div class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[90] flex items-center justify-center fade-in">
            <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="font-bold text-lg text-slate-800">å……å€¼èµ„é‡‘ (${currency})</h3>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
                </div>
                
                <div class="p-6 overflow-y-auto">
                    ${isUSD ? `
                    <div class="bg-slate-100 p-1 rounded-xl flex mb-6">
                        <button id="tab-crypto" onclick="window._switchDepositTab('crypto')" class="flex-1 py-2 text-sm font-bold rounded-lg bg-white text-indigo-600 shadow-sm transition">åŠ å¯†è´§å¸ (USDT)</button>
                        <button id="tab-fiat" onclick="window._switchDepositTab('fiat')" class="flex-1 py-2 text-sm font-bold rounded-lg text-slate-500 hover:text-slate-700 transition">é“¶è¡Œè½¬è´¦ (Bank)</button>
                    </div>` : ''}

                    <div id="deposit-content"></div>
                </div>

                <div class="p-4 border-t border-slate-100 bg-slate-50/50">
                    <button onclick="closeModal()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg transition">æˆ‘å·²å®Œæˆè½¬è´¦</button>
                </div>
            </div>
        </div>`;
        
        document.getElementById('modal-container').innerHTML = modalHTML;
        renderContent(); // åˆå§‹æ¸²æŸ“
    }
}
</script>
<script>
{
    // --- 1. æ•°æ®å‡†å¤‡ (ä¿æŒä¸å˜) ---
    if (!window.currentUser) window.currentUser = { balance: 12450.80 };
    if (!window.currentUser.wallets) {
        window.currentUser.wallets = [
            { code: 'USD', name: 'US Dollar', symbol: '$', balance: 12450.80, flag: 'ğŸ‡ºğŸ‡¸' },
            { code: 'EUR', name: 'Euro', symbol: 'â‚¬', balance: 450.00, flag: 'ğŸ‡ªğŸ‡º' },
            { code: 'HKD', name: 'HK Dollar', symbol: 'HK$', balance: 25000.00, flag: 'ğŸ‡­ğŸ‡°' },
            { code: 'GBP', name: 'British Pound', symbol: 'Â£', balance: 0.00, flag: 'ğŸ‡¬ğŸ‡§' }
        ];
    }
    // æŒå¡äººæ•°æ®æ¨¡æ‹Ÿ
    if (!window._cardholders) window._cardholders = [{ id: 'h1', name: 'James Smith' }, { id: 'h2', name: 'Li Wei' }];

    window._applyState = window._applyState || { cardType: 'prepaid', currency: 'USD', tab: 'ads', binIndex: 0, qty: 1 };

    window._binData = [
        { bin: '544923', net: 'Mastercard', type: 'Credit', platforms: ['google', 'facebook'], label: 'å¹¿å‘Šä¸“ç”¨', fee: 3.5, category: 'ads', supportShared: true, currencies: ['USD', 'EUR'], requiresCardholder: true }, // éœ€è¦å®å
        { bin: '428811', net: 'Visa', type: 'Credit', platforms: ['tiktok', 'pinterest'], label: 'ç»¼åˆé€šç”¨', fee: 2.5, category: 'ads', supportShared: false, currencies: ['USD'], requiresCardholder: false },
        { bin: '527375', net: 'Mastercard', type: 'Credit', platforms: ['amazon', 'shopify'], label: 'ç”µå•†é¦–é€‰', fee: 2.0, category: 'ecom', supportShared: true, currencies: ['USD', 'HKD', 'GBP'], requiresCardholder: false },
        { bin: '558325', net: 'Mastercard', type: 'Prepaid', platforms: ['booking', 'uber'], label: 'å•†æ—…å‡ºè¡Œ', fee: 0.0, category: 'enterprise', supportShared: true, currencies: ['USD', 'HKD', 'EUR', 'GBP'], requiresCardholder: true } // éœ€è¦å®å
    ];

    // --- 2. è§†å›¾æ¸²æŸ“ ---
    views.apply = () => {
        const state = window._applyState;
        const wallet = window.currentUser.wallets.find(w => w.code === state.currency) || window.currentUser.wallets[0];
        
        // ç­›é€‰é€»è¾‘
        const filteredBins = window._binData.filter(item => {
            if (state.cardType === 'shared' && !item.supportShared) return false;
            if (!item.currencies.includes(state.currency)) return false;
            if (item.category !== state.tab) return false;
            return true;
        });
        
        if (state.binIndex >= filteredBins.length) state.binIndex = 0;
        const currentBin = filteredBins[state.binIndex];

        // æ ¸å¿ƒï¼šè´¹ç”¨æ˜ç»†è®¡ç®—
        const qty = state.qty;
        const feePerCard = currentBin ? currentBin.fee : 0;
        const monthlyFee = 0; // å‡è®¾æœˆè´¹ä¸º0ï¼Œå¦‚éœ€æ˜¾ç¤ºå¯ä¿®æ”¹
        const preChargePerCard = state.cardType === 'shared' ? 0 : 10; // å…±äº«å¡0é¢„å……ï¼Œæ™®é€šå¡10é¢„å……

        const totalIssuanceFee = feePerCard * qty;
        const totalMonthlyFee = monthlyFee * qty;
        const totalPreCharge = preChargePerCard * qty;
        const totalCost = totalIssuanceFee + totalMonthlyFee + totalPreCharge;

        // åˆ¤æ–­æ˜¯å¦éœ€è¦æŒå¡äºº
        const needHolder = currentBin ? currentBin.requiresCardholder : false;

        // æ ·å¼è¾…åŠ©
        const getTypeCardStyle = (type) => {
            const isSelected = state.cardType === type;
            const color = type === 'shared' ? 'purple' : 'indigo';
            return isSelected ? `border-${color}-600 bg-${color}-50 ring-1 ring-${color}-600 shadow-sm z-10` : 'border-slate-200 bg-white hover:border-slate-300 hover:bg-slate-50';
        };
        const renderTags = (arr) => arr.slice(0,2).map(t=>`<span class="text-[10px] bg-slate-100 text-slate-500 border border-slate-200 px-1 rounded uppercase">${t}</span>`).join('');

        return `
        <div class="max-w-6xl mx-auto fade-in pb-24">
            
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800">ç”³è¯·æ–°å¡ (Issue Card)</h2>
                <div class="px-4 py-2 bg-indigo-50 text-indigo-600 rounded-lg text-sm font-bold border border-indigo-100">
                    ä½™é¢: ${wallet.symbol}${wallet.balance.toLocaleString(undefined, {minimumFractionDigits: 2})} <span class="text-xs opacity-70 ml-1">(${wallet.code})</span>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8 space-y-8">
                
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-3 uppercase tracking-wider">Step 1: èµ„é‡‘æ¨¡å¼</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div onclick="window._setCardType('prepaid')" class="relative p-5 rounded-xl border-2 cursor-pointer transition flex items-center gap-4 ${getTypeCardStyle('prepaid')}">
                            <div class="w-12 h-12 rounded-full bg-indigo-50 flex items-center justify-center flex-shrink-0 text-indigo-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg></div>
                            <div><h4 class="font-bold text-slate-800 text-sm">æ™®é€šå¡ (Prepaid)</h4><p class="text-xs text-slate-500 mt-1">ç‹¬ç«‹èµ„é‡‘è´¦æˆ·ï¼Œéœ€æ‰‹åŠ¨åˆ’è½¬ã€‚</p></div>
                            ${state.cardType==='prepaid' ? '<div class="absolute top-4 right-4 text-indigo-600"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg></div>' : ''}
                        </div>
                        <div onclick="window._setCardType('shared')" class="relative p-5 rounded-xl border-2 cursor-pointer transition flex items-center gap-4 ${getTypeCardStyle('shared')}">
                            <div class="w-12 h-12 rounded-full bg-purple-50 flex items-center justify-center flex-shrink-0 text-purple-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg></div>
                            <div><h4 class="font-bold text-slate-800 text-sm">å…±äº«å¡ (Shared)</h4><p class="text-xs text-slate-500 mt-1">ç›´æ¥æ¶ˆè€—ä¸»ä½™é¢ï¼Œæ— éœ€å……å€¼ã€‚</p></div>
                            ${state.cardType==='shared' ? '<div class="absolute top-4 right-4 text-purple-600"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg></div>' : ''}
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-3 uppercase tracking-wider">Step 2: å¡ç‰‡å¸ç§</label>
                    <div class="flex flex-wrap gap-3">
                        ${window.currentUser.wallets.map(w => {
                            const isActive = w.code === state.currency;
                            return `<button onclick="window._setApplyCurrency('${w.code}')" class="px-5 py-2.5 rounded-lg text-sm font-bold flex items-center gap-2 transition-all border ${isActive ? 'bg-indigo-600 text-white border-indigo-600 shadow-md' : 'bg-white text-slate-600 border-slate-200 hover:border-slate-300 hover:bg-slate-50'}"><span class="text-lg leading-none">${w.flag}</span><span>${w.code}</span></button>`;
                        }).join('')}
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-3 uppercase tracking-wider">Step 3: ä¸šåŠ¡åœºæ™¯</label>
                    <div class="flex gap-3 mb-4">
                        ${[{id:'ads', name:'å¹¿å‘ŠæŠ•æ”¾', icon:'ğŸ“¢'}, {id:'ecom', name:'ç”µå•†æµ·æ·˜', icon:'ğŸ›’'}, {id:'enterprise', name:'ä¼ä¸šä¸šåŠ¡', icon:'ğŸ¢'}].map(cat => `<button onclick="window._switchTab('${cat.id}')" class="px-6 py-2.5 rounded-full text-xs font-bold border transition flex items-center gap-2 ${state.tab===cat.id ? 'bg-indigo-600 text-white shadow-md' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}"><span>${cat.icon}</span> ${cat.name}</button>`).join('')}
                    </div>
                    <div class="min-h-[160px]">
                        ${filteredBins.length > 0 ? `
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            ${filteredBins.map((item, index) => {
                                const isSelected = state.binIndex === index;
                                return `
                                <div onclick="window._selectBin(${index})" class="relative border rounded-xl p-4 cursor-pointer transition-all duration-200 group ${isSelected ? 'border-indigo-600 bg-indigo-50/10 ring-1 ring-indigo-600' : 'border-slate-200 hover:border-indigo-300 bg-white'}">
                                    ${isSelected ? '<div class="absolute -top-2 -right-2 w-5 h-5 bg-indigo-600 rounded-full flex items-center justify-center text-white text-xs shadow-sm">âœ“</div>' : ''}
                                    <div class="flex justify-between items-center mb-2"><span class="px-1.5 py-0.5 border border-slate-200 rounded text-[10px] font-bold text-slate-600 bg-white">${item.net}</span><span class="text-sm font-bold text-indigo-600">${wallet.symbol}${item.fee}</span></div>
                                    <p class="text-xl font-mono font-bold text-slate-800">${item.bin}</p>
                                    <div class="flex gap-1 flex-wrap mt-2">${renderTags(item.platforms)}</div>
                                    ${item.requiresCardholder ? '<div class="mt-3 pt-2 border-t border-indigo-100 text-[10px] text-indigo-600 font-bold flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>éœ€å…³è”æŒå¡äºº</div>' : ''}
                                </div>`;
                            }).join('')}
                        </div>` : `<div class="p-8 text-center text-slate-400 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50">æ— åŒ¹é…å¡æ®µ</div>`}
                    </div>
                </div>

                <div class="bg-slate-50 rounded-xl p-6 border border-slate-100 mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        
                        ${needHolder ? `
                        <div>
                            <label class="flex justify-between text-xs font-bold text-slate-500 mb-2">
                                <span>å…³è”æŒå¡äºº (Cardholder)</span>
                                <button onclick="window.openHolderModal()" class="text-indigo-600 hover:underline">+ æ–°å¢</button>
                            </label>
                            <div class="relative"><select id="apply-holder" class="w-full px-4 py-3 border border-slate-200 rounded-xl text-sm font-bold text-slate-800 outline-none bg-white focus:border-indigo-500">${window._cardholders.map(h => `<option value="${h.id}">${h.name}</option>`).join('')}</select></div>
                        </div>
                        ` : ''}

                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-2">å¼€å¡æ•°é‡</label>
                            <div class="relative"><select id="apply-qty" onchange="window._updateQty(this.value)" class="w-full px-4 py-3 border border-slate-200 rounded-xl text-sm font-bold text-slate-800 outline-none bg-white focus:border-indigo-500"><option value="1">1 å¼ </option><option value="5">5 å¼ </option><option value="10">10 å¼ </option></select></div>
                        </div>
                        
                        <div class="${needHolder ? 'md:col-span-2' : ''}">
                            <label class="block text-xs font-bold text-slate-500 mb-2">å¡ç‰‡æ˜µç§° / å¤‡æ³¨</label>
                            <input type="text" id="apply-nickname" class="w-full px-4 py-3 border border-slate-200 rounded-xl text-sm font-bold text-slate-800 outline-none focus:border-indigo-500" placeholder="ä¾‹å¦‚ï¼šAds Team 01">
                        </div>
                    </div>
                    
                    <div class="bg-white border border-slate-200 rounded-lg p-4 space-y-2 text-sm">
                        <div class="flex justify-between text-slate-500">
                            <span>å¼€å¡è´¹ (${wallet.symbol}${feePerCard} Ã— ${qty})</span>
                            <span class="font-mono">${wallet.symbol}${totalIssuanceFee.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between text-slate-500">
                            <span>æœˆç®¡ç†è´¹</span>
                            <span class="font-mono">${wallet.symbol}0.00</span>
                        </div>
                        <div class="flex justify-between text-slate-500">
                            <span>é¢„å……å€¼é‡‘é¢ (${wallet.symbol}${preChargePerCard} Ã— ${qty})</span>
                            <span class="font-mono">${wallet.symbol}${totalPreCharge.toFixed(2)}</span>
                        </div>
                        <div class="border-t border-slate-100 my-2"></div>
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-slate-800">åˆè®¡æ‰£æ¬¾</span>
                            <span class="text-xl font-bold text-red-600 font-mono">${wallet.symbol}${totalCost.toFixed(2)}</span>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end pt-2">
                    <button onclick="window._handleApplyPay('${wallet.symbol}', ${totalCost}, ${needHolder})" ${!currentBin ? 'disabled' : ''} class="px-8 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 transition disabled:opacity-50 disabled:cursor-not-allowed">ç¡®è®¤æ”¯ä»˜å¼€å¡</button>
                </div>
            </div>
        </div>`;
    }

    // --- 3. äº¤äº’é€»è¾‘ (ä¿æŒä¸å˜) ---
    window._setApplyCurrency = (code) => { window._applyState.currency = code; window._applyState.binIndex = 0; showView('apply'); }
    window._setCardType = (type) => { window._applyState.cardType = type; window._applyState.binIndex = 0; showView('apply'); }
    window._switchTab = (tab) => { window._applyState.tab = tab; window._applyState.binIndex = 0; showView('apply'); }
    window._selectBin = (index) => { window._applyState.binIndex = index; showView('apply'); }
    window._updateQty = (val) => { window._applyState.qty = parseInt(val); showView('apply'); }

    window._handleApplyPay = (symbol, cost, needHolder) => {
        const wallet = window.currentUser.wallets.find(w => w.code === window._applyState.currency);
        if (cost > wallet.balance) return alert(`ä½™é¢ä¸è¶³ï¼`);
        
        // æ ¡éªŒæŒå¡äºº
        let cardName = document.getElementById('apply-nickname').value || 'New Card';
        if (needHolder) {
            const holderSelect = document.getElementById('apply-holder');
            if(!holderSelect || !holderSelect.value) return alert('è¯·é€‰æ‹©æˆ–æ·»åŠ æŒå¡äººï¼');
            // å¯ä»¥æŠŠæŒå¡äººåå­—åŠ åˆ°å¡åé‡Œï¼Œæˆ–è€…å­˜ä¸ºç‹¬ç«‹å­—æ®µ
        }

        if(!confirm(`ç¡®è®¤æ”¯ä»˜ ${symbol}${cost.toFixed(2)}ï¼Ÿ`)) return;

        wallet.balance -= cost;
        if (wallet.code === 'USD') window.currentUser.balance = wallet.balance;

        // ç”Ÿæˆ
        const filteredBins = window._binData.filter(item => {
            if (item.category !== window._applyState.tab) return false;
            if (window._applyState.cardType === 'shared' && !item.supportShared) return false;
            if (!item.currencies.includes(window._applyState.currency)) return false;
            return true;
        });
        const bin = filteredBins[window._applyState.binIndex] || filteredBins[0];
        
        for(let i=0; i<window._applyState.qty; i++) {
            window.myCards.unshift({
                id: 'c_'+Date.now()+i,
                name: window._applyState.qty>1 ? `${cardName} #${i+1}` : cardName,
                number: bin.bin + Math.floor(Math.random()*100000000000),
                cvv: '888', exp: '12/29',
                balance: window._applyState.cardType==='shared' ? 0 : 10,
                status: 'active', type: bin.net, product: bin.label,
                mode: window._applyState.cardType,
                currency: window._applyState.currency,
                limit: 5000
            });
        }
        alert('ğŸ‰ å¼€å¡æˆåŠŸï¼');
        showView('cards');
    }

    if(document.querySelector('h2') && document.querySelector('h2').innerText.includes('ç”³è¯·')) showView('apply');
}
</script>
<script>
{
    // 1. åˆå§‹åŒ–æ•°æ® (ç‹¬ç«‹å‘½åç©ºé—´ï¼Œé˜²æ­¢å†²çª)
    window.HolderModule = {
        data: [
            { id: 'h_01', name: 'James Smith', email: 'james@corp.com', country: 'US', address: '4522 SW 3rd St, Miami' },
            { id: 'h_02', name: 'Li Wei', email: 'wei.li@tech.cn', country: 'SG', address: '1 Raffles Place, Singapore' }
        ]
    };

    // 2. æ³¨å†Œè§†å›¾ï¼šæŒå¡äººåˆ—è¡¨ (è¦†ç›–å¼æ³¨å†Œ)
    views.holders = function() {
        const list = window.HolderModule.data;
        return `
        <div class="max-w-6xl mx-auto fade-in pb-24">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-bold text-slate-800">æŒå¡äººç®¡ç†</h2>
                <button onclick="window.HolderModule.openAdd()" class="px-5 py-2.5 bg-indigo-600 text-white rounded-lg font-bold shadow-lg hover:bg-indigo-700 transition">
                    + æ–°å¢æŒå¡äºº
                </button>
            </div>
            
            <div class="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 border-b border-slate-200 text-slate-500">
                        <tr>
                            <th class="px-6 py-4 font-medium">å§“å</th>
                            <th class="px-6 py-4 font-medium">é‚®ç®±</th>
                            <th class="px-6 py-4 font-medium">å›½å®¶/åœ°åŒº</th>
                            <th class="px-6 py-4 font-medium">è´¦å•åœ°å€</th>
                            <th class="px-6 py-4 font-medium text-right">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        ${list.length > 0 ? list.map(h => `
                        <tr class="hover:bg-slate-50 transition">
                            <td class="px-6 py-4 font-bold text-slate-800">${h.name}</td>
                            <td class="px-6 py-4 text-slate-500 font-mono">${h.email}</td>
                            <td class="px-6 py-4"><span class="px-2 py-1 bg-slate-100 rounded text-xs font-bold text-slate-600">${h.country}</span></td>
                            <td class="px-6 py-4 text-slate-500 truncate max-w-[200px]" title="${h.address}">${h.address}</td>
                            <td class="px-6 py-4 text-right">
                                <button onclick="window.HolderModule.remove('${h.id}')" class="text-red-500 hover:text-red-700 font-bold text-xs">åˆ é™¤</button>
                            </td>
                        </tr>`).join('') : '<tr><td colspan="5" class="p-8 text-center text-slate-400">æš‚æ— æŒå¡äººæ•°æ®ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’æ–°å¢ã€‚</td></tr>'}
                    </tbody>
                </table>
            </div>
        </div>`;
    };

    // 3. æ³¨å†ŒåŠŸèƒ½é€»è¾‘ (æŒ‚è½½åˆ° HolderModule å¯¹è±¡)
    window.HolderModule.openAdd = function() {
        const html = `
        <div class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[200] flex items-center justify-center fade-in">
            <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-lg text-slate-800">æ–°å¢æŒå¡äººæ¡£æ¡ˆ</h3>
                    <button onclick="document.getElementById('modal-container').innerHTML=''" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
                </div>
                <div class="space-y-4">
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">å§“å</label><input id="hm-name" class="w-full px-3 py-2 border rounded-lg outline-none focus:border-indigo-500" placeholder="San Zhang"></div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">é‚®ç®±</label><input id="hm-email" class="w-full px-3 py-2 border rounded-lg outline-none focus:border-indigo-500" placeholder="zhang@example.com"></div>
                    <div class="flex gap-4">
                        <div class="w-1/3"><label class="block text-xs font-bold text-slate-500 mb-1">å›½å®¶ä»£ç </label><input id="hm-country" class="w-full px-3 py-2 border rounded-lg outline-none focus:border-indigo-500" value="US"></div>
                        <div class="w-2/3"><label class="block text-xs font-bold text-slate-500 mb-1">è¯¦ç»†åœ°å€</label><input id="hm-addr" class="w-full px-3 py-2 border rounded-lg outline-none focus:border-indigo-500" placeholder="Street, City..."></div>
                    </div>
                    <button onclick="window.HolderModule.save()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg mt-2 transition">ç¡®è®¤ä¿å­˜</button>
                </div>
            </div>
        </div>`;
        document.getElementById('modal-container').innerHTML = html;
    };

    window.HolderModule.save = function() {
        const name = document.getElementById('hm-name').value;
        const email = document.getElementById('hm-email').value;
        const country = document.getElementById('hm-country').value;
        const addr = document.getElementById('hm-addr').value;

        if (!name || !email) return alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');

        window.HolderModule.data.push({
            id: 'h_' + Date.now(),
            name, email, country, address: addr
        });

        document.getElementById('modal-container').innerHTML = '';
        showView('holders'); // åˆ·æ–°é¡µé¢
        alert('âœ… æ·»åŠ æˆåŠŸ');
    };

    window.HolderModule.remove = function(id) {
        if(!confirm('ç¡®è®¤åˆ é™¤æ­¤æ¡£æ¡ˆï¼Ÿ')) return;
        window.HolderModule.data = window.HolderModule.data.filter(h => h.id !== id);
        showView('holders');
    };

    // 4. ã€æš´åŠ›èœå•å®ˆæŠ¤ç¨‹åºã€‘ (æ¯500æ¯«ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œæ²¡äº†å°±åŠ )
    setInterval(() => {
        const nav = document.querySelector('nav');
        // åªæœ‰å½“ä¾§è¾¹æ å­˜åœ¨ï¼Œä¸”æˆ‘ä»¬çš„æŒ‰é’®ä¸åœ¨æ—¶ï¼Œæ‰æ’å…¥
        if (nav && !document.getElementById('nav-item-holders')) {
            // åˆ›å»ºèœå• HTML
            const btnHtml = `
            <a href="#" id="nav-item-holders" onclick="showView('holders'); return false;" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-slate-600 hover:bg-slate-50 transition group cursor-pointer border-t border-slate-100 mt-2">
                <div class="w-5 h-5 flex items-center justify-center bg-indigo-50 text-indigo-600 rounded">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                </div>
                <span class="font-medium">æŒå¡äººç®¡ç†</span>
            </a>`;
            
            // ç®€å•ç²—æš´ï¼šç›´æ¥è¿½åŠ åˆ° nav çš„æœ€åé¢
            nav.insertAdjacentHTML('beforeend', btnHtml);
        }
    }, 500);

}
</script>
<script>
{
    // 1. å¼ºåˆ¶ä¿®æ”¹çŠ¶æ€ä¸º USD
    if (window._applyState) {
        window._applyState.currency = 'USD';
    } else {
        // å¦‚æœçŠ¶æ€å°šæœªåˆå§‹åŒ–ï¼Œé¢„è®¾ä¸º USD
        window._applyState = { 
            cardType: 'prepaid', 
            currency: 'USD', 
            tab: 'ads', 
            binIndex: 0, 
            qty: 1 
        };
    }

    // 2. å¦‚æœå½“å‰æ­£å¤„äºå¼€å¡é¡µé¢ï¼Œç«‹å³åˆ·æ–°ä¸€ä¸‹è§†å›¾ï¼Œè®©é€‰ä¸­æ€ç”Ÿæ•ˆ
    const currentTitle = document.querySelector('h2')?.innerText || '';
    if (currentTitle.includes('ç”³è¯·') && typeof showView === 'function') {
        showView('apply');
    }
}
</script>
<script>
{
    // é‡å†™ï¼šå¡ç‰‡åˆ—è¡¨è§†å›¾
    views.cards = () => {
        const list = myCards.filter(c => {
            const matchType = _cardState.filter === 'all' || (_cardState.filter === 'shared' ? c.mode === 'shared' : c.mode !== 'shared');
            const matchSearch = ! _cardState.searchQuery || c.name.toLowerCase().includes(_cardState.searchQuery.toLowerCase()) || c.number.includes(_cardState.searchQuery);
            return matchType && matchSearch;
        });
        const activeCount = list.filter(c => c.status === 'active').length;
        const totalBalance = list.reduce((sum, c) => sum + (c.mode==='shared'?0:c.balance), 0);

        return `
        <div class="max-w-[1200px] mx-auto fade-in pb-20">
            <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-slate-900 tracking-tight">å¡ç‰‡ç®¡ç†</h2>
                    <div class="flex items-center gap-4 mt-2 text-sm text-slate-500">
                        <span>æ´»è·ƒå¡ç‰‡: <b class="text-slate-800">${activeCount}</b></span>
                        <span class="w-1 h-1 bg-slate-300 rounded-full"></span>
                        <span>ç‹¬ç«‹æ€»ä½™é¢: <b class="text-slate-800">$${totalBalance.toLocaleString()}</b></span>
                    </div>
                </div>
                <button onclick="showView('apply')" class="px-5 py-2.5 bg-slate-900 hover:bg-slate-800 text-white rounded-lg text-sm font-semibold shadow-lg shadow-slate-200 transition flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    ç”³è¯·æ–°å¡
                </button>
            </div>

            <div class="bg-white border border-slate-200 rounded-xl p-1.5 flex justify-between items-center mb-6 shadow-sm">
                <div class="flex gap-1">
                    <button onclick="window._setCardFilter('all')" class="px-4 py-2 rounded-lg text-sm font-medium transition ${_cardState.filter === 'all' ? 'bg-slate-100 text-slate-900 shadow-sm' : 'text-slate-500 hover:bg-slate-50 hover:text-slate-700'}">å…¨éƒ¨</button>
                    <button onclick="window._setCardFilter('prepaid')" class="px-4 py-2 rounded-lg text-sm font-medium transition ${_cardState.filter === 'prepaid' ? 'bg-indigo-50 text-indigo-600 shadow-sm' : 'text-slate-500 hover:bg-slate-50 hover:text-slate-700'}">æ™®é€šå¡</button>
                    <button onclick="window._setCardFilter('shared')" class="px-4 py-2 rounded-lg text-sm font-medium transition ${_cardState.filter === 'shared' ? 'bg-purple-50 text-purple-600 shadow-sm' : 'text-slate-500 hover:bg-slate-50 hover:text-slate-700'}">å…±äº«å¡</button>
                </div>
                <div class="relative mr-2 hidden md:block">
                    <input type="text" placeholder="æœç´¢å¡å· / å¤‡æ³¨å..." oninput="window._searchCard(this.value)" class="pl-9 pr-4 py-2 bg-slate-50 border-none rounded-lg text-sm w-64 focus:ring-2 focus:ring-indigo-500/20 text-slate-800 placeholder:text-slate-400 outline-none transition">
                    <svg class="w-4 h-4 text-slate-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                </div>
            </div>

            <div class="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 border-b border-slate-200 text-slate-500">
                        <tr>
                            <th class="px-6 py-4 font-medium w-64">å¡ç‰‡ä¿¡æ¯</th>
                            <th class="px-6 py-4 font-medium">å®Œæ•´å¡å·</th>
                            <th class="px-6 py-4 font-medium">ç±»å‹ / æŒå¡äºº</th> <th class="px-6 py-4 font-medium text-right">å¯ç”¨ä½™é¢/é™é¢</th>
                            <th class="px-6 py-4 font-medium text-center">çŠ¶æ€</th>
                            <th class="px-6 py-4 font-medium text-right">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        ${list.length > 0 ? list.map(c => {
                            // è·å–å…³è”æŒå¡äººä¿¡æ¯
                            const holder = c.holderId && window._cardholders ? window._cardholders.find(h => h.id === c.holderId) : null;
                            
                            return `
                            <tr onclick="window._goToDetail('${c.id}')" class="hover:bg-slate-50/80 transition cursor-pointer group">
                                <td class="px-6 py-4 font-medium text-slate-900">
                                    ${c.name}
                                    <div class="text-[10px] font-normal text-slate-400 mt-0.5">${c.product}</div>
                                </td>
                                <td class="px-6 py-4 font-mono text-slate-600">â€¢â€¢â€¢â€¢ ${c.number.slice(-4)}</td>
                                
                                <td class="px-6 py-4">
                                    <div class="flex flex-col items-start gap-1.5">
                                        ${c.mode === 'shared' 
                                            ? '<span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold bg-purple-50 text-purple-700 border border-purple-100">å…±äº«å¡</span>' 
                                            : '<span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold bg-slate-100 text-slate-600 border border-slate-200">æ™®é€šå¡</span>'
                                        }
                                        
                                        ${holder ? `
                                        <div class="flex items-center gap-1.5 px-2 py-0.5 bg-indigo-50 text-indigo-700 rounded border border-indigo-100 text-[10px] font-bold" title="å…³è”æŒå¡äºº: ${holder.firstName} ${holder.lastName}">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                                            <span class="truncate max-w-[80px]">å®å: ${holder.firstName} ${holder.lastName}</span>
                                        </div>` : ''}
                                    </div>
                                </td>

                                <td class="px-6 py-4 text-right">
                                    ${c.mode === 'shared' 
                                        ? '<span class="text-slate-400 text-xs">å…±äº«ä¸»è´¦æˆ·</span>'
                                        : `<span class="font-bold text-slate-800">$${c.balance.toFixed(2)}</span>`
                                    }
                                </td>
                                <td class="px-6 py-4 text-center">
                                    <span class="inline-flex w-2.5 h-2.5 rounded-full ${c.status === 'active' ? 'bg-emerald-500' : 'bg-rose-500'}"></span>
                                </td>
                                <td class="px-6 py-4 text-right text-slate-400">
                                    <span class="text-xs group-hover:text-indigo-600 transition">æŸ¥çœ‹è¯¦æƒ… ></span>
                                </td>
                            </tr>`;
                        }).join('') : '<tr><td colspan="6" class="p-12 text-center text-slate-400">æš‚æ— ç¬¦åˆæ¡ä»¶çš„å¡ç‰‡</td></tr>'}
                    </tbody>
                </table>
            </div>
        </div>`;
    };
}
</script>
<script>
(function() {
    // 1. å…ˆç¡®ä¿æœ‰æŒå¡äººæ•°æ® (å¦‚æœæ²¡æœ‰ï¼Œè¡¥ä¸€ä¸ª James)
    if (!window._cardholders) window._cardholders = [];
    var hasJames = window._cardholders.some(function(h) { return h.id === 'h_01'; });
    if (!hasJames) {
        window._cardholders.push({ 
            id: 'h_01', firstName: 'James', lastName: 'Smith', 
            email: 'james@corp.com', country: 'US', address: '4522 SW 3rd St, Miami' 
        });
    }

    // 2. å®šä¹‰ä¸€å¼ å®åå¡ (å…³è” h_01)
    var kycCard = {
        id: 'c_kyc_' + Math.floor(Math.random() * 10000),
        name: 'James Media Buy',
        number: '55832500' + Math.floor(Math.random() * 100000000),
        cvv: '999',
        exp: '10/28',
        balance: 8800.00,
        status: 'active',
        type: 'Mastercard',
        product: 'ä¼ä¸šå®åå¡',
        mode: 'prepaid',
        currency: 'USD',
        limit: 20000,
        holderId: 'h_01' // â˜…â˜…â˜… å…³é”®ï¼šå…³è”äº† James Smith
    };

    // 3. æ‰¾åˆ°åˆ—è¡¨å¹¶æ’å…¥
    // å°è¯•è·å–å…¨å±€ myCards
    var cardsList = window.myCards || myCards;
    
    if (cardsList) {
        // é˜²æ­¢åˆ·æ–°é‡å¤æ’å…¥ï¼šæ£€æŸ¥æ˜¯å¦å·²æœ‰è¯¥æŒå¡äººçš„å¡
        var alreadyExists = cardsList.some(function(c) { return c.holderId === 'h_01'; });
        
        if (!alreadyExists) {
            cardsList.unshift(kycCard); // æ’åˆ°æœ€å‰é¢
            console.log("âœ… å®åå¡ç‰‡æ•°æ®å·²æˆåŠŸæ³¨å…¥!");
        }
    } else {
        console.error("âŒ æ‰¾ä¸åˆ° myCards æ•°æ®æºï¼Œæ— æ³•æ·»åŠ ");
    }

    // 4. å»¶è¿Ÿ 0.5ç§’ å¼ºåˆ¶åˆ·æ–°åˆ—è¡¨è§†å›¾ (ç¡®ä¿æ•°æ®ç”Ÿæ•ˆåæ›´æ–°UI)
    setTimeout(function() {
        if (typeof showView === 'function') {
            // å¦‚æœå½“å‰æ²¡åœ¨å¡ç‰‡é¡µï¼Œä¸å¼ºè·³ï¼›å¦‚æœå°±åœ¨å¡ç‰‡é¡µï¼Œåˆ·æ–°ä¹‹
            var currentTitle = document.querySelector('h2') ? document.querySelector('h2').innerText : '';
            if (currentTitle.includes('å¡ç‰‡') || currentTitle.includes('Cards')) {
                showView('cards');
            }
        }
    }, 500);
})();
</script>
<script>
{
    // 1. é‡æ–°å®šä¹‰ï¼šæˆåŠŸçŠ¶æ€çš„ HTML ç”Ÿæˆå™¨
    const getSuccessHtml = () => `
        <div class="bg-white w-full max-w-sm rounded-2xl p-8 text-center shadow-2xl transform scale-100 transition-all relative overflow-hidden mx-auto mt-20 animate-bounce-in">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-green-400 to-emerald-500"></div>
            
            <div class="w-20 h-20 bg-green-50 rounded-full flex items-center justify-center mx-auto mb-6">
                <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center shadow-lg shadow-green-200">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>
                </div>
            </div>
            
            <h2 class="text-2xl font-bold text-slate-800 mb-2">å¼€å¡æˆåŠŸï¼</h2>
            <p class="text-sm text-slate-500 mb-8">æ–°å¡ç‰‡å·²æ¿€æ´»ï¼Œæ‚¨å¯ä»¥ç«‹å³ä½¿ç”¨ã€‚</p>
            
            <div class="grid grid-cols-2 gap-3">
                <button onclick="document.getElementById('modal-container').innerHTML=''; showView('apply')" class="py-3 border border-slate-200 text-slate-600 font-bold rounded-xl hover:bg-slate-50 transition">ç»§ç»­å¼€å¡</button>
                <button onclick="document.getElementById('modal-container').innerHTML=''; showView('cards')" class="py-3 bg-slate-900 text-white font-bold rounded-xl hover:bg-slate-800 shadow-lg transition">æŸ¥çœ‹å¡ç‰‡</button>
            </div>
        </div>`;

    // 2. é‡å†™ï¼šæ”¶é“¶å°å¼¹çª— (openPaymentConfirmModal)
    window.openPaymentConfirmModal = function(symbol, cost, qty, walletCode, onConfirm) {
        const modalHTML = `
        <div class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[100] flex items-center justify-center fade-in" id="payment-modal-overlay">
            <div id="payment-card-container" class="bg-white w-full max-w-[400px] rounded-2xl shadow-2xl overflow-hidden">
                
                <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <div>
                        <h3 class="font-bold text-lg text-slate-800">ç¡®è®¤ä»˜æ¬¾</h3>
                        <p class="text-xs text-slate-500">Secure Payment</p>
                    </div>
                    <button onclick="document.getElementById('modal-container').innerHTML=''" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
                </div>

                <div class="p-6">
                    <div class="text-center mb-8">
                        <p class="text-xs text-slate-500 font-bold uppercase mb-2">æ”¯ä»˜æ€»é¢ (${walletCode})</p>
                        <h2 class="text-4xl font-bold text-slate-900 tracking-tight">${symbol}${cost.toFixed(2)}</h2>
                    </div>

                    <div class="bg-slate-50 rounded-xl p-4 border border-slate-100 mb-6 space-y-3 text-sm">
                        <div class="flex justify-between text-slate-600"><span>ä¸šåŠ¡ç±»å‹</span><span class="font-bold text-slate-800">æ‰¹é‡å¼€å¡ (${qty}å¼ )</span></div>
                        <div class="flex justify-between text-slate-600"><span>ä»˜æ¬¾è´¦æˆ·</span><span class="font-mono text-slate-800">${walletCode} Wallet</span></div>
                        <div class="w-full h-px bg-slate-200 border-t border-dashed border-slate-300"></div>
                        <div class="flex justify-between items-center"><span class="text-xs font-bold text-slate-500">å®ä»˜é‡‘é¢</span><span class="font-bold text-indigo-600">${symbol}${cost.toFixed(2)}</span></div>
                    </div>

                    <button id="btn-confirm-pay" class="w-full py-3.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg transition flex items-center justify-center gap-2">
                        ç«‹å³æ”¯ä»˜
                    </button>
                </div>
            </div>
        </div>`;
        
        document.getElementById('modal-container').innerHTML = modalHTML;
        
        // ç»‘å®šäº‹ä»¶
        document.getElementById('btn-confirm-pay').onclick = function() {
            const btn = this;
            btn.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> å¤„ç†ä¸­...';
            btn.disabled = true;

            // æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚
            setTimeout(() => {
                // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
                onConfirm(); 
                
                // ã€å…³é”®ä¿®å¤ã€‘ç›´æ¥æ›¿æ¢å½“å‰å¼¹çª—çš„å†…å®¹ï¼Œè€Œä¸æ˜¯å…³é—­å†æ‰“å¼€
                // è¿™æ ·å°±ç»å¯¹ä¸ä¼šæœ‰é—ªçƒæˆ–å¼¹ä¸å‡ºæ¥çš„é—®é¢˜äº†
                const overlay = document.getElementById('payment-modal-overlay');
                if (overlay) {
                    overlay.innerHTML = getSuccessHtml(); // åŸåœ°å˜èº«
                }
            }, 800);
        };
    };

    // --- 3. ä¸šåŠ¡å…¥å£ï¼šç‚¹å‡»æ”¯ä»˜ ---
    window._handleApplyPay = (symbol, cost, needHolder) => {
        const wallet = window.currentUser.wallets.find(w => w.code === window._applyState.currency);
        
        // ä½™é¢æ ¡éªŒ
        if (cost > wallet.balance) {
            const html = `<div class="fixed inset-0 bg-black/60 z-[200] flex items-center justify-center"><div class="bg-white p-6 rounded-xl w-80 text-center"><div class="text-4xl mb-2">ğŸ’¸</div><h3 class="font-bold text-lg text-slate-800">ä½™é¢ä¸è¶³</h3><p class="text-sm text-slate-500 mt-1 mb-4">å½“å‰ä½™é¢ ${symbol}${wallet.balance.toFixed(2)}</p><button onclick="document.getElementById('modal-container').innerHTML=''" class="w-full py-2 bg-slate-100 font-bold text-slate-600 rounded-lg">å…³é—­</button></div></div>`;
            document.getElementById('modal-container').innerHTML = html;
            return;
        }

        // æŒå¡äººæ ¡éªŒ
        let cardName = document.getElementById('apply-nickname').value || 'New Card';
        let holderId = null;
        if (needHolder) {
            const holderSelect = document.getElementById('apply-holder');
            if(!holderSelect || !holderSelect.value) return alert('è¯·é€‰æ‹©æŒå¡äººï¼');
            holderId = holderSelect.value;
            const h = window._cardholders.find(x => x.id === holderId);
            if(h) cardName = `${h.firstName} ${h.lastName}`;
        }

        // æ‰“å¼€æ”¶é“¶å° (ä¼ å…¥å›è°ƒ)
        window.openPaymentConfirmModal(symbol, cost, window._applyState.qty, wallet.code, () => {
            // æ‰£æ¬¾
            wallet.balance -= cost;
            if (wallet.code === 'USD') window.currentUser.balance = wallet.balance;

            // ç”Ÿæˆæ•°æ®
            const bin = window._binData.filter(i => 
                i.category === window._applyState.tab && 
                (window._applyState.cardType === 'shared' ? i.supportShared : true) && 
                i.currencies.includes(window._applyState.currency)
            )[window._applyState.binIndex] || window._binData[0];
            
            for(let i=0; i<window._applyState.qty; i++) {
                window.myCards.unshift({
                    id: 'c_'+Date.now()+i,
                    name: window._applyState.qty>1 ? `${cardName} #${i+1}` : cardName,
                    number: bin.bin + Math.floor(Math.random()*100000000000),
                    cvv: '888', exp: '12/29',
                    balance: window._applyState.cardType==='shared' ? 0 : 10,
                    status: 'active', type: bin.net, product: bin.label,
                    mode: window._applyState.cardType,
                    currency: window._applyState.currency,
                    limit: 5000, holderId: holderId
                });
            }
            
            // åˆ·æ–°åå°ä½™é¢æ˜¾ç¤º
            if(document.getElementById('nav-total-balance')) {
                document.getElementById('nav-total-balance').innerText = (window.currentUser.balance + window.currentUser.cardBalance).toLocaleString();
            }
        });
    }
}
</script>
<script>
{
    // 1. ã€æ ¸å¿ƒä¿®å¤ã€‘å¼ºåˆ¶åˆå§‹åŒ–å…¨å±€å¡ç‰‡æ•°ç»„
    // å¦‚æœ window.myCards ä¸å­˜åœ¨ï¼Œå°è¯•è¯»å–æ—§å˜é‡ myCardsï¼Œå¦‚æœéƒ½æ²¡æœ‰ï¼Œè¿™å°±åˆå§‹åŒ–ä¸ºç©ºæ•°ç»„
    if (!window.myCards) {
        if (typeof myCards !== 'undefined') {
            window.myCards = myCards; // ç»§æ‰¿åŸæœ‰æ•°æ®
        } else {
            window.myCards = []; // åˆå§‹åŒ–ä¸ºç©º
        }
    }

    // 2. é‡æ–°ç»‘å®šæ”¯ä»˜é€»è¾‘ (å¢åŠ å®¹é”™)
    window._handleApplyPay = (symbol, cost, needHolder) => {
        // å†æ¬¡ç¡®ä¿é’±åŒ…å­˜åœ¨
        if (!window.currentUser || !window.currentUser.wallets) return alert('ç³»ç»Ÿæ•°æ®åŠ è½½å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é¡µé¢');
        
        const wallet = window.currentUser.wallets.find(w => w.code === window._applyState.currency);
        
        // ä½™é¢æ£€æŸ¥
        if (cost > wallet.balance) {
            const html = `<div class="fixed inset-0 bg-black/60 z-[200] flex items-center justify-center fade-in"><div class="bg-white p-6 rounded-xl w-80 text-center"><div class="text-4xl mb-2">ğŸ’¸</div><h3 class="font-bold text-lg text-slate-800">ä½™é¢ä¸è¶³</h3><p class="text-sm text-slate-500 mt-1 mb-4">å½“å‰ä½™é¢ ${symbol}${wallet.balance.toFixed(2)}ï¼Œä¸è¶³ä»¥æ”¯ä»˜ã€‚</p><button onclick="document.getElementById('modal-container').innerHTML=''" class="w-full py-2 bg-slate-100 font-bold text-slate-600 rounded-lg">å…³é—­</button></div></div>`;
            document.getElementById('modal-container').innerHTML = html;
            return;
        }
        
        // æŒå¡äººæ ¡éªŒ
        let cardName = document.getElementById('apply-nickname').value || 'New Card';
        let holderId = null;
        if (needHolder) {
            const holderSelect = document.getElementById('apply-holder');
            if(!holderSelect || !holderSelect.value) return alert('è¯·é€‰æ‹©æŒå¡äººï¼');
            holderId = holderSelect.value;
            // æŸ¥æ‰¾æŒå¡äººå§“å
            if (window._cardholders) {
                const h = window._cardholders.find(x => x.id === holderId);
                if(h) cardName = `${h.firstName} ${h.lastName}`;
            }
        }

        // å”¤èµ·æ”¶é“¶å°
        window.openPaymentConfirmModal(symbol, cost, window._applyState.qty, wallet.code, () => {
            // --- æ”¯ä»˜å¤„ç† ---
            wallet.balance -= cost;
            if (wallet.code === 'USD') window.currentUser.balance = wallet.balance;

            // ç”Ÿæˆå¡ç‰‡
            const bin = window._binData.filter(i => 
                i.category === window._applyState.tab && 
                (window._applyState.cardType === 'shared' ? i.supportShared : true) && 
                i.currencies.includes(window._applyState.currency)
            )[window._applyState.binIndex] || window._binData[0];
            
            // ã€æ ¸å¿ƒä¿®å¤ç‚¹ã€‘å†æ¬¡æ£€æŸ¥å¹¶åˆå§‹åŒ–æ•°ç»„ï¼Œé˜²æ­¢ unshift æŠ¥é”™
            if (!window.myCards) window.myCards = [];

            for(let i=0; i<window._applyState.qty; i++) {
                // åˆ›å»ºæ–°å¡å¯¹è±¡
                const newCard = {
                    id: 'c_' + Date.now() + i,
                    name: window._applyState.qty > 1 ? `${cardName} #${i+1}` : cardName,
                    number: bin.bin + Math.floor(Math.random() * 100000000000),
                    cvv: '888', exp: '12/29',
                    balance: window._applyState.cardType === 'shared' ? 0 : 10,
                    status: 'active', type: bin.net, product: bin.label,
                    mode: window._applyState.cardType,
                    currency: window._applyState.currency,
                    limit: 5000, 
                    holderId: holderId
                };
                
                // å®‰å…¨æ’å…¥
                window.myCards.unshift(newCard);
            }

            // å…³é—­æ”¶é“¶å° -> æ‰“å¼€æˆåŠŸé¡µ (åŸåœ°å˜èº«)
            const overlay = document.getElementById('payment-modal-overlay');
            if (overlay) {
                // è·å–æˆåŠŸé¡µ HTML (è¿™é‡Œç›´æ¥å†…è”ï¼Œé˜²æ­¢ getSuccessHtml ä¸¢å¤±)
                overlay.innerHTML = `
                <div class="bg-white w-full max-w-sm rounded-2xl p-8 text-center shadow-2xl transform scale-100 transition-all relative overflow-hidden mx-auto mt-20 animate-bounce-in">
                    <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-green-400 to-emerald-500"></div>
                    <div class="w-20 h-20 bg-green-50 rounded-full flex items-center justify-center mx-auto mb-6">
                        <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center shadow-lg shadow-green-200">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>
                        </div>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">å¼€å¡æˆåŠŸï¼</h2>
                    <p class="text-sm text-slate-500 mb-8">æ–°å¡ç‰‡å·²æ¿€æ´»ï¼Œæ‚¨å¯ä»¥ç«‹å³ä½¿ç”¨ã€‚</p>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="document.getElementById('modal-container').innerHTML=''; showView('apply')" class="py-3 border border-slate-200 text-slate-600 font-bold rounded-xl hover:bg-slate-50 transition">ç»§ç»­å¼€å¡</button>
                        <button onclick="document.getElementById('modal-container').innerHTML=''; showView('cards')" class="py-3 bg-slate-900 text-white font-bold rounded-xl hover:bg-slate-800 shadow-lg transition">æŸ¥çœ‹å¡ç‰‡</button>
                    </div>
                </div>`;
            } else {
                // å¦‚æœæ‰¾ä¸åˆ° overlayï¼Œå›é€€åˆ° alert
                alert('ğŸ‰ å¼€å¡æˆåŠŸï¼');
                showView('cards');
            }
            
            // åˆ·æ–°åå°ä½™é¢
            const navBal = document.getElementById('nav-total-balance');
            if(navBal) navBal.innerText = (window.currentUser.balance + window.currentUser.cardBalance).toLocaleString(undefined, {minimumFractionDigits: 2});
        });
    }
}
</script>
</body>
</html>
